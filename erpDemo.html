<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ERP é™æ€æ¼”ç¤º Demo</title>
<style>
  /* Ant Design/Element UI é£æ ¼ç¾åŒ– */
  :root{
    --bg:#f5f7fa; --card:#fff; --muted:#6c757d; --accent:#1890ff;
    --success:#52c41a; --danger:#ff4d4f; --warning:#faad14; --info:#722ed1;
    --border-color:#d9d9d9; --shadow:0 2px 8px rgba(0,0,0,0.15);
    --header-bg:#fff; --sidebar-bg:#001529; --hover-bg:#f0f2f5;
  }
  *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft YaHei','Helvetica Neue',Helvetica,Arial,sans-serif}
  body{margin:0;background:var(--bg);color:#333;font-size:15px;line-height:1.6}
  .app{display:flex;min-height:100vh;}
  .sidebar{width:260px;background:#0f1724;color:#fff;padding:18px 16px;flex-shrink:0;}
  .logo{font-weight:700;letter-spacing:0.4px;margin-bottom:18px;font-size:18px}
  .nav{display:flex;flex-direction:column;gap:6px}
  .nav button{background:transparent;border:0;color:rgba(255,255,255,0.85);padding:14px 18px;border-radius:6px;text-align:left;cursor:pointer;font-size:15px;transition:all 0.3s ease}
  .nav button.active{background:rgba(255,255,255,0.06)}
  .nav button:hover{background:rgba(255,255,255,0.04)}
  .main{flex:1;padding:18px;display:flex;flex-direction:column;gap:12px}
  header.top{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:linear-gradient(90deg,#ffffffcc,#f3f4f6cc);border-radius:10px}
  .search{display:flex;gap:8px;align-items:center}
  .search input{padding:8px 10px;border-radius:8px;border:1px solid #e6e9ee}
  .card-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 2px 6px rgba(15,23,42,0.04)}
  .card .title{font-size:15px;color:var(--muted);margin-bottom:8px;font-weight:500}
  .card .value{font-size:26px;font-weight:600;color:#333}
  .content{display:flex;gap:12px}
  .panel{flex:1;background:var(--card);padding:12px;border-radius:10px;min-height:400px;box-shadow:0 2px 6px rgba(15,23,42,0.04)}
  table{width:100%;border-collapse:collapse;font-size:15px}
  th,td{padding:8px 12px;text-align:left;border-bottom:1px solid var(--border-color)}
  th{background:#fafafa;color:var(--muted);font-weight:600;font-size:15px}
  .muted{color:var(--muted);font-size:15px}
  .btn{padding:10px 20px;border-radius:6px;border:0;background:var(--accent);color:white;cursor:pointer;font-size:15px;font-weight:500;transition:all 0.3s ease;display:inline-flex;align-items:center;gap:6px}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(11,118,239,0.12)}
  .btn.primary{background:var(--success);color:white}
  .badge{display:inline-block;padding:5px 10px;border-radius:4px;font-size:13px;font-weight:500;color:#fff}
  .badge.success{background:var(--success)}
  .badge.danger{background:var(--danger)}
  .badge.warning{background:var(--warning)}
  .badge.info{background:var(--info)}
  .hidden{display:none}
  .small{font-size:14px;color:var(--muted)}
  .flex{display:flex;gap:12px;align-items:center}
  .form-row{display:flex;gap:12px;margin-bottom:8px}
  .form-row input, .form-row select{flex:1;padding:12px 16px;border-radius:6px;border:1px solid var(--border-color);font-size:15px}
  .toolbar{display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px;align-items:center;flex-wrap:wrap}
  
  /* æ¨¡æ€è¡¨å•é«˜åº¦ä¼˜åŒ– */
  .modal-form {
    max-height: 90vh;
    overflow-y: auto;
  }
  
  .modal-body {
    max-height: calc(90vh - 180px);
    overflow-y: auto;
  }
  
  /* è¡¨æ ¼å“åº”å¼ä¼˜åŒ– */
  .panel {
    overflow-x: auto;
  }
  
  table {
    min-width: 100%;
  }
  
  /* äº§å“åˆ—è¡¨å·¥å…·æ ä¼˜åŒ– */
  #productsView .toolbar {
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
  }
  
  #productsView .toolbar > div {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  /* ç±»ç›®æ ‡ç­¾å®¹å™¨ä¼˜åŒ– */
  .category-tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin: 4px 0;
  }
  .pill{padding:6px 12px;border-radius:16px;background:var(--hover-bg);color:#333;font-size:13px;font-weight:500}
  
  /* ç±»ç›®æ ‡ç­¾æ ·å¼ */
  .category-tag {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    color: white;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    margin: 0 4px;
    border: 1px solid rgba(255,255,255,0.2);
  }
  
  .category-tag:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    opacity: 0.9;
  }
  
  /* äº§å“åˆ†ç±»æ ‡ç­¾æ ·å¼ */
  .classification-tag {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 10px;
    color: white;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    margin: 0 3px;
    border: 1px solid rgba(255,255,255,0.2);
  }
  
  .classification-tag:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    opacity: 0.9;
  }
  
  /* å›¾ç‰‡æ‚¬åœæ•ˆæœ */
  .product-image {
    cursor: pointer;
    transition: transform 0.2s ease;
    display: inline-block;
  }
  .product-image:hover {
    transform: scale(2);
    z-index: 100;
    position: relative;
  }
  
  /* å›¾ç‰‡é¢„è§ˆæ‚¬æµ®æ¡† */
  .image-preview {
    position: fixed;
    background: var(--card);
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    z-index: 1000;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
    border: 1px solid rgba(0,0,0,0.1);
  }
  .image-preview.show {
    opacity: 1;
  }
  
  /* è¯¦æƒ…é¡µé¢ç¾åŒ– */
  .side-detail {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 580px;
    max-height: 85vh;
    background: var(--card);
    padding: 32px;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    z-index: 2000;
    overflow: auto;
    border: 1px solid rgba(255,255,255,0.2);
  }
  
  /* é®ç½©å±‚ */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1999;
    backdrop-filter: blur(4px);
  }
  
  .side-detail.hidden {
    display: none;
  }
  
  /* é‡‡è´­è®¢å•è¯¦æƒ…é¡µé¢ - æ›´å¤§çš„å°ºå¯¸ */
  .purchase-order-detail {
    width: 800px !important;
    max-height: 90vh !important;
  }
  
  /* è®¢å•æ˜ç»†è¡¨æ ¼æ ·å¼ */
  .order-lines-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-top: 8px;
  }
  
  .order-lines-table th {
    background: var(--hover-bg);
    padding: 8px 6px;
    text-align: left;
    border: 1px solid var(--border-color);
    font-weight: 600;
    color: var(--text);
  }
  
  .order-lines-table td {
    padding: 8px 6px;
    border: 1px solid var(--border-color);
    vertical-align: top;
  }
  
  .category-group {
    margin-bottom: 16px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    overflow: hidden;
  }
  
  .category-header {
    background: var(--primary);
    color: white;
    padding: 8px 12px;
    font-weight: 600;
    font-size: 14px;
  }
  
  /* æ²Ÿé€šè®°å½•é“¾æ¥æ ·å¼ */
  .communication-link {
    color: var(--primary);
    text-decoration: none;
    cursor: pointer;
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 3px;
    transition: background-color 0.2s;
  }
  
  .communication-link:hover {
    background: var(--hover-bg);
    text-decoration: underline;
  }
  
  /* è¯¦æƒ…é¡µé¢æ ‡é¢˜ç¾åŒ– */
  .detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 28px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
  }
  
  .detail-title {
    font-size: 20px;
    font-weight: 700;
    color: #1f2937;
  }
  
  .detail-close {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    border: none;
    background: #f3f4f6;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: #6b7280;
    transition: all 0.2s ease;
  }
  
  .detail-close:hover {
    background: #e5e7eb;
    color: #374151;
  }
  .chart{height:220px;margin:16px 0;position:relative}
  .chart-bar{background:linear-gradient(90deg,var(--accent),#69c0ff);border-radius:4px;margin:6px 0;position:relative}
  .chart-label{position:absolute;left:0;top:50%;transform:translateY(-50%);padding-left:14px;font-size:14px;color:white;font-weight:500}
  .progress-ring{width:90px;height:90px;border-radius:50%;background:conic-gradient(var(--accent) 0deg, var(--accent) var(--progress), #f0f0f0 var(--progress));display:flex;align-items:center;justify-content:center}
  .progress-ring::before{content:attr(data-text);font-size:18px;font-weight:600}
  footer{font-size:14px;color:var(--muted);margin-top:20px;text-align:center}

  /* æ¨¡æ€è¡¨å•æ ·å¼ */
  .modal-form {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 600px;
    max-width: 90vw;
    max-height: 85vh;
    background: var(--card);
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    z-index: 2000;
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  /* æ¨¡æ€æ¡†å†…å®¹å®¹å™¨ - é˜²æ­¢å†…éƒ¨ç‚¹å‡»è§¦å‘å…³é—­ */
  .modal-form .modal-header,
  .modal-form .modal-body,
  .modal-form .modal-footer {
    position: relative;
    z-index: 1;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 28px;
    border-bottom: 1px solid var(--border-color);
    background: #fafafa;
    border-radius: 12px 12px 0 0;
  }
  
  .modal-title {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .modal-close {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 6px;
    background: var(--hover-bg);
    color: var(--muted);
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }
  
  .modal-close:hover {
    background: #e5e7eb;
    color: #333;
  }
  
  .modal-body {
    padding: 20px 28px;
    overflow-y: auto;
    flex: 1;
  }
  
  .form-description {
    color: var(--muted);
    font-size: 15px;
    margin-bottom: 24px;
    line-height: 1.6;
  }
  
  .form-group {
    margin-bottom: 12px;
  }
  
  .form-label {
    display: block;
    font-size: 15px;
    font-weight: 500;
    color: #333;
    margin-bottom: 8px;
  }
  
  .form-input,
  .form-select {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 15px;
    background: white;
    transition: border-color 0.3s ease;
  }
  
  .form-input:focus,
  .form-select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(24,144,255,0.1);
  }
  
  .form-section {
    margin: 16px 0;
  }
  
  .section-title {
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid var(--hover-bg);
  }
  
  .po-items {
    min-height: 60px;
    padding: 16px;
    background: var(--hover-bg);
    border-radius: 8px;
    margin-bottom: 16px;
  }
  
  .modal-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 28px;
    border-top: 1px solid var(--border-color);
    background: #fafafa;
    border-radius: 0 0 12px 12px;
  }
  
  .total-amount {
    font-size: 16px;
    color: #333;
  }
  
  .tab-btn {
    padding: 8px 16px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    color: var(--muted);
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  
  .tab-btn:hover {
    color: var(--primary);
  }
  
  .tab-btn.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
  }
  
  .amount {
    font-weight: 600;
    color: var(--accent);
  }
  
  .form-actions {
    display: flex;
    gap: 12px;
  }
  
  .filter-btn {
    padding: 6px 12px;
    background: var(--bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--muted);
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  
  .filter-btn:hover {
    background: var(--accent-light);
    border-color: var(--accent);
  }
  
  .filter-btn.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }
  
  .po-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
  }
  
  .po-item:hover {
    border-color: var(--accent);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .item-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .item-sku {
    font-size: 14px;
    font-weight: 600;
    color: var(--accent);
    background: rgba(24,144,255,0.1);
    padding: 4px 8px;
    border-radius: 4px;
  }
  
  .item-name {
    font-size: 15px;
    font-weight: 500;
    color: #333;
  }
  
  .item-qty {
    font-size: 14px;
    color: var(--muted);
    background: var(--hover-bg);
    padding: 4px 8px;
    border-radius: 4px;
  }
  
  .item-price {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .price {
    font-size: 16px;
    font-weight: 600;
    color: var(--success);
  }

  /* å…¥åº“ç®¡ç†æ ·å¼ */
  .delivery-types {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin: 16px 0;
  }

  .delivery-type-card {
    border: 2px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .delivery-type-card:hover {
    border-color: var(--accent);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }

  .delivery-icon {
    font-size: 32px;
    margin-bottom: 8px;
  }

  .delivery-title {
    font-weight: 600;
    margin-bottom: 4px;
    color: #333;
  }

  .delivery-desc {
    font-size: 13px;
    color: var(--muted);
  }

  .inbound-step {
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .purchase-order-info {
    margin-bottom: 16px;
  }

  #quantityCheckTable {
    border-collapse: collapse;
  }

  #quantityCheckTable th,
  #quantityCheckTable td {
    padding: 8px;
    border: 1px solid var(--border-color);
    text-align: left;
  }

  #quantityCheckTable th {
    background: #fafafa;
    font-weight: 600;
  }
  /* responsive */
  @media (max-width:900px){
    .sidebar{display:none}
    .card-row{grid-template-columns:repeat(2,1fr)}
  }
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="logo">ERP Demoï¼ˆé™æ€ï¼‰</div>
    <div class="muted" style="margin-bottom:12px">æ¼”ç¤ºï¼šäº§å“/é‡‡è´­/åº“å­˜/é”€å”®/ä¾›åº”å•†</div>
    <nav class="nav" id="nav">
      <button data-view="dashboard" class="active">æ¦‚è§ˆ</button>
      <button data-view="products">äº§å“ç®¡ç†</button>
      <button data-view="purchase">é‡‡è´­ç®¡ç†</button>
      <button data-view="inventory">åº“å­˜ç®¡ç†</button>
      <button data-view="sales">é”€å”®ç®¡ç†</button>
      <button data-view="suppliers">ä¾›åº”å•†</button>
    </nav>
    <div style="margin-top:18px">
      <div class="small">ç”¨æˆ·åˆ‡æ¢</div>
      <select id="userSwitch" onchange="switchUser()" style="width:100%;margin-top:6px;padding:6px;border-radius:6px;border:1px solid #e6e9ee">
        <option value="è€æ¿æ">è€æ¿æ (ç®¡ç†å‘˜)</option>
        <option value="é‡‡è´­å‘˜å¼ ">é‡‡è´­å‘˜å¼ </option>
        <option value="é‡‡è´­å‘˜ç‹">é‡‡è´­å‘˜ç‹</option>
        <option value="ä»“åº“ç®¡ç†å‘˜">ä»“åº“ç®¡ç†å‘˜</option>
        <option value="é”€å”®å‘˜">é”€å”®å‘˜</option>
      </select>
      <div class="muted" style="margin-top:6px">æ¼”ç¤ºç‰ˆæœ¬ Â· ä»…ä¾›è¯„å®¡</div>
    </div>
  </aside>

  <main class="main">
    <header class="top">
      <div style="display:flex;gap:12px;align-items:center;flex:1">
        <div style="font-weight:700">ERP æ¼”ç¤ºæ§åˆ¶å°</div>
        <div class="muted small">æ˜¾ç¤ºå…³é”®æ•°æ®ä¸å¯¼èˆª</div>
      </div>
      <div class="search">
        <input id="globalSearch" placeholder="å¿«é€Ÿæœç´¢ SKU / åç§° / è®¢å•å·" style="max-width:300px" />
      </div>
    </header>

    <!-- Dashboard -->
    <section id="dashboardView">
      <div class="card-row" style="margin-top:8px">
        <div class="card">
          <div class="title">åº“å­˜ SKU æ€»æ•°</div>
          <div class="value" id="stat-skus">â€”</div>
          <div class="small muted">æ´»è·ƒ SKU æ•°é‡</div>
        </div>
        <div class="card">
          <div class="title">å¾…æ”¶é‡‡è´­å•</div>
          <div class="value" id="stat-pos">â€”</div>
          <div class="small muted">æ­£åœ¨è¿è¾“/å¾…å…¥åº“</div>
        </div>
        <div class="card">
          <div class="title">ä»Šæ—¥é”€å”®å•</div>
          <div class="value" id="stat-sales">â€”</div>
          <div class="small muted">å·²å‘è´§ / å¾…å‘è´§</div>
        </div>
        <div class="card">
          <div class="title">åº“å­˜æ€»ä»¶æ•°</div>
          <div class="value" id="stat-qty">â€”</div>
          <div class="small muted">å•ä½ï¼šä»¶</div>
        </div>
      </div>

      <div class="content" style="margin-top:12px">
        <div class="panel" style="flex:2">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:600">è¿‘æœŸé‡‡è´­</div>
            <div class="small muted">é‡‡è´­å•ä»…ä½œç¤ºä¾‹</div>
          </div>
          <table id="table-pos">
            <thead>
              <tr><th>é‡‡è´­å•å·</th><th>ä¾›åº”å•†</th><th>é¡¹æ•°</th><th>æ€»é¢</th><th>çŠ¶æ€</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="panel" style="flex:1">
          <div style="font-weight:600;margin-bottom:8px">åº“å­˜é¢„è­¦</div>
          <div id="lowStockList"></div>
          <hr style="margin:10px 0" />
          <div style="font-weight:600;margin-bottom:8px">å¿«é€Ÿæ“ä½œ</div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn ghost" onclick="exportMock()">å¯¼å‡ºåº“å­˜æŠ¥è¡¨</button>
          </div>
        </div>
      </div>

      <!-- Analytics Section -->
      <div class="content" style="margin-top:12px">
        <div class="panel" style="flex:1">
          <div style="font-weight:600;margin-bottom:12px">åº“å­˜åˆ†æ</div>
          <div id="inventoryChart" class="chart"></div>
        </div>
        <div class="panel" style="flex:1">
          <div style="font-weight:600;margin-bottom:12px">é”€å”®è¶‹åŠ¿</div>
          <div id="salesChart" class="chart"></div>
        </div>
      </div>

      <!-- Financial Overview -->
      <div class="content" style="margin-top:12px">
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div style="font-weight:600">è´¢åŠ¡æ¦‚è§ˆ</div>
            <div class="small muted">å•ä½ï¼šä¸‡å…ƒ</div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;align-items:center">
            <div style="text-align:center">
              <div class="progress-ring" id="payableRing" data-text="0%" style="--progress:0deg"></div>
              <div class="small muted" style="margin-top:8px">åº”ä»˜è´¦æ¬¾</div>
            </div>
            <div style="text-align:center">
              <div class="progress-ring" id="receivableRing" data-text="0%" style="--progress:0deg"></div>
              <div class="small muted" style="margin-top:8px">åº”æ”¶è´¦æ¬¾</div>
            </div>
            <div style="text-align:center">
              <div class="progress-ring" id="profitRing" data-text="0%" style="--progress:0deg"></div>
              <div class="small muted" style="margin-top:8px">æ¯›åˆ©ç‡</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Products -->
    <section id="productsView" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="font-weight:600">äº§å“ç®¡ç†</div>
        <div class="toolbar">
          <input id="productFilter" placeholder="ç­›é€‰ SKU æˆ– åç§°" />
          <button class="btn primary" onclick="openAddProductModal()">â• æ–°å¢äº§å“</button>
          <button class="btn" onclick="renderProducts()">åˆ·æ–°</button>
        </div>
      </div>
      <div class="panel">
        <div style="margin-bottom:8px">
          <div class="toolbar">
            <div>
              <button class="btn ghost" onclick="showProductType('all')">å…¨éƒ¨</button>
              <button class="btn ghost" onclick="showProductType('æ™®å“')">æ™®å“</button>
              <button class="btn ghost" onclick="showProductType('ç»„åˆ')">ç»„åˆ</button>
              <button class="btn ghost" onclick="showProductType('ç”Ÿäº§')">ç”Ÿäº§</button>
            </div>
          </div>
          
          <div class="category-tags-container">
            <span class="category-tag" onclick="showCategory('all')" style="background: #8b5cf6;">å…¨ç±»ç›®</span>
            <span class="category-tag" onclick="showCategory('æ¸¸æˆ')" style="background: #ef4444;">æ¸¸æˆ</span>
            <span class="category-tag" onclick="showCategory('3Cç±»')" style="background: #3b82f6;">3Cç±»</span>
            <span class="category-tag" onclick="showCategory('æ¯å©´')" style="background: #f59e0b;">æ¯å©´</span>
            <span class="category-tag" onclick="showCategory('æ±½é…')" style="background: #10b981;">æ±½é…</span>
            <span class="category-tag" onclick="showCategory('æˆ·å¤–è¿åŠ¨')" style="background: #06b6d4;">æˆ·å¤–è¿åŠ¨</span>
            <span class="category-tag" onclick="showCategory('ç©å…·')" style="background: #ec4899;">ç©å…·</span>
            <span class="category-tag" onclick="showCategory('å®¶å±…')" style="background: #84cc16;">å®¶å±…</span>
          </div>
          
          <div class="category-tags-container">
            <span class="classification-tag" onclick="showClassification('all')" style="background: #6b7280;">å…¨éƒ¨åˆ†ç±»</span>
            <span class="classification-tag" onclick="showClassification('æˆå“')" style="background: #059669;">æˆå“</span>
            <span class="classification-tag" onclick="showClassification('åŠæˆå“')" style="background: #dc2626;">åŠæˆå“</span>
            <span class="classification-tag" onclick="showClassification('ç‰©æ–™')" style="background: #7c3aed;">ç‰©æ–™</span>
            <span class="classification-tag" onclick="showClassification('åŒ…è£…è¾…æ–™')" style="background: #ea580c;">åŒ…è£…è¾…æ–™</span>
          </div>
        </div>
        <div style="overflow-x: auto; max-width: 100%;">
          <table id="table-products" style="min-width: 1200px;">
          <thead><tr><th style="white-space: nowrap; min-width: 50px;">å›¾ç‰‡</th><th style="white-space: nowrap; min-width: 70px;">SKU</th><th style="white-space: nowrap; min-width: 100px;">åç§°</th><th style="white-space: nowrap; min-width: 70px;">å‹å·</th><th style="white-space: nowrap; min-width: 50px;">ç±»å‹</th><th style="white-space: nowrap; min-width: 60px;">ç±»ç›®</th><th style="white-space: nowrap; min-width: 70px;">åˆ†ç±»</th><th style="white-space: nowrap; min-width: 50px;">åº“å­˜</th><th style="white-space: nowrap; min-width: 50px;">äº¤æœŸ</th><th style="white-space: nowrap; min-width: 70px;" onclick="sortProducts('sales10d')" style="cursor:pointer">10å¤©é”€é‡ â†•</th><th style="white-space: nowrap; min-width: 70px;" onclick="sortProducts('sales30d')" style="cursor:pointer">30å¤©é”€é‡ â†•</th><th style="white-space: nowrap; min-width: 90px;" onclick="sortProducts('createdDate')" style="cursor:pointer">åˆ›å»ºæ—¶é—´ â†•</th><th style="white-space: nowrap; min-width: 90px;" onclick="sortProducts('modifiedDate')" style="cursor:pointer">æœ€åä¿®æ”¹ â†•</th><th style="white-space: nowrap; min-width: 60px;">æ“ä½œ</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Purchase -->
    <section id="purchaseView" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="font-weight:600">é‡‡è´­ç®¡ç†</div>
        <div class="toolbar">
          <button class="btn" onclick="openCreatePO()">â• åˆ›å»ºé‡‡è´­è®¡åˆ’</button>
          <button class="btn ghost" onclick="openPurchaseOrder()">ğŸ“‹ é‡‡è´­è®¢å•</button>
          <button class="btn ghost" onclick="openReturnOrder()">â†©ï¸ é€€è´§å•</button>
          <button class="btn ghost" onclick="simulateReceive()">ğŸ“¦ æ¨¡æ‹Ÿæ”¶è´§</button>
        </div>
      </div>
      <div class="panel">
        <!-- é¡µé¢åˆ‡æ¢æ ‡ç­¾ -->
        <div style="display:flex;gap:12px;margin-bottom:16px;border-bottom:1px solid var(--border-color);">
          <button class="tab-btn active" onclick="showPurchaseTab('plans')" id="plansTab">ğŸ“‹ é‡‡è´­è®¡åˆ’</button>
          <button class="tab-btn" onclick="showPurchaseTab('orders')" id="ordersTab">ğŸ“‹ é‡‡è´­è®¢å•</button>
          <button class="tab-btn" onclick="showPurchaseTab('warehouse')" id="warehouseTab">ğŸ“¦ ä»“åº“å¾…å‘è´§</button>
          <button class="tab-btn" onclick="showPurchaseTab('quotes')" id="quotesTab">ğŸ’° ä¾›åº”å•†æŠ¥ä»·</button>
        </div>
        
        <!-- é‡‡è´­è®¡åˆ’åˆ—è¡¨ -->
        <div id="plansSection">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:600">é‡‡è´­è®¡åˆ’åˆ—è¡¨</div>
            <div class="small muted">å½“å‰ç”¨æˆ·ï¼š<span id="currentUserDisplay"></span> <span id="currentUserRole"></span></div>
          </div>
          
          <!-- é‡‡è´­å•çŠ¶æ€ç­›é€‰æ ‡ç­¾ -->
          <div style="margin-bottom:12px">
            <span class="category-tag" onclick="filterPOByStatus('all')" style="background: #6b7280;">å…¨éƒ¨çŠ¶æ€</span>
            <span class="category-tag" onclick="filterPOByStatus('è‰ç¨¿')" style="background: #9ca3af;">è‰ç¨¿</span>
            <span class="category-tag" onclick="filterPOByStatus('å¾…å®¡æ ¸')" style="background: #f59e0b;">å¾…å®¡æ ¸</span>
            <span class="category-tag" onclick="filterPOByStatus('å·²é©³å›')" style="background: #ef4444;">å·²é©³å›</span>
            <span class="category-tag" onclick="filterPOByStatus('å¾…é‡‡è´­')" style="background: #3b82f6;">å¾…é‡‡è´­</span>
            <span class="category-tag" onclick="filterPOByStatus('ä»“åº“å¾…å‘è´§')" style="background: #f97316;">ä»“åº“å¾…å‘è´§</span>
            <span class="category-tag" onclick="filterPOByStatus('å·²å‘è´§')" style="background: #06b6d4;">å·²å‘è´§</span>
            <span class="category-tag" onclick="filterPOByStatus('å¾…æ”¶è´§')" style="background: #8b5cf6;">å¾…æ”¶è´§</span>
            <span class="category-tag" onclick="filterPOByStatus('å·²å®Œæˆ')" style="background: #10b981;">å·²å®Œæˆ</span>
          </div>
          
          <table id="table-purchase">
            <thead><tr><th>é‡‡è´­å•å·</th><th>ä¾›åº”å•†</th><th>ç”³è¯·äºº</th><th>æ€»é¢</th><th>çŠ¶æ€</th><th>å®¡æ‰¹äºº</th><th onclick="sortByCreateDate()" style="cursor:pointer">åˆ›å»ºæ—¶é—´ â†•</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        
        <!-- é‡‡è´­è®¢å•åˆ—è¡¨ -->
        <div id="ordersSection" class="hidden">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-weight:600">é‡‡è´­è®¢å•åˆ—è¡¨</div>
            <div class="small muted">å½“å‰ç”¨æˆ·ï¼š<span id="currentUserDisplay"></span> <span id="currentUserRole"></span></div>
          </div>
          
          <!-- é‡‡è´­è®¢å•çŠ¶æ€ç­›é€‰æ ‡ç­¾ -->
          <div style="margin-bottom:12px">
            <span class="category-tag" onclick="filterPurchaseOrderByStatus('all')" style="background: #6b7280;">å…¨éƒ¨çŠ¶æ€</span>
            <span class="category-tag" onclick="filterPurchaseOrderByStatus('å¾…ä¾›åº”å•†ç¡®è®¤')" style="background: #f59e0b;">å¾…ä¾›åº”å•†ç¡®è®¤</span>
            <span class="category-tag" onclick="filterPurchaseOrderByStatus('ä¾›åº”å•†å·²ç¡®è®¤')" style="background: #3b82f6;">ä¾›åº”å•†å·²ç¡®è®¤</span>
            <span class="category-tag" onclick="filterPurchaseOrderByStatus('å·²å‘è´§')" style="background: #06b6d4;">å·²å‘è´§</span>
            <span class="category-tag" onclick="filterPurchaseOrderByStatus('å¾…æ”¶è´§')" style="background: #8b5cf6;">å¾…æ”¶è´§</span>
            <span class="category-tag" onclick="filterPurchaseOrderByStatus('å·²æ”¶è´§')" style="background: #10b981;">å·²æ”¶è´§</span>
            <span class="category-tag" onclick="filterPurchaseOrderByStatus('å·²å®Œæˆ')" style="background: #22c55e;">å·²å®Œæˆ</span>
          </div>
          
          <table id="table-purchaseOrders">
            <thead><tr><th>è®¢å•å·</th><th>ä¾›åº”å•†</th><th>é‡‡è´­å‘˜</th><th>æ€»é¢</th><th>é¢„è®¡äº¤æœŸ</th><th>å®é™…äº¤æœŸ</th><th>çŠ¶æ€</th><th>æ”¶è´§çŠ¶æ€</th><th onclick="sortPurchaseOrderByCreateDate()" style="cursor:pointer">åˆ›å»ºæ—¶é—´ â†•</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        
        <!-- ä»“åº“å¾…å‘è´§é¡µé¢ -->
        <div id="warehouseSection" class="hidden">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div style="font-weight:600">ä»“åº“å¾…å‘è´§</div>
          </div>
          
          <!-- æŸ¥è¯¢ç­›é€‰ -->
          <div style="margin-bottom:12px">
            <div class="toolbar">
              <select id="warehouseSalesmanFilter" onchange="filterWarehouseOrders()" style="padding:6px;border:1px solid var(--border-color);border-radius:4px;">
                <option value="">ä¸šåŠ¡å‘˜</option>
              </select>
              <input type="date" id="warehouseDateFilter" onchange="filterWarehouseOrders()" style="padding:6px;border:1px solid var(--border-color);border-radius:4px;">
              <input type="text" id="warehouseSearchFilter" placeholder="æœç´¢å“å" onchange="filterWarehouseOrders()" style="padding:6px;border:1px solid var(--border-color);border-radius:4px;width:200px;">
            </div>
          </div>
          
          <!-- è®¢å•åˆ—è¡¨ -->
          <table id="table-warehouse">
            <thead><tr><th>æ‰¹æ¬¡å·</th><th>å›¾ç‰‡</th><th>äº§å“SKU</th><th>äº§å“åç§°</th><th>äº§å“è§„æ ¼</th><th>å‘è´§æ•°é‡</th><th>ç®±æ•°</th><th>é‡é‡</th><th>ç‰©æµå…¬å¸</th><th>ç‰©æµå•å·</th><th>ç‰©æµè´¹ç”¨</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        
        <!-- ä¾›åº”å•†æŠ¥ä»·åˆ—è¡¨ -->
        <div id="quotesSection" class="hidden">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div style="font-weight:600">ä¾›åº”å•†æŠ¥ä»·åˆ—è¡¨</div>
            <div class="toolbar">
              <button class="btn ghost" onclick="openSupplierQuote()">â• æ–°å¢æŠ¥ä»·</button>
            </div>
          </div>
          
          <!-- æŠ¥ä»·ç­›é€‰ -->
          <div style="margin-bottom:12px">
            <div class="toolbar">
              <select id="quoteFilterSupplier" onchange="filterQuotes()" style="padding:6px;border:1px solid var(--border-color);border-radius:4px;">
                <option value="">å…¨éƒ¨ä¾›åº”å•†</option>
              </select>
              <select id="quoteFilterProduct" onchange="filterQuotes()" style="padding:6px;border:1px solid var(--border-color);border-radius:4px;">
                <option value="">å…¨éƒ¨äº§å“</option>
              </select>
            </div>
          </div>
          
          <table id="table-quotes">
            <thead><tr><th>ä¾›åº”å•†</th><th>äº§å“</th><th>æŠ¥ä»·</th><th>æœ€å°èµ·è®¢é‡</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Inventory -->
    <section id="inventoryView" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="font-weight:600">åº“å­˜ç®¡ç†</div>
        <div class="toolbar">
          <span class="pill">äºŒç»´ç /æ ‡ç­¾: æ”¯æŒæ‰“å°</span>
          <button class="btn ghost" onclick="showWarehouseInbound()">ğŸ“¦ å…¥åº“ç®¡ç†</button>
          <button class="btn ghost" onclick="exportMock()">å¯¼å‡ºåº“å­˜</button>
        </div>
      </div>
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="toolbar">
            <button class="btn ghost" onclick="showInventoryView('summary')">æ€»è§ˆ</button>
            <button class="btn ghost" onclick="showInventoryView('adjustments')">åº“å­˜è°ƒæ•´</button>
            <button class="btn ghost" onclick="showInventoryView('outbound')">å‡ºåº“è®°å½•</button>
            <button class="btn ghost" onclick="showInventoryAlerts()">åº“å­˜é¢„è­¦</button>
            <button class="btn ghost" onclick="showInventoryCount()">åº“å­˜ç›˜ç‚¹</button>
          </div>
        </div>
        <table id="table-inventory">
          <thead><tr><th>SKU</th><th>äº§å“</th><th>å¯ç”¨åº“å­˜</th><th>äº¤æœŸ</th><th>10å¤©é”€é‡â†•</th><th>30å¤©é”€é‡â†•</th><th>åˆ›å»ºæ—¶é—´â†•</th><th>æœ€åä¿®æ”¹â†•</th><th>æ“ä½œ</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Sales -->
    <section id="salesView" class="hidden">
      <!-- é”€å”®ç®¡ç†åŠŸèƒ½åˆ‡æ¢æ ‡ç­¾ -->
      <div style="margin-bottom:16px;border-bottom:1px solid var(--border-color);">
        <div style="display:flex;gap:0;">
          <button class="tab-btn active" onclick="showSalesSubView('orders')">é”€å”®è®¢å•</button>
          <button class="tab-btn" onclick="showSalesSubView('customers')">å®¢æˆ·ç®¡ç†</button>
          <button class="tab-btn" onclick="showSalesSubView('quotes')">é”€å”®æŠ¥ä»·</button>
          <button class="tab-btn" onclick="showSalesSubView('deliveries')">å‘è´§ç®¡ç†</button>
          <button class="tab-btn" onclick="showSalesSubView('returns')">é€€æ¢è´§</button>
          <button class="tab-btn" onclick="showSalesSubView('invoices')">å‘ç¥¨ç”³è¯·</button>
        </div>
      </div>

      <!-- é”€å”®è®¢å•è§†å›¾ -->
      <div id="salesOrdersView" class="sales-sub-view">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:600">é”€å”®è®¢å•</div>
          <div class="toolbar">
            <button class="btn" onclick="openCreateSalesOrder()">æ–°å»ºè®¢å•</button>
          </div>
        </div>
        
        <!-- è®¢å•ç±»å‹ç­›é€‰ -->
        <div style="display:flex;gap:8px;margin-bottom:16px;">
          <button class="filter-btn active" onclick="filterSalesByType('all')">å…¨éƒ¨è®¢å•</button>
          <button class="filter-btn" onclick="filterSalesByType('1688')">1688ä¸šåŠ¡</button>
          <button class="filter-btn" onclick="filterSalesByType('offline')">çº¿ä¸‹åˆä½œ</button>
        </div>

        <!-- æŸ¥è¯¢æ¡ä»¶ -->
        <div class="form-section" style="margin-bottom:16px;">
          <div class="section-title">æŸ¥è¯¢æ¡ä»¶</div>
          <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:12px;">
            <input type="text" id="salesSearchOrderNo" placeholder="è®¢å•å·" style="padding:8px;border:1px solid var(--border-color);border-radius:6px;" onkeyup="filterSalesOrders()">
            <input type="text" id="salesSearchCustomer" placeholder="å®¢æˆ·å" style="padding:8px;border:1px solid var(--border-color);border-radius:6px;" onkeyup="filterSalesOrders()">
            <input type="text" id="salesSearchContact" placeholder="è”ç³»äºº" style="padding:8px;border:1px solid var(--border-color);border-radius:6px;" onkeyup="filterSalesOrders()">
            <input type="text" id="salesSearchPhone" placeholder="æ‰‹æœºå·" style="padding:8px;border:1px solid var(--border-color);border-radius:6px;" onkeyup="filterSalesOrders()">
            <input type="date" id="salesSearchDate" style="padding:8px;border:1px solid var(--border-color);border-radius:6px;" onchange="filterSalesOrders()">
            <select id="salesSearchSalesperson" style="padding:8px;border:1px solid var(--border-color);border-radius:6px;" onchange="filterSalesOrders()">
              <option value="">å…¨éƒ¨ä¸šåŠ¡å‘˜</option>
              <option value="å¼ ä¸‰">å¼ ä¸‰</option>
              <option value="æå››">æå››</option>
            </select>
          </div>
          <div style="margin-top:12px;">
            <button class="btn ghost" onclick="clearSalesFilter()">æ¸…ç©ºç­›é€‰</button>
          </div>
        </div>

        <div class="panel">
          <table id="table-sales">
            <thead>
              <tr>
                <th>è®¢å•å·</th>
                <th>è®¢å•ç±»å‹</th>
                <th>é”€å”®æ—¥æœŸ</th>
                <th>å®¢æˆ·å</th>
                <th>äº¤è´§æ—¥æœŸ</th>
                <th>æ•°é‡</th>
                <th>æ€»é‡‘é¢</th>
                <th>ä»˜æ¬¾çŠ¶æ€</th>
                <th>å¿«é€’å•å·</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- å®¢æˆ·ç®¡ç†è§†å›¾ -->
      <div id="salesCustomersView" class="sales-sub-view hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:600">å®¢æˆ·ç®¡ç†</div>
          <div class="toolbar">
            <button class="btn" onclick="openCreateCustomer()">æ–°å¢å®¢æˆ·</button>
          </div>
        </div>
        
        <div class="panel">
          <table id="table-customers">
            <thead>
              <tr>
                <th>å®¢æˆ·ç¼–å·</th>
                <th>å®¢æˆ·åç§°</th>
                <th>å®¢æˆ·ç±»å‹</th>
                <th>è”ç³»äºº</th>
                <th>è”ç³»ç”µè¯</th>
                <th>ç»“ç®—æ–¹å¼</th>
                <th>ä¿¡ç”¨é¢åº¦</th>
                <th>åˆ›å»ºæ—¶é—´</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- é”€å”®æŠ¥ä»·è§†å›¾ -->
      <div id="salesQuotesView" class="sales-sub-view hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:600">é”€å”®æŠ¥ä»·</div>
          <div class="toolbar">
            <button class="btn" onclick="openCreateQuote()">æ–°å»ºæŠ¥ä»·</button>
          </div>
        </div>
        
        <div class="panel">
          <table id="table-quotes">
            <thead>
              <tr>
                <th>æŠ¥ä»·ç¼–å·</th>
                <th>å®¢æˆ·åç§°</th>
                <th>æŠ¥ä»·é‡‘é¢</th>
                <th>æœ‰æ•ˆæœŸ</th>
                <th>æŠ¥ä»·çŠ¶æ€</th>
                <th>åˆ›å»ºæ—¥æœŸ</th>
                <th>ä¸šåŠ¡å‘˜</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- å‘è´§ç®¡ç†è§†å›¾ -->
      <div id="salesDeliveriesView" class="sales-sub-view hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:600">å‘è´§ç®¡ç†</div>
          <div class="toolbar">
            <button class="btn" onclick="printDeliveryList()">æ‰“å°å‘è´§å•</button>
          </div>
        </div>
        
        <div class="panel">
          <table id="table-deliveries">
            <thead>
              <tr>
                <th>æ‰¹æ¬¡å·</th>
                <th>è®¢å•å·</th>
                <th>ä¸šåŠ¡å‘˜</th>
                <th>å›¾ç‰‡</th>
                <th>äº§å“SKU</th>
                <th>äº§å“åç§°</th>
                <th>å‘è´§æ•°é‡</th>
                <th>ç®±æ•°</th>
                <th>é‡é‡</th>
                <th>ç‰©æµå…¬å¸</th>
                <th>ç‰©æµå•å·</th>
                <th>ç‰©æµè´¹ç”¨</th>
                <th>çŠ¶æ€</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- é€€æ¢è´§è§†å›¾ -->
      <div id="salesReturnsView" class="sales-sub-view hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:600">é€€æ¢è´§ç®¡ç†</div>
          <div class="toolbar">
            <button class="btn" onclick="openCreateReturn()">æ–°å»ºé€€è´§å•</button>
          </div>
        </div>
        
        <div class="panel">
          <table id="table-returns">
            <thead>
              <tr>
                <th>é€€è´§ç¼–å·</th>
                <th>åŸè®¢å•å·</th>
                <th>å®¢æˆ·åç§°</th>
                <th>é€€è´§æ—¥æœŸ</th>
                <th>é€€è´§é‡‘é¢</th>
                <th>é€€è´§åŸå› </th>
                <th>å¤„ç†çŠ¶æ€</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- å‘ç¥¨ç”³è¯·è§†å›¾ -->
      <div id="salesInvoicesView" class="sales-sub-view hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:600">å‘ç¥¨ç”³è¯·</div>
          <div class="toolbar">
            <button class="btn" onclick="openCreateInvoice()">ç”³è¯·å‘ç¥¨</button>
          </div>
        </div>
        
        <div class="panel">
          <table id="table-invoices">
            <thead>
              <tr>
                <th>ç”³è¯·ç¼–å·</th>
                <th>è®¢å•å·</th>
                <th>å®¢æˆ·åç§°</th>
                <th>å‘ç¥¨é‡‘é¢</th>
                <th>ç”³è¯·æ—¥æœŸ</th>
                <th>å®¡æ‰¹çŠ¶æ€</th>
                <th>å¼€ç¥¨çŠ¶æ€</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Suppliers -->
    <section id="suppliersView" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="font-weight:600">ä¾›åº”å•†ç®¡ç†</div>
        <div class="toolbar">
          <button class="btn" onclick="openSupplierCreate()">æ–°å¢ä¾›åº”å•†</button>
        </div>
      </div>
      <div class="panel">
        <!-- æŸ¥è¯¢æ¡ä»¶ -->
        <div class="form-section" style="margin-bottom:16px;">
          <div class="section-title">æŸ¥è¯¢æ¡ä»¶</div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;">
            <input type="text" id="supplierSearchName" placeholder="ä¾›åº”å•†åç§°" style="padding:8px;border:1px solid var(--border-color);border-radius:6px;" onkeyup="filterSuppliers()">
            <input type="text" id="supplierSearchContact" placeholder="è”ç³»äºº" style="padding:8px;border:1px solid var(--border-color);border-radius:6px;" onkeyup="filterSuppliers()">
            <input type="text" id="supplierSearchPhone" placeholder="ç”µè¯" style="padding:8px;border:1px solid var(--border-color);border-radius:6px;" onkeyup="filterSuppliers()">
            <input type="text" id="supplierSearchCode" placeholder="ä¾›åº”å•†ä»£ç " style="padding:8px;border:1px solid var(--border-color);border-radius:6px;" onkeyup="filterSuppliers()">
          </div>
          <div style="margin-top:12px;">
            <button class="btn ghost" onclick="clearSupplierFilter()">æ¸…ç©ºç­›é€‰</button>
          </div>
        </div>
        <table id="table-suppliers">
          <thead>
            <tr>
              <th>ä¾›åº”å•†ä»£ç </th>
              <th>åç§°</th>
              <th>æ˜Ÿçº§</th>
              <th>è”ç³»äºº</th>
              <th>æ‰‹æœºå·</th>
              <th>ç»“ç®—æ–¹å¼</th>
              <th>åˆ›å»ºæ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <footer class="muted">æ¼”ç¤ºç‰ˆ Â· éç”Ÿäº§ç¯å¢ƒ Â· åŠŸèƒ½ä»…ä½œæ¼”ç¤º</footer>
  </main>
</div>

<!-- ä¾›åº”å•†è¡¨å•æ¨¡æ€æ¡† -->
<div id="supplierFormModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title" id="supplierFormTitle">ğŸ¢ æ–°å¢ä¾›åº”å•†</div>
    <button class="modal-close" onclick="closeSupplierFormModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description" id="supplierFormDescription">å¡«å†™ä¾›åº”å•†åŸºæœ¬ä¿¡æ¯</div>
    
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">åŸºæœ¬ä¿¡æ¯</div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
          <label for="supplierName" class="form-label">ä¾›åº”å•†åç§° <span class="required">*</span></label>
          <input type="text" id="supplierName" class="form-control" placeholder="è¯·è¾“å…¥ä¾›åº”å•†åç§°">
        </div>
        <div>
          <label for="supplierCode" class="form-label">ä¾›åº”å•†ä»£ç </label>
          <input type="text" id="supplierCode" class="form-control" placeholder="è‡ªåŠ¨ç”Ÿæˆï¼Œå¯ä¿®æ”¹">
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
        <div>
          <label for="supplierScale" class="form-label">ä¼ä¸šè§„æ¨¡</label>
          <select id="supplierScale" class="form-control">
            <option value="">è¯·é€‰æ‹©</option>
            <option value="å°å‹">å°å‹ä¼ä¸š</option>
            <option value="ä¸­å‹">ä¸­å‹ä¼ä¸š</option>
            <option value="å¤§å‹">å¤§å‹ä¼ä¸š</option>
            <option value="è·¨å›½">è·¨å›½ä¼ä¸š</option>
          </select>
        </div>
        <div>
          <label for="supplierCreditCode" class="form-label">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç </label>
          <input type="text" id="supplierCreditCode" class="form-control" placeholder="è¯·è¾“å…¥ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ">
        </div>
      </div>
    </div>
    
    <!-- è”ç³»ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">è”ç³»ä¿¡æ¯</div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
          <label for="supplierContact" class="form-label">è”ç³»äºº <span class="required">*</span></label>
          <input type="text" id="supplierContact" class="form-control" placeholder="è¯·è¾“å…¥è”ç³»äººå§“å">
        </div>
        <div>
          <label for="supplierPhone" class="form-label">æ‰‹æœºå· <span class="required">*</span></label>
          <input type="tel" id="supplierPhone" class="form-control" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç ">
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
        <div>
          <label for="supplierWechat" class="form-label">å¾®ä¿¡å·</label>
          <input type="text" id="supplierWechat" class="form-control" placeholder="è¯·è¾“å…¥å¾®ä¿¡å·ï¼ˆå¯é€‰ï¼‰">
        </div>
        <div>
          <label for="supplierCompanyPhone" class="form-label">å…¬å¸å›ºè¯</label>
          <input type="tel" id="supplierCompanyPhone" class="form-control" placeholder="è¯·è¾“å…¥å…¬å¸å›ºå®šç”µè¯">
        </div>
      </div>
      <div style="margin-top: 16px;">
        <label for="supplierEmail" class="form-label">ç”µå­é‚®ç®±</label>
        <input type="email" id="supplierEmail" class="form-control" placeholder="è¯·è¾“å…¥ç”µå­é‚®ç®±ï¼ˆå¯é€‰ï¼‰">
      </div>
      <div style="margin-top: 16px;">
        <label for="supplierAddress" class="form-label">åœ°å€</label>
        <textarea id="supplierAddress" class="form-control" rows="3" placeholder="è¯·è¾“å…¥ä¾›åº”å•†åœ°å€"></textarea>
      </div>
    </div>
    
    <!-- ä¸šåŠ¡ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">ä¸šåŠ¡ä¿¡æ¯</div>
      <div>
        <label for="supplierStarRating" class="form-label">åˆä½œæ˜Ÿçº§ <span class="required">*</span></label>
        <div style="margin-top: 8px;">
          <select id="supplierStarRating" class="form-control" onchange="updateStarRating()">
            <option value="0">è¯·é€‰æ‹©æ˜Ÿçº§</option>
            <option value="1">â­ ä¸€æ˜Ÿçº§</option>
            <option value="2">â­â­ äºŒæ˜Ÿçº§</option>
            <option value="3">â­â­â­ ä¸‰æ˜Ÿçº§</option>
            <option value="4">â­â­â­â­ å››æ˜Ÿçº§</option>
            <option value="5">â­â­â­â­â­ äº”æ˜Ÿçº§</option>
          </select>
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
        <div>
          <label for="supplierSettle" class="form-label">ç»“ç®—æ–¹å¼ <span class="required">*</span></label>
          <select id="supplierSettle" class="form-control">
            <option value="ç°ç»“">ç°ç»“</option>
            <option value="å‘¨ç»“">å‘¨ç»“</option>
            <option value="åŠæœˆç»“">åŠæœˆç»“</option>
            <option value="æœˆç»“" selected>æœˆç»“</option>
            <option value="å­£åº¦ç»“">å­£åº¦ç»“</option>
            <option value="å¹´ç»“">å¹´ç»“</option>
          </select>
        </div>
        <div>
          <label for="supplierCategory" class="form-label">ä¸»è¥ç±»åˆ«</label>
          <input type="text" id="supplierCategory" class="form-control" placeholder="å¦‚ï¼šç”µå­å…ƒå™¨ä»¶ã€æœºæ¢°è®¾å¤‡ã€åŸææ–™ç­‰">
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
        <div>
          <label for="supplierDeliveryMethod" class="form-label">é…é€æ–¹å¼</label>
          <select id="supplierDeliveryMethod" class="form-control">
            <option value="">è¯·é€‰æ‹©</option>
            <option value="è‡ªæ">è‡ªæ</option>
            <option value="é…é€">ä¾›åº”å•†é…é€</option>
            <option value="ç‰©æµ">ç¬¬ä¸‰æ–¹ç‰©æµ</option>
            <option value="å¿«é€’">å¿«é€’</option>
          </select>
        </div>
        <div>
          <label for="supplierTaxType" class="form-label">ç¨ç¥¨ç±»å‹</label>
          <select id="supplierTaxType" class="form-control">
            <option value="">è¯·é€‰æ‹©</option>
            <option value="æ™®ç¥¨">æ™®é€šå‘ç¥¨</option>
            <option value="ä¸“ç¥¨" selected>å¢å€¼ç¨ä¸“ç”¨å‘ç¥¨</option>
            <option value="æ— ç¥¨">ä¸å¼€ç¥¨</option>
          </select>
        </div>
      </div>
      <div style="margin-top: 16px;">
        <label for="supplierTaxRate" class="form-label">ç¨ç‚¹ï¼ˆ%ï¼‰</label>
        <input type="number" id="supplierTaxRate" class="form-control" placeholder="å¦‚ï¼š13" min="0" max="50" step="0.1">
      </div>
    </div>
    
    <!-- å¤‡æ³¨ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">å¤‡æ³¨ä¿¡æ¯</div>
      <div>
        <label for="supplierNotes" class="form-label">å¤‡æ³¨</label>
        <textarea id="supplierNotes" class="form-control" rows="3" placeholder="ä¾›åº”å•†çš„å¤‡æ³¨ä¿¡æ¯"></textarea>
      </div>
    </div>
    
    <!-- åœ°å€ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">åœ°å€ä¿¡æ¯</div>
      <div style="margin-bottom: 16px;">
        <label for="supplierOfficeAddress" class="form-label">åŠå…¬åœ°å€</label>
        <textarea id="supplierOfficeAddress" class="form-control" rows="2" placeholder="è¯·è¾“å…¥åŠå…¬åœ°å€"></textarea>
      </div>
      <div style="margin-bottom: 16px;">
        <label for="supplierProductionAddress" class="form-label">ç”Ÿäº§åœ°å€</label>
        <textarea id="supplierProductionAddress" class="form-control" rows="2" placeholder="è¯·è¾“å…¥ç”Ÿäº§åœ°å€"></textarea>
      </div>
      <div>
        <label for="supplierWarehouseAddress" class="form-label">ä»“åº“åœ°å€</label>
        <textarea id="supplierWarehouseAddress" class="form-control" rows="2" placeholder="è¯·è¾“å…¥ä»“åº“åœ°å€"></textarea>
      </div>
    </div>
    
    <!-- é™„ä»¶ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">é™„ä»¶ä¿¡æ¯</div>
      <div>
        <label for="supplierBusinessLicense" class="form-label">è¥ä¸šæ‰§ç…§</label>
        <div style="margin-top: 8px;">
          <input type="file" id="supplierBusinessLicense" accept=".pdf,.jpg,.png,.doc,.docx" class="form-control" style="border: none; padding: 8px;">
          <div class="small muted" style="margin-top: 4px;">æ”¯æŒ PDFã€JPGã€PNGã€DOC æ ¼å¼</div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeSupplierFormModal()">å–æ¶ˆ</button>
      <button class="btn primary" onclick="saveSupplier()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ä¾›åº”å•†è¯¦æƒ…æ¨¡æ€æ¡† -->

<!-- æ–°å¢äº§å“æ¨¡æ€æ¡† -->
<div id="addProductModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“¦ æ–°å¢äº§å“</div>
    <button class="modal-close" onclick="closeAddProductModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">å¡«å†™äº§å“åŸºæœ¬ä¿¡æ¯</div>
    
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">åŸºæœ¬ä¿¡æ¯</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">SKU *</label>
          <input type="text" id="newProductSku" class="form-input" placeholder="è¯·è¾“å…¥äº§å“SKU" required>
        </div>
        <div class="form-group">
          <label class="form-label">äº§å“åç§° *</label>
          <input type="text" id="newProductName" class="form-input" placeholder="è¯·è¾“å…¥äº§å“åç§°" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">å‹å·</label>
          <input type="text" id="newProductModel" class="form-input" placeholder="è¯·è¾“å…¥äº§å“å‹å·">
        </div>
        <div class="form-group">
          <label class="form-label">äº§å“ç±»å‹</label>
          <select id="newProductType" class="form-select">
            <option value="æ™®å“">æ™®å“</option>
            <option value="ç»„åˆ">ç»„åˆ</option>
            <option value="ç”Ÿäº§">ç”Ÿäº§</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">äº§å“ç±»ç›®</label>
          <select id="newProductCategory" class="form-select">
            <option value="ç”µå­">ç”µå­</option>
            <option value="å®¶å±…">å®¶å±…</option>
            <option value="æ¯å©´">æ¯å©´</option>
            <option value="æœè£…">æœè£…</option>
            <option value="é£Ÿå“">é£Ÿå“</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">äº§å“åˆ†ç±»</label>
          <select id="newProductClassification" class="form-select">
            <option value="æˆå“">æˆå“</option>
            <option value="åŠæˆå“">åŠæˆå“</option>
            <option value="ç‰©æ–™">ç‰©æ–™</option>
            <option value="åŒ…è£…è¾…æ–™">åŒ…è£…è¾…æ–™</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- åº“å­˜ä¸é‡‡è´­ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">åº“å­˜ä¸é‡‡è´­ä¿¡æ¯</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">åˆå§‹åº“å­˜</label>
          <input type="number" id="newProductStock" class="form-input" placeholder="0" value="0" min="0">
        </div>
        <div class="form-group">
          <label class="form-label">äº¤æœŸ</label>
          <input type="text" id="newProductDeliveryTime" class="form-input" placeholder="å¦‚ï¼š7å¤©">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ç®±è§„</label>
          <input type="text" id="newProductCarton" class="form-input" placeholder="å¦‚ï¼š100/ç®±">
        </div>
        <div class="form-group">
          <label class="form-label">äº§å“å›¾ç‰‡</label>
          <select id="newProductImage" class="form-select">
            <option value="mouse">é¼ æ ‡</option>
            <option value="keyboard">é”®ç›˜</option>
            <option value="monitor">æ˜¾ç¤ºå™¨</option>
            <option value="controller">æ¸¸æˆæ‰‹æŸ„</option>
            <option value="bottle">å¥¶ç“¶</option>
            <option value="chain">æ‰‹æœºé“¾</option>
            <option value="gamepad">æ¸¸æˆæ‰‹æŸ„</option>
            <option value="cable">æ•°æ®çº¿</option>
            <option value="headphones">è€³æœº</option>
            <option value="camera">æ‘„åƒå¤´</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- é‡‡è´­ä¸æˆæœ¬ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">é‡‡è´­ä¸æˆæœ¬ä¿¡æ¯</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">é‡‡è´­å‘˜</label>
          <select id="newProductPurchaser" class="form-select">
            <option value="é‡‡è´­å‘˜å¼ ">é‡‡è´­å‘˜å¼ </option>
            <option value="é‡‡è´­å‘˜ç‹">é‡‡è´­å‘˜ç‹</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">æˆæœ¬ä»·æ ¼</label>
          <input type="number" id="newProductCost" class="form-input" placeholder="0.00" step="0.01" min="0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group full-width">
          <label class="form-label">å¤‡æ³¨</label>
          <textarea id="newProductNotes" class="form-textarea" placeholder="è¯·è¾“å…¥äº§å“å¤‡æ³¨ä¿¡æ¯" rows="3"></textarea>
        </div>
      </div>
    </div>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-color);">
      <button class="btn ghost" onclick="closeAddProductModal()">å–æ¶ˆ</button>
      <button class="btn primary" onclick="saveNewProduct()">ä¿å­˜äº§å“</button>
    </div>
  </div>
</div>

<!-- é‡‡è´­å•åˆ›å»ºæ¨¡æ€æ¡† -->
<div id="createPOModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“ åˆ›å»ºé‡‡è´­è®¡åˆ’</div>
    <button class="modal-close" onclick="closeCreatePO()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">åˆ›å»ºæ–°çš„é‡‡è´­è®¡åˆ’ï¼Œå…ˆæ”¶é›†ä¾›åº”å•†æŠ¥ä»·ï¼Œå†æäº¤å®¡æ‰¹</div>
    
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">åŸºæœ¬ä¿¡æ¯</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ä¾›åº”å•†</label>
          <select id="poSupplier" class="form-select">
            <option value="">è¯·é€‰æ‹©ä¾›åº”å•†</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">é¢„è®¡åˆ°è´§æ—¥æœŸ</label>
          <input type="date" id="poExpectedDate" class="form-input" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">å¤‡æ³¨è¯´æ˜</label>
          <input type="text" id="poNotes" class="form-input" placeholder="é‡‡è´­è®¡åˆ’çš„ç‰¹æ®Šè¦æ±‚æˆ–è¯´æ˜" />
        </div>
      </div>
    </div>
    
    <!-- é‡‡è´­é¡¹ç›® -->
    <div class="form-section">
      <div class="section-title">é‡‡è´­é¡¹ç›®</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">é€‰æ‹©äº§å“</label>
          <select id="poProduct" class="form-select">
            <option value="">è¯·é€‰æ‹©äº§å“</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">é‡‡è´­æ•°é‡</label>
          <input type="number" id="poQty" class="form-input" placeholder="è¾“å…¥é‡‡è´­æ•°é‡" min="1" />
        </div>
        <div class="form-group" style="display:flex; align-items:end;">
          <button class="btn" onclick="addPoItem()" style="height:40px;">â• æ·»åŠ </button>
        </div>
      </div>
      
      <!-- é‡‡è´­é¡¹ç›®åˆ—è¡¨ -->
      <div id="poItems" class="po-items">
        <div style="text-align: center; color: var(--muted); padding: 20px;">ğŸ“ æš‚æ— é‡‡è´­é¡¹ç›®ï¼Œè¯·æ·»åŠ é‡‡è´­é¡¹</div>
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="total-amount">
      æ€»è®¡ï¼š<span class="amount" id="poTotal">Â¥0.00</span>
    </div>
    <div class="form-actions">
      <button class="btn ghost" onclick="closeCreatePO()">å–æ¶ˆ</button>
      <button class="btn" onclick="savePO()">åˆ›å»ºè‰ç¨¿è®¡åˆ’</button>
    </div>
  </div>
</div>

<!-- ä»“åº“å‘è´§æ¨¡æ€æ¡† -->
<div id="warehouseDeliveryModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸšš å¡«å†™ç‰©æµä¿¡æ¯</div>
    <button class="modal-close" onclick="closeWarehouseDeliveryModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">é‡‡è´­å•å·</label>
        <input id="warehousePOId" class="form-input" readonly />
      </div>
      <div class="form-group">
        <label class="form-label">ä¾›åº”å•†</label>
        <input id="warehouseSupplier" class="form-input" readonly />
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">æ€»æ•°é‡</label>
        <input id="warehouseTotalQty" class="form-input" readonly />
      </div>
      <div class="form-group">
        <label class="form-label">ç‰©æµå…¬å¸</label>
        <select id="logisticsCompany" class="form-select">
          <option value="">è¯·é€‰æ‹©ç‰©æµå…¬å¸</option>
          <option value="é¡ºä¸°å¿«é€’">é¡ºä¸°å¿«é€’</option>
          <option value="åœ†é€šå¿«é€’">åœ†é€šå¿«é€’</option>
          <option value="ä¸­é€šå¿«é€’">ä¸­é€šå¿«é€’</option>
          <option value="ç”³é€šå¿«é€’">ç”³é€šå¿«é€’</option>
          <option value="éŸµè¾¾å¿«é€’">éŸµè¾¾å¿«é€’</option>
          <option value="äº¬ä¸œç‰©æµ">äº¬ä¸œç‰©æµ</option>
          <option value="å¾·é‚¦ç‰©æµ">å¾·é‚¦ç‰©æµ</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">ç‰©æµå•å·</label>
        <input id="logisticsNumber" class="form-input" placeholder="è¯·è¾“å…¥ç‰©æµå•å·" />
      </div>
      <div class="form-group">
        <label class="form-label">ç‰©æµè´¹ç”¨ (Â¥)</label>
        <input id="logisticsCost" class="form-input" type="number" placeholder="0.00" />
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">é¢„è®¡é€è¾¾æ—¥æœŸ</label>
        <input id="estimatedDelivery" class="form-input" type="date" />
      </div>
      <div class="form-group">
        <label class="form-label">å‘è´§å¤‡æ³¨</label>
        <textarea id="deliveryNotes" class="form-textarea" rows="3" placeholder="è¯·è¾“å…¥å‘è´§å¤‡æ³¨ä¿¡æ¯"></textarea>
      </div>
    </div>
    
    <div class="form-actions">
      <button class="btn ghost" onclick="closeWarehouseDeliveryModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="saveWarehouseDelivery()">ä¿å­˜å‘è´§ä¿¡æ¯</button>
    </div>
  </div>
</div>

<script>
  function filterPOByStatus(status) {
    const table = document.getElementById('table-purchase');
    const tbody = table.querySelector('tbody');
    const rows = tbody.querySelectorAll('tr');
    
    rows.forEach(row => {
      if (status === 'all') {
        row.style.display = '';
      } else {
        const statusCell = row.querySelector('td:nth-child(5)');
        if (statusCell && statusCell.textContent.includes(status)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      }
    });
  }
  
  function generateDeliverySlip(poId) {
    const po = data.pos.find(p => p.id === poId);
    if (!po) return;
    
    const slipId = new Date().toISOString().slice(0,10).replace(/-/g,'') + 
                  String(Math.floor(Math.random() * 1000)).padStart(3, '0');
    const queryCode = String(Math.floor(Math.random() * 10000)).padStart(4, '0');
    
    showToast(`å‘è´§å•å·²ç”Ÿæˆ\nå•å·ï¼š${slipId}\næŸ¥è¯¢ç ï¼š${queryCode}\nä¾›åº”å•†ï¼š${po.supplier}`, 'success');
  }
  
  function approvePO(poId, action) {
    const po = data.pos.find(p => p.id === poId);
    if (!po) return;
    
    if (action === 'approve') {
      po.status = 'å¾…é‡‡è´­';
      showToast('é‡‡è´­å•å·²å®¡æ‰¹é€šè¿‡', 'success');
    } else if (action === 'reject') {
      const reason = prompt('è¯·è¾“å…¥é©³å›åŸå› ï¼š');
      if (reason) {
        po.status = 'å·²é©³å›';
        po.rejectReason = reason;
        showToast('é‡‡è´­å•å·²é©³å›', 'error');
      }
    }
    renderPurchaseOrders();
  }
  
  function uploadAttachment(poId) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.pdf,.jpg,.png';
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        const po = data.pos.find(p => p.id === poId);
        if (po) {
          if (!po.attachments) po.attachments = [];
          po.attachments.push({
            name: file.name,
            type: file.type,
            uploadTime: new Date().toLocaleString()
          });
          showToast(`æ–‡ä»¶ ${file.name} å·²ä¸Šä¼ `, 'success');
        }
      }
    };
    input.click();
  }
  
  function renderPurchaseOrders() {
    const table = document.getElementById('table-purchase');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    const filteredPOs = data.pos.filter(po => {
      // åªæ˜¾ç¤ºé‡‡è´­ç®¡ç†ç›¸å…³çš„é‡‡è´­å•ï¼Œè¿‡æ»¤æ‰Dashboardçš„ç¤ºä¾‹æ•°æ®
      return po.applicant || po.lines;
    });
    
    filteredPOs.forEach(po => {
      const tr = document.createElement('tr');
      let actionButtons = `<button class="btn ghost" onclick="viewPODetail('${po.id}')">è¯¦æƒ…</button>`;
      
      // è‰ç¨¿çŠ¶æ€ï¼šæ”¶é›†æŠ¥ä»·å’Œæäº¤å®¡æ‰¹
      if (po.status === 'è‰ç¨¿') {
        actionButtons += ` <button class="btn ghost" onclick="collectQuotesForPO('${po.id}')">æ”¶é›†æŠ¥ä»·</button>`;
        actionButtons += ` <button class="btn" onclick="submitPOForApproval('${po.id}')">æäº¤å®¡æ‰¹</button>`;
      }
      
      // å¾…å®¡æ ¸çŠ¶æ€ï¼šè€æ¿å®¡æ‰¹
      if (po.status === 'å¾…å®¡æ ¸' && hasPermission('approve_po')) {
        actionButtons += ` <button class="btn" onclick="approvePO('${po.id}')">æ‰¹å‡†</button>`;
        actionButtons += ` <button class="btn ghost" style="background:var(--danger);color:white" onclick="rejectPO('${po.id}')">é©³å›</button>`;
      }
      
      // å·²é©³å›çŠ¶æ€ï¼šé‡‡è´­å‘˜å¯é‡æ–°æäº¤
      if (po.status === 'å·²é©³å›' && !hasPermission('approve_po')) {
        actionButtons += ` <button class="btn" onclick="resubmitPO('${po.id}')">é‡æ–°æäº¤</button>`;
      }
      
      if (po.status === 'å¾…é‡‡è´­') {
        if (!po.convertedToOrder) {
          actionButtons += ` <button class="btn" onclick="convertPOToPurchaseOrder('${po.id}')">è½¬ä¸ºé‡‡è´­è®¢å•</button>`;
          actionButtons += ` <button class="btn ghost" onclick="generateContract('${po.id}')">ç”ŸæˆåˆåŒ</button>`;
          actionButtons += ` <button class="btn ghost" onclick="manageQualityStandards('${po.id}')">è´¨æ£€æ ‡å‡†</button>`;
          actionButtons += ` <button class="btn ghost" onclick="uploadAttachment('${po.id}')">ä¸Šä¼ é™„ä»¶</button>`;
        } else {
          // å·²è½¬ä¸ºé‡‡è´­è®¢å•ï¼Œæ˜¾ç¤ºä¸å¯ç¼–è¾‘çŠ¶æ€
          actionButtons += ` <span style="color: #10b981; font-weight: 500;">âœ… å·²è½¬ä¸ºé‡‡è´­è®¢å•</span>`;
          actionButtons += ` <button class="btn ghost" onclick="viewConvertedPurchaseOrder('${po.id}')">æŸ¥çœ‹é‡‡è´­è®¢å•</button>`;
        }
      }
      
      if (po.status === 'ä»“åº“å¾…å‘è´§') {
        actionButtons += ` <button class="btn ghost" onclick="printWarehouseDeliverySlip('${po.id}')">æ‰“å°å‘è´§å•</button>`;
        actionButtons += ` <button class="btn" onclick="openWarehouseDeliveryModal('${po.id}')">å¡«å†™ç‰©æµä¿¡æ¯</button>`;
      }
      
      if (po.status === 'å·²å‘è´§') {
        actionButtons += ` <button class="btn ghost" onclick="viewLogisticsInfo('${po.id}')">æŸ¥çœ‹ç‰©æµ</button>`;
      }
      
            
      tr.innerHTML = `<td>${po.id}</td><td>${po.supplier}</td><td>${po.applicant || '-'}</td><td>Â¥${po.total}</td><td>${po.status}${po.convertedToOrder ? '<span style="color:#10b981;font-size:12px;margin-left:8px;">âœ… å·²è½¬è®¢å•</span>' : ''}</td><td>${po.approver || '-'}</td><td>${po.applyDate || '-'}</td><td>${actionButtons}</td>`;
      tbody.appendChild(tr);
    });
  }
  
  function completePO(poId) {
    const po = data.pos.find(p => p.id === poId);
    if (po) {
      po.status = 'å·²å®Œæˆ';
      // å¢åŠ åº“å­˜
      po.lines.forEach(line => {
        const product = data.products.find(p => p.sku === line.sku);
        if (product) {
          product.stock += line.qty;
        }
      });
      renderPurchaseOrders();
      renderAll();
      showToast('é‡‡è´­å•å·²ç¡®è®¤æ”¶è´§å®Œæˆï¼Œåº“å­˜å·²æ›´æ–°', 'success');
    }
  }
  
  // æŸ¥çœ‹å·²è½¬æ¢çš„é‡‡è´­è®¢å•
  function viewConvertedPurchaseOrder(poId) {
    const po = data.pos.find(p => p.id === poId);
    if (!po || !po.convertedToOrder) return;
    
    // æŸ¥æ‰¾å¯¹åº”çš„é‡‡è´­è®¢å•
    const purchaseOrder = data.purchaseOrders.find(o => o.sourcePOId === poId);
    if (!purchaseOrder) {
      showToast('æ‰¾ä¸åˆ°å¯¹åº”çš„é‡‡è´­è®¢å•', 'error');
      return;
    }
    
    // å…³é—­é‡‡è´­è®¡åˆ’è¯¦æƒ…
    closePODetail();
    
    // æ‰“å¼€é‡‡è´­è®¢å•è¯¦æƒ…
    setTimeout(() => {
      openPurchaseOrderDetail(purchaseOrder.id);
    }, 300);
  }
  
  // æŸ¥çœ‹ç‰©æµä¿¡æ¯
  function viewLogisticsInfo(poId) {
    const po = data.pos.find(p => p.id === poId);
    if (!po) return;
    
    const modal = document.getElementById('poDetailModal');
    const content = document.getElementById('poDetailContent');
    
    if (!modal || !content) return;
    
    content.innerHTML = `
      <div class="po-detail-section">
        <div class="po-detail-title">ğŸ“¦ é‡‡è´­è®¢å• ${po.id}</div>
        <div class="po-detail-row"><span class="po-detail-label">ä¾›åº”å•†ï¼š</span><span>${po.supplier}</span></div>
        <div class="po-detail-row"><span class="po-detail-label">çŠ¶æ€ï¼š</span><span style="color: #3b82f6;">${po.status}</span></div>
        <div class="po-detail-row"><span class="po-detail-label">æ€»é‡‘é¢ï¼š</span><span>Â¥${po.total}</span></div>
        
        <div class="po-detail-subtitle">ğŸšš ç‰©æµä¿¡æ¯</div>
        <div class="po-detail-row"><span class="po-detail-label">ç‰©æµå…¬å¸ï¼š</span><span>${po.logisticsCompany || 'æœªå¡«å†™'}</span></div>
        <div class="po-detail-row"><span class="po-detail-label">ç‰©æµå•å·ï¼š</span><span>${po.logisticsTrackingNumber || 'æœªå¡«å†™'}</span></div>
        <div class="po-detail-row"><span class="po-detail-label">ç‰©æµè´¹ç”¨ï¼š</span><span>Â¥${po.logisticsCost || '0.00'}</span></div>
        <div class="po-detail-row"><span class="po-detail-label">é¢„è®¡é€è¾¾ï¼š</span><span>${po.estimatedDelivery || 'æœªè®¾ç½®'}</span></div>
        <div class="po-detail-row"><span class="po-detail-label">å‘è´§å¤‡æ³¨ï¼š</span><span>${po.deliveryNotes || 'æ— '}</span></div>
        <div class="po-detail-row"><span class="po-detail-label">å‘è´§å¤„ç†äººï¼š</span><span>${po.warehouseProcessor || 'æœªçŸ¥'}</span></div>
        <div class="po-detail-row"><span class="po-detail-label">å‘è´§æ—¥æœŸï¼š</span><span>${po.warehouseProcessDate || 'æœªçŸ¥'}</span></div>
        
        <div class="po-detail-subtitle">ğŸ“‹ äº§å“æ˜ç»†</div>
        <table style="width:100%; border-collapse: collapse; margin-top:8px;">
          <thead>
            <tr style="background: #f9fafb;">
              <th style="padding:8px; text-align:left; border:1px solid #e5e7eb;">SKU</th>
              <th style="padding:8px; text-align:left; border:1px solid #e5e7eb;">äº§å“åç§°</th>
              <th style="padding:8px; text-align:right; border:1px solid #e5e7eb;">æ•°é‡</th>
              <th style="padding:8px; text-align:right; border:1px solid #e5e7eb;">å•ä»·</th>
            </tr>
          </thead>
          <tbody>
            ${po.lines.map(line => {
              const product = data.products.find(p => p.sku === line.sku);
              return `
                <tr>
                  <td style="padding:8px; border:1px solid #e5e7eb;">${line.sku}</td>
                  <td style="padding:8px; border:1px solid #e5e7eb;">${product ? product.name : line.sku}</td>
                  <td style="padding:8px; text-align:right; border:1px solid #e5e7eb;">${line.qty}</td>
                  <td style="padding:8px; text-align:right; border:1px solid #e5e7eb;">Â¥${line.price}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    `;
    
    modal.classList.remove('hidden');
    modal.style.display = '';
  }
  
  function showToast(message, type = 'info') {
    // åˆ›å»ºtoastå…ƒç´ 
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    
    // æ·»åŠ æ ·å¼
    toast.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 10000;
      font-size: 14px;
      font-weight: 500;
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s ease;
    `;
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(toast);
    
    // æ˜¾ç¤ºåŠ¨ç”»
    setTimeout(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    }, 100);
    
    // è‡ªåŠ¨éšè—
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-20px)';
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }, 3000);
  }
  
  function sortByCreateDate() {
    // æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
    data.pos.sort((a, b) => {
      const dateA = new Date(a.applyDate || '2000-01-01');
      const dateB = new Date(b.applyDate || '2000-01-01');
      return dateB - dateA;
    });
    renderPurchaseOrders();
  }
  
  // ä¾›åº”å•†æŠ¥ä»·åŠŸèƒ½
  function openSupplierQuote() {
    const modal = document.getElementById('supplierQuoteModal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = '';
      
      // å¡«å……ä¾›åº”å•†åˆ—è¡¨
      const supSel = document.getElementById('quoteSupplier');
      if (supSel) {
        supSel.innerHTML = '<option value="">è¯·é€‰æ‹©ä¾›åº”å•†</option>';
        data.suppliers.forEach(s => {
          supSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        });
      }
      
      // å¡«å……äº§å“åˆ—è¡¨
      const prodSel = document.getElementById('quoteProduct');
      if (prodSel) {
        prodSel.innerHTML = '<option value="">è¯·é€‰æ‹©äº§å“</option>';
        data.products.forEach(p => {
          prodSel.innerHTML += `<option value="${p.sku}">${p.sku} Â· ${p.name}</option>`;
        });
      }
    }
  }
  
  function closeSupplierQuote() {
    const modal = document.getElementById('supplierQuoteModal');
    if (modal) {
      modal.classList.add('hidden');
        modal.style.display = 'none';
      // æ¸…ç†ç¼–è¾‘çŠ¶æ€
      modal.removeAttribute('data-edit-index');
      quoteDraft = [];
      window.currentPOId = null; // æ¸…ç†å…³è”çš„é‡‡è´­è®¡åˆ’ID
    }
  }
  
  let quoteDraft = [];
  function addQuote() {
    const supplier = document.getElementById('quoteSupplier').value;
    const product = document.getElementById('quoteProduct').value;
    const price = document.getElementById('quotePrice').value;
    const minQty = document.getElementById('quoteMinQty').value;
    
    if (!supplier || !product || !price || !minQty) {
      showToast('è¯·å¡«å†™å®Œæ•´çš„æŠ¥ä»·ä¿¡æ¯', 'error');
      return;
    }
    
    const prod = data.products.find(p => p.sku === product);
    quoteDraft.push({
      supplier,
      product,
      productName: prod.name,
      price: parseFloat(price),
      minQty: parseInt(minQty),
      createDate: new Date().toISOString().split('T')[0]
    });
    
    renderQuoteList();
    // æ¸…ç©ºè¡¨å•
    document.getElementById('quotePrice').value = '';
    document.getElementById('quoteMinQty').value = '';
  }
  
  function renderQuoteList() {
    const div = document.getElementById('quoteList');
    if (!div) return;
    
    if (quoteDraft.length === 0) {
      div.innerHTML = '<div class="small muted">æš‚æ— æŠ¥ä»·æ•°æ®</div>';
      return;
    }
    
    div.innerHTML = '';
    quoteDraft.forEach((quote, idx) => {
      const item = document.createElement('div');
      item.className = 'po-item';
      item.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong>${quote.productName}</strong>
            <div class="small muted">Â¥${quote.price} / æœ€å°èµ·è®¢é‡: ${quote.minQty}</div>
          </div>
          <button class="btn ghost" onclick="removeQuote(${idx})" style="background:var(--danger);color:white">åˆ é™¤</button>
        </div>
      `;
      div.appendChild(item);
    });
  }
  
  function removeQuote(idx) {
    quoteDraft.splice(idx, 1);
    renderQuoteList();
  }
  
  function saveQuotes() {
    if (quoteDraft.length === 0) {
      showToast('è¯·è‡³å°‘æ·»åŠ ä¸€æ¡æŠ¥ä»·', 'error');
      return;
    }
    
    // ä¿å­˜åˆ°æ•°æ®ä¸­ï¼ˆå®é™…åº”ç”¨ä¸­ä¼šå‘é€åˆ°æœåŠ¡å™¨ï¼‰
    if (!data.supplierQuotes) data.supplierQuotes = [];
    data.supplierQuotes.push(...quoteDraft);
    
    quoteDraft = [];
    closeSupplierQuote();
    showToast('æŠ¥ä»·å·²ä¿å­˜', 'success');
  }
  
  // é‡‡è´­è®¢å•åŠŸèƒ½
  function openPurchaseOrder() {
    const modal = document.getElementById('purchaseOrderModal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = '';
      
      // å¡«å……å·²å®¡æ‰¹çš„é‡‡è´­è®¡åˆ’
      const planSel = document.getElementById('poPlanSelect');
      if (planSel) {
        planSel.innerHTML = '<option value="">è¯·é€‰æ‹©å·²å®¡æ‰¹çš„é‡‡è´­è®¡åˆ’</option>';
        const approvedPOs = data.pos.filter(po => po.status === 'å¾…é‡‡è´­');
        approvedPOs.forEach(po => {
          planSel.innerHTML += `<option value="${po.id}">${po.id} - ${po.supplier} - Â¥${po.total}</option>`;
        });
      }
    }
  }
  
  function closePurchaseOrder() {
    const modal = document.getElementById('purchaseOrderModal');
    if (modal) {
      modal.classList.add('hidden');
        modal.style.display = 'none';
    }
  }
  
  function loadPOPlan() {
    const planId = document.getElementById('poPlanSelect').value;
    const infoDiv = document.getElementById('poOrderInfo');
    
    if (!planId) {
      infoDiv.innerHTML = '<div class="small muted">è¯·å…ˆé€‰æ‹©é‡‡è´­è®¡åˆ’</div>';
      return;
    }
    
    const po = data.pos.find(p => p.id === planId);
    if (!po) return;
    
    infoDiv.innerHTML = `
      <div style="margin-bottom:12px"><strong>é‡‡è´­è®¡åˆ’ï¼š${po.id}</strong></div>
      <div style="margin-bottom:8px">ä¾›åº”å•†ï¼š${po.supplier}</div>
      <div style="margin-bottom:12px">
        <strong>é‡‡è´­æ˜ç»†ï¼š</strong>
        ${po.lines.map(line => {
          const prod = data.products.find(p => p.sku === line.sku);
          return `<div style="margin:4px 0">${prod.name} x ${line.qty} = Â¥${(line.qty * line.price).toFixed(2)}</div>`;
        }).join('')}
      </div>
      <div><strong>æ€»è®¡ï¼šÂ¥${po.total}</strong></div>
    `;
  }
  
  function createPurchaseOrder() {
    const planId = document.getElementById('poPlanSelect').value;
    if (!planId) {
      showToast('è¯·é€‰æ‹©é‡‡è´­è®¡åˆ’', 'error');
      return;
    }
    
    const po = data.pos.find(p => p.id === planId);
    if (!po) return;
    
    // åˆ›å»ºé‡‡è´­è®¢å•ï¼ˆå®é™…åº”ç”¨ä¸­ä¼šå¤åˆ¶é‡‡è´­è®¡åˆ’æ•°æ®ï¼‰
    const order = {
      ...po,
      id: 'ORD' + po.id.replace('PO', ''),
      type: 'è®¢å•',
      orderDate: new Date().toISOString().split('T')[0],
      status: 'å¾…æ”¶è´§'
    };
    
    data.pos.push(order);
    closePurchaseOrder();
    renderPurchaseOrders();
    renderAll();
    showToast('é‡‡è´­è®¢å•å·²åˆ›å»º', 'success');
  }
  
  // é€€è´§å•åŠŸèƒ½
  function openReturnOrder() {
    const modal = document.getElementById('returnOrderModal');
    if (modal) {
      modal.classList.remove('hidden');
      modal.style.display = '';
      
      // å¡«å……ä¾›åº”å•†åˆ—è¡¨
      const supSel = document.getElementById('returnSupplier');
      if (supSel) {
        supSel.innerHTML = '<option value="">è¯·é€‰æ‹©ä¾›åº”å•†</option>';
        data.suppliers.forEach(s => {
          supSel.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        });
      }
    }
  }
  
  function closeReturnOrder() {
    const modal = document.getElementById('returnOrderModal');
    if (modal) {
      modal.classList.add('hidden');
        modal.style.display = 'none';
    }
  }
  
  function createReturnOrder() {
    const supplier = document.getElementById('returnSupplier').value;
    const reason = document.getElementById('returnReason').value;
    
    if (!supplier) {
      showToast('è¯·é€‰æ‹©ä¾›åº”å•†', 'error');
      return;
    }
    
    const returnOrder = {
      id: 'RT' + (Math.floor(Math.random()*900000)+100000),
      supplier: data.suppliers.find(s => s.id === supplier)?.name || supplier,
      reason,
      status: 'å¾…å®¡æ ¸',
      applicant: currentUser,
      applyDate: new Date().toISOString().split('T')[0],
      items: [] // å®é™…åº”ç”¨ä¸­ä¼šæ·»åŠ é€€è´§äº§å“æ˜ç»†
    };
    
    data.returns = data.returns || [];
    data.returns.push(returnOrder);
    
    closeReturnOrder();
    showToast('é€€è´§å•å·²æäº¤ï¼Œç­‰å¾…å®¡æ‰¹', 'info');
  }
</script>

<!-- ä¾›åº”å•†é€‰æ‹©ç†ç”±è¾“å…¥æ¨¡æ€æ¡† -->
<div id="quoteReasonModal" class="modal-form hidden" style="display: none; z-index: 9998;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“ é€‰æ‹©ä¾›åº”å•†æŠ¥ä»·åŸå› </div>
    <button class="modal-close" onclick="closeQuoteReasonModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div style="margin-bottom: 16px;">
      <div style="font-weight: 600; margin-bottom: 8px;">ä¾›åº”å•†ä¿¡æ¯ï¼š</div>
      <div id="quoteReasonSupplierInfo" style="padding: 8px; background: var(--hover-bg); border-radius: 4px; font-size: 14px;"></div>
    </div>
    
    <div style="margin-bottom: 16px;">
      <label for="quoteReasonInput" class="form-label">é€‰æ‹©åŸå›  <span class="required">*</span></label>
      <textarea 
        id="quoteReasonInput" 
        class="form-control" 
        rows="4" 
        placeholder="è¯·è¯´æ˜é€‰æ‹©æ­¤ä¾›åº”å•†æŠ¥ä»·çš„åŸå› ï¼Œä¾‹å¦‚ï¼šä»·æ ¼æœ€ä¼˜ã€è´¨é‡å¯é ã€äº¤æœŸçŸ­ã€é•¿æœŸåˆä½œç­‰"
        style="resize: vertical; min-height: 80px;"
      ></textarea>
    </div>
    
    <div style="font-size: 12px; color: #666; margin-top: 8px;">
      ğŸ’¡ æç¤ºï¼šè¯·è¯¦ç»†è¯´æ˜é€‰æ‹©åŸå› ï¼Œä¾¿äºåç»­å®¡æ ¸å’Œè¿½æº¯<br>
      âŒ¨ï¸ å¿«æ·é”®ï¼šESCå–æ¶ˆï¼ŒCtrl+Enterç¡®è®¤
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeQuoteReasonModal()">å–æ¶ˆ</button>
      <button class="btn primary" onclick="confirmQuoteReason()">ç¡®è®¤é€‰æ‹©</button>
    </div>
  </div>
</div>

<!-- ä¾›åº”å•†æŠ¥ä»·æ¨¡æ€æ¡† -->
<div id="supplierQuoteModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ’° ä¾›åº”å•†æŠ¥ä»·ç®¡ç†</div>
    <button class="modal-close" onclick="closeSupplierQuote()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">ç®¡ç†ä¾›åº”å•†äº§å“æŠ¥ä»·ä¿¡æ¯</div>
    
    <!-- ä¾›åº”å•†é€‰æ‹© -->
    <div class="form-section">
      <div class="section-title">é€‰æ‹©ä¾›åº”å•†</div>
      <div style="margin-bottom:16px">
        <select id="quoteSupplier" style="width:100%;padding:8px;border:1px solid var(--border-color);border-radius:6px;">
          <option value="">è¯·é€‰æ‹©ä¾›åº”å•†</option>
        </select>
      </div>
    </div>
    
    <!-- äº§å“é€‰æ‹©å’ŒæŠ¥ä»· -->
    <div class="form-section">
      <div class="section-title">äº§å“æŠ¥ä»·</div>
      <div style="display:flex;gap:8px;margin-bottom:16px">
        <select id="quoteProduct" style="flex:1;padding:8px;border:1px solid var(--border-color);border-radius:6px;">
          <option value="">è¯·é€‰æ‹©äº§å“</option>
        </select>
        <input type="number" id="quotePrice" placeholder="æŠ¥ä»·" style="width:120px;padding:8px;border:1px solid var(--border-color);border-radius:6px;">
        <input type="number" id="quoteMinQty" placeholder="æœ€å°èµ·è®¢é‡" style="width:120px;padding:8px;border:1px solid var(--border-color);border-radius:6px;">
        <button class="btn" onclick="addQuote()">æ·»åŠ </button>
      </div>
    </div>
    
    <!-- æŠ¥ä»·åˆ—è¡¨ -->
    <div class="form-section">
      <div class="section-title">å½“å‰æŠ¥ä»·åˆ—è¡¨</div>
      <div id="quoteList" style="max-height:300px;overflow-y:auto;">
        <div class="small muted">æš‚æ— æŠ¥ä»·æ•°æ®</div>
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeSupplierQuote()">å…³é—­</button>
      <button class="btn" onclick="saveQuotes()">ä¿å­˜æŠ¥ä»·</button>
    </div>
  </div>
</div>

<!-- å‘è´§å•ç®¡ç†æ¨¡æ€æ¡† -->
<div id="deliverySlipModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“¦ å‘è´§å•ç®¡ç†</div>
    <button class="modal-close" onclick="closeDeliverySlipModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <!-- å‘è´§å•åŸºæœ¬ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">å‘è´§å•åŸºæœ¬ä¿¡æ¯</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px;">
        <div><strong>å‘è´§å•å·ï¼š</strong><span id="deliverySlipId"></span></div>
        <div><strong>æŸ¥è¯¢ç ï¼š</strong><span id="deliverySlipQueryCode"></span></div>
        <div><strong>åˆ›å»ºæ—¥æœŸï¼š</strong><span id="deliverySlipDate"></span></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
        <div><strong>ä¾›åº”å•†ï¼š</strong><span id="deliverySlipSupplier"></span></div>
        <div><strong>æ”¶è´§åœ°å€ï¼š</strong><span id="deliverySlipRecipient"></span></div>
      </div>
    </div>
    
    <!-- é€è´§å•æ˜ç»† -->
    <div class="form-section">
      <div class="section-title">é€è´§å•æ˜ç»†</div>
      <table style="width:100%;border-collapse:collapse;margin-bottom:16px;">
        <thead>
          <tr style="background:var(--hover-bg);">
            <th style="padding:8px;border:1px solid var(--border-color);">å›¾ç‰‡</th>
            <th style="padding:8px;border:1px solid var(--border-color);">SKU</th>
            <th style="padding:8px;border:1px solid var(--border-color);">å“å</th>
            <th style="padding:8px;border:1px solid var(--border-color);">é‡‡è´­æ•°</th>
            <th style="padding:8px;border:1px solid var(--border-color);">é€è´§æ•°</th>
          </tr>
        </thead>
        <tbody id="deliverySlipDetails">
          <!-- åŠ¨æ€å¡«å……é€è´§å•æ˜ç»† -->
        </tbody>
      </table>
    </div>
    
    <!-- ç•™ç™½åŒºåŸŸ -->
    <div class="form-section">
      <div class="section-title">ç›–ç« åŒºåŸŸ</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:32px;padding:32px 0;">
        <div style="text-align:center;">
          <div style="border-bottom:1px solid #333;padding-bottom:8px;margin-bottom:4px;">
            <strong>é€è´§å•ä½åŠç»æ‰‹äººï¼ˆç›–ç« ï¼‰</strong>
          </div>
          <div style="height:60px;"></div>
        </div>
        <div style="text-align:center;">
          <div style="border-bottom:1px solid #333;padding-bottom:8px;margin-bottom:4px;">
            <strong>æ”¶è´§å•ä½åŠç»æ‰‹äººï¼ˆç›–ç« ï¼‰</strong>
          </div>
          <div style="height:60px;"></div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeDeliverySlipModal()">å…³é—­</button>
      <button class="btn ghost" onclick="previewDeliverySlip()">é¢„è§ˆ</button>
      <button class="btn" onclick="printDeliverySlip()">æ‰“å°å‘è´§å•</button>
      <button class="btn ghost" onclick="downloadDeliverySlipPDF()">ä¸‹è½½PDF</button>
    </div>
  </div>
</div>

<!-- å‘è´§å•é¢„è§ˆæ¨¡æ€æ¡† -->
<div id="deliverySlipPreviewModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“‹ å‘è´§å•é¢„è§ˆ</div>
    <button class="modal-close" onclick="closeDeliverySlipPreviewModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div id="deliverySlipPreviewContent" style="max-height: 70vh; overflow: auto;">
      <!-- é¢„è§ˆå†…å®¹å°†åŠ¨æ€å¡«å…… -->
    </div>
  </div>
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeDeliverySlipPreviewModal()">å…³é—­é¢„è§ˆ</button>
      <button class="btn ghost" onclick="printDeliverySlip()">æ‰“å°å‘è´§å•</button>
    </div>
  </div>
</div>

<!-- è´¨æ£€æ ‡å‡†ç®¡ç†æ¨¡æ€æ¡† -->
<div id="qualityModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“Š è´¨æ£€æ ‡å‡†ç®¡ç†</div>
    <button class="modal-close" onclick="closeQualityModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <!-- è´¨æ£€æ–¹å¼ -->
    <div class="form-section">
      <div class="section-title">æ£€éªŒæ–¹å¼</div>
      <div style="margin-bottom:16px;">
        <select id="qualityInspectionType" class="form-select" style="width:100%;">
          <option value="">è¯·é€‰æ‹©æ£€éªŒæ–¹å¼</option>
          <option value="å…¨æ£€">å…¨æ£€</option>
          <option value="æŠ½æ£€">æŠ½æ£€</option>
          <option value="å…æ£€">å…æ£€</option>
        </select>
      </div>
    </div>
    
    <!-- ä¾›åº”å•†è‡ªæ£€å“è´¨æŠ¥å‘Š -->
    <div class="form-section">
      <div class="section-title">ä¾›åº”å•†è‡ªæ£€å“è´¨æŠ¥å‘Š</div>
      <div style="margin-bottom:16px;">
        <button class="btn ghost" onclick="uploadQualityReport()">
          ğŸ“„ ä¸Šä¼ ä¾›åº”å•†è‡ªæ£€å“è´¨æŠ¥å‘Š
        </button>
        <div id="qualityReportList" style="margin-top:12px;">
          <!-- åŠ¨æ€æ˜¾ç¤ºå·²ä¸Šä¼ çš„æŠ¥å‘Š -->
        </div>
      </div>
    </div>
    
    <!-- è¿”æ¨¡å…·è´¹åˆåŒ -->
    <div class="form-section">
      <div class="section-title">è¿”æ¨¡å…·è´¹åˆåŒ</div>
      <div style="margin-bottom:16px;">
        <button class="btn ghost" onclick="uploadMoldContract()">
          ğŸ’° ä¸Šä¼ è¿”æ¨¡å…·è´¹åˆåŒ
        </button>
        <div id="moldContractInfo" style="margin-top:12px;">
          <!-- åŠ¨æ€æ˜¾ç¤ºåˆåŒä¿¡æ¯ -->
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeQualityModal()">å…³é—­</button>
      <button class="btn" onclick="saveQualityStandards()">ä¿å­˜æ ‡å‡†</button>
    </div>
  </div>
</div>

<!-- é‡‡è´­è®¡åˆ’è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="poDetailModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“‹ é‡‡è´­è®¡åˆ’è¯¦æƒ…</div>
    <button class="modal-close" onclick="closePODetail()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div id="poDetailContent">
      <!-- åŠ¨æ€å¡«å……é‡‡è´­è®¡åˆ’è¯¦æƒ…å’Œä¾›åº”å•†æŠ¥ä»·å¯¹æ¯” -->
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closePODetail()">å…³é—­</button>
      <button class="btn primary" onclick="saveSelectedQuotesToPO()" id="saveQuoteSelectionBtn">ğŸ’¾ ä¿å­˜æŠ¥ä»·é€‰æ‹©</button>
    </div>
  </div>
</div>

<!-- é‡‡è´­è®¢å•æ¨¡æ€æ¡† -->
<div id="purchaseOrderModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“‹ åˆ›å»ºé‡‡è´­è®¢å•</div>
    <button class="modal-close" onclick="closePurchaseOrder()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">åŸºäºå·²å®¡æ‰¹çš„é‡‡è´­è®¡åˆ’åˆ›å»ºæ­£å¼é‡‡è´­è®¢å•</div>
    
    <!-- é€‰æ‹©é‡‡è´­è®¡åˆ’ -->
    <div class="form-section">
      <div class="section-title">é€‰æ‹©é‡‡è´­è®¡åˆ’</div>
      <div style="margin-bottom:16px">
        <select id="poPlanSelect" onchange="loadPOPlan()" style="width:100%;padding:8px;border:1px solid var(--border-color);border-radius:6px;">
          <option value="">è¯·é€‰æ‹©å·²å®¡æ‰¹çš„é‡‡è´­è®¡åˆ’</option>
        </select>
      </div>
    </div>
    
    <!-- è®¢å•ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">è®¢å•ä¿¡æ¯</div>
      <div id="poOrderInfo" style="background:var(--hover-bg);padding:12px;border-radius:6px;margin-bottom:16px;">
        <div class="small muted">è¯·å…ˆé€‰æ‹©é‡‡è´­è®¡åˆ’</div>
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closePurchaseOrder()">å…³é—­</button>
      <button class="btn" onclick="createPurchaseOrder()">åˆ›å»ºè®¢å•</button>
    </div>
  </div>
</div>

<!-- ä¾›åº”å•†æ²Ÿé€šè®°å½•æ¨¡æ€æ¡† -->
<div id="communicationModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“ ä¾›åº”å•†æ²Ÿé€šè®°å½•</div>
    <button class="modal-close" onclick="closeCommunicationModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div id="communicationContent">
      <!-- åŠ¨æ€å¡«å……æ²Ÿé€šè®°å½•å†…å®¹ -->
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeCommunicationModal()">å…³é—­</button>
      <button class="btn primary" onclick="addNewCommunicationNote()">æ·»åŠ æ–°è®°å½•</button>
    </div>
  </div>
</div>

<!-- é€€è´§å•æ¨¡æ€æ¡† -->
<div id="returnOrderModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">â†©ï¸ åˆ›å»ºé€€è´§å•</div>
    <button class="modal-close" onclick="closeReturnOrder()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">åˆ›å»ºä¾›åº”å•†é€€è´§ç”³è¯·å•</div>
    
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">åŸºæœ¬ä¿¡æ¯</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
        <div>
          <label>ä¾›åº”å•†</label>
          <select id="returnSupplier" style="width:100%;padding:8px;border:1px solid var(--border-color);border-radius:6px;">
            <option value="">è¯·é€‰æ‹©ä¾›åº”å•†</option>
          </select>
        </div>
        <div>
          <label>é€€è´§åŸå› </label>
          <select id="returnReason" style="width:100%;padding:8px;border:1px solid var(--border-color);border-radius:6px;">
            <option value="è´¨é‡é—®é¢˜">è´¨é‡é—®é¢˜</option>
            <option value="æ•°é‡ä¸ç¬¦">æ•°é‡ä¸ç¬¦</option>
            <option value="é”™å‘äº§å“">é”™å‘äº§å“</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- é€€è´§äº§å“ -->
    <div class="form-section">
      <div class="section-title">é€€è´§äº§å“</div>
      <div id="returnItems" style="min-height:100px;border:1px dashed var(--border-color);border-radius:6px;padding:16px;">
        <div class="small muted">è¯·æ·»åŠ é€€è´§äº§å“</div>
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeReturnOrder()">å…³é—­</button>
      <button class="btn" onclick="createReturnOrder()">æäº¤é€€è´§å•</button>
    </div>
  </div>
</div>

<!-- ä¾§æ è¯¦æƒ… / æ¨¡æ‹Ÿè¡¨å• -->
<div id="sideDetail" class="side-detail hidden" aria-hidden="true">
  <div class="detail-header">
    <div id="detailTitle" class="detail-title">è¯¦æƒ…</div>
    <button class="detail-close" onclick="closeDetail()" title="å…³é—­">Ã—</button>
  </div>
  <div id="detailBody">å†…å®¹</div>
</div>

<!-- å…¥åº“ç®¡ç†æ¨¡æ€æ¡† -->
<div id="warehouseInboundModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“¦ å…¥åº“ç®¡ç†</div>
    <button class="modal-close" onclick="closeWarehouseInbound()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <!-- ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©é€è´§ç±»å‹ -->
    <div id="inboundStep1" class="inbound-step">
      <div class="form-description">è¯·é€‰æ‹©é€è´§ç±»å‹</div>
      
      <div class="delivery-types">
        <div class="delivery-type-card" onclick="selectDeliveryType('supplier_delivery')">
          <div class="delivery-icon">ğŸšš</div>
          <div class="delivery-title">ä¾›åº”å•†è‡ªé€</div>
          <div class="delivery-desc">ä¾›åº”å•†è‡ªè¡Œé€è´§åˆ°ä»“åº“</div>
        </div>
        
        <div class="delivery-type-card" onclick="selectDeliveryType('supplier_arranged')">
          <div class="delivery-icon">ğŸ“¦</div>
          <div class="delivery-title">ä¾›åº”å•†å«è½¦</div>
          <div class="delivery-desc">ä¾›åº”å•†å®‰æ’è½¦è¾†é€è´§</div>
        </div>
        
        <div class="delivery-type-card" onclick="selectDeliveryType('express')">
          <div class="delivery-icon">ğŸ“¬</div>
          <div class="delivery-title">å¿«é€’/ç‰©æµé€è´§ä¸Šé—¨</div>
          <div class="delivery-desc">é€šè¿‡å¿«é€’æˆ–ç‰©æµå…¬å¸é€è´§</div>
        </div>
        
        <div class="delivery-type-card" onclick="selectDeliveryType('self_pickup')">
          <div class="delivery-icon">ğŸƒ</div>
          <div class="delivery-title">ä¸Šé—¨è‡ªæ</div>
          <div class="delivery-desc">è‡ªè¡Œä¸Šé—¨æå–è´§ç‰©</div>
        </div>
      </div>
    </div>
    
    <!-- ç¬¬äºŒæ­¥ï¼šæŸ¥è¯¢é‡‡è´­è®¢å• -->
    <div id="inboundStep2" class="inbound-step hidden">
      <div class="form-description">è¯·è¾“å…¥é€è´§å•å·æˆ–å¿«é€’å•å·ï¼ˆå¯è¾“å…¥ä»»æ„å•å·æŸ¥çœ‹æ‰€æœ‰å¯å…¥åº“è®¢å•ï¼‰</div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">é€è´§å•å·/å¿«é€’å•å·</label>
          <input id="deliveryNumber" class="form-input" placeholder="è¯·è¾“å…¥é€è´§å•å·æˆ–å¿«é€’å•å·" />
        </div>
        <div class="form-group">
          <label class="form-label">é€è´§ç±»å‹</label>
          <input id="selectedDeliveryType" class="form-input" readonly />
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn ghost" onclick="backToStep1()">ä¸Šä¸€æ­¥</button>
        <button class="btn" onclick="searchPurchaseOrder()">æŸ¥è¯¢é‡‡è´­è®¢å•</button>
      </div>
    </div>
    
    <!-- ç¬¬ä¸‰æ­¥ï¼šè´¨æ£€å’Œæ ¸æ•° -->
    <div id="inboundStep3" class="inbound-step hidden">
      <div class="form-description">è¯·è¿›è¡Œè´¨æ£€å’Œæ ¸æ•°æ“ä½œ</div>
      
      <div class="purchase-order-info" id="purchaseOrderInfo">
        <!-- é‡‡è´­è®¢å•ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
      </div>
      
      <div class="form-section">
        <div class="section-title">è´¨æ£€ä¿¡æ¯</div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">è´¨æ£€ç»“æœ</label>
            <select id="qualityResult" class="form-select">
              <option value="passed">é€šè¿‡</option>
              <option value="failed">ä¸é€šè¿‡</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">è´¨æ£€å¤‡æ³¨</label>
            <input id="qualityNotes" class="form-input" placeholder="è¯·è¾“å…¥è´¨æ£€å¤‡æ³¨" />
          </div>
        </div>
      </div>
      
      <div class="form-section">
        <div class="section-title">æ ¸æ•°ä¿¡æ¯</div>
        <table id="quantityCheckTable" style="width:100%; margin-top:8px; font-size:14px;">
          <thead>
            <tr>
              <th>SKU</th>
              <th>äº§å“åç§°</th>
              <th>åº”æ”¶æ•°é‡</th>
              <th>å®æ”¶æ•°é‡</th>
              <th>å·®å¼‚æ•°é‡</th>
              <th>çŠ¶æ€</th>
            </tr>
          </thead>
          <tbody>
            <!-- æ ¸æ•°è¡¨æ ¼å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
          </tbody>
        </table>
      </div>
      
      <div class="form-actions">
        <button class="btn ghost" onclick="backToStep2()">ä¸Šä¸€æ­¥</button>
        <button class="btn" onclick="completeInbound()">å®Œæˆå…¥åº“</button>
      </div>
    </div>
  </div>
</div>

<!-- ä¾›åº”å•†ç¡®è®¤è®°å½•å¼¹çª— -->
<div id="supplierContactModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“ è®°å½•ä¾›åº”å•†ç¡®è®¤</div>
    <button class="modal-close" onclick="closeSupplierContactModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">è®°å½•ä¸ä¾›åº”å•†çš„ç¡®è®¤æ²Ÿé€šæƒ…å†µ</div>
    
    <!-- ç¡®è®¤ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">ç¡®è®¤ä¿¡æ¯</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ç¡®è®¤æ–¹å¼</label>
          <select id="confirmMethod" class="form-select">
            <option value="">è¯·é€‰æ‹©ç¡®è®¤æ–¹å¼</option>
            <option value="ç”µè¯">ç”µè¯</option>
            <option value="å¾®ä¿¡">å¾®ä¿¡</option>
            <option value="é‚®ä»¶">é‚®ä»¶</option>
            <option value="è§é¢">è§é¢</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ç¡®è®¤æ—¥æœŸ</label>
          <input type="date" id="confirmDate" class="form-input" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ä¾›åº”å•†è”ç³»äºº</label>
          <input type="text" id="supplierContact" class="form-input" placeholder="è¯·è¾“å…¥ä¾›åº”å•†è”ç³»äººå§“å" />
        </div>
        <div class="form-group">
          <label class="form-label">è”ç³»æ–¹å¼</label>
          <input type="text" id="contactInfo" class="form-input" placeholder="ç”µè¯/å¾®ä¿¡/é‚®ç®±" />
        </div>
      </div>
    </div>
    
    <!-- æ²Ÿé€šå†…å®¹ -->
    <div class="form-section">
      <div class="section-title">æ²Ÿé€šå†…å®¹</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ç¡®è®¤ç»“æœ</label>
          <select id="confirmResult" class="form-select">
            <option value="">è¯·é€‰æ‹©ç¡®è®¤ç»“æœ</option>
            <option value="ç¡®è®¤æ¥å•">ç¡®è®¤æ¥å•</option>
            <option value="éœ€è¦ä¿®æ”¹">éœ€è¦ä¿®æ”¹</option>
            <option value="æ— æ³•æ¥å•">æ— æ³•æ¥å•</option>
            <option value="éœ€è¦æ—¶é—´è€ƒè™‘">éœ€è¦æ—¶é—´è€ƒè™‘</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">é¢„è®¡å›å¤æ—¶é—´</label>
          <input type="date" id="replyTime" class="form-input" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">æ²Ÿé€šå¤‡æ³¨</label>
          <textarea id="contactNotes" class="form-textarea" rows="3" placeholder="è¯·è®°å½•æ²Ÿé€šçš„è¯¦ç»†å†…å®¹"></textarea>
        </div>
      </div>
    </div>
    
    <!-- ä¸‹ä¸€æ­¥å®‰æ’ -->
    <div class="form-section">
      <div class="section-title">ä¸‹ä¸€æ­¥å®‰æ’</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">åç»­è·Ÿè¿›æ—¶é—´</label>
          <input type="datetime-local" id="followUpTime" class="form-input" />
        </div>
        <div class="form-group">
          <label class="form-label">è´Ÿè´£äºº</label>
          <input type="text" id="responsiblePerson" class="form-input" value="${currentUser}" readonly />
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeSupplierContactModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="saveSupplierContact()">ä¿å­˜è®°å½•</button>
    </div>
  </div>
</div>

<!-- é‡‡è´­è®¢å•ç¼–è¾‘å¼¹çª— -->
<div id="purchaseOrderEditModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">âœï¸ ç¼–è¾‘é‡‡è´­è®¢å•</div>
    <button class="modal-close" onclick="closePurchaseOrderEditModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">ç¼–è¾‘é‡‡è´­è®¢å•ä¿¡æ¯</div>
    
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">åŸºæœ¬ä¿¡æ¯</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">è®¢å•å·</label>
          <input type="text" id="editOrderId" class="form-input" readonly />
        </div>
        <div class="form-group">
          <label class="form-label">çŠ¶æ€</label>
          <select id="editOrderStatus" class="form-select">
            <option value="å¾…ä¾›åº”å•†ç¡®è®¤">å¾…ä¾›åº”å•†ç¡®è®¤</option>
            <option value="ä¾›åº”å•†å·²ç¡®è®¤">ä¾›åº”å•†å·²ç¡®è®¤</option>
            <option value="å·²å‘è´§">å·²å‘è´§</option>
            <option value="å¾…æ”¶è´§">å¾…æ”¶è´§</option>
            <option value="å·²æ”¶è´§">å·²æ”¶è´§</option>
            <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ä¾›åº”å•†</label>
          <input type="text" id="editSupplier" class="form-input" readonly />
        </div>
        <div class="form-group">
          <label class="form-label">é‡‡è´­å‘˜</label>
          <input type="text" id="editPurchaser" class="form-input" />
        </div>
      </div>
    </div>
    
    <!-- æ—¶é—´ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">æ—¶é—´ä¿¡æ¯</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">é¢„è®¡äº¤æœŸ</label>
          <input type="date" id="editExpectedDate" class="form-input" />
        </div>
        <div class="form-group">
          <label class="form-label">å®é™…äº¤æœŸ</label>
          <input type="date" id="editActualDate" class="form-input" />
        </div>
      </div>
    </div>
    
    <!-- ä¾›åº”å•†å¤‡æ³¨ -->
    <div class="form-section">
      <div class="section-title">ä¾›åº”å•†å¤‡æ³¨</div>
      <div class="form-row">
        <div class="form-group">
          <textarea id="editSupplierNotes" class="form-textarea" rows="3" placeholder="ä¾›åº”å•†æ²Ÿé€šå¤‡æ³¨"></textarea>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closePurchaseOrderEditModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="savePurchaseOrderEdit()">ä¿å­˜ä¿®æ”¹</button>
    </div>
  </div>
</div>

<!-- åˆåŒä¸Šä¼ å¼¹çª— -->
<div id="signedContractModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“„ ä¸Šä¼ ç›–ç« åˆåŒ</div>
    <button class="modal-close" onclick="closeSignedContractModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">ä¸Šä¼ ä¾›åº”å•†ç›–ç« åçš„åˆåŒæ–‡ä»¶</div>
    
    <!-- è®¢å•ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">è®¢å•ä¿¡æ¯</div>
      <div style="background: var(--hover-bg); padding: 12px; border-radius: 6px;">
        <div><strong>è®¢å•å·ï¼š</strong><span id="contractOrderId"></span></div>
        <div><strong>ä¾›åº”å•†ï¼š</strong><span id="contractSupplier"></span></div>
        <div><strong>åˆåŒé‡‘é¢ï¼š</strong><span id="contractAmount"></span></div>
      </div>
    </div>
    
    <!-- æ–‡ä»¶ä¸Šä¼  -->
    <div class="form-section">
      <div class="section-title">åˆåŒæ–‡ä»¶</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">é€‰æ‹©æ–‡ä»¶</label>
          <input type="file" id="contractFile" class="form-input" accept=".pdf,.jpg,.png,.doc,.docx" />
          <div class="small muted">æ”¯æŒæ ¼å¼ï¼šPDFã€JPGã€PNGã€DOCã€DOCX</div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">æ–‡ä»¶è¯´æ˜</label>
          <input type="text" id="contractDescription" class="form-input" placeholder="è¯·è¾“å…¥æ–‡ä»¶è¯´æ˜ï¼ˆå¯é€‰ï¼‰" />
        </div>
      </div>
    </div>
    
    <!-- å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨ -->
    <div class="form-section" id="uploadedContractsSection" style="display: none;">
      <div class="section-title">å·²ä¸Šä¼ åˆåŒ</div>
      <div id="uploadedContractsList">
        <!-- åŠ¨æ€æ˜¾ç¤ºå·²ä¸Šä¼ çš„åˆåŒæ–‡ä»¶ -->
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeSignedContractModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="uploadSignedContract()">ä¸Šä¼ æ–‡ä»¶</button>
    </div>
  </div>
</div>

<!-- æ”¶è´§ä¿¡æ¯å¼¹çª— -->
<div id="receivingModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“¦ æ”¶è´§ä¿¡æ¯ç™»è®°</div>
    <button class="modal-close" onclick="closeReceivingModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">ç™»è®°æ”¶è´§ä¿¡æ¯å’Œè´¨é‡æ£€æŸ¥ç»“æœ</div>
    
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">æ”¶è´§ä¿¡æ¯</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">æ”¶è´§æ—¥æœŸ</label>
          <input type="date" id="receivingDate" class="form-input" />
        </div>
        <div class="form-group">
          <label class="form-label">æ”¶è´§çŠ¶æ€</label>
          <select id="receivingStatus" class="form-select">
            <option value="å…¨éƒ¨æ”¶é½">å…¨éƒ¨æ”¶é½</option>
            <option value="éƒ¨åˆ†æ”¶è´§">éƒ¨åˆ†æ”¶è´§</option>
            <option value="å»¶æœŸæ”¶è´§">å»¶æœŸæ”¶è´§</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">æ”¶è´§äºº</label>
          <input type="text" id="receiver" class="form-input" value="${currentUser}" readonly />
        </div>
        <div class="form-group">
          <label class="form-label">é€è´§å•æ ¸å¯¹</label>
          <div style="padding: 8px;">
            <label style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="supplierDeliverySlipCheck" />
              <span>ä¾›åº”å•†é€è´§å•å·²æ ¸å¯¹</span>
            </label>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ”¶è´§æ˜ç»† -->
    <div class="form-section">
      <div class="section-title">æ”¶è´§æ˜ç»†</div>
      <div id="receivingDetails">
        <!-- åŠ¨æ€ç”Ÿæˆæ”¶è´§æ˜ç»†è¡¨æ ¼ -->
      </div>
    </div>
    
    <!-- è´¨é‡æ£€æŸ¥ -->
    <div class="form-section">
      <div class="section-title">è´¨é‡æ£€æŸ¥</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">æ˜¯å¦æœ‰è´¨é‡é—®é¢˜</label>
          <div style="padding: 8px;">
            <label style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="hasQualityIssues" />
              <span>å­˜åœ¨è´¨é‡é—®é¢˜éœ€è¦è®°å½•</span>
            </label>
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">æ”¶è´§å¤‡æ³¨</label>
          <textarea id="receivingNotes" class="form-textarea" rows="3" placeholder="è¯·è¾“å…¥æ”¶è´§å¤‡æ³¨ä¿¡æ¯"></textarea>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeReceivingModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="saveReceiving()">ä¿å­˜æ”¶è´§ä¿¡æ¯</button>
    </div>
  </div>
</div>

<!-- åº“å­˜è°ƒæ•´æ¨¡æ€æ¡† -->
<div id="inventoryAdjustmentModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“Š åº“å­˜è°ƒæ•´</div>
    <button class="modal-close" onclick="closeInventoryAdjustmentModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">è°ƒæ•´åº“å­˜æ•°é‡ï¼Œè®°å½•è°ƒæ•´åŸå› </div>
    
    <div class="form-section">
      <div class="section-title">è°ƒæ•´ä¿¡æ¯</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">äº§å“SKU</label>
          <input type="text" id="adjustSku" class="form-input" readonly placeholder="è¯·é€‰æ‹©äº§å“">
        </div>
        <div class="form-group">
          <label class="form-label">äº§å“åç§°</label>
          <input type="text" id="adjustProductName" class="form-input" readonly placeholder="äº§å“åç§°">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">å½“å‰åº“å­˜</label>
          <input type="number" id="currentStock" class="form-input" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">è°ƒæ•´æ•°é‡</label>
          <input type="number" id="adjustQuantity" class="form-input" placeholder="æ­£æ•°ä¸ºå¢åŠ ï¼Œè´Ÿæ•°ä¸ºå‡å°‘">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">è°ƒæ•´ååº“å­˜</label>
          <input type="number" id="newStock" class="form-input" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">è°ƒæ•´ç±»å‹</label>
          <select id="adjustType" class="form-input">
            <option value="manual">æ‰‹åŠ¨è°ƒæ•´</option>
            <option value="damage">æŠ¥æŸ</option>
            <option value="loss">ä¸¢å¤±</option>
            <option value="correction">ç›˜ç‚¹æ ¡æ­£</option>
            <option value="other">å…¶ä»–</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">è°ƒæ•´åŸå› </label>
          <textarea id="adjustReason" class="form-textarea" rows="3" placeholder="è¯·è¾“å…¥è°ƒæ•´åŸå› "></textarea>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeInventoryAdjustmentModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="saveInventoryAdjustment()">ä¿å­˜è°ƒæ•´</button>
    </div>
  </div>
</div>


<!-- åº“å­˜ç›˜ç‚¹æ¨¡æ€æ¡† -->
<div id="inventoryCountModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“‹ åº“å­˜ç›˜ç‚¹</div>
    <button class="modal-close" onclick="closeInventoryCountModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">åˆ›å»ºç›˜ç‚¹è®¡åˆ’ï¼Œè®°å½•å®é™…åº“å­˜æ•°é‡</div>
    
    <div class="form-section">
      <div class="section-title">ç›˜ç‚¹è®¡åˆ’</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ç›˜ç‚¹ç¼–å·</label>
          <input type="text" id="countId" class="form-input" readonly placeholder="ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ">
        </div>
        <div class="form-group">
          <label class="form-label">ç›˜ç‚¹æ—¥æœŸ</label>
          <input type="date" id="countDate" class="form-input">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ç›˜ç‚¹ä»“åº“</label>
          <select id="countWarehouse" class="form-input">
            <option value="main">ä¸»ä»“åº“</option>
            <option value="branch">åˆ†ä»“åº“</option>
            <option value="overseas">æµ·å¤–ä»“</option>
            <option value="all">å…¨ä»“åº“</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ç›˜ç‚¹ç±»å‹</label>
          <select id="countType" class="form-input">
            <option value="full">å…¨ç›˜</option>
            <option value="partial">æŠ½ç›˜</option>
            <option value="category">åˆ†ç±»ç›˜ç‚¹</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">è´Ÿè´£äºº</label>
          <input type="text" id="countManager" class="form-input" placeholder="ç›˜ç‚¹è´Ÿè´£äºº">
        </div>
        <div class="form-group">
          <label class="form-label">ç›˜ç‚¹å¤‡æ³¨</label>
          <textarea id="countNotes" class="form-textarea" rows="2" placeholder="ç›˜ç‚¹å¤‡æ³¨ä¿¡æ¯"></textarea>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <div class="section-title">ç›˜ç‚¹äº§å“é€‰æ‹©</div>
      <div class="toolbar">
        <button class="btn ghost" onclick="selectAllProducts()">å…¨é€‰</button>
        <button class="btn ghost" onclick="deselectAllProducts()">å–æ¶ˆå…¨é€‰</button>
        <button class="btn ghost" onclick="selectByCategory()">æŒ‰åˆ†ç±»é€‰æ‹©</button>
      </div>
      <div id="countProductList" style="max-height: 300px; overflow-y: auto; margin-top: 12px;">
        <!-- åŠ¨æ€ç”Ÿæˆäº§å“åˆ—è¡¨ -->
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeInventoryCountModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="createInventoryCount()">åˆ›å»ºç›˜ç‚¹è®¡åˆ’</button>
    </div>
  </div>
</div>

<!-- åº“å­˜é¢„è­¦æ¨¡æ€æ¡† -->
<div id="inventoryAlertsModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">âš ï¸ åº“å­˜é¢„è­¦</div>
    <button class="modal-close" onclick="closeInventoryAlertsModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">æŸ¥çœ‹å’Œç®¡ç†åº“å­˜é¢„è­¦ä¿¡æ¯</div>
    
    <div class="form-section">
      <div class="section-title">é¢„è­¦ç»Ÿè®¡</div>
      <div class="card-row">
        <div class="card">
          <div class="title">ä½åº“å­˜é¢„è­¦</div>
          <div class="value" id="lowStockCount">0</div>
        </div>
        <div class="card">
          <div class="title">è¶…åº“å­˜é¢„è­¦</div>
          <div class="value" id="overStockCount">0</div>
        </div>
        <div class="card">
          <div class="title">å‘†æ»åº“å­˜</div>
          <div class="value" id="deadStockCount">0</div>
        </div>
        <div class="card">
          <div class="title">å³å°†è¿‡æœŸ</div>
          <div class="value" id="expiryCount">0</div>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <div class="section-title">é¢„è­¦æ˜ç»†</div>
      <div class="toolbar">
        <button class="btn ghost" onclick="filterAlerts('all')">å…¨éƒ¨</button>
        <button class="btn ghost" onclick="filterAlerts('low_stock')">ä½åº“å­˜</button>
        <button class="btn ghost" onclick="filterAlerts('over_stock')">è¶…åº“å­˜</button>
        <button class="btn ghost" onclick="filterAlerts('dead_stock')">å‘†æ»</button>
        <button class="btn ghost" onclick="filterAlerts('expiry')">å³å°†è¿‡æœŸ</button>
      </div>
      <div id="alertsList" style="max-height: 400px; overflow-y: auto; margin-top: 12px;">
        <!-- åŠ¨æ€ç”Ÿæˆé¢„è­¦åˆ—è¡¨ -->
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeInventoryAlertsModal()">å…³é—­</button>
      <button class="btn primary" onclick="exportAlerts()">å¯¼å‡ºé¢„è­¦æŠ¥å‘Š</button>
    </div>
  </div>
</div>

<!-- é”€å”®æŠ¥ä»·æ¨¡æ€æ¡† -->
<div id="salesQuoteCreateModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“‹ æ–°å»ºé”€å”®æŠ¥ä»·</div>
    <button class="modal-close" onclick="closeSalesQuoteCreateModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">åˆ›å»ºæ–°çš„é”€å”®æŠ¥ä»·å•</div>
    
    <form id="salesQuoteCreateForm" onsubmit="event.preventDefault()">
      <!-- æŠ¥ä»·åŸºæœ¬ä¿¡æ¯ -->
      <div class="form-section">
        <div class="section-title">æŠ¥ä»·åŸºæœ¬ä¿¡æ¯</div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          <div>
            <label>æŠ¥ä»·ç¼–å· <span style="color: var(--danger);">*</span></label>
            <input type="text" id="quoteNo" required placeholder="ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ" readonly style="background: var(--bg);">
          </div>
          <div>
            <label>å®¢æˆ·åç§° <span style="color: var(--danger);">*</span></label>
            <select id="quoteCustomer" required>
              <option value="">è¯·é€‰æ‹©å®¢æˆ·</option>
            </select>
          </div>
          <div>
            <label>æŠ¥ä»·æœ‰æ•ˆæœŸ <span style="color: var(--danger);">*</span></label>
            <input type="date" id="quoteValidUntil" required>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 12px;">
          <div>
            <label>ä¸šåŠ¡å‘˜ <span style="color: var(--danger);">*</span></label>
            <input type="text" id="quoteSalesperson" required value="å½“å‰ç”¨æˆ·">
          </div>
          <div>
            <label>æŠ¥ä»·çŠ¶æ€</label>
            <select id="quoteStatus">
              <option value="å¾…å®¡æ‰¹">å¾…å®¡æ‰¹</option>
              <option value="å·²æ‰¹å‡†">å·²æ‰¹å‡†</option>
              <option value="å·²æ‹’ç»">å·²æ‹’ç»</option>
              <option value="å·²è¿‡æœŸ">å·²è¿‡æœŸ</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- äº§å“æ˜ç»† -->
      <div class="form-section">
        <div class="section-title">äº§å“æ˜ç»†</div>
        <div style="margin-bottom: 12px;">
          <button type="button" class="btn ghost" onclick="openQuoteProductSelectModal()">â• æ·»åŠ äº§å“</button>
        </div>
        <div id="quoteItems" style="margin-bottom: 12px;">
          <!-- äº§å“æ˜ç»†å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 16px; padding: 12px; background: var(--hover-bg); border-radius: 6px;">
          <div style="font-weight: 600;">æ€»é‡‘é¢ï¼š</div>
          <div style="font-size: 18px; color: var(--primary); font-weight: 700;" id="quoteTotalAmount">Â¥0.00</div>
        </div>
      </div>
      
      <!-- å…¶ä»–ä¿¡æ¯ -->
      <div class="form-section">
        <div class="section-title">å…¶ä»–ä¿¡æ¯</div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">æŠ¥ä»·å¤‡æ³¨</label>
            <textarea id="quoteRemark" class="form-textarea" rows="3" placeholder="è¯·è¾“å…¥æŠ¥ä»·å¤‡æ³¨ä¿¡æ¯"></textarea>
          </div>
        </div>
      </div>
    </form>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button type="button" class="btn ghost" onclick="closeSalesQuoteCreateModal()">å–æ¶ˆ</button>
      <button type="button" class="btn primary" onclick="submitQuoteForApproval()">æäº¤å®¡æ‰¹</button>
    </div>
  </div>
</div>

<!-- æŠ¥ä»·äº§å“é€‰æ‹©æ¨¡æ€æ¡† -->
<div id="quoteProductSelectModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ” é€‰æ‹©æŠ¥ä»·äº§å“</div>
    <button class="modal-close" onclick="closeQuoteProductSelectModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">
      <input type="text" id="quoteProductSearch" placeholder="æœç´¢SKUæˆ–äº§å“åç§°..." style="width: 100%; margin-bottom: 12px;" oninput="searchQuoteProducts()">
    </div>
    
    <div id="quoteProductList" style="max-height: 400px; overflow-y: auto;">
      <!-- äº§å“åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeQuoteProductSelectModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="addSelectedQuoteProducts()">æ·»åŠ é€‰ä¸­</button>
    </div>
  </div>
</div>

<!-- æŠ¥ä»·å®¡æ‰¹æ¨¡æ€æ¡† -->
<div id="quoteApprovalModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“‹ æŠ¥ä»·å®¡æ‰¹</div>
    <button class="modal-close" onclick="closeQuoteApprovalModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">å®¡æ‰¹é”€å”®æŠ¥ä»·ç”³è¯·</div>
    
    <!-- æŠ¥ä»·ä¿¡æ¯ -->
    <div class="form-section">
      <div class="section-title">æŠ¥ä»·ä¿¡æ¯</div>
      <div id="approvalQuoteInfo" style="background: var(--hover-bg); padding: 12px; border-radius: 6px;">
        <!-- æŠ¥ä»·ä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
    
    <!-- å®¡æ‰¹æ“ä½œ -->
    <div class="form-section">
      <div class="section-title">å®¡æ‰¹æ“ä½œ</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">å®¡æ‰¹ç»“æœ <span style="color: var(--danger);">*</span></label>
          <select id="approvalResult" class="form-input" required onchange="toggleApprovalRemark()">
            <option value="">è¯·é€‰æ‹©å®¡æ‰¹ç»“æœ</option>
            <option value="å·²æ‰¹å‡†">æ‰¹å‡†</option>
            <option value="å·²æ‹’ç»">æ‹’ç»</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">å®¡æ‰¹äºº</label>
          <input type="text" id="approvalPerson" class="form-input" value="å½“å‰ç”¨æˆ·" readonly>
        </div>
      </div>
      <div class="form-row" id="approvalRemarkRow" style="display: none;">
        <div class="form-group" style="grid-column: span 2;">
          <label class="form-label">å®¡æ‰¹æ„è§ <span style="color: var(--danger);">*</span></label>
          <textarea id="approvalRemark" class="form-textarea" rows="3" placeholder="è¯·è¾“å…¥å®¡æ‰¹æ„è§"></textarea>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeQuoteApprovalModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="saveQuoteApproval()">ä¿å­˜å®¡æ‰¹</button>
    </div>
  </div>
</div>

<!-- åº“å­˜å‡ºåº“æ¨¡æ€æ¡† -->
<div id="inventoryOutboundModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“¦ åº“å­˜å‡ºåº“</div>
    <button class="modal-close" onclick="closeInventoryOutboundModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">è®°å½•åº“å­˜å‡ºåº“ä¿¡æ¯ï¼Œæ— éœ€å®¡æ‰¹æµç¨‹</div>
    
    <div class="form-section">
      <div class="section-title">äº§å“ä¿¡æ¯</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">äº§å“SKU</label>
          <input type="text" id="outboundSku" class="form-input" readonly placeholder="è¯·é€‰æ‹©äº§å“">
        </div>
        <div class="form-group">
          <label class="form-label">äº§å“åç§°</label>
          <input type="text" id="outboundProductName" class="form-input" readonly placeholder="äº§å“åç§°">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">å½“å‰åº“å­˜</label>
          <input type="text" id="outboundCurrentStock" class="form-input" readonly placeholder="å½“å‰åº“å­˜æ•°é‡">
        </div>
        <div class="form-group">
          <label class="form-label">å‡ºåº“æ•°é‡ *</label>
          <input type="number" id="outboundQuantity" class="form-input" min="1" placeholder="è¯·è¾“å…¥å‡ºåº“æ•°é‡">
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <div class="section-title">å‡ºåº“ä¿¡æ¯</div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">å‡ºåº“ç±»å‹ *</label>
          <select id="outboundType" class="form-input">
            <option value="">è¯·é€‰æ‹©å‡ºåº“ç±»å‹</option>
            <option value="é”€å”®å‡ºåº“">é”€å”®å‡ºåº“</option>
            <option value="é€€è´§å‡ºåº“">é€€è´§å‡ºåº“</option>
            <option value="æ¢è´§å‡ºåº“">æ¢è´§å‡ºåº“</option>
            <option value="æŠ¥æŸå‡ºåº“">æŠ¥æŸå‡ºåº“</option>
            <option value="å…¶ä»–å‡ºåº“">å…¶ä»–å‡ºåº“</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">å‡ºåº“æ—¥æœŸ *</label>
          <input type="date" id="outboundDate" class="form-input">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">å…³è”å•å·</label>
          <input type="text" id="outboundRefNo" class="form-input" placeholder="é”€å”®è®¢å•å·æˆ–å…¶ä»–å…³è”å•å·">
        </div>
        <div class="form-group">
          <label class="form-label">æ“ä½œå‘˜</label>
          <input type="text" id="outboundOperator" class="form-input" value="å½“å‰ç”¨æˆ·" readonly>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">å¤‡æ³¨</label>
          <textarea id="outboundRemark" class="form-textarea" rows="2" placeholder="è¯·è¾“å…¥å‡ºåº“å¤‡æ³¨ä¿¡æ¯"></textarea>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <div class="form-actions">
      <button class="btn ghost" onclick="closeInventoryOutboundModal()">å–æ¶ˆ</button>
      <button class="btn" onclick="saveInventoryOutbound()">ç¡®è®¤å‡ºåº“</button>
    </div>
  </div>
</div>

<script>

/* å›¾ç‰‡é¢„è§ˆåŠŸèƒ½ */
let currentImagePreview = null;
let imagePreviewTimeout;

/* å…¥åº“ç®¡ç†åŠŸèƒ½ */
let currentInboundStep = 1;
let selectedDeliveryType = '';
let currentPurchaseOrder = null;

// é€è´§ç±»å‹é…ç½®
const deliveryTypes = {
  'supplier_delivery': 'ä¾›åº”å•†è‡ªé€',
  'supplier_arranged': 'ä¾›åº”å•†å«è½¦',
  'express': 'å¿«é€’/ç‰©æµé€è´§ä¸Šé—¨',
  'self_pickup': 'ä¸Šé—¨è‡ªæ'
};

function showWarehouseInbound() {
  const modal = document.getElementById('warehouseInboundModal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.style.display = '';
    resetInboundProcess();
  }
}

function closeWarehouseInbound() {
  const modal = document.getElementById('warehouseInboundModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
  }
  resetInboundProcess();
}

function resetInboundProcess() {
  currentInboundStep = 1;
  selectedDeliveryType = '';
  currentPurchaseOrder = null;
  
  // éšè—æ‰€æœ‰æ­¥éª¤ï¼Œæ˜¾ç¤ºç¬¬ä¸€æ­¥
  document.querySelectorAll('.inbound-step').forEach(step => step.classList.add('hidden'));
  document.getElementById('inboundStep1').classList.remove('hidden');
  
  // æ¸…ç©ºè¡¨å•
  document.getElementById('deliveryNumber').value = '';
  document.getElementById('selectedDeliveryType').value = '';
  document.getElementById('qualityResult').value = 'passed';
  document.getElementById('qualityNotes').value = '';
}

function selectDeliveryType(type) {
  selectedDeliveryType = type;
  currentInboundStep = 2;
  
  // éšè—ç¬¬ä¸€æ­¥ï¼Œæ˜¾ç¤ºç¬¬äºŒæ­¥
  document.getElementById('inboundStep1').classList.add('hidden');
  document.getElementById('inboundStep2').classList.remove('hidden');
  
  // è®¾ç½®é€‰ä¸­çš„é€è´§ç±»å‹
  document.getElementById('selectedDeliveryType').value = deliveryTypes[type];
}

function backToStep1() {
  currentInboundStep = 1;
  document.getElementById('inboundStep2').classList.add('hidden');
  document.getElementById('inboundStep1').classList.remove('hidden');
}

function backToStep2() {
  currentInboundStep = 2;
  document.getElementById('inboundStep3').classList.add('hidden');
  document.getElementById('inboundStep2').classList.remove('hidden');
}

function searchPurchaseOrder() {
  const deliveryNumber = document.getElementById('deliveryNumber').value.trim();
  if (!deliveryNumber) {
    alert('è¯·è¾“å…¥é€è´§å•å·æˆ–å¿«é€’å•å·');
    return;
  }
  
  // æ˜¾ç¤ºæ‰€æœ‰é‡‡è´­è®¢å•ä¾›ç”¨æˆ·é€‰æ‹©
  showPurchaseOrderSelection();
}

function showPurchaseOrderSelection() {
  const poInfo = document.getElementById('purchaseOrderInfo');
  
  let ordersHtml = '<div style="margin-bottom: 16px;"><strong>è¯·é€‰æ‹©è¦å…¥åº“çš„é‡‡è´­è®¢å•ï¼š</strong></div>';
  
  // æ˜¾ç¤ºæ‰€æœ‰é‡‡è´­è®¢å•ï¼ˆå®é™…åº”ç”¨ä¸­å¯ä»¥æ ¹æ®å¿«é€’å•å·è¿‡æ»¤ï¼Œè¿™é‡Œä¸ºäº†æ¼”ç¤ºæ˜¾ç¤ºæ‰€æœ‰ï¼‰
  const availableOrders = data.pos.filter(po => po.status === 'å·²å®¡æ‰¹' || po.status === 'å¾…æ”¶è´§');
  
  if (availableOrders.length === 0) {
    ordersHtml = '<div style="color: var(--danger);">æš‚æ— å¯å…¥åº“çš„é‡‡è´­è®¢å•</div>';
  } else {
    ordersHtml += '<div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 12px;">';
    
    availableOrders.forEach(po => {
      const statusClass = po.status === 'å¾…æ”¶è´§' ? 'warning' : 'info';
      const itemsCount = po.lines ? po.lines.length : 0;
      
      ordersHtml += `
        <div style="border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; margin-bottom: 12px; cursor: pointer;" 
             onclick="selectPurchaseOrderForInbound('${po.id}')">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div style="font-weight: 500;">${po.id}</div>
            <span class="badge ${statusClass}">${po.status}</span>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; font-size: 14px;">
            <div><strong>ä¾›åº”å•†ï¼š</strong>${po.supplier || 'æœªæŒ‡å®š'}</div>
            <div><strong>é¡¹æ•°ï¼š</strong>${itemsCount}</div>
            <div><strong>æ€»é‡‘é¢ï¼š</strong>Â¥${po.total || 0}</div>
          </div>
          <div style="font-size: 14px; color: var(--muted); margin-top: 4px;">
            åˆ›å»ºæ—¶é—´ï¼š${po.date || 'æœªè®°å½•'}
          </div>
        </div>
      `;
    });
    
    ordersHtml += '</div>';
  }
  
  ordersHtml += `
    <div style="margin-top: 16px;">
      <button class="btn ghost" onclick="backToStep2()">é‡æ–°è¾“å…¥å•å·</button>
    </div>
  `;
  
  poInfo.innerHTML = ordersHtml;
  
  // åˆ‡æ¢åˆ°ç¬¬ä¸‰æ­¥
  document.getElementById('inboundStep2').classList.add('hidden');
  document.getElementById('inboundStep3').classList.remove('hidden');
}

function selectPurchaseOrderForInbound(poId) {
  const selectedPO = data.pos.find(po => po.id === poId);
  if (selectedPO) {
    currentPurchaseOrder = selectedPO;
    showInboundStep3();
  }
}

function backToStep2() {
  document.getElementById('inboundStep3').classList.add('hidden');
  document.getElementById('inboundStep2').classList.remove('hidden');
}

function showInboundStep3() {
  currentInboundStep = 3;
  
  // æ˜¾ç¤ºé‡‡è´­è®¢å•ä¿¡æ¯
  const poInfo = document.getElementById('purchaseOrderInfo');
  poInfo.innerHTML = `
    <div style="background: var(--hover-bg); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
      <div style="font-weight: 600; margin-bottom: 8px;">é‡‡è´­è®¢å•ä¿¡æ¯</div>
      <table style="width:100%; font-size:14px;">
        <tr><td style="width:100px;">é‡‡è´­å•å·ï¼š</td><td>${currentPurchaseOrder.id}</td></tr>
        <tr><td>ä¾›åº”å•†ï¼š</td><td>${currentPurchaseOrder.supplier}</td></tr>
        <tr><td>é€è´§å•å·ï¼š</td><td>${document.getElementById('deliveryNumber').value}</td></tr>
        <tr><td>é€è´§ç±»å‹ï¼š</td><td>${deliveryTypes[selectedDeliveryType]}</td></tr>
      </table>
    </div>
  `;
  
  // æ˜¾ç¤ºæ ¸æ•°è¡¨æ ¼
  const tbody = document.querySelector('#quantityCheckTable tbody');
  tbody.innerHTML = '';
  
  currentPurchaseOrder.lines.forEach(line => {
    const product = data.products.find(p => p.sku === line.sku);
    if (product) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${line.sku}</td>
        <td>${product.name}</td>
        <td>${line.qty}</td>
        <td>
          <input type="number" class="form-input" style="width:80px;" 
                 value="${line.qty}" min="0" 
                 onchange="updateQuantityCheck('${line.sku}', this.value)">
        </td>
        <td id="diff-${line.sku}">0</td>
        <td id="status-${line.sku}"><span class="badge success">æ­£å¸¸</span></td>
      `;
      tbody.appendChild(row);
    }
  });
  
  // åˆ‡æ¢åˆ°ç¬¬ä¸‰æ­¥
  document.getElementById('inboundStep2').classList.add('hidden');
  document.getElementById('inboundStep3').classList.remove('hidden');
}

function updateQuantityCheck(sku, actualQty) {
  const expectedQty = currentPurchaseOrder.lines.find(l => l.sku === sku).qty;
  const diff = actualQty - expectedQty;
  const diffElement = document.getElementById(`diff-${sku}`);
  const statusElement = document.getElementById(`status-${sku}`);
  
  diffElement.textContent = diff;
  
  if (diff === 0) {
    statusElement.innerHTML = '<span class="badge success">æ­£å¸¸</span>';
  } else if (diff > 0) {
    statusElement.innerHTML = '<span class="badge warning">å¤šæ”¶</span>';
  } else {
    statusElement.innerHTML = '<span class="badge danger">å°‘æ”¶</span>';
  }
}

function completeInbound() {
  const qualityResult = document.getElementById('qualityResult').value;
  const qualityNotes = document.getElementById('qualityNotes').value;
  
  // æ£€æŸ¥è´¨æ£€ç»“æœ
  if (qualityResult === 'failed') {
    const confirmReject = confirm('è´¨æ£€ä¸é€šè¿‡ï¼Œæ˜¯å¦æ‹’æ”¶ï¼Ÿ');
    if (!confirmReject) {
      return;
    }
    alert('è´§ç‰©å·²æ‹’æ”¶ï¼Œè¯·è”ç³»ä¾›åº”å•†å¤„ç†');
    closeWarehouseInbound();
    return;
  }
  
  // æ›´æ–°åº“å­˜
  currentPurchaseOrder.lines.forEach(line => {
    const actualQty = parseInt(document.querySelector(`input[onchange*="${line.sku}"]`).value) || line.qty;
    const product = data.products.find(p => p.sku === line.sku);
    if (product) {
      product.stock += actualQty;
    }
  });
  
  // æ›´æ–°é‡‡è´­å•çŠ¶æ€
  currentPurchaseOrder.status = 'å·²å®Œæˆ';
  
  // ç”Ÿæˆæ‰¹æ¬¡è®°å½•
  generateBatchRecord();
  
  // æ‰“å°å…¥åº“æ ‡ç­¾
  printInboundLabels();
  
  // å…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°
  closeWarehouseInbound();
  renderAll();
  
  alert('å…¥åº“å®Œæˆï¼Œåº“å­˜å·²æ›´æ–°');
}

function generateBatchRecord() {
  // ä¸ºæ¯ä¸ªäº§å“ç”Ÿæˆæ‰¹æ¬¡è®°å½•
  currentPurchaseOrder.lines.forEach(line => {
    const product = data.products.find(p => p.sku === line.sku);
    if (product) {
      const actualQty = parseInt(document.querySelector(`input[onchange*="${line.sku}"]`).value) || line.qty;
      
      if (!product.batches) {
        product.batches = [];
      }
      
      const batchNumber = `B${Date.now()}-${Math.floor(Math.random() * 1000)}`;
      const expiryDate = new Date();
      expiryDate.setFullYear(expiryDate.getFullYear() + 1); // é»˜è®¤1å¹´ä¿è´¨æœŸ
      
      product.batches.push({
        batch: batchNumber,
        quantity: actualQty,
        receivedDate: new Date().toISOString().split('T')[0],
        expiry: expiryDate.toISOString().split('T')[0],
        supplier: currentPurchaseOrder.supplier,
        deliveryNumber: document.getElementById('deliveryNumber').value
      });
    }
  });
}

function printInboundLabels() {
  // æ¨¡æ‹Ÿæ‰“å°å…¥åº“æ ‡ç­¾
  const labels = [];
  currentPurchaseOrder.lines.forEach(line => {
    const product = data.products.find(p => p.sku === line.sku);
    if (product) {
      const actualQty = parseInt(document.querySelector(`input[onchange*="${line.sku}"]`).value) || line.qty;
      const batchNumber = product.batches[product.batches.length - 1].batch;
      
      // è®¡ç®—éœ€è¦çš„ç®±æ•°
      const cartonQty = parseInt(product.carton) || 1;
      const cartonsNeeded = Math.ceil(actualQty / cartonQty);
      
      for (let i = 0; i < cartonsNeeded; i++) {
        labels.push({
          supplierCode: currentPurchaseOrder.supplier,
          sku: product.sku,
          name: product.name,
          model: product.model || '',
          quantity: i === cartonsNeeded - 1 ? actualQty - (i * cartonQty) : cartonQty,
          cartonSpec: `${cartonQty}/ç®±`,
          batchNumber: batchNumber,
          qrCode: `${product.sku}-${batchNumber}-${i + 1}`,
          weight: '0.5kg', // æ¨¡æ‹Ÿé‡é‡
          dimensions: '30x20x10cm' // æ¨¡æ‹Ÿå°ºå¯¸
        });
      }
    }
  });
  
  // æ˜¾ç¤ºæ ‡ç­¾é¢„è§ˆï¼ˆå®é™…åº”ç”¨ä¸­ä¼šè°ƒç”¨æ‰“å°åŠŸèƒ½ï¼‰
  showLabelPreview(labels);
}

function showLabelPreview(labels) {
  const side = document.getElementById('sideDetail');
  const overlay = createModalOverlay();
  
  overlay.classList.remove('hidden');
  side.classList.remove('hidden');
  
  document.getElementById('detailTitle').textContent = 'å…¥åº“æ ‡ç­¾é¢„è§ˆ';
  
  let labelsHtml = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">';
  labels.forEach((label, index) => {
    labelsHtml += `
      <div style="border: 2px solid #333; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 12px;">
        <div style="text-align: center; font-weight: bold; margin-bottom: 8px;">å…¥åº“æ ‡ç­¾</div>
        <div><strong>ä¾›åº”å•†:</strong> ${label.supplierCode}</div>
        <div><strong>SKU:</strong> ${label.sku}</div>
        <div><strong>å“å:</strong> ${label.name}</div>
        <div><strong>å‹å·:</strong> ${label.model}</div>
        <div><strong>æ•°é‡:</strong> ${label.quantity}</div>
        <div><strong>ç®±è§„:</strong> ${label.cartonSpec}</div>
        <div><strong>æ‰¹æ¬¡:</strong> ${label.batchNumber}</div>
        <div><strong>æ—¥æœŸ:</strong> ${new Date().toLocaleDateString()}</div>
        <div><strong>é‡é‡:</strong> ${label.weight}</div>
        <div><strong>å°ºå¯¸:</strong> ${label.dimensions}</div>
        <div style="text-align: center; margin-top: 8px;">
          <div style="width: 80px; height: 80px; background: #f0f0f0; margin: 0 auto; display: flex; align-items: center; justify-content: center; font-size: 10px;">
            QR Code<br/>${label.qrCode}
          </div>
        </div>
      </div>
    `;
  });
  labelsHtml += '</div>';
  
  document.getElementById('detailBody').innerHTML = labelsHtml + `
    <div style="margin-top: 16px; text-align: center;">
      <button class="btn" onclick="printLabels()">æ‰“å°æ ‡ç­¾</button>
      <button class="btn ghost" onclick="closeDetail()">å…³é—­</button>
    </div>
  `;
}

function printLabels() {
  alert('æ ‡ç­¾å·²å‘é€åˆ°æ‰“å°æœºï¼ˆæ¨¡æ‹ŸåŠŸèƒ½ï¼‰');
  closeDetail();
}

function showImagePreview(event, imageType, productName) {
  // æ¸…é™¤ä¹‹å‰çš„é¢„è§ˆ
  hideImagePreview();
  
  clearTimeout(imagePreviewTimeout);
  
  const preview = document.createElement('div');
  preview.className = 'image-preview';
  preview.innerHTML = `
    <div style="text-align: center; margin-bottom: 10px; font-weight: 600; font-size: 15px;">${productName}</div>
    ${getLargeProductImage(imageType, false)}
    <div style="text-align: center; margin-top: 10px; font-size: 13px; color: var(--muted);">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</div>
  `;
  
  document.body.appendChild(preview);
  currentImagePreview = preview;
  
  // è®¡ç®—ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºå±å¹•
  const rect = event.target.getBoundingClientRect();
  const previewRect = preview.getBoundingClientRect();
  
  let left = rect.left + rect.width / 2 - previewRect.width / 2;
  let top = rect.top - previewRect.height - 10;
  
  // è¾¹ç•Œæ£€æŸ¥
  if (left < 10) left = 10;
  if (left + previewRect.width > window.innerWidth - 10) left = window.innerWidth - previewRect.width - 10;
  if (top < 10) {
    top = rect.bottom + 10;
  }
  
  preview.style.left = left + 'px';
  preview.style.top = top + 'px';
  
  // å»¶è¿Ÿæ˜¾ç¤ºï¼Œé¿å…å¿«é€Ÿç§»åŠ¨æ—¶çš„é—ªçƒ
  imagePreviewTimeout = setTimeout(() => {
    preview.classList.add('show');
  }, 100);
}

function hideImagePreview() {
  clearTimeout(imagePreviewTimeout);
  if (currentImagePreview) {
    currentImagePreview.classList.remove('show');
    setTimeout(() => {
      if (currentImagePreview && currentImagePreview.parentNode) {
        currentImagePreview.parentNode.removeChild(currentImagePreview);
        currentImagePreview = null;
      }
    }, 200);
  }
}

// åˆ›å»ºé®ç½©å±‚
function createModalOverlay() {
  let overlay = document.querySelector('.modal-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.className = 'modal-overlay hidden';
    overlay.onclick = closeDetail;
    document.body.appendChild(overlay);
  }
  return overlay;
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
function setupModalClickOutside(modalId, closeFunction) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.addEventListener('click', function(event) {
      // åªæœ‰ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯ï¼ˆä¸æ˜¯å†…å®¹åŒºåŸŸï¼‰æ‰å…³é—­
      if (event.target === modal) {
        closeFunction();
      }
    });
  }
}

// åˆå§‹åŒ–æ‰€æœ‰æ¨¡æ€æ¡†çš„ç‚¹å‡»å¤–éƒ¨å…³é—­åŠŸèƒ½
function initializeModalHandlers() {
  setupModalClickOutside('warehouseInboundModal', closeWarehouseInbound);
  setupModalClickOutside('deliverySlipModal', closeDeliverySlipModal);
  setupModalClickOutside('deliverySlipPreviewModal', closeDeliverySlipPreviewModal);
  setupModalClickOutside('qualityModal', closeQualityModal);
}

// å‘è´§å•ç®¡ç†æ¨¡æ€æ¡†
function openDeliverySlipModal(poId) {
  const po = data.pos.find(p => p.id === poId);
  if (!po) return;
  
  const modal = document.getElementById('deliverySlipModal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.style.display = '';
    
    // å¡«å……å‘è´§å•ä¿¡æ¯
    const slipIdEl = document.getElementById('deliverySlipId');
    const queryCodeEl = document.getElementById('deliverySlipQueryCode');
    const deliveryDateEl = document.getElementById('deliverySlipDate');
    const supplierEl = document.getElementById('deliverySlipSupplier');
    const recipientEl = document.getElementById('deliverySlipRecipient');
    
    if (slipIdEl) slipIdEl.textContent = po.deliverySlipId || '';
    if (queryCodeEl) queryCodeEl.textContent = po.deliverySlipQueryCode || '';
    if (deliveryDateEl) deliveryDateEl.textContent = po.deliverySlipDate || '';
    if (supplierEl) supplierEl.textContent = po.supplier || '';
    if (recipientEl) recipientEl.textContent = getCompanyAddress();
    
    // å¡«å……é€è´§å•æ˜ç»†
    const tbody = document.getElementById('deliverySlipDetails');
    if (tbody) {
      tbody.innerHTML = '';
      po.deliveryDetails?.forEach((detail, index) => {
        const product = data.products.find(p => p.sku === detail.sku);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${product ? getProductImage(product.image) : ''}</td>
          <td>${detail.sku}</td>
          <td>${product ? product.name : detail.sku}</td>
          <td>${detail.quantity}</td>
          <td>
            <input type="number" value="${detail.deliveredQuantity}" min="0" max="${detail.quantity}" 
                   onchange="updateDeliveredQuantity('${poId}', ${index}, this.value)"
                   style="width:80px;padding:4px;border:1px solid #ddd;border-radius:4px;">
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // å­˜å‚¨å½“å‰å¤„ç†çš„é‡‡è´­è®¢å•ID
    window.currentDeliverySlipPOId = poId;
  }
}

function closeDeliverySlipModal() {
  const modal = document.getElementById('deliverySlipModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
  }
}

function closeDeliverySlipPreviewModal() {
  const modal = document.getElementById('deliverySlipPreviewModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
  }
}

function updateDeliveredQuantity(poId, detailIndex, value) {
  const po = data.pos.find(p => p.id === poId);
  if (po && po.deliveryDetails && po.deliveryDetails[detailIndex]) {
    po.deliveryDetails[detailIndex].deliveredQuantity = parseInt(value) || 0;
  }
}

function getCompanyAddress() {
  return 'å…¬å¸åœ°å€ï¼šå¹¿ä¸œçœæ·±åœ³å¸‚XXåŒºXXè¡—é“XXå·';
}

// è´¨æ£€æ ‡å‡†ç®¡ç†æ¨¡æ€æ¡†
function openQualityModal(poId) {
  const po = data.pos.find(p => p.id === poId);
  if (!po) return;
  
  const modal = document.getElementById('qualityModal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.style.display = '';
    
    // å¡«å……ç°æœ‰è´¨æ£€æ ‡å‡†
    const inspectionTypeEl = document.getElementById('qualityInspectionType');
    const reportUploadEl = document.getElementById('qualityReportUpload');
    const contractUploadEl = document.getElementById('moldContractUpload');
    
    if (inspectionTypeEl) {
      inspectionTypeEl.value = po.qualityInspectionType || '';
    }
    
    // å­˜å‚¨å½“å‰å¤„ç†çš„é‡‡è´­è®¢å•ID
    window.currentQualityPOId = poId;
  }
}

function closeQualityModal() {
  const modal = document.getElementById('qualityModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
  }
}

function saveQualityStandards() {
  const po = data.pos.find(p => p.id === window.currentQualityPOId);
  if (!po) return;
  
  const inspectionType = document.getElementById('qualityInspectionType').value;
  
  po.qualityInspectionType = inspectionType;
  po.qualityStandards = {
    inspectionType: inspectionType,
    setupDate: new Date().toISOString().split('T')[0]
  };
  
  showToast('è´¨æ£€æ ‡å‡†å·²ä¿å­˜', 'success');
  closeQualityModal();
  renderPurchaseOrders();
}

function uploadQualityReport() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.pdf,.jpg,.png';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const po = data.pos.find(p => p.id === window.currentQualityPOId);
      if (po) {
        if (!po.qualityReports) po.qualityReports = [];
        po.qualityReports.push({
          name: file.name,
          type: 'ä¾›åº”å•†è‡ªæ£€å“è´¨æŠ¥å‘Š',
          uploadTime: new Date().toLocaleString(),
          uploadedBy: currentUser
        });
        showToast('ä¾›åº”å•†è‡ªæ£€å“è´¨æŠ¥å‘Šå·²ä¸Šä¼ ', 'success');
      }
    }
  };
  input.click();
}

function uploadMoldContract() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.pdf,.doc,.docx';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const po = data.pos.find(p => p.id === window.currentQualityPOId);
      if (po) {
        po.moldContract = {
          name: file.name,
          uploadTime: new Date().toLocaleString(),
          uploadedBy: currentUser,
          notes: 'è¿”æ¨¡å…·è´¹åˆåŒ'
        };
        showToast('è¿”æ¨¡å…·è´¹åˆåŒå·²ä¸Šä¼ ', 'success');
      }
    }
  };
  input.click();
}

// æ‰“å°å‘è´§å•åŠŸèƒ½
function printDeliverySlip() {
  // é¦–å…ˆå°è¯•åœ¨é‡‡è´­è®¡åˆ’ä¸­æŸ¥æ‰¾
  let po = data.pos.find(p => p.id === window.currentDeliverySlipPOId);
  
  // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•åœ¨é‡‡è´­è®¢å•ä¸­æŸ¥æ‰¾
  if (!po) {
    po = data.purchaseOrders.find(p => p.id === window.currentDeliverySlipPOId);
  }
  
  if (!po) return;
  
  // åˆ¤æ–­æ˜¯å¦ä¸ºé‡‡è´­è®¢å•ï¼ˆæ²¡æœ‰å‘è´§å•å­—æ®µï¼‰
  const isPurchaseOrder = !po.deliveryDetails;
  const deliveryDetails = po.deliveryDetails || (po.lines ? po.lines.map(line => ({
    sku: line.sku,
    quantity: line.qty || line.quantity,
    deliveredQuantity: line.qty || line.quantity // é»˜è®¤å…¨éƒ¨äº¤ä»˜
  })) : []);
  
  const deliverySlipId = po.deliverySlipId || po.id;
  const deliverySlipQueryCode = po.deliverySlipQueryCode || 'N/A';
  const deliverySlipDate = po.deliverySlipDate || new Date().toISOString().split('T')[0];
  
  const printContent = `
    <div style="padding:20px;font-family:Arial,sans-serif;">
      <h2 style="text-align:center;margin-bottom:20px;">å‘è´§å•</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px;">
        <div><strong>å‘è´§å•å·ï¼š</strong>${deliverySlipId}</div>
        <div><strong>æŸ¥è¯¢ç ï¼š</strong>${deliverySlipQueryCode}</div>
        <div><strong>æ—¥æœŸï¼š</strong>${deliverySlipDate}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
        <div><strong>ä¾›åº”å•†ï¼š</strong>${po.supplier}</div>
        <div><strong>æ”¶è´§åœ°å€ï¼š${getCompanyAddress()}</div>
      </div>
      
      <h3 style="margin-bottom:10px;">é€è´§å•æ˜ç»†</h3>
      <table style="width:100%;border-collapse:collapse;margin-bottom:30px;">
        <thead>
          <tr style="border-bottom:2px solid #333;">
            <th style="padding:8px;text-align:left;">SKU</th>
            <th style="padding:8px;text-align:left;">å“å</th>
            <th style="padding:8px;text-align:center;">é‡‡è´­æ•°</th>
            <th style="padding:8px;text-align:center;">é€è´§æ•°</th>
          </tr>
        </thead>
        <tbody>
          ${deliveryDetails.map(detail => {
            const product = data.products.find(p => p.sku === detail.sku);
            return `
              <tr style="border-bottom:1px solid #ddd;">
                <td style="padding:8px;">${detail.sku}</td>
                <td style="padding:8px;">${product ? product.name : detail.sku}</td>
                <td style="padding:8px;text-align:center;">${detail.quantity}</td>
                <td style="padding:8px;text-align:center;">${detail.deliveredQuantity || detail.quantity}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:50px;margin-top:50px;">
        <div style="text-align:center;">
          <div style="border-bottom:1px solid #333;padding-bottom:8px;margin-bottom:20px;">
            <strong>é€è´§å•ä½åŠç»æ‰‹äººï¼ˆç›–ç« ï¼‰</strong>
          </div>
          <div style="height:60px;"></div>
        </div>
        <div style="text-align:center;">
          <div style="border-bottom:1px solid #333;padding-bottom:8px;margin-bottom:20px;">
            <strong>æ”¶è´§å•ä½åŠç»æ‰‹äººï¼ˆç›–ç« ï¼‰</strong>
          </div>
          <div style="height:60px;"></div>
        </div>
      </div>
    </div>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printContent);
  printWindow.document.close();
  printWindow.print();
  printWindow.close();
  
  showToast('å‘è´§å•å·²å‘é€åˆ°æ‰“å°æœº', 'success');
}

// é¢„è§ˆå‘è´§å•åŠŸèƒ½
function previewDeliverySlip() {
  // é¦–å…ˆå°è¯•åœ¨é‡‡è´­è®¡åˆ’ä¸­æŸ¥æ‰¾
  let po = data.pos.find(p => p.id === window.currentDeliverySlipPOId);
  
  // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•åœ¨é‡‡è´­è®¢å•ä¸­æŸ¥æ‰¾
  if (!po) {
    po = data.purchaseOrders.find(p => p.id === window.currentDeliverySlipPOId);
  }
  
  if (!po) return;
  
  // åˆ¤æ–­æ˜¯å¦ä¸ºé‡‡è´­è®¢å•ï¼ˆæ²¡æœ‰å‘è´§å•å­—æ®µï¼‰
  const isPurchaseOrder = !po.deliveryDetails;
  const deliveryDetails = po.deliveryDetails || (po.lines ? po.lines.map(line => ({
    sku: line.sku,
    quantity: line.qty || line.quantity,
    deliveredQuantity: line.qty || line.quantity // é»˜è®¤å…¨éƒ¨äº¤ä»˜
  })) : []);
  
  const deliverySlipId = po.deliverySlipId || po.id;
  const deliverySlipQueryCode = po.deliverySlipQueryCode || 'N/A';
  const deliverySlipDate = po.deliverySlipDate || new Date().toISOString().split('T')[0];
  
  const previewContent = `
    <div style="padding:20px;font-family:Arial,sans-serif;max-width:800px;margin:0 auto;">
      <h2 style="text-align:center;margin-bottom:20px;">å‘è´§å•é¢„è§ˆ</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px;">
        <div><strong>å‘è´§å•å·ï¼š</strong>${deliverySlipId}</div>
        <div><strong>æŸ¥è¯¢ç ï¼š</strong>${deliverySlipQueryCode}</div>
        <div><strong>æ—¥æœŸï¼š</strong>${deliverySlipDate}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
        <div><strong>ä¾›åº”å•†ï¼š</strong>${po.supplier}</div>
        <div><strong>æ”¶è´§åœ°å€ï¼š</strong>${getCompanyAddress()}</div>
      </div>
      
      <h3 style="margin-bottom:10px;">é€è´§å•æ˜ç»†</h3>
      <table style="width:100%;border-collapse:collapse;margin-bottom:30px;border:1px solid #ddd;">
        <thead>
          <tr style="border-bottom:2px solid #333;background-color:#f5f5f5;">
            <th style="padding:12px;text-align:left;border:1px solid #ddd;">SKU</th>
            <th style="padding:12px;text-align:left;border:1px solid #ddd;">å“å</th>
            <th style="padding:12px;text-align:center;border:1px solid #ddd;">é‡‡è´­æ•°</th>
            <th style="padding:12px;text-align:center;border:1px solid #ddd;">é€è´§æ•°</th>
          </tr>
        </thead>
        <tbody>
          ${deliveryDetails.map(detail => {
            const product = data.products.find(p => p.sku === detail.sku);
            return `
              <tr style="border-bottom:1px solid #ddd;">
                <td style="padding:12px;border:1px solid #ddd;">${detail.sku}</td>
                <td style="padding:12px;border:1px solid #ddd;">${product ? product.name : detail.sku}</td>
                <td style="padding:12px;text-align:center;border:1px solid #ddd;">${detail.quantity}</td>
                <td style="padding:12px;text-align:center;border:1px solid #ddd;">${detail.deliveredQuantity || detail.quantity}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:50px;margin-top:50px;">
        <div style="text-align:center;">
          <div style="border-bottom:1px solid #333;padding-bottom:8px;margin-bottom:20px;">
            <strong>é€è´§å•ä½åŠç»æ‰‹äººï¼ˆç›–ç« ï¼‰</strong>
          </div>
          <div style="height:60px;border:1px dashed #ccc;display:flex;align-items:center;justify-content:center;color:#999;">
            ç­¾ç« å¤„
          </div>
        </div>
        <div style="text-align:center;">
          <div style="border-bottom:1px solid #333;padding-bottom:8px;margin-bottom:20px;">
            <strong>æ”¶è´§å•ä½åŠç»æ‰‹äººï¼ˆç›–ç« ï¼‰</strong>
          </div>
          <div style="height:60px;border:1px dashed #ccc;display:flex;align-items:center;justify-content:center;color:#999;">
            ç­¾ç« å¤„
          </div>
        </div>
      </div>
      
      <div style="margin-top:30px;padding-top:20px;border-top:1px solid #ddd;text-align:center;color:#666;font-size:14px;">
        <p>é¢„è§ˆæ¨¡å¼ - æ­¤ä¸ºå‘è´§å•é¢„è§ˆç‰ˆæœ¬</p>
        <p>ç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString()}</p>
      </div>
    </div>
  `;
  
  // ä½¿ç”¨æ ‡å‡†é¢„è§ˆæ¨¡æ€æ¡†
  const previewModal = document.getElementById('deliverySlipPreviewModal');
  const previewContentDiv = document.getElementById('deliverySlipPreviewContent');
  
  if (previewModal && previewContentDiv) {
    previewContentDiv.innerHTML = previewContent;
    previewModal.classList.remove('hidden');
    previewModal.style.display = '';
  }
  
  showToast('å‘è´§å•é¢„è§ˆå·²æ‰“å¼€', 'success');
}

// é‡‡è´­è®¢å•é¢„è§ˆå‘è´§å•åŠŸèƒ½
function previewPurchaseOrderDeliverySlip(orderId) {
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) {
    showToast('é‡‡è´­è®¢å•ä¸å­˜åœ¨', 'error');
    return;
  }
  
  // è®¾ç½®å½“å‰å‘è´§å•IDä»¥ä¾›é¢„è§ˆä½¿ç”¨
  window.currentDeliverySlipPOId = orderId;
  
  // è°ƒç”¨ç°æœ‰çš„é¢„è§ˆåŠŸèƒ½
  previewDeliverySlip();
}

// é‡‡è´­è®¢å•è¯¦æƒ…é¡µé¢„è§ˆå‘è´§å•åŠŸèƒ½
function previewPODeliverySlip(poId) {
  const po = data.pos.find(p => p.id === poId);
  if (!po) {
    showToast('é‡‡è´­è®¡åˆ’ä¸å­˜åœ¨', 'error');
    return;
  }
  
  // è®¾ç½®å½“å‰å‘è´§å•IDä»¥ä¾›é¢„è§ˆä½¿ç”¨
  window.currentDeliverySlipPOId = poId;
  
  // è°ƒç”¨ç°æœ‰çš„é¢„è§ˆåŠŸèƒ½
  previewDeliverySlip();
}

// é‡‡è´­è®¢å•è¯¦æƒ…é¡µæ‰“å°å‘è´§å•åŠŸèƒ½
function printPurchaseOrderDeliverySlip(orderId) {
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) {
    showToast('é‡‡è´­è®¢å•ä¸å­˜åœ¨', 'error');
    return;
  }
  
  // è®¾ç½®å½“å‰å‘è´§å•IDä»¥ä¾›æ‰“å°ä½¿ç”¨
  window.currentDeliverySlipPOId = orderId;
  
  // è°ƒç”¨ç°æœ‰çš„æ‰“å°åŠŸèƒ½
  printDeliverySlip();
}

function printPODeliverySlip(poId) {
  const po = data.pos.find(p => p.id === poId);
  if (!po || !po.deliverySlipGenerated) {
    showToast('å‘è´§å•ä¸å­˜åœ¨æˆ–æœªç”Ÿæˆ', 'error');
    return;
  }
  
  // è®¾ç½®å½“å‰å‘è´§å•IDä»¥ä¾›æ‰“å°ä½¿ç”¨
  window.currentDeliverySlipPOId = poId;
  
  // è°ƒç”¨ç°æœ‰çš„æ‰“å°åŠŸèƒ½
  printDeliverySlip();
}

// ä¸‹è½½å‘è´§å•PDFåŠŸèƒ½
function downloadDeliverySlipPDF() {
  // é¦–å…ˆå°è¯•åœ¨é‡‡è´­è®¡åˆ’ä¸­æŸ¥æ‰¾
  let po = data.pos.find(p => p.id === window.currentDeliverySlipPOId);
  
  // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•åœ¨é‡‡è´­è®¢å•ä¸­æŸ¥æ‰¾
  if (!po) {
    po = data.purchaseOrders.find(p => p.id === window.currentDeliverySlipPOId);
  }
  
  if (!po) return;
  
  showToast('PDFç”Ÿæˆä¸­ï¼Œè¯·ç¨å€™...', 'info');
  
  setTimeout(() => {
    // æ¨¡æ‹ŸPDFä¸‹è½½
    const pdfName = `å‘è´§å•_${po.deliverySlipId}_${new Date().toISOString().split('T')[0]}.pdf`;
    const dummyPDFContent = `PDFå†…å®¹æ¨¡æ‹Ÿï¼šå‘è´§å• ${po.deliverySlipId}`;
    
    const blob = new Blob([dummyPDFContent], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = pdfName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast(`${pdfName} ä¸‹è½½å®Œæˆ`, 'success');
  }, 1500);
}

// åˆåŒç”Ÿæˆå’Œæ‰“å°åŠŸèƒ½
function generateContractAndPrint(poId) {
  const po = data.pos.find(p => p.id === poId);
  if (!po) return;
  
  // ç”ŸæˆåˆåŒç¼–å·
  const contractId = 'CON-' + new Date().toISOString().slice(0, 10).replace(/-/g, '') + '-' + Math.floor(Math.random() * 1000);
  
  const contractContent = `
    <div style="padding:40px;font-family:Arial,sans-serif;max-width:800px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:40px;">
        <h1 style="margin-bottom:10px;">é‡‡è´­åˆåŒ</h1>
        <div style="font-size:18px;color:#666;">åˆåŒç¼–å·ï¼š${contractId}</div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:40px;">
        <div>
          <strong>ç”²æ–¹ï¼ˆé‡‡è´­æ–¹ï¼‰ï¼š</strong><br>
          å…¬å¸åç§°ï¼šXXæœ‰é™å…¬å¸<br>
          å…¬å¸åœ°å€ï¼š${getCompanyAddress()}<br>
          è”ç³»ç”µè¯ï¼š0755-XXXXXXXX<br>
          ç”µå­å…¬ç« ï¼šğŸ¢
        </div>
        <div>
          <strong>ä¹™æ–¹ï¼ˆä¾›åº”å•†ï¼‰ï¼š</strong><br>
          å…¬å¸åç§°ï¼š${po.supplier}<br>
          å…¬å¸åœ°å€ï¼šï¼ˆä¾›åº”å•†åœ°å€ï¼‰<br>
          è”ç³»ç”µè¯ï¼šï¼ˆä¾›åº”å•†ç”µè¯ï¼‰<br>
          æ³•å®šä»£è¡¨äººï¼šï¼ˆä¾›åº”å•†æ³•äººï¼‰
        </div>
      </div>
      
      <div style="margin-bottom:30px;">
        <h3 style="margin-bottom:15px;">é‡‡è´­äº§å“æ˜ç»†</h3>
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f5f5f5;">
              <th style="padding:10px;border:1px solid #ddd;">SKU</th>
              <th style="padding:10px;border:1px solid #ddd;">äº§å“åç§°</th>
              <th style="padding:10px;border:1px solid #ddd;">æ•°é‡</th>
              <th style="padding:10px;border:1px solid #ddd;">å•ä»·</th>
              <th style="padding:10px;border:1px solid #ddd;">æ€»ä»·</th>
            </tr>
          </thead>
          <tbody>
            ${po.lines.map(line => {
              const product = data.products.find(p => p.sku === line.sku);
              return `
                <tr>
                  <td style="padding:10px;border:1px solid #ddd;">${line.sku}</td>
                  <td style="padding:10px;border:1px solid #ddd;">${product ? product.name : line.sku}</td>
                  <td style="padding:10px;border:1px solid #ddd;text-align:center;">${line.qty}</td>
                  <td style="padding:10px;border:1px solid #ddd;text-align:right;">Â¥${line.price.toFixed(2)}</td>
                  <td style="padding:10px;border:1px solid #ddd;text-align:right;">Â¥${(line.qty * line.price).toFixed(2)}</td>
                </tr>
              `;
            }).join('')}
            <tr style="background:#f9f9f9;font-weight:bold;">
              <td colspan="4" style="padding:10px;border:1px solid #ddd;text-align:right;">æ€»è®¡ï¼š</td>
              <td style="padding:10px;border:1px solid #ddd;text-align:right;">Â¥${po.total.toFixed(2)}</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div style="margin-bottom:30px;">
        <h3 style="margin-bottom:15px;">è´¨é‡è¦æ±‚</h3>
        <div style="line-height:1.6;">
          <p>1. äº§å“è´¨é‡ç¬¦åˆå›½å®¶ç›¸å…³æ ‡å‡†åŠè¡Œä¸šè§„èŒƒ</p>
          <p>2. ä¹™æ–¹æä¾›çš„äº§å“åº”å½“æ˜¯å…¨æ–°ã€æœªä½¿ç”¨è¿‡çš„åŸè£…åˆæ ¼äº§å“</p>
          <p>3. äº§å“åŒ…è£…åº”å½“ç¬¦åˆè¿è¾“è¦æ±‚ï¼Œä¿è¯äº§å“åœ¨è¿è¾“è¿‡ç¨‹ä¸­ä¸å—æŸå</p>
          <p>4. è´¨æ£€æ ‡å‡†ï¼š${po.qualityInspectionType || 'å…¨æ£€'}</p>
        </div>
      </div>
      
      <div style="margin-bottom:40px;">
        <h3 style="margin-bottom:15px;">åŒæ–¹ç­¾ç« </h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:60px;">
          <div style="text-align:center;">
            <div style="border-bottom:1px solid #333;padding-bottom:8px;margin-bottom:40px;">
              <strong>ç”²æ–¹ï¼ˆç›–ç« ï¼‰</strong>
            </div>
            <div>æ³•å®šä»£è¡¨äººæˆ–æˆæƒä»£è¡¨ï¼š</div>
            <div style="margin-top:20px;">æ—¥æœŸï¼š${new Date().toLocaleDateString()}</div>
          </div>
          <div style="text-align:center;">
            <div style="border-bottom:1px solid #333;padding-bottom:8px;margin-bottom:40px;">
              <strong>ä¹™æ–¹ï¼ˆç›–ç« ï¼‰</strong>
            </div>
            <div>æ³•å®šä»£è¡¨äººæˆ–æˆæƒä»£è¡¨ï¼š</div>
            <div style="margin-top:20px;">æ—¥æœŸï¼š${new Date().toLocaleDateString()}</div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // æ‰“å¼€æ–°çª—å£æ˜¾ç¤ºåˆåŒ
  const contractWindow = window.open('', '_blank');
  contractWindow.document.write(contractContent);
  contractWindow.document.close();
  
  // æ›´æ–°é‡‡è´­è®¢å•ä¿¡æ¯
  po.contractId = contractId;
  po.contractGenerated = true;
  po.contractDate = new Date().toISOString().split('T')[0];
  
  renderPurchaseOrders();
  showToast('é‡‡è´­åˆåŒå·²ç”Ÿæˆå¹¶åŠ ç›–ç”µå­å…¬ç« ï¼Œå¯ç›´æ¥æ‰“å°', 'success');
}

/* ========= ç”¨æˆ·è§’è‰²ç®¡ç† ========== */
const userRoles = {
  'é‡‡è´­å‘˜å¼ ': { role: 'é‡‡è´­å‘˜', permissions: ['create_po', 'view_suppliers', 'view_products', 'view_1688', 'view_cost'] },
  'é‡‡è´­å‘˜ç‹': { role: 'é‡‡è´­å‘˜', permissions: ['create_po', 'view_suppliers', 'view_products', 'view_1688', 'view_cost'] },
  'è€æ¿æ': { role: 'è€æ¿', permissions: ['*'] }, // å…¨éƒ¨æƒé™
  'ä»“åº“ç®¡ç†å‘˜': { role: 'ä»“åº“ç®¡ç†å‘˜', permissions: ['inventory_in', 'inventory_out', 'print_labels'] },
  'é”€å”®å‘˜': { role: 'é”€å”®å‘˜', permissions: ['create_so', 'view_customers'] }
};

let currentUser = 'è€æ¿æ'; // å½“å‰ç™»å½•ç”¨æˆ·

function hasPermission(permission) {
  const user = userRoles[currentUser];
  if (!user) return false;
  return user.permissions.includes('*') || user.permissions.includes(permission);
}

// Ensure admin has approve_po permission
userRoles['è€æ¿æ'].permissions.push('approve_po');

/* ========= æ¨¡æ‹Ÿæ•°æ® ========== */
const data = {
  products: [
    { 
      sku: 'SKU001', 
      name: 'Wireless Mouse', 
      model: 'WM-200Pro', 
      type: 'æ™®å“', 
      classification: 'æˆå“',
      subClassification: 'å¤–é‡‡-å…¥åº“---é”€å”®',
      stock: 120, 
      carton: '20/ç®±', 
      channel:['AMZ'], 
      category: '3Cç±»',
      description: 'é«˜ç²¾åº¦æ— çº¿é¼ æ ‡ï¼Œ2.4Gè¿æ¥ï¼Œäººä½“å·¥å­¦è®¾è®¡',
      deliveryTime: '7å¤©',
      createdDate: '2025-10-15 14:30:25',
      modifiedDate: '2025-10-28 09:15:42',
      sales30d: 85,
      sales10d: 28,
      purchasing: {
        purchaser: 'é‡‡è´­å‘˜å¼ ',
        deliveryTime: '7å¤©',
        cost: 10.5,
        notes: 'å­£åº¦å›ºå®šé‡‡è´­ï¼Œå“è´¨ç¨³å®š',
        link1688: 'https://detail.1688.com/offer/807896461298.html?offerId=807896461298&spm=a260k.home2025.recommendpart.21'
      },
      image: 'mouse',
      quality: {
        standard: 'å…¨æ£€',
        requirements: 'å¤–è§‚æ— åˆ’ç—•ï¼ŒåŠŸèƒ½æµ‹è¯•é€šè¿‡',
        passed: true
      }
    },
    { 
      sku: 'SKU002', 
      name: 'Controller Combo', 
      model: 'CC-500', 
      type: 'ç»„åˆ', 
      classification: 'æˆå“',
      subClassification: 'å¤–é‡‡-å…¥åº“---é”€å”®',
      stock: 40, 
      carton: '10/ç®±', 
      channel:['MKD'],
      category: '3Cç±»',
      description: 'æ¸¸æˆæ‰‹æŸ„ç»„åˆåŒ…ï¼Œå«æ‰‹æŸ„å’Œæ•°æ®çº¿',
      deliveryTime: '10å¤©',
      createdDate: '2025-10-01 11:20:15',
      modifiedDate: '2025-10-27 16:45:30',
      sales30d: 35,
      sales10d: 12,
      purchasing: {
        purchaser: 'é‡‡è´­å‘˜ç‹',
        deliveryTime: '10å¤©',
        cost: 25.0,
        notes: 'ç»„åˆäº§å“ï¼Œéœ€è¦å…³æ³¨åº“å­˜åè°ƒ',
        link1688: 'https://1688.com/product/controller-combo-002'
      },
      image: 'controller',
      quality: {
        standard: 'æŠ½æ£€',
        requirements: 'é…ä»¶é½å…¨ï¼ŒåŒ…è£…å®Œå¥½',
        passed: true
      },
      bom: [
        { component_sku: 'SKU005', component_name: 'Wireless Controller', quantity: 1 },
        { component_sku: 'SKU006', component_name: 'USB Cable', quantity: 1 }
      ]
    },
    { 
      sku: 'SKU003', 
      name: 'Baby Bottle', 
      model: 'BB-300', 
      type: 'æ™®å“', 
      classification: 'æˆå“',
      subClassification: 'å¤–é‡‡-å…¥åº“---é”€å”®',
      stock: 300, 
      carton: '50/ç®±', 
      channel:['1688'],
      category: 'æ¯å©´',
      description: 'å®½å£å¾„å¥¶ç“¶ï¼ŒBPA freeï¼Œé˜²èƒ€æ°”è®¾è®¡',
      deliveryTime: '5å¤©',
      createdDate: '2025-09-20 08:10:33',
      modifiedDate: '2025-10-26 13:22:18',
      sales30d: 120,
      sales10d: 45,
      purchasing: {
        purchaser: 'é‡‡è´­å‘˜å¼ ',
        deliveryTime: '5å¤©',
        cost: 3.2,
        notes: 'çƒ­é”€äº§å“ï¼Œå»ºè®®ä¿æŒå®‰å…¨åº“å­˜',
        link1688: 'https://1688.com/product/baby-bottle-003'
      },
      image: 'bottle',
      quality: {
        standard: 'å…¨æ£€',
        requirements: 'æ— å¼‚å‘³ï¼Œå¯†å°æ€§æµ‹è¯•',
        passed: true
      }
    },
    { 
      sku: 'SKU004', 
      name: 'Phone Chain', 
      model: 'PC-100', 
      type: 'æ™®å“', 
      classification: 'æˆå“',
      subClassification: 'å¤–é‡‡-å…¥åº“---é”€å”®',
      stock: 8, 
      carton: '200/ç®±', 
      channel:['çº¿ä¸‹'],
      category: '3Cç±»',
      description: 'ç¡…èƒ¶æ‰‹æœºæŒ‚ç»³ï¼Œå¤šè‰²å¯é€‰',
      deliveryTime: '3å¤©',
      createdDate: '2025-10-05 15:40:12',
      modifiedDate: '2025-10-25 10:35:55',
      sales30d: 95,
      sales10d: 32,
      purchasing: {
        purchaser: 'é‡‡è´­å‘˜ç‹',
        deliveryTime: '3å¤©',
        cost: 0.8,
        notes: 'è¡¥è´§ç´§æ€¥ï¼Œä¾›åº”å•†å“åº”å¿«',
        link1688: 'https://1688.com/product/phone-chain-004'
      },
      image: 'chain',
      quality: {
        standard: 'æŠ½æ£€',
        requirements: 'æ— æ˜æ˜¾ç‘•ç–µï¼Œé¢œè‰²ä¸€è‡´æ€§',
        passed: true
      }
    },
    { 
      sku: 'SKU005', 
      name: 'Wireless Controller', 
      model: 'WC-400', 
      type: 'æ™®å“', 
      classification: 'åŠæˆå“',
      subClassification: 'å¯ä»¥ç›´æ¥å•å“é”€å”®',
      stock: 60, 
      carton: '30/ç®±', 
      channel:['AMZ'],
      category: 'æ¸¸æˆ',
      description: 'æ— çº¿æ¸¸æˆæ‰‹æŸ„ï¼Œæ”¯æŒå¤šå¹³å°',
      deliveryTime: '14å¤©',
      createdDate: '2025-10-10 09:25:47',
      modifiedDate: '2025-10-24 14:18:33',
      sales30d: 55,
      sales10d: 18,
      purchasing: {
        purchaser: 'é‡‡è´­å‘˜å¼ ',
        deliveryTime: '14å¤©',
        cost: 18.0,
        notes: 'è¿›å£èŠ¯ç‰‡ï¼Œè´§æœŸè¾ƒé•¿',
        link1688: 'https://1688.com/product/wireless-controller-005'
      },
      image: 'gamepad',
      quality: {
        standard: 'å…¨æ£€',
        requirements: 'æŒ‰é”®åŠŸèƒ½æµ‹è¯•ï¼Œè¿æ¥ç¨³å®šæ€§',
        passed: true
      }
    },
    { 
      sku: 'SKU006', 
      name: 'USB Cable', 
      model: 'UC-200', 
      type: 'æ™®å“', 
      classification: 'ç‰©æ–™',
      subClassification: 'æ¥æ–™ç”Ÿäº§ç±»å‹',
      stock: 200, 
      carton: '100/ç®±', 
      channel:['1688'],
      category: '3Cç±»',
      description: 'USBæ•°æ®çº¿ï¼Œå¿«é€Ÿå……ç”µ',
      deliveryTime: '5å¤©',
      createdDate: '2025-09-25 16:55:21',
      modifiedDate: '2025-10-23 11:42:09',
      sales30d: 180,
      sales10d: 65,
      purchasing: {
        purchaser: 'é‡‡è´­å‘˜ç‹',
        deliveryTime: '5å¤©',
        cost: 3.5,
        notes: 'è€—æç±»äº§å“ï¼Œé”€é‡ç¨³å®š',
        link1688: 'https://1688.com/product/usb-cable-006'
      },
      image: 'cable',
      quality: {
        standard: 'æŠ½æ£€',
        requirements: 'å……ç”µé€Ÿåº¦æµ‹è¯•ï¼Œçº¿æå¼ºåº¦',
        passed: true
      }
    },
    { 
      sku: 'SKU007', 
      name: 'æ¸¸æˆæ‰‹æŸ„å¤–å£³', 
      model: 'GC-100', 
      type: 'ç”Ÿäº§', 
      classification: 'åŠæˆå“',
      subClassification: 'éœ€è¦ç»„åˆé”€å”®',
      stock: 150, 
      carton: '100/ç®±', 
      channel:['å†…éƒ¨'],
      category: 'æ¸¸æˆ',
      description: 'æ¸¸æˆæ‰‹æŸ„å¤–å£³ç»„ä»¶ï¼Œéœ€ä¸å…¶ä»–ç»„ä»¶ç»„åˆ',
      deliveryTime: '15å¤©',
      createdDate: '2025-09-15 10:20:45',
      modifiedDate: '2025-10-22 14:30:12',
      sales30d: 0,
      sales10d: 0,
      image: 'gamepad',
      quality: {
        standard: 'å…¨æ£€',
        requirements: 'å°ºå¯¸ç²¾åº¦ï¼Œå¤–è§‚è´¨é‡',
        passed: true
      }
    },
    { 
      sku: 'SKU008', 
      name: 'å½©ç›’åŒ…è£…', 
      model: 'CB-200', 
      type: 'æ™®å“', 
      classification: 'åŒ…è£…è¾…æ–™',
      subClassification: 'å½©ç›’',
      stock: 500, 
      carton: '200/ç®±', 
      channel:['å†…éƒ¨'],
      category: 'å®¶å±…',
      description: 'äº§å“å½©ç›’åŒ…è£…ï¼Œå¤šç§å°ºå¯¸å¯é€‰',
      deliveryTime: '3å¤©',
      createdDate: '2025-10-08 09:15:30',
      modifiedDate: '2025-10-21 16:20:55',
      sales30d: 0,
      sales10d: 0,
      image: 'box',
      quality: {
        standard: 'æŠ½æ£€',
        requirements: 'å°åˆ·è´¨é‡ï¼Œå°ºå¯¸å‡†ç¡®æ€§',
        passed: true
      }
    },
    { 
      sku: 'SKU009', 
      name: 'ç”µå­å…ƒä»¶', 
      model: 'EC-300', 
      type: 'ç”Ÿäº§', 
      classification: 'ç‰©æ–™',
      subClassification: 'æ¥æ–™ç”Ÿäº§ç±»å‹',
      stock: 1000, 
      carton: '500/ç®±', 
      channel:['å†…éƒ¨'],
      category: '3Cç±»',
      description: 'ç”µè·¯æ¿ç”µå­å…ƒä»¶ï¼Œç”¨äºç”Ÿäº§ç»„è£…',
      deliveryTime: '20å¤©',
      createdDate: '2025-09-10 13:45:20',
      modifiedDate: '2025-10-20 11:10:33',
      sales30d: 0,
      sales10d: 0,
      image: 'chip',
      quality: {
        standard: 'å…¨æ£€',
        requirements: 'ç”µæ°”æ€§èƒ½æµ‹è¯•ï¼Œå¤–è§‚æ£€æŸ¥',
        passed: true
      }
    },
    { 
      sku: 'SKU010', 
      name: 'å¤–åŒ…è£…ç®±', 
      model: 'OC-400', 
      type: 'æ™®å“', 
      classification: 'åŒ…è£…è¾…æ–™',
      subClassification: 'å¤–ç®±',
      stock: 300, 
      carton: '50/ç®±', 
      channel:['å†…éƒ¨'],
      category: 'å®¶å±…',
      description: 'ç“¦æ¥çº¸å¤–åŒ…è£…ç®±ï¼Œé«˜å¼ºåº¦',
      deliveryTime: '5å¤©',
      createdDate: '2025-10-12 15:30:10',
      modifiedDate: '2025-10-19 09:25:45',
      sales30d: 0,
      sales10d: 0,
      image: 'carton',
      quality: {
        standard: 'æŠ½æ£€',
        requirements: 'æ‰¿é‡æµ‹è¯•ï¼Œå°ºå¯¸æ£€æŸ¥',
        passed: true
      }
    }
  ],
  suppliers: [
    { 
      id:'S001', 
      name:'Shenzhen Parts Co.', 
      contact:'Li Wei', 
      phone:'13800000001', 
      settle:'æœˆç»“',
      starRating: 4,
      scale: 'ä¸­å‹',
      category: 'ç”µå­å…ƒå™¨ä»¶',
      wechat: 'liwei_parts',
      companyPhone: '0755-12345678',
      taxType: 'ä¸“ç¥¨',
      taxRate: 13,
      createdAt: '2023-01-15T08:00:00.000Z',
      updatedAt: '2023-10-01T10:30:00.000Z'
    },
    { 
      id:'S002', 
      name:'Guangzhou Packaging', 
      contact:'Zhang San', 
      phone:'13800000002', 
      settle:'ç°ç»“',
      starRating: 5,
      scale: 'å¤§å‹',
      category: 'åŒ…è£…ææ–™',
      wechat: 'zhangsan_pkg',
      companyPhone: '020-87654321',
      taxType: 'ä¸“ç¥¨',
      taxRate: 13,
      createdAt: '2023-02-20T09:15:00.000Z',
      updatedAt: '2023-09-28T14:20:00.000Z'
    }
  ],
  pos: [
    { id:'PO20231001', supplier:'Shenzhen Parts Co.', items:3, total:520, status:'å¾…æ”¶è´§', lines: [{sku:'SKU001',qty:20,price:10.5}], 
      applicant:'é‡‡è´­å‘˜å¼ ', applyDate:'2023-10-01', approver:'è€æ¿æ', approveDate:'2023-10-01', rejectReason:'' },
    { id:'PO20231002', supplier:'Guangzhou Packaging', items:1, total:80, status:'å·²å®Œæˆ', lines: [{sku:'SKU002',qty:2,price:40}],
      applicant:'é‡‡è´­å‘˜ç‹', applyDate:'2023-09-28', approver:'è€æ¿æ', approveDate:'2023-09-29', rejectReason:'' },
    { id:'PO20231003', supplier:'Shenzhen Parts Co.', items:2, total:180, status:'å¾…å®¡æ ¸', lines: [{sku:'SKU005',qty:5,price:18}],
      applicant:'é‡‡è´­å‘˜å¼ ', applyDate:'2023-10-05', approver:'', approveDate:'', rejectReason:'' }
  ],
  purchaseOrders: [
    // å®¡æ‰¹é€šè¿‡åä»é‡‡è´­è®¡åˆ’è½¬ä¸ºé‡‡è´­è®¢å•
    { 
      id:'POD20231001', 
      sourcePOId:'PO20231001',
      supplier:'Shenzhen Parts Co.', 
      status:'å¾…ä¾›åº”å•†ç¡®è®¤',
      lines: [
        {sku:'SKU001', qty:20, price:10.5, deliveryDate:'2023-10-15', confirmedQty:20, confirmedDate:'2023-10-02'}
      ],
      totalAmount:210,
      purchaser:'é‡‡è´­å‘˜å¼ ',
      createdDate:'2023-10-01',
      estimatedDeliveryDate:'2023-10-15',
      actualDeliveryDate:'',
      signedContract:null,
      deliverySlipId:'20231001001',
      deliverySlipQueryCode:'1234',
      receiveStatus:'',
      receiveDate:'',
      receiveNotes:'',
      hasQualityIssues:false,
      warehouseNotes:'',
      invoiceReceived:false,
      paymentStatus:'å¾…ä»˜æ¬¾'
    }
  ],
  sales: [
    { 
      id:'SO20231010', 
      orderNo:'1688222212120909',
      orderType:'1688',
      customer:'1688-Order-1001', 
      contact:'ç‹å…ˆç”Ÿ',
      phone:'13800138000',
      deliveryDate:'2025-11-15',
      salesDate:'2025-11-10',
      items:[
        {
          sku:'mouse001',
          name:'æ— çº¿é¼ æ ‡',
          model:' ergonomic',
          unit:'ä¸ª',
          price:30,
          quantity:2,
          total:60,
          image:'mouse'
        },
        {
          sku:'keyboard001',
          name:'æœºæ¢°é”®ç›˜',
          model:' RGB',
          unit:'ä¸ª',
          price:30,
          quantity:2,
          total:60,
          image:'keyboard'
        }
      ], 
      total:120, 
      paymentStatus:'å·²æ”¶',
      paymentMethod:'æ”¯ä»˜å®',
      trackingNo:'SF123456789',
      status:'å·²å‘è´§',
      salesperson:'å¼ ä¸‰'
    },
    { 
      id:'SO20231011', 
      orderNo:'çº¿ä¸‹è®¢å•001',
      orderType:'offline',
      customer:'MKD-1002', 
      contact:'æå¥³å£«',
      phone:'13900139000',
      deliveryDate:'2025-11-20',
      salesDate:'2025-11-11',
      items:1, 
      total:35, 
      paymentStatus:'æœªæ”¶',
      paymentMethod:'æœˆç»“',
      trackingNo:'',
      status:'å¾…å‘è´§',
      salesperson:'æå››'
    }
  ],
  customers: [
    {
      id: 'C001',
      name: '1688-Order-1001',
      type: '1688å®¢æˆ·',
      contact: 'ç‹å…ˆç”Ÿ',
      phone: '13800138000',
      address: 'æ·±åœ³å¸‚å—å±±åŒº',
      settlementMethod: 'ç°ç»“',
      creditLimit: 0,
      createTime: '2025-10-01'
    },
    {
      id: 'C002',
      name: 'MKD-1002',
      type: 'çº¿ä¸‹åˆä½œ',
      contact: 'æå¥³å£«',
      phone: '13900139000',
      address: 'ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº',
      settlementMethod: 'æœˆç»“',
      creditLimit: 50000,
      createTime: '2025-10-05'
    }
  ],
  salesQuotes: [
    {
      id: 'Q20231010',
      customer: 'æ–°å®¢æˆ·A',
      amount: 2000,
      validUntil: '2025-12-31',
      status: 'å¾…å®¡æ‰¹',
      createDate: '2025-11-10',
      salesperson: 'å¼ ä¸‰',
      items: [
        {
          sku: 'mouse001',
          name: 'æ— çº¿é¼ æ ‡',
          model: 'ergonomic',
          image: 'mouse',
          unit: 'ä¸ª',
          quantity: 2,
          price: 30,
          total: 60
        },
        {
          sku: 'keyboard001',
          name: 'æœºæ¢°é”®ç›˜',
          model: 'RGB',
          image: 'keyboard',
          unit: 'ä¸ª',
          quantity: 2,
          price: 30,
          total: 60
        }
      ]
    },
    {
      id: 'Q20231011',
      customer: 'MKD-1002',
      amount: 3500,
      validUntil: '2025-11-30',
      status: 'å·²æ‰¹å‡†',
      createDate: '2025-11-08',
      salesperson: 'æå››',
      items: [
        {
          sku: 'monitor001',
          name: 'æ˜¾ç¤ºå™¨',
          model: '24å¯¸LED',
          image: 'monitor',
          unit: 'å°',
          quantity: 1,
          price: 1500,
          total: 1500
        },
        {
          sku: 'headphones001',
          name: 'è€³æœº',
          model: 'æ— çº¿é™å™ª',
          image: 'headphones',
          unit: 'ä¸ª',
          quantity: 2,
          price: 1000,
          total: 2000
        }
      ]
    }
  ],
  supplierQuotes: [
    {
      supplier: 'S001',
      product: 'SKU001',
      productName: 'æ¸¸æˆæ‰‹æŸ„',
      price: 25.5,
      minQty: 10,
      createDate: '2025-11-01'
    }
  ],
  deliveries: [
    {
      batchNo: 'B2023101001',
      orderNo: 'SO20231010',
      salesperson: 'å¼ ä¸‰',
      quantity: 2,
      cartonCount: 1,
      weight: 0.5,
      logisticsCompany: 'é¡ºä¸°',
      trackingNo: 'SF123456789',
      logisticsFee: 12,
      status: 'å·²å‘è´§'
    }
  ],
  returns: [
    {
      id: 'R20231010',
      originalOrderNo: 'SO20231010',
      customer: '1688-Order-1001',
      returnDate: '2025-11-12',
      amount: 60,
      reason: 'äº§å“è´¨é‡é—®é¢˜',
      status: 'å¾…å¤„ç†'
    }
  ],
  invoices: [
    {
      id: 'I20231010',
      orderNo: 'SO20231010',
      customer: '1688-Order-1001',
      amount: 120,
      requestDate: '2025-11-11',
      approvalStatus: 'å·²æ‰¹å‡†',
      invoiceStatus: 'å¾…å¼€ç¥¨'
    }
  ]
};

/* ========= åŸºç¡€æ¸²æŸ“å‡½æ•° ========== */
function $(sel){return document.querySelector(sel)}
function $all(sel){return document.querySelectorAll(sel)}

function renderStats(){
  $('#stat-skus').textContent = data.products.length;
  $('#stat-pos').textContent = data.pos.filter(p=>p.status!=='å·²å®Œæˆ').length;
  $('#stat-sales').textContent = data.sales.length;
  $('#stat-qty').textContent = data.products.reduce((s,p)=>s+p.stock,0);
  renderLowStock();
  renderCharts();
  renderFinancialOverview();
}

function renderLowStock(){
  const container = $('#lowStockList');
  container.innerHTML = '';
  const low = data.products.filter(p=>p.stock < 20);
  if(low.length===0){ container.innerHTML = '<div class="small muted">æ— ä½åº“å­˜</div>'; return; }
  low.forEach(p=>{
    const el = document.createElement('div');
    el.style.padding='8px 0';
    el.innerHTML = `<div style="display:flex;justify-content:space-between"><div>${p.sku} Â· ${p.name}</div><div class="badge">${p.stock}</div></div><div class="small muted">å»ºè®®è¡¥è´§</div>`;
    container.appendChild(el);
  });
}

function renderCharts(){
  renderInventoryChart();
  renderSalesChart();
}

function renderInventoryChart(){
  const container = $('#inventoryChart');
  container.innerHTML = '';
  const maxStock = Math.max(...data.products.map(p => p.stock));
  data.products.forEach(p => {
    const barContainer = document.createElement('div');
    barContainer.style.marginBottom = '8px';
    const percentage = (p.stock / maxStock) * 100;
    barContainer.innerHTML = `
      <div style="display:flex;justify-content:space-between;margin-bottom:4px">
        <div class="small">${p.sku}</div>
        <div class="small">${p.stock}ä»¶</div>
      </div>
      <div class="chart-bar" style="width:${percentage}%;height:24px">
        <div class="chart-label">${p.name}</div>
      </div>
    `;
    container.appendChild(barContainer);
  });
}

function renderSalesChart(){
  const container = $('#salesChart');
  container.innerHTML = '';
  const monthlyData = [
    { month: '1æœˆ', sales: 12.5, purchases: 8.3 },
    { month: '2æœˆ', sales: 15.2, purchases: 9.1 },
    { month: '3æœˆ', sales: 18.7, purchases: 11.2 },
    { month: '4æœˆ', sales: 14.3, purchases: 7.8 },
    { month: '5æœˆ', sales: 22.1, purchases: 13.5 },
    { month: '6æœˆ', sales: 19.8, purchases: 10.9 }
  ];
  
  const maxValue = Math.max(...monthlyData.map(d => Math.max(d.sales, d.purchases)));
  
  monthlyData.forEach(data => {
    const monthContainer = document.createElement('div');
    monthContainer.style.marginBottom = '12px';
    const salesPercentage = (data.sales / maxValue) * 100;
    const purchasesPercentage = (data.purchases / maxValue) * 100;
    
    monthContainer.innerHTML = `
      <div class="small" style="margin-bottom:6px">${data.month}</div>
      <div style="margin-bottom:4px">
        <div class="small" style="margin-bottom:2px">é”€å”® Â¥${data.sales}ä¸‡</div>
        <div class="chart-bar" style="width:${salesPercentage}%;height:20px;background:linear-gradient(90deg,var(--success),#22c55e)">
          <div class="chart-label">é”€å”®</div>
        </div>
      </div>
      <div>
        <div class="small" style="margin-bottom:2px">é‡‡è´­ Â¥${data.purchases}ä¸‡</div>
        <div class="chart-bar" style="width:${purchasesPercentage}%;height:20px;background:linear-gradient(90deg,var(--accent),#3b82f6)">
          <div class="chart-label">é‡‡è´­</div>
        </div>
      </div>
    `;
    container.appendChild(monthContainer);
  });
}

function renderFinancialOverview(){
  const totalPayable = data.pos.filter(p=>p.status==='å¾…æ”¶è´§').reduce((sum,p)=>sum+p.total,0);
  const totalReceivable = data.sales.filter(s=>s.status==='å¾…å‘è´§').reduce((sum,s)=>sum+s.total,0);
  const totalRevenue = data.sales.reduce((sum,s)=>sum+s.total,0);
  const totalCost = data.pos.reduce((sum,p)=>sum+p.total,0);
  const profitMargin = totalRevenue > 0 ? ((totalRevenue - totalCost) / totalRevenue * 100) : 0;
  
  const maxAmount = Math.max(totalPayable, totalReceivable, 100);
  const payablePercentage = (totalPayable / maxAmount) * 100;
  const receivablePercentage = (totalReceivable / maxAmount) * 100;
  
  const payableRing = $('#payableRing');
  const receivableRing = $('#receivableRing');
  const profitRing = $('#profitRing');
  
  payableRing.style.setProperty('--progress', `${payablePercentage * 3.6}deg`);
  payableRing.setAttribute('data-text', `Â¥${totalPayable}`);
  
  receivableRing.style.setProperty('--progress', `${receivablePercentage * 3.6}deg`);
  receivableRing.setAttribute('data-text', `Â¥${totalReceivable}`);
  
  profitRing.style.setProperty('--progress', `${profitMargin * 3.6}deg`);
  profitRing.setAttribute('data-text', `${profitMargin.toFixed(1)}%`);
}

function renderPOs(){
  const tbody = $('#table-pos tbody');
  tbody.innerHTML='';
  data.pos.forEach(po=>{
    const tr = document.createElement('tr');
    let actionButtons = `<button class="btn ghost" onclick="openDetail('po','${po.id}')">æŸ¥çœ‹</button>`;
    
    if(po.status === 'å¾…å®¡æ ¸' && hasPermission('approve_po')){
      actionButtons += ` <button class="btn" onclick="approvePO('${po.id}')">æ‰¹å‡†</button>`;
      actionButtons += ` <button class="btn ghost" style="background:var(--danger);color:white" onclick="rejectPO('${po.id}')">é©³å›</button>`;
    }
    
    tr.innerHTML = `<td>${po.id}</td><td>${po.supplier}</td><td>${po.items}</td><td>Â¥${po.total}</td><td>${po.status}</td>
      <td>${po.approver || '-'}</td><td>${actionButtons}</td>`;
    tbody.appendChild(tr);
  });
}

let currentProductType = 'all';
let currentCategory = 'all';
let currentClassification = 'all';
let currentSortField = 'modifiedDate';
let currentSortOrder = 'desc';

function showProductType(type){
  currentProductType = type;
  renderProducts();
}

function showCategory(category){
  currentCategory = category;
  renderProducts();
}

function showClassification(classification){
  currentClassification = classification;
  renderProducts();
}

function getClassificationColor(classification) {
  const colors = {
    'æˆå“': '#059669',
    'åŠæˆå“': '#dc2626',
    'ç‰©æ–™': '#7c3aed',
    'åŒ…è£…è¾…æ–™': '#ea580c'
  };
  return colors[classification] || '#6b7280';
}

function getProductImage(type) {
  const svgTemplates = {
    mouse: `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" fill="#3b82f6" rx="8"/>
      <text x="20" y="25" font-family="Arial" font-size="10" fill="white" text-anchor="middle">é¼ æ ‡</text>
    </svg>`,
    keyboard: `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" fill="#8b5cf6" rx="8"/>
      <text x="20" y="25" font-family="Arial" font-size="9" fill="white" text-anchor="middle">é”®ç›˜</text>
    </svg>`,
    monitor: `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" fill="#10b981" rx="8"/>
      <text x="20" y="25" font-family="Arial" font-size="9" fill="white" text-anchor="middle">æ˜¾ç¤ºå™¨</text>
    </svg>`,
    headphones: `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" fill="#f59e0b" rx="8"/>
      <text x="20" y="25" font-family="Arial" font-size="9" fill="white" text-anchor="middle">è€³æœº</text>
    </svg>`,
    controller: `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" fill="#10b981" rx="8"/>
      <text x="20" y="25" font-family="Arial" font-size="10" fill="white" text-anchor="middle">æ‰‹æŸ„</text>
    </svg>`,
    bottle: `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" fill="#f59e0b" rx="8"/>
      <text x="20" y="25" font-family="Arial" font-size="10" fill="white" text-anchor="middle">å¥¶ç“¶</text>
    </svg>`,
    chain: `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" fill="#8b5cf6" rx="8"/>
      <text x="20" y="25" font-family="Arial" font-size="10" fill="white" text-anchor="middle">æŒ‚ç»³</text>
    </svg>`,
    gamepad: `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" fill="#ef4444" rx="8"/>
      <text x="20" y="25" font-family="Arial" font-size="9" fill="white" text-anchor="middle">æ¸¸æˆæ‰‹æŸ„</text>
    </svg>`,
    cable: `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" fill="#06b6d4" rx="8"/>
      <text x="20" y="25" font-family="Arial" font-size="9" fill="white" text-anchor="middle">æ•°æ®çº¿</text>
    </svg>`,
    camera: `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" fill="#ef4444" rx="8"/>
      <text x="20" y="25" font-family="Arial" font-size="9" fill="white" text-anchor="middle">æ‘„åƒå¤´</text>
    </svg>`,
    box: `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" fill="#f97316" rx="8"/>
      <text x="20" y="25" font-family="Arial" font-size="9" fill="white" text-anchor="middle">å½©ç›’</text>
    </svg>`,
    chip: `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" fill="#8b5cf6" rx="8"/>
      <text x="20" y="25" font-family="Arial" font-size="9" fill="white" text-anchor="middle">å…ƒä»¶</text>
    </svg>`,
    carton: `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" fill="#84cc16" rx="8"/>
      <text x="20" y="25" font-family="Arial" font-size="9" fill="white" text-anchor="middle">çº¸ç®±</text>
    </svg>`,
    package: `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
      <rect width="40" height="40" fill="#6366f1" rx="8"/>
      <text x="20" y="25" font-family="Arial" font-size="9" fill="white" text-anchor="middle">äº§å“</text>
    </svg>`
  };
  return svgTemplates[type] || svgTemplates.package;
}

function getLargeProductImage(type, isBack = false) {
  const suffix = isBack ? ' - èƒŒé¢' : '';
  const svgTemplates = {
    mouse: {
      front: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#3b82f6" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="14" fill="white" text-anchor="middle">é¼ æ ‡æ­£é¢</text>
      </svg>`,
      back: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#1e40af" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="14" fill="white" text-anchor="middle">é¼ æ ‡èƒŒé¢</text>
      </svg>`
    },
    controller: {
      front: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#10b981" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="14" fill="white" text-anchor="middle">æ‰‹æŸ„æ­£é¢</text>
      </svg>`,
      back: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#059669" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="14" fill="white" text-anchor="middle">æ‰‹æŸ„èƒŒé¢</text>
      </svg>`
    },
    bottle: {
      front: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#f59e0b" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="14" fill="white" text-anchor="middle">å¥¶ç“¶æ­£é¢</text>
      </svg>`,
      back: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#d97706" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="14" fill="white" text-anchor="middle">å¥¶ç“¶èƒŒé¢</text>
      </svg>`
    },
    chain: {
      front: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#8b5cf6" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="14" fill="white" text-anchor="middle">æŒ‚ç»³æ­£é¢</text>
      </svg>`,
      back: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#7c3aed" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="14" fill="white" text-anchor="middle">æŒ‚ç»³èƒŒé¢</text>
      </svg>`
    },
    gamepad: {
      front: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#ef4444" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="13" fill="white" text-anchor="middle">æ‰‹æŸ„æ­£é¢</text>
      </svg>`,
      back: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#dc2626" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="13" fill="white" text-anchor="middle">æ‰‹æŸ„èƒŒé¢</text>
      </svg>`
    },
    cable: {
      front: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#06b6d4" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="13" fill="white" text-anchor="middle">æ•°æ®çº¿æ­£é¢</text>
      </svg>`,
      back: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#0891b2" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="13" fill="white" text-anchor="middle">æ•°æ®çº¿èƒŒé¢</text>
      </svg>`
    },
    box: {
      front: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#f97316" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="13" fill="white" text-anchor="middle">å½©ç›’æ­£é¢</text>
      </svg>`,
      back: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#ea580c" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="13" fill="white" text-anchor="middle">å½©ç›’èƒŒé¢</text>
      </svg>`
    },
    chip: {
      front: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#8b5cf6" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="13" fill="white" text-anchor="middle">å…ƒä»¶æ­£é¢</text>
      </svg>`,
      back: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#7c3aed" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="13" fill="white" text-anchor="middle">å…ƒä»¶èƒŒé¢</text>
      </svg>`
    },
    carton: {
      front: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#84cc16" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="13" fill="white" text-anchor="middle">çº¸ç®±æ­£é¢</text>
      </svg>`,
      back: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#65a30d" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="13" fill="white" text-anchor="middle">çº¸ç®±èƒŒé¢</text>
      </svg>`
    },
    package: {
      front: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#6366f1" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="13" fill="white" text-anchor="middle">äº§å“æ­£é¢</text>
      </svg>`,
      back: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
        <rect width="80" height="80" fill="#4f46e5" rx="12"/>
        <text x="40" y="45" font-family="Arial" font-size="13" fill="white" text-anchor="middle">äº§å“èƒŒé¢</text>
      </svg>`
    }
  };
  const images = svgTemplates[type] || svgTemplates.mouse;
  return isBack ? images.back : images.front;
}

function sortProducts(field) {
  if (currentSortField === field) {
    currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
  } else {
    currentSortField = field;
    currentSortOrder = 'asc';
  }
  renderProducts();
}

function renderProducts(){
  const filter = $('#productFilter')?.value?.toLowerCase() || $('#globalSearch')?.value?.toLowerCase() || '';
  const tbody = $('#table-products tbody');
  tbody.innerHTML='';
  
  let filteredProducts = data.products.filter(p=>{
    const matchesFilter = p.sku.toLowerCase().includes(filter) || p.name.toLowerCase().includes(filter);
    const matchesType = currentProductType === 'all' || p.type === currentProductType;
    const matchesCategory = currentCategory === 'all' || p.category === currentCategory;
    const matchesClassification = currentClassification === 'all' || p.classification === currentClassification;
    return matchesFilter && matchesType && matchesCategory && matchesClassification;
  });
  
  // é»˜è®¤æŒ‰æœ€åä¿®æ”¹æ—¶é—´å€’åºæ’åº
  filteredProducts.sort((a, b) => {
    const fieldA = currentSortField === 'createdDate' || currentSortField === 'modifiedDate' ? 
      new Date(a[currentSortField]) : a[currentSortField];
    const fieldB = currentSortField === 'createdDate' || currentSortField === 'modifiedDate' ? 
      new Date(b[currentSortField]) : b[currentSortField];
    
    if (currentSortOrder === 'asc') {
      return fieldA > fieldB ? 1 : -1;
    } else {
      return fieldA < fieldB ? 1 : -1;
    }
  });
  
  filteredProducts.forEach(p=>{
    const tr = document.createElement('tr');
    const typeBadge = p.type === 'ç»„åˆ' ? '<span class="badge">ç»„åˆ</span>' : p.type;
    const lowStockClass = p.stock < 20 ? 'style="color:var(--danger)"' : '';
    const highSalesClass = p.sales10d > 50 ? 'style="color:var(--success)"' : '';
    
    tr.innerHTML = `
      <td><div class="product-image" onclick="openDetail('product','${p.sku}')" onmouseenter="showImagePreview(event, '${p.image}', '${p.name}')" onmouseleave="hideImagePreview()">${getProductImage(p.image)}</div></td>
      <td>${p.sku}</td>
      <td>${p.name}</td>
      <td>${p.model || '-'}</td>
      <td>${p.type}</td>
      <td>${p.category}</td>
      <td><span class="classification-tag" style="background: ${getClassificationColor(p.classification)};">${p.classification}</span></td>
      <td ${lowStockClass}>${p.stock}</td>
      <td>${p.deliveryTime}</td>
      <td ${highSalesClass}>${p.sales10d}</td>
      <td>${p.sales30d}</td>
      <td>${p.createdDate}</td>
      <td>${p.modifiedDate}</td>
      <td>
        <button class="btn ghost" onclick="openDetail('product','${p.sku}')">è¯¦æƒ…</button>
        <button class="btn primary" onclick="createPurchaseForProduct('${p.sku}')" style="margin-left: 5px;">é‡‡è´­</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

let inventoryView = 'summary';
let currentSalesView = 'orders';
let currentSalesTypeFilter = 'all';

function showInventoryView(view){
  inventoryView = view;
  renderInventory();
}

// é”€å”®ç®¡ç†å­è§†å›¾åˆ‡æ¢
function showSalesSubView(view) {
  currentSalesView = view;
  
  // æ›´æ–°æ ‡ç­¾æŒ‰é’®çŠ¶æ€
  document.querySelectorAll('#salesView .tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // éšè—æ‰€æœ‰å­è§†å›¾
  document.querySelectorAll('.sales-sub-view').forEach(subView => {
    subView.classList.add('hidden');
  });
  
  // æ˜¾ç¤ºå½“å‰è§†å›¾
  const targetView = document.getElementById(`sales${view.charAt(0).toUpperCase() + view.slice(1)}View`);
  if (targetView) {
    targetView.classList.remove('hidden');
  }
  
  // æ¸²æŸ“å¯¹åº”æ•°æ®
  switch(view) {
    case 'orders':
      renderSales();
      break;
    case 'customers':
      renderCustomers();
      break;
    case 'quotes':
      renderSalesQuotes();
      break;
    case 'deliveries':
      renderDeliveries();
      break;
    case 'returns':
      renderReturns();
      break;
    case 'invoices':
      renderInvoices();
      break;
  }
}

// é”€å”®è®¢å•ç±»å‹ç­›é€‰
function filterSalesByType(type) {
  currentSalesTypeFilter = type;
  
  // æ›´æ–°ç­›é€‰æŒ‰é’®çŠ¶æ€
  document.querySelectorAll('#salesOrdersView .filter-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  renderSales();
}

// é”€å”®è®¢å•æŸ¥è¯¢ç­›é€‰
function filterSalesOrders() {
  renderSales();
}

// æ¸…ç©ºé”€å”®ç­›é€‰æ¡ä»¶
function clearSalesFilter() {
  document.getElementById('salesSearchOrderNo').value = '';
  document.getElementById('salesSearchCustomer').value = '';
  document.getElementById('salesSearchContact').value = '';
  document.getElementById('salesSearchPhone').value = '';
  document.getElementById('salesSearchDate').value = '';
  document.getElementById('salesSearchSalesperson').value = '';
  renderSales();
}



// ===== åº“å­˜ç®¡ç†æ‰©å±•åŠŸèƒ½ =====

// åº“å­˜è°ƒæ•´åŠŸèƒ½
function openInventoryAdjustment(sku) {
  const product = data.products.find(p => p.sku === sku);
  if (!product) return;
  
  const modal = document.getElementById('inventoryAdjustmentModal');
  if (modal) {
    document.getElementById('adjustSku').value = product.sku;
    document.getElementById('adjustProductName').value = product.name;
    document.getElementById('currentStock').value = product.stock;
    document.getElementById('newStock').value = product.stock;
    
    // ç›‘å¬è°ƒæ•´æ•°é‡å˜åŒ–
    document.getElementById('adjustQuantity').addEventListener('input', function() {
      const currentStock = parseInt(document.getElementById('currentStock').value) || 0;
      const adjustQuantity = parseInt(this.value) || 0;
      document.getElementById('newStock').value = currentStock + adjustQuantity;
    });
    
    modal.classList.remove('hidden');
    modal.style.display = '';
  }
}

function closeInventoryAdjustmentModal() {
  const modal = document.getElementById('inventoryAdjustmentModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
  }
}

function saveInventoryAdjustment() {
  const sku = document.getElementById('adjustSku').value;
  const product = data.products.find(p => p.sku === sku);
  if (!product) return;
  
  const adjustQuantity = parseInt(document.getElementById('adjustQuantity').value) || 0;
  const adjustReason = document.getElementById('adjustReason').value;
  const adjustType = document.getElementById('adjustType').value;
  
  if (adjustQuantity === 0) {
    showToast('è¯·è¾“å…¥è°ƒæ•´æ•°é‡', 'error');
    return;
  }
  
  if (!adjustReason.trim()) {
    showToast('è¯·è¾“å…¥è°ƒæ•´åŸå› ', 'error');
    return;
  }
  
  const newStock = product.stock + adjustQuantity;
  if (newStock < 0) {
    showToast('è°ƒæ•´ååº“å­˜ä¸èƒ½ä¸ºè´Ÿæ•°', 'error');
    return;
  }
  
  // æ›´æ–°åº“å­˜
  product.stock = newStock;
  
  // è®°å½•è°ƒæ•´å†å²
  if (!data.inventoryAdjustments) data.inventoryAdjustments = [];
  data.inventoryAdjustments.push({
    id: 'ADJ' + Date.now(),
    sku: sku,
    productName: product.name,
    adjustQuantity: adjustQuantity,
    beforeStock: product.stock - adjustQuantity,
    afterStock: newStock,
    adjustType: adjustType,
    reason: adjustReason,
    operator: 'å½“å‰ç”¨æˆ·',
    date: new Date().toISOString().split('T')[0],
    time: new Date().toLocaleTimeString()
  });
  
  closeInventoryAdjustmentModal();
  renderInventory();
  showToast('åº“å­˜è°ƒæ•´æˆåŠŸ', 'success');
}


// åº“å­˜ç›˜ç‚¹åŠŸèƒ½
function showInventoryCount() {
  const modal = document.getElementById('inventoryCountModal');
  if (modal) {
    // è®¾ç½®é»˜è®¤å€¼
    document.getElementById('countId').value = 'COUNT' + Date.now();
    document.getElementById('countDate').value = new Date().toISOString().split('T')[0];
    
    // ç”Ÿæˆäº§å“é€‰æ‹©åˆ—è¡¨
    renderCountProductList();
    
    modal.classList.remove('hidden');
    modal.style.display = '';
  }
}

function closeInventoryCountModal() {
  const modal = document.getElementById('inventoryCountModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
  }
}

function renderCountProductList() {
  const container = document.getElementById('countProductList');
  if (!container) return;
  
  let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">';
  
  data.products.forEach(product => {
    html += `
      <div style="border: 1px solid var(--border-color); padding: 12px; border-radius: 8px;">
        <label style="display: flex; align-items: flex-start; gap: 8px; cursor: pointer;">
          <input type="checkbox" value="${product.sku}" style="margin-top: 4px;">
          <div style="flex: 1;">
            <div style="font-weight: 500;">${product.sku}</div>
            <div style="font-size: 14px; color: var(--muted);">${product.name}</div>
            <div style="font-size: 14px; color: var(--muted);">å½“å‰åº“å­˜: ${product.stock}</div>
          </div>
        </label>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

function selectAllProducts() {
  const checkboxes = document.querySelectorAll('#countProductList input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = true);
}

// åº“å­˜å‡ºåº“åŠŸèƒ½
function openInventoryOutbound(sku) {
  const product = data.products.find(p => p.sku === sku);
  if (!product) return;
  
  const modal = document.getElementById('inventoryOutboundModal');
  if (modal) {
    document.getElementById('outboundSku').value = product.sku;
    document.getElementById('outboundProductName').value = product.name;
    document.getElementById('outboundCurrentStock').value = product.stock;
    document.getElementById('outboundDate').value = new Date().toISOString().split('T')[0];
    
    modal.classList.remove('hidden');
    modal.style.display = '';
  }
}

function closeInventoryOutboundModal() {
  const modal = document.getElementById('inventoryOutboundModal');
  if (modal) {
    modal.classList.add('hidden');
    modal.style.display = 'none';
  }
}

function saveInventoryOutbound() {
  const sku = document.getElementById('outboundSku').value;
  const product = data.products.find(p => p.sku === sku);
  if (!product) return;
  
  const outboundQuantity = parseInt(document.getElementById('outboundQuantity').value) || 0;
  const outboundType = document.getElementById('outboundType').value;
  const outboundDate = document.getElementById('outboundDate').value;
  
  if (outboundQuantity <= 0) {
    showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å‡ºåº“æ•°é‡', 'error');
    return;
  }
  
  if (outboundQuantity > product.stock) {
    showToast('å‡ºåº“æ•°é‡ä¸èƒ½è¶…è¿‡å½“å‰åº“å­˜', 'error');
    return;
  }
  
  if (!outboundType) {
    showToast('è¯·é€‰æ‹©å‡ºåº“ç±»å‹', 'error');
    return;
  }
  
  if (!outboundDate) {
    showToast('è¯·é€‰æ‹©å‡ºåº“æ—¥æœŸ', 'error');
    return;
  }
  
  // æ›´æ–°åº“å­˜
  product.stock -= outboundQuantity;
  
  // è®°å½•å‡ºåº“å†å²
  if (!data.inventoryOutbound) data.inventoryOutbound = [];
  data.inventoryOutbound.push({
    id: 'OUT' + Date.now(),
    sku: sku,
    productName: product.name,
    quantity: outboundQuantity,
    type: outboundType,
    date: outboundDate,
    operator: document.getElementById('outboundOperator').value,
    refNo: document.getElementById('outboundRefNo').value,
    remark: document.getElementById('outboundRemark').value,
    beforeStock: product.stock + outboundQuantity,
    afterStock: product.stock,
    createTime: new Date().toISOString()
  });
  
  closeInventoryOutboundModal();
  renderInventory();
  showToast('å‡ºåº“æˆåŠŸ', 'success');
}

function viewOutboundDetail(outboundId) {
  const outbound = data.inventoryOutbound.find(o => o.id === outboundId);
  if (!outbound) return;
  
  const side = $('#sideDetail');
  side.classList.remove('hidden');
  $('#detailTitle').textContent = 'å‡ºåº“å•è¯¦æƒ…';
  
  const typeClass = outbound.type === 'é”€å”®å‡ºåº“' ? 'success' : outbound.type === 'æŠ¥æŸå‡ºåº“' ? 'danger' : outbound.type === 'é€€è´§å‡ºåº“' || outbound.type === 'æ¢è´§å‡ºåº“' ? 'info' : 'warning';
  
  $('#detailBody').innerHTML = `
    <div><strong>å‡ºåº“å•å·ï¼š</strong>${outbound.id}</div>
    <div><strong>äº§å“SKUï¼š</strong>${outbound.sku}</div>
    <div><strong>äº§å“åç§°ï¼š</strong>${outbound.productName}</div>
    <div><strong>å‡ºåº“æ•°é‡ï¼š</strong>${outbound.quantity}</div>
    <div><strong>å‡ºåº“ç±»å‹ï¼š</strong><span class="badge ${typeClass}">${outbound.type}</span></div>
    <div><strong>å‡ºåº“æ—¥æœŸï¼š</strong>${outbound.date}</div>
    <div><strong>æ“ä½œå‘˜ï¼š</strong>${outbound.operator}</div>
    ${outbound.refNo ? `<div><strong>å…³è”å•å·ï¼š</strong>${outbound.refNo}</div>` : ''}
    ${outbound.remark ? `<div><strong>å¤‡æ³¨ï¼š</strong>${outbound.remark}</div>` : ''}
    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
      <div><strong>å‡ºåº“å‰åº“å­˜ï¼š</strong>${outbound.beforeStock}</div>
      <div><strong>å‡ºåº“ååº“å­˜ï¼š</strong>${outbound.afterStock}</div>
    </div>
    <div style="margin-top: 8px; font-size: 12px; color: var(--muted);">
      åˆ›å»ºæ—¶é—´ï¼š${new Date(outbound.createTime).toLocaleString()}
    </div>
  `;
}

function deselectAllProducts() {
  const checkboxes = document.querySelectorAll('#countProductList input[type="checkbox"]');
  checkboxes.forEach(cb => cb.checked = false);
}

function selectByCategory() {
  // ç®€åŒ–ç‰ˆæœ¬ï¼šå®é™…åº”ç”¨ä¸­éœ€è¦åˆ†ç±»ç­›é€‰åŠŸèƒ½
  alert('æŒ‰åˆ†ç±»é€‰æ‹©åŠŸèƒ½å¼€å‘ä¸­...');
}

function createInventoryCount() {
  const selectedProducts = Array.from(document.querySelectorAll('#countProductList input[type="checkbox"]:checked'))
    .map(cb => cb.value);
  
  if (selectedProducts.length === 0) {
    showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªäº§å“', 'error');
    return;
  }
  
  const countData = {
    id: document.getElementById('countId').value,
    date: document.getElementById('countDate').value,
    warehouse: document.getElementById('countWarehouse').value,
    type: document.getElementById('countType').value,
    manager: document.getElementById('countManager').value,
    notes: document.getElementById('countNotes').value,
    products: selectedProducts,
    status: 'pending',
    createTime: new Date().toISOString()
  };
  
  // è®°å½•ç›˜ç‚¹è®¡åˆ’
  if (!data.inventoryCounts) data.inventoryCounts = [];
  data.inventoryCounts.push(countData);
  
  closeInventoryCountModal();
  showToast('ç›˜ç‚¹è®¡åˆ’åˆ›å»ºæˆåŠŸ', 'success');
  
  // è·³è½¬åˆ°ç›˜ç‚¹æ‰§è¡Œç•Œé¢ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
  executeInventoryCount(countData);
}

function executeInventoryCount(countData) {
  const side = $('#sideDetail');
  side.classList.remove('hidden');
  $('#detailTitle').textContent = `æ‰§è¡Œç›˜ç‚¹ - ${countData.id}`;
  
  let html = `
    <div style="margin-bottom: 16px;">
      <div><strong>ç›˜ç‚¹ç¼–å·ï¼š</strong>${countData.id}</div>
      <div><strong>ç›˜ç‚¹æ—¥æœŸï¼š</strong>${countData.date}</div>
      <div><strong>ä»“åº“ï¼š</strong>${countData.warehouse}</div>
      <div><strong>ç±»å‹ï¼š</strong>${countData.type}</div>
      <div><strong>è´Ÿè´£äººï¼š</strong>${countData.manager}</div>
    </div>
    
    <table style="width: 100%; font-size: 14px;">
      <thead>
        <tr>
          <th>SKU</th>
          <th>äº§å“åç§°</th>
          <th>ç³»ç»Ÿåº“å­˜</th>
          <th>å®é™…åº“å­˜</th>
          <th>å·®å¼‚</th>
          <th>çŠ¶æ€</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  countData.products.forEach(sku => {
    const product = data.products.find(p => p.sku === sku);
    if (product) {
      html += `
        <tr>
          <td>${product.sku}</td>
          <td>${product.name}</td>
          <td>${product.stock}</td>
          <td><input type="number" style="width: 80px;" value="${product.stock}" onchange="updateCountDifference(this, '${sku}')"></td>
          <td id="diff-${sku}">0</td>
          <td id="status-${sku}"><span class="badge success">æ­£å¸¸</span></td>
        </tr>
      `;
    }
  });
  
  html += `
      </tbody>
    </table>
    <div style="margin-top: 16px;">
      <button class="btn" onclick="completeInventoryCount('${countData.id}')">å®Œæˆç›˜ç‚¹</button>
    </div>
  `;
  
  $('#detailBody').innerHTML = html;
}

function updateCountDifference(input, sku) {
  const systemStock = data.products.find(p => p.sku === sku).stock;
  const actualStock = parseInt(input.value) || 0;
  const diff = actualStock - systemStock;
  
  document.getElementById(`diff-${sku}`).textContent = diff;
  const statusElement = document.getElementById(`status-${sku}`);
  
  if (diff === 0) {
    statusElement.innerHTML = '<span class="badge success">æ­£å¸¸</span>';
  } else if (diff > 0) {
    statusElement.innerHTML = '<span class="badge warning">ç›˜ç›ˆ</span>';
  } else {
    statusElement.innerHTML = '<span class="badge danger">ç›˜äº</span>';
  }
}

function completeInventoryCount(countId) {
  alert(`ç›˜ç‚¹ ${countId} å·²å®Œæˆï¼Œå·®å¼‚è®°å½•å·²ä¿å­˜`);
  closeSideDetail();
}

// åº“å­˜é”€é‡æ’åºåŠŸèƒ½
function sortInventoryBySales(period) {
  let sortByField = '';
  let sortOrder = 1; // 1ä¸ºå‡åºï¼Œ-1ä¸ºé™åº
  
  if (period === '10days') {
    sortByField = 'tenDaySales';
  } else if (period === '30days') {
    sortByField = 'thirtyDaySales';
  }
  
  // ç®€åŒ–æ’åºï¼šå®é™…åº”ç”¨ä¸­ä¼šæ ¹æ®é”€é‡æ•°æ®é‡æ–°æ’åº
  showToast(`æŒ‰${period === '10days' ? '10å¤©' : '30å¤©'}é”€é‡æ’åºåŠŸèƒ½å¼€å‘ä¸­...`, 'info');
}

// åº“å­˜é¢„è­¦åŠŸèƒ½
function showInventoryAlerts() {
  const modal = document.getElementById('inventoryAlertsModal');
  if (modal) {
    renderInventoryAlerts();
    modal.classList.remove('hidden');
    modal.style.display = '';
  }
}

function closeInventoryAlertsModal() {
  const modal = document.getElementById('inventoryAlertsModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
  }
}

function renderInventoryAlerts() {
  const alerts = generateInventoryAlerts();
  
  // æ›´æ–°ç»Ÿè®¡æ•°æ®
  document.getElementById('lowStockCount').textContent = alerts.lowStock.length;
  document.getElementById('overStockCount').textContent = alerts.overStock.length;
  document.getElementById('deadStockCount').textContent = alerts.deadStock.length;
  document.getElementById('expiryCount').textContent = alerts.expiry.length;
  
  // æ˜¾ç¤ºé¢„è­¦åˆ—è¡¨
  const container = document.getElementById('alertsList');
  let html = '';
  
  // ä½åº“å­˜é¢„è­¦
  if (alerts.lowStock.length > 0) {
    html += '<div style="margin-bottom: 16px;"><strong>ä½åº“å­˜é¢„è­¦</strong></div>';
    alerts.lowStock.forEach(alert => {
      html += `
        <div style="border: 1px solid var(--warning); padding: 12px; margin-bottom: 8px; border-radius: 6px; background: rgba(250, 173, 20, 0.1);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 500;">${alert.sku} - ${alert.name}</div>
              <div style="font-size: 14px; color: var(--muted);">å½“å‰åº“å­˜: ${alert.stock} | å»ºè®®åº“å­˜: ${alert.recommendedStock}</div>
            </div>
            <span class="badge warning">ä½åº“å­˜</span>
          </div>
        </div>
      `;
    });
  }
  
  // è¶…åº“å­˜é¢„è­¦
  if (alerts.overStock.length > 0) {
    html += '<div style="margin-bottom: 16px;"><strong>è¶…åº“å­˜é¢„è­¦</strong></div>';
    alerts.overStock.forEach(alert => {
      html += `
        <div style="border: 1px solid var(--info); padding: 12px; margin-bottom: 8px; border-radius: 6px; background: rgba(114, 46, 209, 0.1);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 500;">${alert.sku} - ${alert.name}</div>
              <div style="font-size: 14px; color: var(--muted);">å½“å‰åº“å­˜: ${alert.stock} | æœ€å¤§åº“å­˜: ${alert.maxStock}</div>
            </div>
            <span class="badge info">è¶…åº“å­˜</span>
          </div>
        </div>
      `;
    });
  }
  
  // å‘†æ»åº“å­˜é¢„è­¦
  if (alerts.deadStock.length > 0) {
    html += '<div style="margin-bottom: 16px;"><strong>å‘†æ»åº“å­˜é¢„è­¦</strong></div>';
    alerts.deadStock.forEach(alert => {
      html += `
        <div style="border: 1px solid var(--danger); padding: 12px; margin-bottom: 8px; border-radius: 6px; background: rgba(255, 77, 79, 0.1);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 500;">${alert.sku} - ${alert.name}</div>
              <div style="font-size: 14px; color: var(--muted);">æœ€åé”€å”®: ${alert.lastSaleDate || 'æ— è®°å½•'} | åº“å­˜å¤©æ•°: ${alert.daysInStock}å¤©</div>
            </div>
            <span class="badge danger">å‘†æ»</span>
          </div>
        </div>
      `;
    });
  }
  
  // å³å°†è¿‡æœŸé¢„è­¦
  if (alerts.expiry.length > 0) {
    html += '<div style="margin-bottom: 16px;"><strong>å³å°†è¿‡æœŸé¢„è­¦</strong></div>';
    alerts.expiry.forEach(alert => {
      html += `
        <div style="border: 1px solid var(--danger); padding: 12px; margin-bottom: 8px; border-radius: 6px; background: rgba(255, 77, 79, 0.1);">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 500;">${alert.sku} - ${alert.name}</div>
              <div style="font-size: 14px; color: var(--muted);">æ‰¹æ¬¡: ${alert.batch} | è¿‡æœŸæ—¥æœŸ: ${alert.expiryDate}</div>
            </div>
            <span class="badge danger">å³å°†è¿‡æœŸ</span>
          </div>
        </div>
      `;
    });
  }
  
  if (html === '') {
    html = '<div style="text-align: center; padding: 20px; color: var(--muted);">æš‚æ— é¢„è­¦ä¿¡æ¯</div>';
  }
  
  container.innerHTML = html;
}

function generateInventoryAlerts() {
  const alerts = {
    lowStock: [],
    overStock: [],
    deadStock: [],
    expiry: []
  };
  
  const today = new Date();
  
  data.products.forEach(product => {
    // ä½åº“å­˜é¢„è­¦ (åº“å­˜ä½äº30å¤©é”€é‡)
    const monthlySales = Math.random() * 50; // æ¨¡æ‹Ÿæœˆé”€é‡
    const recommendedStock = Math.max(monthlySales / 30 * 30, 10); // 30å¤©å®‰å…¨åº“å­˜
    if (product.stock < recommendedStock) {
      alerts.lowStock.push({
        sku: product.sku,
        name: product.name,
        stock: product.stock,
        recommendedStock: Math.round(recommendedStock)
      });
    }
    
    // è¶…åº“å­˜é¢„è­¦ (åº“å­˜è¶…è¿‡90å¤©é”€é‡)
    const maxStock = monthlySales * 3; // 90å¤©æœ€å¤§åº“å­˜
    if (product.stock > maxStock) {
      alerts.overStock.push({
        sku: product.sku,
        name: product.name,
        stock: product.stock,
        maxStock: Math.round(maxStock)
      });
    }
    
    // å‘†æ»åº“å­˜é¢„è­¦ (è¶…è¿‡180å¤©æ— é”€å”®)
    const daysInStock = Math.floor(Math.random() * 365); // æ¨¡æ‹Ÿåº“å­˜å¤©æ•°
    if (daysInStock > 180) {
      alerts.deadStock.push({
        sku: product.sku,
        name: product.name,
        daysInStock: daysInStock,
        lastSaleDate: new Date(today.getTime() - daysInStock * 24 * 60 * 60 * 1000).toLocaleDateString()
      });
    }
    
    // å³å°†è¿‡æœŸé¢„è­¦
    if (product.batches) {
      product.batches.forEach(batch => {
        const expiryDate = new Date(batch.expiry);
        const daysToExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        if (daysToExpiry <= 90 && daysToExpiry > 0) {
          alerts.expiry.push({
            sku: product.sku,
            name: product.name,
            batch: batch.batch,
            expiryDate: batch.expiry,
            daysToExpiry: daysToExpiry
          });
        }
      });
    }
  });
  
  return alerts;
}

function filterAlerts(type) {
  // æ ¹æ®ç±»å‹è¿‡æ»¤é¢„è­¦
  const alerts = generateInventoryAlerts();
  const container = document.getElementById('alertsList');
  let html = '';
  
  switch(type) {
    case 'low_stock':
      alerts.lowStock.forEach(alert => {
        html += createAlertHtml(alert, 'warning', 'ä½åº“å­˜');
      });
      break;
    case 'over_stock':
      alerts.overStock.forEach(alert => {
        html += createAlertHtml(alert, 'info', 'è¶…åº“å­˜');
      });
      break;
    case 'dead_stock':
      alerts.deadStock.forEach(alert => {
        html += createAlertHtml(alert, 'danger', 'å‘†æ»');
      });
      break;
    case 'expiry':
      alerts.expiry.forEach(alert => {
        html += createAlertHtml(alert, 'danger', 'å³å°†è¿‡æœŸ');
      });
      break;
    default:
      renderInventoryAlerts();
      return;
  }
  
  if (html === '') {
    html = '<div style="text-align: center; padding: 20px; color: var(--muted);">æš‚æ— ç›¸å…³é¢„è­¦ä¿¡æ¯</div>';
  }
  
  container.innerHTML = html;
}

function createAlertHtml(alert, type, label) {
  const colorClass = type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'danger';
  const bgColor = type === 'warning' ? 'rgba(250, 173, 20, 0.1)' : type === 'info' ? 'rgba(114, 46, 209, 0.1)' : 'rgba(255, 77, 79, 0.1)';
  
  let detailHtml = '';
  if (label === 'ä½åº“å­˜') {
    detailHtml = `å½“å‰åº“å­˜: ${alert.stock} | å»ºè®®åº“å­˜: ${alert.recommendedStock}`;
  } else if (label === 'è¶…åº“å­˜') {
    detailHtml = `å½“å‰åº“å­˜: ${alert.stock} | æœ€å¤§åº“å­˜: ${alert.maxStock}`;
  } else if (label === 'å‘†æ»') {
    detailHtml = `æœ€åé”€å”®: ${alert.lastSaleDate || 'æ— è®°å½•'} | åº“å­˜å¤©æ•°: ${alert.daysInStock}å¤©`;
  } else if (label === 'å³å°†è¿‡æœŸ') {
    detailHtml = `æ‰¹æ¬¡: ${alert.batch} | è¿‡æœŸæ—¥æœŸ: ${alert.expiryDate}`;
  }
  
  return `
    <div style="border: 1px solid var(--${colorClass}); padding: 12px; margin-bottom: 8px; border-radius: 6px; background: ${bgColor};">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="font-weight: 500;">${alert.sku} - ${alert.name}</div>
          <div style="font-size: 14px; color: var(--muted);">${detailHtml}</div>
        </div>
        <span class="badge ${colorClass}">${label}</span>
      </div>
    </div>
  `;
}

function exportAlerts() {
  const alerts = generateInventoryAlerts();
  let csvContent = "SKU,äº§å“åç§°,é¢„è­¦ç±»å‹,è¯¦æƒ…,ä¸¥é‡ç¨‹åº¦\n";
  
  [...alerts.lowStock.map(a => ({...a, type: 'ä½åº“å­˜', severity: 'ä¸­ç­‰'})),
   ...alerts.overStock.map(a => ({...a, type: 'è¶…åº“å­˜', severity: 'ä½'})),
   ...alerts.deadStock.map(a => ({...a, type: 'å‘†æ»', severity: 'é«˜'})),
   ...alerts.expiry.map(a => ({...a, type: 'å³å°†è¿‡æœŸ', severity: 'é«˜'}))
  ].forEach(alert => {
    let detail = '';
    if (alert.type === 'ä½åº“å­˜') {
      detail = `å½“å‰åº“å­˜: ${alert.stock}, å»ºè®®åº“å­˜: ${alert.recommendedStock}`;
    } else if (alert.type === 'è¶…åº“å­˜') {
      detail = `å½“å‰åº“å­˜: ${alert.stock}, æœ€å¤§åº“å­˜: ${alert.maxStock}`;
    } else if (alert.type === 'å‘†æ»') {
      detail = `åº“å­˜å¤©æ•°: ${alert.daysInStock}å¤©`;
    } else if (alert.type === 'å³å°†è¿‡æœŸ') {
      detail = `æ‰¹æ¬¡: ${alert.batch}, è¿‡æœŸæ—¥æœŸ: ${alert.expiryDate}`;
    }
    
    csvContent += `${alert.sku},${alert.name},${alert.type},${detail},${alert.severity}\n`;
  });
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `åº“å­˜é¢„è­¦æŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  
  showToast('é¢„è­¦æŠ¥å‘Šå·²å¯¼å‡º', 'success');
}

// æ›´æ–°renderInventoryå‡½æ•°ä»¥æ”¯æŒæ–°çš„è§†å›¾
function showInventoryView(view) {
  inventoryView = view;
  renderInventory();
}

function renderInventory() {
  const tbody = $('#table-inventory tbody');
  tbody.innerHTML='';
  
  if(inventoryView === 'summary'){
    document.querySelector('#table-inventory thead').innerHTML = '<tr><th>å›¾ç‰‡</th><th>SKU</th><th>äº§å“</th><th>å‹å·</th><th>ç±»åˆ«</th><th>åˆ†ç±»</th><th>å¯ç”¨åº“å­˜</th><th>æ“ä½œ</th></tr>';
    data.products.forEach(p=>{
      const tr = document.createElement('tr');
      const batchCount = p.batches ? p.batches.length : 0;
      
      tr.innerHTML = `<td><div class="product-image" onclick="openDetail('product','${p.sku}')" onmouseenter="showImagePreview(event, '${p.image}', '${p.name}')" onmouseleave="hideImagePreview()">${getProductImage(p.image || 'package')}</div></td><td>${p.sku}</td><td>${p.name}</td>
        <td>${p.model || '-'}</td>
        <td>${p.category || '-'}</td>
        <td>${p.classification || '-'}</td>
        <td>${p.stock}</td>
        <td>
          <button class="btn ghost" onclick="openInventoryAdjustment('${p.sku}')">è°ƒæ•´</button>
          <button class="btn ghost" onclick="openInventoryOutbound('${p.sku}')">å‡ºåº“</button>
        </td>`;
      tbody.appendChild(tr);
    });
  } else if(inventoryView === 'adjustments'){
    document.querySelector('#table-inventory thead').innerHTML = '<tr><th>è°ƒæ•´ç¼–å·</th><th>SKU</th><th>äº§å“åç§°</th><th>è°ƒæ•´æ•°é‡</th><th>è°ƒæ•´å‰</th><th>è°ƒæ•´å</th><th>è°ƒæ•´ç±»å‹</th><th>æ“ä½œå‘˜</th><th>è°ƒæ•´æ—¶é—´</th><th>æ“ä½œ</th></tr>';
    if(data.inventoryAdjustments){
      data.inventoryAdjustments.forEach(adj=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${adj.id}</td><td>${adj.sku}</td><td>${adj.productName}</td><td>${adj.adjustQuantity}</td><td>${adj.beforeStock}</td><td>${adj.afterStock}</td><td>${adj.adjustType}</td><td>${adj.operator}</td><td>${adj.date} ${adj.time}</td>
          <td><button class="btn ghost" onclick="viewAdjustmentDetail('${adj.id}')">æŸ¥çœ‹</button></td>`;
        tbody.appendChild(tr);
      });
    }
  } else if(inventoryView === 'outbound'){
    document.querySelector('#table-inventory thead').innerHTML = '<tr><th>å‡ºåº“å•å·</th><th>SKU</th><th>äº§å“åç§°</th><th>å‡ºåº“æ•°é‡</th><th>å‡ºåº“ç±»å‹</th><th>å‡ºåº“æ—¥æœŸ</th><th>æ“ä½œå‘˜</th><th>å…³è”å•å·</th><th>å¤‡æ³¨</th><th>æ“ä½œ</th></tr>';
    if(data.inventoryOutbound){
      data.inventoryOutbound.forEach(out=>{
        const tr = document.createElement('tr');
        const typeClass = out.type === 'é”€å”®å‡ºåº“' ? 'success' : out.type === 'æŠ¥æŸå‡ºåº“' ? 'danger' : out.type === 'é€€è´§å‡ºåº“' || out.type === 'æ¢è´§å‡ºåº“' ? 'info' : 'warning';
        tr.innerHTML = `<td>${out.id}</td><td>${out.sku}</td><td>${out.productName}</td><td>${out.quantity}</td><td><span class="badge ${typeClass}">${out.type}</span></td><td>${out.date}</td><td>${out.operator}</td><td>${out.refNo || '-'}</td><td>${out.remark || '-'}</td>
          <td><button class="btn ghost" onclick="viewOutboundDetail('${out.id}')">æŸ¥çœ‹</button></td>`;
        tbody.appendChild(tr);
      });
    }
  }
}

function renderSales(){
  const tbody = $('#table-sales tbody');
  tbody.innerHTML='';
  
  let filteredSales = data.sales;
  const orderTypeFilter = currentSalesTypeFilter;
  
  if (orderTypeFilter !== 'all') {
    filteredSales = data.sales.filter(s => s.orderType === orderTypeFilter);
  }
  
  filteredSales.forEach(s=>{
    const tr = document.createElement('tr');
    const paymentStatusClass = s.paymentStatus === 'å·²æ”¶' ? 'success' : 'warning';
    const orderTypeDisplay = s.orderType === '1688' ? '1688ä¸šåŠ¡' : 'çº¿ä¸‹åˆä½œ';
    
    tr.innerHTML = `
      <td>${s.orderNo}</td>
      <td>${orderTypeDisplay}</td>
      <td>${s.salesDate}</td>
      <td>${s.customer}</td>
      <td>${s.deliveryDate}</td>
      <td>${s.items}</td>
      <td>Â¥${s.total}</td>
      <td><span class="badge ${paymentStatusClass}">${s.paymentStatus}</span></td>
      <td>${s.trackingNo || '-'}</td>
      <td>
        <button class="btn ghost" onclick="viewSalesOrderDetail('${s.id}')">æŸ¥çœ‹</button>
        <button class="btn ghost" onclick="editSalesOrder('${s.id}')">ç¼–è¾‘</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function renderCustomers(){
  const tbody = $('#table-customers tbody');
  tbody.innerHTML='';
  data.customers.forEach(c=>{
    const tr = document.createElement('tr');
    const creditDisplay = c.creditLimit > 0 ? `Â¥${c.creditLimit}` : 'æ— ';
    
    tr.innerHTML = `
      <td>${c.id}</td>
      <td>${c.name}</td>
      <td>${c.type}</td>
      <td>${c.contact}</td>
      <td>${c.phone}</td>
      <td>${c.settlementMethod}</td>
      <td>${creditDisplay}</td>
      <td>${c.createTime}</td>
      <td>
        <button class="btn ghost" onclick="viewCustomerDetail('${c.id}')">æŸ¥çœ‹</button>
        <button class="btn ghost" onclick="editCustomer('${c.id}')">ç¼–è¾‘</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function renderSalesQuotes(){
  const tbody = $('#salesQuotesView #table-quotes tbody');
  tbody.innerHTML='';
  
  if (!data.salesQuotes || data.salesQuotes.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);">æš‚æ— æŠ¥ä»·æ•°æ®</td></tr>';
    return;
  }
  
  data.salesQuotes.forEach((q, index)=>{
    const tr = document.createElement('tr');
    const statusClass = q.status === 'å·²æ‰¹å‡†' ? 'success' : 'warning';
    
    tr.innerHTML = `
      <td>${q.id}</td>
      <td>${q.customer}</td>
      <td>Â¥${(q.amount || 0).toFixed(2)}</td>
      <td>${q.validUntil}</td>
      <td><span class="badge ${statusClass}">${q.status}</span></td>
      <td>${q.createDate}</td>
      <td>${q.salesperson}</td>
      <td>
        <button class="btn ghost" onclick="viewQuoteDetail('${q.id}')">æŸ¥çœ‹</button>
        <button class="btn ghost" onclick="approveQuote('${q.id}')">å®¡æ‰¹</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function renderDeliveries(){
  const tbody = $('#table-deliveries tbody');
  tbody.innerHTML='';
  data.deliveries.forEach(d=>{
    const tr = document.createElement('tr');
    const statusClass = d.status === 'å·²å‘è´§' ? 'success' : 'warning';
    
    tr.innerHTML = `
      <td>${d.batchNo}</td>
      <td>${d.orderNo}</td>
      <td>${d.salesperson}</td>
      <td><img src="https://via.placeholder.com/40" style="width:40px;height:40px;border-radius:4px;"></td>
      <td>-</td>
      <td>-</td>
      <td>${d.quantity}</td>
      <td>${d.cartonCount}</td>
      <td>${d.weight}kg</td>
      <td>${d.logisticsCompany}</td>
      <td>${d.trackingNo}</td>
      <td>Â¥${d.logisticsFee}</td>
      <td><span class="badge ${statusClass}">${d.status}</span></td>
      <td>
        <button class="btn ghost" onclick="viewDeliveryDetail('${d.batchNo}')">æŸ¥çœ‹</button>
        <button class="btn ghost" onclick="printDelivery('${d.batchNo}')">æ‰“å°</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function renderReturns(){
  const tbody = $('#table-returns tbody');
  tbody.innerHTML='';
  data.returns.forEach(r=>{
    const tr = document.createElement('tr');
    const statusClass = r.status === 'å·²å¤„ç†' ? 'success' : 'warning';
    
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.originalOrderNo}</td>
      <td>${r.customer}</td>
      <td>${r.returnDate}</td>
      <td>Â¥${r.amount}</td>
      <td>${r.reason}</td>
      <td><span class="badge ${statusClass}">${r.status}</span></td>
      <td>
        <button class="btn ghost" onclick="viewReturnDetail('${r.id}')">æŸ¥çœ‹</button>
        <button class="btn ghost" onclick="processReturn('${r.id}')">å¤„ç†</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function renderInvoices(){
  const tbody = $('#table-invoices tbody');
  tbody.innerHTML='';
  data.invoices.forEach(i=>{
    const tr = document.createElement('tr');
    const approvalClass = i.approvalStatus === 'å·²æ‰¹å‡†' ? 'success' : 'warning';
    const invoiceClass = i.invoiceStatus === 'å·²å¼€ç¥¨' ? 'success' : 'warning';
    
    tr.innerHTML = `
      <td>${i.id}</td>
      <td>${i.orderNo}</td>
      <td>${i.customer}</td>
      <td>Â¥${i.amount}</td>
      <td>${i.requestDate}</td>
      <td><span class="badge ${approvalClass}">${i.approvalStatus}</span></td>
      <td><span class="badge ${invoiceClass}">${i.invoiceStatus}</span></td>
      <td>
        <button class="btn ghost" onclick="viewInvoiceDetail('${i.id}')">æŸ¥çœ‹</button>
        <button class="btn ghost" onclick="approveInvoice('${i.id}')">å®¡æ‰¹</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function renderSuppliers(){
  const tbody = document.querySelector('#table-suppliers tbody');
  if (!tbody) return;
  
  tbody.innerHTML='';
  data.suppliers.forEach(s=>{
    const tr = document.createElement('tr');
    
    // æ˜Ÿçº§æ˜¾ç¤º - å…¼å®¹æ—§æ•°æ®
    const starRating = s.starRating || (s.level ? (s.level === 'A' ? 5 : s.level === 'B' ? 4 : s.level === 'C' ? 3 : s.level === 'D' ? 2 : 3) : 0);
    const stars = 'â­'.repeat(starRating);
    const starDisplay = starRating > 0 ? 
      `<span style="color: #f59e0b; font-weight: 600;" title="${starRating}æ˜Ÿçº§ä¾›åº”å•†">${stars}</span>` : 
      '<span style="color: #666;">æœªè¯„çº§</span>';
    
    tr.innerHTML = `
      <td>${s.code || s.id}</td>
      <td>${s.name}</td>
      <td>${starDisplay}</td>
      <td>${s.contact || '-'}</td>
      <td>${s.phone || '-'}</td>
      <td>${s.settle}</td>
      <td style="font-size: 12px; color: #666;">
        ${s.createdAt ? new Date(s.createdAt).toLocaleDateString('zh-CN') : 'æœªçŸ¥'}
      </td>
      <td>
        <button class="btn ghost" onclick="openDetail('supplier','${s.id}')">æŸ¥çœ‹</button>
        <button class="btn ghost" onclick="editSupplierFromList('${s.id}')">ç¼–è¾‘</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* æ‰“å¼€ä¾›åº”å•†ç¼–è¾‘ï¼ˆç”¨äºåˆ—è¡¨ä¸­çš„ç¼–è¾‘æŒ‰é’®ï¼‰ */
function editSupplierFromList(supplierId) {
  console.log('editSupplierFromList called with ID:', supplierId);
  console.log('Current data.suppliers:', data.suppliers);
  
  // å…³é—­å¯èƒ½æ‰“å¼€çš„è¯¦æƒ…é¢æ¿
  const sideDetail = document.getElementById('sideDetail');
  const overlay = document.querySelector('.modal-overlay');
  if (sideDetail) {
    sideDetail.classList.add('hidden');
    sideDetail.classList.remove('purchase-order-detail');
  }
  if (overlay) {
    overlay.classList.add('hidden');
  }
  
  // æŸ¥æ‰¾ä¾›åº”å•†æ•°æ®
  const supplier = data.suppliers.find(s => s.id === supplierId);
  if (!supplier) {
    console.error('Supplier not found for ID:', supplierId);
    showToast('ä¾›åº”å•†ä¸å­˜åœ¨', 'error');
    return;
  }
  
  console.log('Found supplier:', supplier);
  
  // ç›´æ¥è°ƒç”¨ç¼–è¾‘å‡½æ•°å¹¶ä¼ é€’ä¾›åº”å•†æ•°æ®
  editSupplierWithData(supplier);
}

/* ç¼–è¾‘ä¾›åº”å•†ï¼ˆæ¥æ”¶ä¾›åº”å•†æ•°æ®ï¼‰ */
function editSupplierWithData(supplier) {
  console.log('editSupplierWithData called with:', supplier);
  
  currentEditingSupplierId = supplier.id;
  window.currentViewingSupplierId = supplier.id; // ç¡®ä¿ä¹Ÿè®¾ç½®å…¨å±€å˜é‡
  
  // è®¾ç½®è¡¨å•æ ‡é¢˜å’Œæè¿°
  document.getElementById('supplierFormTitle').textContent = 'ğŸ¢ ç¼–è¾‘ä¾›åº”å•†';
  document.getElementById('supplierFormDescription').textContent = 'ä¿®æ”¹ä¾›åº”å•†ä¿¡æ¯';
  
  // å¡«å……è¡¨å•æ•°æ®
  document.getElementById('supplierName').value = supplier.name || '';
  document.getElementById('supplierCode').value = supplier.code || '';
  document.getElementById('supplierContact').value = supplier.contact || '';
  document.getElementById('supplierPhone').value = supplier.phone || '';
  document.getElementById('supplierEmail').value = supplier.email || '';
  document.getElementById('supplierAddress').value = supplier.address || '';
  document.getElementById('supplierStarRating').value = supplier.starRating || 3;
  document.getElementById('supplierSettle').value = supplier.settle || 'æœˆç»“';
  document.getElementById('supplierCategory').value = supplier.category || '';
  document.getElementById('supplierNotes').value = supplier.notes || '';
  
  // å¡«å……æ–°å¢å­—æ®µ
  document.getElementById('supplierScale').value = supplier.scale || '';
  document.getElementById('supplierCreditCode').value = supplier.creditCode || '';
  document.getElementById('supplierWechat').value = supplier.wechat || '';
  document.getElementById('supplierCompanyPhone').value = supplier.companyPhone || '';
  document.getElementById('supplierOfficeAddress').value = supplier.officeAddress || '';
  document.getElementById('supplierProductionAddress').value = supplier.productionAddress || '';
  document.getElementById('supplierWarehouseAddress').value = supplier.warehouseAddress || '';
  document.getElementById('supplierDeliveryMethod').value = supplier.deliveryMethod || '';
  document.getElementById('supplierTaxType').value = supplier.taxType || '';
  document.getElementById('supplierTaxRate').value = supplier.taxRate || '';
  
  // æ›´æ–°æ˜Ÿçº§æ˜¾ç¤º
  updateStarRating();
  
  // æ˜¾ç¤ºè¡¨å•æ¨¡æ€æ¡†
  const modal = document.getElementById('supplierFormModal');
  console.log('Found supplierFormModal:', modal);
  if (modal) {
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
    console.log('Supplier form modal should now be visible');
  } else {
    console.error('supplierFormModal not found!');
  }
}


function filterSuppliers() {
  const name = document.getElementById('supplierSearchName').value.toLowerCase();
  const contact = document.getElementById('supplierSearchContact').value.toLowerCase();
  const phone = document.getElementById('supplierSearchPhone').value.toLowerCase();
  const code = document.getElementById('supplierSearchCode').value.toLowerCase();
  
  const tbody = document.querySelector('#table-suppliers tbody');
  if (!tbody) return;
  
  const rows = tbody.querySelectorAll('tr');
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    const supplierName = cells[1].textContent.toLowerCase();
    const supplierContact = cells[4].textContent.toLowerCase();
    const supplierPhone = cells[5].textContent.toLowerCase();
    const supplierCode = cells[0].textContent.toLowerCase();
    
    const matchName = !name || supplierName.includes(name);
    const matchContact = !contact || supplierContact.includes(contact);
    const matchPhone = !phone || supplierPhone.includes(phone);
    const matchCode = !code || supplierCode.includes(code);
    
    row.style.display = matchName && matchContact && matchPhone && matchCode ? '' : 'none';
  });
}

function clearSupplierFilter() {
  document.getElementById('supplierSearchName').value = '';
  document.getElementById('supplierSearchContact').value = '';
  document.getElementById('supplierSearchPhone').value = '';
  document.getElementById('supplierSearchCode').value = '';
  
  const tbody = document.querySelector('#table-suppliers tbody');
  if (tbody) {
    const rows = tbody.querySelectorAll('tr');
    rows.forEach(row => row.style.display = '');
  }
}


function viewAttachment(type, supplierId) {
  showToast(`æŸ¥çœ‹é™„ä»¶åŠŸèƒ½å¼€å‘ä¸­`, 'info');
}

function viewContracts(supplierId) {
  showToast(`æŸ¥çœ‹åˆåŒåŠŸèƒ½å¼€å‘ä¸­`, 'info');
}

// é‡‡è´­é¡µé¢æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
function showPurchaseTab(tab) {
  console.log('åˆ‡æ¢åˆ°æ ‡ç­¾:', tab); // è°ƒè¯•æ—¥å¿—
  
  const plansTab = document.getElementById('plansTab');
  const ordersTab = document.getElementById('ordersTab');
  const warehouseTab = document.getElementById('warehouseTab');
  const quotesTab = document.getElementById('quotesTab');
  const plansSection = document.getElementById('plansSection');
  const ordersSection = document.getElementById('ordersSection');
  const warehouseSection = document.getElementById('warehouseSection');
  const quotesSection = document.getElementById('quotesSection');
  
  if (!plansTab || !ordersTab || !warehouseTab || !quotesTab || !plansSection || !ordersSection || !warehouseSection || !quotesSection) {
    console.error('æ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ :', {
      plansTab: !!plansTab,
      ordersTab: !!ordersTab,
      warehouseTab: !!warehouseTab,
      quotesTab: !!quotesTab,
      plansSection: !!plansSection,
      warehouseSection: !!warehouseSection,
      quotesSection: !!quotesSection
    });
    return;
  }
  
  // é‡ç½®æ‰€æœ‰æ ‡ç­¾å’ŒåŒºåŸŸ
  plansTab.classList.remove('active');
  ordersTab.classList.remove('active');
  warehouseTab.classList.remove('active');
  quotesTab.classList.remove('active');
  plansSection.style.display = 'none';
  ordersSection.style.display = 'none';
  warehouseSection.style.display = 'none';
  quotesSection.style.display = 'none';
  
  if (tab === 'plans') {
    plansTab.classList.add('active');
    plansSection.style.display = 'block';
    renderPurchaseOrders();
  } else if (tab === 'orders') {
    ordersTab.classList.add('active');
    ordersSection.style.display = 'block';
    renderPurchaseOrdersList();
  } else if (tab === 'warehouse') {
    warehouseTab.classList.add('active');
    warehouseSection.style.display = 'block';
    renderWarehouseOrders();
  } else if (tab === 'quotes') {
    quotesTab.classList.add('active');
    quotesSection.style.display = 'block';
    // å¡«å……ç­›é€‰å™¨é€‰é¡¹
    populateQuoteFilters();
    // æ¸²æŸ“æŠ¥ä»·åˆ—è¡¨
    renderSupplierQuotes();
  }
}

// é‡‡è´­è®¢å•åˆ—è¡¨æ¸²æŸ“å‡½æ•°
function renderPurchaseOrdersList() {
  const table = document.getElementById('table-purchaseOrders');
  if (!table) return;
  
  const tbody = table.querySelector('tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  // è·å–ç­›é€‰çŠ¶æ€
  const currentFilter = window.currentPurchaseOrderFilter || 'all';
  let filteredOrders = data.purchaseOrders || [];
  
  if (currentFilter !== 'all') {
    filteredOrders = filteredOrders.filter(order => order.status === currentFilter);
  }
  
  if (filteredOrders.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:20px;">æš‚æ— é‡‡è´­è®¢å•</td></tr>';
    return;
  }
  
  filteredOrders.forEach(order => {
    const tr = document.createElement('tr');
    let actionButtons = `<button class="btn ghost" onclick="openPurchaseOrderDetail('${order.id}')">è¯¦æƒ…</button>`;
    
    // å‘è´§å•é¢„è§ˆå’Œæ‰“å°æŒ‰é’® - æ— çŠ¶æ€é™åˆ¶
    actionButtons += ` <button class="btn ghost" onclick="previewPurchaseOrderDeliverySlip('${order.id}')">é¢„è§ˆå‘è´§å•</button>`;
    actionButtons += ` <button class="btn ghost" onclick="printPurchaseOrderDeliverySlip('${order.id}')">æ‰“å°å‘è´§å•</button>`;
    
    // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒæ“ä½œ
    if (order.status === 'å¾…ä¾›åº”å•†ç¡®è®¤') {
      actionButtons += ` <button class="btn ghost" onclick="editPurchaseOrder('${order.id}')">ç¼–è¾‘</button>`;
    }
    
    if (order.status === 'ä¾›åº”å•†å·²ç¡®è®¤' && !order.signedContract) {
      actionButtons += ` <button class="btn" onclick="uploadSignedContract('${order.id}')">ä¸Šä¼ ç›–ç« åˆåŒ</button>`;
    }
    
    if (order.status === 'å·²å‘è´§' || order.status === 'å¾…æ”¶è´§') {
      actionButtons += ` <button class="btn" onclick="openReceivingModal('${order.id}')">æ”¶è´§</button>`;
    }
    
    tr.innerHTML = `<td>${order.id}</td>
      <td>${order.supplier}</td>
      <td>${order.purchaser}</td>
      <td>Â¥${order.totalAmount?.toFixed(2) || '0.00'}</td>
      <td>${order.estimatedDeliveryDate || '-'}</td>
      <td>${order.actualDeliveryDate || '-'}</td>
      <td>${order.status}</td>
      <td>${order.receiveStatus || '-'}</td>
      <td>${order.createdDate}</td>
      <td>${actionButtons}</td>`;
    tbody.appendChild(tr);
  });
}

// é‡‡è´­è®¢å•çŠ¶æ€ç­›é€‰
function filterPurchaseOrderByStatus(status) {
  window.currentPurchaseOrderFilter = status;
  renderPurchaseOrdersList();
}

// é‡‡è´­è®¢å•è¯¦æƒ…
function openPurchaseOrderDetail(orderId) {
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) return;
  
  openDetail('purchaseOrder', orderId);
}

// é‡‡è´­è®¡åˆ’è½¬é‡‡è´­è®¢å•
function convertPOToPurchaseOrder(poId) {
  const po = data.pos.find(p => p.id === poId);
  if (!po) return;
  
  if (po.status !== 'å¾…é‡‡è´­') {
    showToast('åªæœ‰å®¡æ‰¹é€šè¿‡çš„é‡‡è´­è®¡åˆ’æ‰èƒ½è½¬ä¸ºé‡‡è´­è®¢å•', 'warning');
    return;
  }
  
  // åˆ›å»ºé‡‡è´­è®¢å•
  const purchaseOrderId = 'POD' + Date.now().toString().substr(-8);
  const purchaseOrder = {
    id: purchaseOrderId,
    sourcePOId: po.id,
    supplier: po.supplier,
    status: 'å¾…ä¾›åº”å•†ç¡®è®¤', // é‡‡è´­å‘˜éœ€è¦è”ç³»ä¾›åº”å•†ç¡®è®¤
    lines: po.lines.map(line => ({
      sku: line.sku,
      qty: line.qty,
      price: line.price,
      deliveryDate: '', // å¾…ä¾›åº”å•†ç¡®è®¤äº¤æœŸ
      confirmedQty: line.qty,
      confirmedDate: ''
    })),
    totalAmount: po.lines.reduce((sum, line) => sum + line.qty * line.price, 0),
    purchaser: po.applicant || currentUser,
    createdDate: new Date().toISOString().split('T')[0],
    estimatedDeliveryDate: '',
    actualDeliveryDate: '',
    signedContract: null,
    deliverySlipId: '',
    deliverySlipQueryCode: '',
    receiveStatus: '',
    receiveDate: '',
    receiveNotes: '',
    hasQualityIssues: false,
    warehouseNotes: '',
    invoiceReceived: false,
    paymentStatus: 'å¾…ä»˜æ¬¾',
    supplierContact: '', // ä¾›åº”å•†è”ç³»äºº
    supplierContactDate: '', // ä¾›åº”å•†è”ç³»æ—¥æœŸ
    supplierNotes: '' // ä¾›åº”å•†æ²Ÿé€šå¤‡æ³¨
  };
  
  // æ·»åŠ åˆ°é‡‡è´­è®¢å•åˆ—è¡¨
  if (!data.purchaseOrders) {
    data.purchaseOrders = [];
  }
  data.purchaseOrders.push(purchaseOrder);
  
  // æ›´æ–°é‡‡è´­è®¡åˆ’çŠ¶æ€
  po.status = 'å·²è½¬è®¢å•';
  po.convertedToOrder = true;
  po.convertedDate = new Date().toISOString().split('T')[0];
  
  showToast(`é‡‡è´­è®¡åˆ’ ${po.id} å·²è½¬ä¸ºé‡‡è´­è®¢å• ${purchaseOrderId}\nè¯·åŠæ—¶è”ç³»ä¾›åº”å•†ç¡®è®¤è®¢å•è¯¦æƒ…`, 'success');
  renderPurchaseOrders();
  renderPurchaseOrdersList();
}

// ä»“åº“è®¢å•æ¸²æŸ“å‡½æ•°
function renderWarehouseOrders() {
  const table = document.getElementById('table-warehouse');
  if (!table) return;
  
  const tbody = table.querySelector('tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  const warehousePOs = data.pos.filter(po => po.status === 'ä»“åº“å¾…å‘è´§');
  
  // Apply filters if they exist
  const salesmanFilter = document.getElementById('warehouseSalesmanFilter')?.value || '';
  const dateFilter = document.getElementById('warehouseDateFilter')?.value || '';
  const searchFilter = document.getElementById('warehouseSearchFilter')?.value.toLowerCase() || '';
  
  const filteredPOs = warehousePOs.filter(po => {
    // Filter by salesman
    if (salesmanFilter && po.warehouseProcessor !== salesmanFilter) {
      return false;
    }
    
    // Filter by date
    if (dateFilter && po.warehouseReadyDate !== dateFilter) {
      return false;
    }
    
    // Filter by product name
    if (searchFilter) {
      const productNames = po.lines.map(line => {
        const product = data.products.find(p => p.sku === line.sku);
        return product ? product.name.toLowerCase() : '';
      }).join(' ');
      
      if (!productNames.includes(searchFilter)) {
        return false;
      }
    }
    
    return true;
  });
  
  filteredPOs.forEach(po => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${po.batchNumber || '-'}</td>
      <td>${po.lines.map(line => {
        const product = data.products.find(p => p.sku === line.sku);
        return product ? getProductImage(product.image) : '';
      }).join('')}</td>
      <td>${po.lines.map(l => l.sku).join(', ')}</td>
      <td>${po.lines.map(line => {
        const product = data.products.find(p => p.sku === line.sku);
        return product ? product.name : line.sku;
      }).join(', ')}</td>
      <td>${po.lines.map(line => {
        const product = data.products.find(p => p.sku === line.sku);
        return product ? product.model : '-';
      }).join(', ')}</td>
      <td>${po.lines.reduce((sum, line) => sum + line.qty, 0)}</td>
      <td>${po.cartonCount || '-'}</td>
      <td>${po.weight || '-'}</td>
      <td>${po.logisticsCompany || '-'}</td>
      <td>${po.logisticsTrackingNumber || '-'}</td>
      <td>${po.logisticsCost || '-'}</td>
      <td>
        <button class="btn ghost" onclick="printWarehouseDeliverySlip('${po.id}')">æ‰“å°å‘è´§å•</button>
        <button class="btn" onclick="openWarehouseDeliveryModal('${po.id}')">å¡«å†™ç‰©æµä¿¡æ¯</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// è¿‡æ»¤ä»“åº“å¾…å‘è´§è®¢å•
function filterWarehouseOrders() {
  renderWarehouseOrders();
}

// æ‰“å°ä»“åº“å‘è´§å•
function printWarehouseDeliverySlip(poId) {
  const po = data.pos.find(p => p.id === poId);
  if (!po) return;
  
  const batchNumber = po.batchNumber || generateBatchNumber(po);
  po.batchNumber = batchNumber;
  
  const printContent = `
    <div style="padding:20px;font-family:Arial,sans-serif;">
      <div style="text-align:center;margin-bottom:20px;">
        <h2>å‘è´§å•</h2>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px;margin-bottom:20px;">
        <div><strong>å‘è´§å•å·ï¼š</strong>${po.deliverySlipId || '-'}</div>
        <div><strong>æ‰¹æ¬¡å·ï¼š</strong>${batchNumber}</div>
        <div><strong>è®¢å•å·ï¼š</strong>${po.id}</div>
        <div><strong>ä¸šåŠ¡å‘˜ï¼š</strong>${po.applicant}</div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
        <div><strong>æ‰“å°æ—¶é—´ï¼š</strong>${new Date().toLocaleString()}</div>
        <div><strong>å‘è´§æ—¶é—´ï¼š</strong>${po.warehouseProcessDate || '-'}</div>
      </div>
      
      <h3>å‘è´§å•æ˜ç»†</h3>
      <table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
        <thead>
          <tr style="border-bottom:2px solid #333;">
            <th style="padding:8px;text-align:left;">ç¼–å·</th>
            <th style="padding:8px;text-align:left;">å›¾ç‰‡</th>
            <th style="padding:8px;text-align:left;">å“å</th>
            <th style="padding:8px;text-align:left;">SKU</th>
            <th style="padding:8px;text-align:center;">å‘è´§æ•°é‡</th>
            <th style="padding:8px;text-align:left;">å¤‡æ³¨</th>
          </tr>
        </thead>
        <tbody>
          ${po.lines.map((line, index) => {
            const product = data.products.find(p => p.sku === line.sku);
            return `
              <tr style="border-bottom:1px solid #ddd;">
                <td style="padding:8px;">${index + 1}</td>
                <td style="padding:8px;">${product ? getProductImage(product.image) : ''}</td>
                <td style="padding:8px;">${product ? product.name : line.sku}</td>
                <td style="padding:8px;">${line.sku}</td>
                <td style="padding:8px;text-align:center;">${line.qty}</td>
                <td style="padding:8px;">${po.notes || '-'}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
      
      <div style="margin-top:30px;">
        <strong>å¤‡æ³¨ä¿¡æ¯ï¼š</strong>${po.notes || 'æ— '}
      </div>
    </div>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printContent);
  printWindow.document.close();
  printWindow.print();
  printWindow.close();
  
  showToast('å‘è´§å•å·²å‘é€åˆ°æ‰“å°æœº', 'success');
}

// ç”Ÿæˆæ‰¹æ¬¡å·
function generateBatchNumber(po) {
  return po.id + '-' + Date.now().toString(36).substr(-6);
}

// æ‰“å¼€ä»“åº“å‘è´§æ¨¡æ€æ¡†
function openWarehouseDeliveryModal(poId) {
  const po = data.pos.find(p => p.id === poId);
  if (!po) return;
  
  const modal = document.getElementById('warehouseDeliveryModal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.style.display = '';
    
    // å¡«å……é‡‡è´­è®¢å•ä¿¡æ¯
    const poIdEl = document.getElementById('warehousePOId');
    const supplierEl = document.getElementById('warehouseSupplier');
    const totalQtyEl = document.getElementById('warehouseTotalQty');
    
    if (poIdEl) poIdEl.textContent = po.id;
    if (supplierEl) supplierEl.textContent = po.supplier;
    if (totalQtyEl) totalQtyEl.textContent = po.lines.reduce((sum, line) => sum + line.qty, 0);
    
    // å­˜å‚¨å½“å‰é‡‡è´­è®¢å•ID
    window.currentWarehousePOId = poId;
  }
}

// ä¿å­˜ä»“åº“å‘è´§ä¿¡æ¯
function saveWarehouseDelivery() {
  const po = data.pos.find(p => p.id === window.currentWarehousePOId);
  if (!po) return;
  
  const logisticsCompany = document.getElementById('logisticsCompany').value;
  const logisticsNumber = document.getElementById('logisticsNumber').value;
  const logisticsCost = document.getElementById('logisticsCost').value;
  const estimatedDelivery = document.getElementById('estimatedDelivery').value;
  const deliveryNotes = document.getElementById('deliveryNotes').value;
  
  if (!logisticsCompany || !logisticsNumber) {
    showToast('è¯·å¡«å†™ç‰©æµå…¬å¸å’Œç‰©æµå•å·', 'warning');
    return;
  }
  
  // æ›´æ–°é‡‡è´­è®¢å•ä¿¡æ¯
  po.logisticsCompany = logisticsCompany;
  po.logisticsTrackingNumber = logisticsNumber;
  po.logisticsCost = logisticsCost;
  po.estimatedDelivery = estimatedDelivery;
  po.deliveryNotes = deliveryNotes;
  po.warehouseProcessor = currentUser;
  po.warehouseProcessDate = new Date().toISOString().split('T')[0];
  
  // æ›´æ–°çŠ¶æ€ä¸ºå·²å‘è´§
  po.status = 'å·²å‘è´§';
  
  closeWarehouseDeliveryModal();
  renderWarehouseOrders();
  renderPurchaseOrders();
  renderAll();
  showToast('ç‰©æµä¿¡æ¯å·²ä¿å­˜ï¼Œè®¢å•çŠ¶æ€å·²æ›´æ–°ä¸ºå·²å‘è´§', 'success');
}

// å…³é—­ä»“åº“å‘è´§æ¨¡æ€æ¡†
function closeWarehouseDeliveryModal() {
  const modal = document.getElementById('warehouseDeliveryModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
  }
}

// é‡‡è´­è®¡åˆ’è¯¦æƒ…åŠŸèƒ½
function viewPODetail(poId) {
  const po = data.pos.find(p => p.id === poId);
  if (!po) return;
  
  const modal = document.getElementById('poDetailModal');
  const content = document.getElementById('poDetailContent');
  
  // å­˜å‚¨å½“å‰æŸ¥çœ‹çš„é‡‡è´­è®¡åˆ’ID
  window.currentViewingPOId = poId;
  
  // åŒæ­¥é‡‡è´­è®¡åˆ’ä¸­çš„é€‰æ‹©åˆ°å…¨å±€å˜é‡
  if (po.selectedQuotes) {
    if (!window.selectedQuotes) {
      window.selectedQuotes = {};
    }
    // å°†é‡‡è´­è®¡åˆ’ä¸­çš„é€‰æ‹©åŒæ­¥åˆ°å…¨å±€å˜é‡
    Object.keys(po.selectedQuotes).forEach(sku => {
      window.selectedQuotes[sku] = po.selectedQuotes[sku];
    });
  }
  
  if (!modal || !content) return;
  
  // æŸ¥æ‰¾ç›¸å…³ä¾›åº”å•†æŠ¥ä»·
  const relatedQuotes = (data.supplierQuotes || []).filter(quote => {
    return po.lines.some(line => line.sku === quote.product);
  });
  
  content.innerHTML = `
    <div class="form-section">
      <div class="section-title">é‡‡è´­è®¡åˆ’åŸºæœ¬ä¿¡æ¯</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
        <div><strong>é‡‡è´­å•å·ï¼š</strong>${po.id}</div>
        <div><strong>ä¾›åº”å•†ï¼š</strong>${po.supplier}</div>
        <div><strong>ç”³è¯·äººï¼š</strong>${po.applicant || '-'}</div>
        <div><strong>çŠ¶æ€ï¼š</strong>${po.status} ${po.convertedToOrder ? '<span style="color:#10b981;font-size:12px;margin-left:8px;">âœ… å·²è½¬è®¢å•</span>' : ''}</div>
        <div><strong>ç”³è¯·æ—¶é—´ï¼š</strong>${po.applyDate || '-'}</div>
        <div><strong>æ€»é¢ï¼š</strong>Â¥${po.total}</div>
        ${po.convertedToOrder && po.convertedDate ? `<div style="grid-column:1/-1;color:#666;font-size:13px;"><strong>è½¬å•æ—¶é—´ï¼š</strong>${po.convertedDate}</div>` : ''}
      </div>
    </div>
    
    <div class="form-section">
      <div class="section-title">é‡‡è´­æ˜ç»†</div>
      <div style="margin-bottom:16px;">
        ${po.lines.map(line => {
          const product = data.products.find(p => p.sku === line.sku);
          return `
            <div style="padding:12px;background:var(--hover-bg);border-radius:6px;margin-bottom:8px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <strong>${product ? product.name : line.sku}</strong>
                <span>æ•°é‡ï¼š${line.qty} Ã— Â¥${line.price} = Â¥${(line.qty * line.price).toFixed(2)}</span>
              </div>
              <div class="small muted">${line.sku}</div>
              
              <!-- ç›¸å…³ä¾›åº”å•†æŠ¥ä»·å¯¹æ¯” -->
              <div style="margin-top:12px;">
                <div style="font-weight:600;margin-bottom:8px;color:var(--primary)">ä¾›åº”å•†æŠ¥ä»·å¯¹æ¯”ï¼š</div>
                ${getProductQuotesHTML(line.sku)}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
    
    <div class="form-section">
      <div class="section-title">æœ€ä¼˜æŠ¥ä»·å»ºè®®</div>
      <div id="bestQuoteSuggestion">
        ${generateBestQuoteSuggestion(po)}
      </div>
    </div>
  `;
  
  modal.classList.remove('hidden');
  modal.style.display = '';
  
  // è®¾ç½®ä¿å­˜æŒ‰é’®çš„poIdå‚æ•°
  const saveBtn = document.getElementById('saveQuoteSelectionBtn');
  if (saveBtn) {
    saveBtn.setAttribute('onclick', `saveSelectedQuotesToPO('${poId}')`);
  }
}

function getProductQuotesHTML(sku) {
  const quotes = (data.supplierQuotes || []).filter(q => q.product === sku);
  
  if (quotes.length === 0) {
    return '<div style="color:var(--muted);font-size:14px;">æš‚æ— ç›¸å…³æŠ¥ä»·</div>';
  }
  
  // æ£€æŸ¥é‡‡è´­è®¡åˆ’æ˜¯å¦å·²è½¬ä¸ºè®¢å•
  const isConvertedToOrder = window.currentViewingPOId && data.pos.find(p => p.id === window.currentViewingPOId)?.convertedToOrder;
  
  // æŒ‰ä»·æ ¼ä»ä½åˆ°é«˜æ’åº
  quotes.sort((a, b) => a.price - b.price);
  
  // è·å–å½“å‰é€‰ä¸­çš„æŠ¥ä»·ï¼ˆä¼˜å…ˆä»é‡‡è´­è®¡åˆ’ä¸­è·å–ï¼‰
  let selectedQuote = null;
  if (window.currentViewingPOId) {
    const currentPO = data.pos.find(p => p.id === window.currentViewingPOId);
    if (currentPO && currentPO.selectedQuotes) {
      selectedQuote = currentPO.selectedQuotes[sku];
    }
  }
  // å¦‚æœé‡‡è´­è®¡åˆ’ä¸­æ²¡æœ‰ï¼Œåˆ™ä»å…¨å±€å˜é‡ä¸­è·å–
  if (!selectedQuote && window.selectedQuotes) {
    selectedQuote = window.selectedQuotes[sku];
  }
  
  return `
    <table style="width:100%;font-size:14px;border-collapse:collapse;">
      <thead>
        <tr style="background:var(--hover-bg);">
          <th style="padding:6px;text-align:left;border:1px solid var(--border-color);">ä¾›åº”å•†</th>
          <th style="padding:6px;text-align:left;border:1px solid var(--border-color);">æŠ¥ä»·</th>
          <th style="padding:6px;text-align:left;border:1px solid var(--border-color);">æœ€å°èµ·è®¢é‡</th>
          <th style="padding:6px;text-align:left;border:1px solid var(--border-color);">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        ${quotes.map((quote, index) => {
          const supplier = data.suppliers.find(s => s.id === quote.supplier);
          const isSelected = selectedQuote && selectedQuote.supplier === quote.supplier && selectedQuote.price === quote.price;
          const rowStyle = isSelected ? 'background: #e0f2fe; border: 2px solid #0ea5e9;' : '';
          
          return `
            <tr style="${rowStyle}" id="quote-row-${sku}-${quote.supplier}">
              <td style="padding:6px;border:1px solid var(--border-color); ${isSelected ? 'font-weight: 600;' : ''}">${supplier ? supplier.name : quote.supplier}</td>
              <td style="padding:6px;border:1px solid var(--border-color); ${isSelected ? 'font-weight: 600; color: #0ea5e9;' : ''}">Â¥${quote.price.toFixed(2)}</td>
              <td style="padding:6px;border:1px solid var(--border-color);">${quote.minQty}</td>
              <td style="padding:6px;border:1px solid var(--border-color);">
                ${isSelected ? 
                  `<span style="color: #0ea5e9; font-weight: 600; padding: 4px 8px; font-size: 12px;">âœ“ å·²é€‰æ‹©</span>` :
                  (isConvertedToOrder ? 
                    `<span style="color: #666; font-style: italic; padding: 4px 8px; font-size: 12px;">å·²è½¬è®¢å•</span>` :
                    `<button class="btn ghost" onclick="selectQuoteForProduct('${sku}', '${quote.supplier}', ${quote.price}, '${supplier ? supplier.name : quote.supplier}')" style="padding:4px 8px;font-size:12px;">é€‰æ‹©</button>`
                  )
                }
              </td>
            </tr>
          `;
        }).join('')}
      </tbody>
    </table>
    
    ${selectedQuote ? `
    <div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px;">
      <div style="font-weight: 600; margin-bottom: 8px; color: #0ea5e9;">å·²é€‰æŠ¥ä»·ä¿¡æ¯ï¼š</div>
      <div style="font-size: 14px; line-height: 1.5;">
        <div><strong>ä¾›åº”å•†ï¼š</strong>${selectedQuote.supplierName}</div>
        <div><strong>æŠ¥ä»·ï¼š</strong>Â¥${selectedQuote.price.toFixed(2)}</div>
        <div><strong>é€‰æ‹©åŸå› ï¼š</strong>${selectedQuote.reason || 'æœªå¡«å†™'}</div>
      </div>
      <div style="margin-top: 8px;">
        ${isConvertedToOrder ? 
          `<span style="color: #666; font-style: italic; font-size: 12px;">é‡‡è´­è®¡åˆ’å·²è½¬ä¸ºè®¢å•ï¼Œæ— æ³•æ›´æ”¹</span>` :
          `<button class="btn ghost" onclick="changeQuoteSelection('${sku}')" style="padding: 4px 8px; font-size: 12px;">é‡æ–°é€‰æ‹©</button>`
        }
      </div>
    </div>
    ` : ''}
  `;
}

function generateBestQuoteSuggestion(po) {
  let suggestions = [];
  let selectedQuotes = [];
  
  // æ”¶é›†å·²é€‰æ‹©çš„æŠ¥ä»·
  if (window.selectedQuotes) {
    po.lines.forEach(line => {
      if (window.selectedQuotes[line.sku]) {
        const selected = window.selectedQuotes[line.sku];
        const product = data.products.find(p => p.sku === line.sku);
        
        selectedQuotes.push({
          product: product ? product.name : line.sku,
          supplier: selected.supplierName,
          price: selected.price,
          reason: selected.reason,
          line: line
        });
      }
    });
  }
  
  // æ”¶é›†æœ€ä¼˜æŠ¥ä»·å»ºè®®
  po.lines.forEach(line => {
    const quotes = (data.supplierQuotes || []).filter(q => q.product === line.sku);
    if (quotes.length > 0) {
      // æ‰¾åˆ°æœ€ä½æŠ¥ä»·
      const bestQuote = quotes.reduce((best, current) => 
        current.price < best.price ? current : best
      );
      const supplier = data.suppliers.find(s => s.id === bestQuote.supplier);
      const product = data.products.find(p => p.sku === line.sku);
      
      // æ£€æŸ¥æ˜¯å¦å·²è¢«é€‰æ‹©
      const isSelected = window.selectedQuotes && window.selectedQuotes[line.sku];
      
      if (!isSelected) {
        suggestions.push({
          product: product ? product.name : line.sku,
          supplier: supplier ? supplier.name : bestQuote.supplier,
          price: bestQuote.price,
          savings: (line.price - bestQuote.price) * line.qty
        });
      }
    }
  });
  
  let html = '';
  
  // æ˜¾ç¤ºå·²é€‰æ‹©çš„æŠ¥ä»·
  if (selectedQuotes.length > 0) {
    html += `
      <div style="background:#e0f2fe;color:#0ea5e9;padding:12px;border-radius:6px;margin-bottom:12px;">
        <div style="font-weight:600;margin-bottom:8px;">âœ… å·²é€‰æ‹©çš„ä¾›åº”å•†æŠ¥ä»·</div>
        ${selectedQuotes.map(s => `
          <div style="margin-bottom:6px;padding:8px;background:white;border-radius:4px;">
            <div style="font-weight:500;margin-bottom:2px;">${s.product}</div>
            <div style="font-size:12px;color:#666;margin-bottom:2px;">
              ä¾›åº”å•†ï¼š${s.supplier} | æŠ¥ä»·ï¼šÂ¥${s.price.toFixed(2)}
            </div>
            <div style="font-size:12px;color:#0ea5e9;">
              åŸå› ï¼š${s.reason}
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }
  
  // æ˜¾ç¤ºæœ€ä¼˜æŠ¥ä»·å»ºè®®
  if (suggestions.length > 0) {
    const totalSavings = suggestions.reduce((sum, s) => sum + s.savings, 0);
    
    html += `
      <div style="background:var(--success-bg);color:var(--success);padding:12px;border-radius:6px;">
        <div style="font-weight:600;margin-bottom:8px;">ğŸ’° æˆæœ¬ä¼˜åŒ–å»ºè®®</div>
        ${suggestions.map(s => `
          <div style="margin-bottom:4px;">
            ${s.product} å»ºè®®é€‰æ‹© ${s.supplier} (Â¥${s.price.toFixed(2)})ï¼Œ
            å¯èŠ‚çœ Â¥${s.savings.toFixed(2)}
          </div>
        `).join('')}
        <div style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(16,185,129,0.2);">
          <strong>æ€»è®¡å¯èŠ‚çœï¼šÂ¥${totalSavings.toFixed(2)}</strong>
        </div>
      </div>
    `;
  }
  
  if (!html) {
    return '<div style="color:var(--muted);">æš‚æ— å¯æ¯”ä»·å»ºè®®</div>';
  }
  
  return html;
}

function closePODetail() {
  const modal = document.getElementById('poDetailModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
  }
}

// ä¾›åº”å•†é€‰æ‹©ç†ç”±ç›¸å…³å˜é‡
let currentQuoteSelection = null;

function selectQuoteForProduct(sku, supplier, price, supplierName) {
  // ä¿å­˜å½“å‰é€‰æ‹©çš„ä¿¡æ¯
  currentQuoteSelection = {
    sku: sku,
    supplier: supplier,
    supplierName: supplierName,
    price: price
  };
  
  // æ˜¾ç¤ºä¾›åº”å•†ä¿¡æ¯
  document.getElementById('quoteReasonSupplierInfo').innerHTML = `
    <div><strong>ä¾›åº”å•†ï¼š</strong>${supplierName}</div>
    <div><strong>æŠ¥ä»·ï¼š</strong>Â¥${price.toFixed(2)}</div>
    <div><strong>äº§å“SKUï¼š</strong>${sku}</div>
  `;
  
  // æ¸…ç©ºä¹‹å‰è¾“å…¥çš„åŸå› 
  document.getElementById('quoteReasonInput').value = '';
  
  // æ˜¾ç¤ºæ¨¡æ€æ¡†
  document.getElementById('quoteReasonModal').classList.remove('hidden');
  document.getElementById('quoteReasonModal').style.display = 'flex';
  
  // èšç„¦åˆ°è¾“å…¥æ¡†
  setTimeout(() => {
    document.getElementById('quoteReasonInput').focus();
  }, 100);
  
  // æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
  document.getElementById('quoteReasonInput').addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeQuoteReasonModal();
    } else if (e.key === 'Enter' && e.ctrlKey) {
      confirmQuoteReason();
    }
  });
}

function closeQuoteReasonModal() {
  document.getElementById('quoteReasonModal').classList.add('hidden');
  document.getElementById('quoteReasonModal').style.display = 'none';
  currentQuoteSelection = null;
}

function confirmQuoteReason() {
  const reasonInput = document.getElementById('quoteReasonInput');
  const reason = reasonInput.value.trim();
  
  if (!reason) {
    showToast('è¯·è¾“å…¥é€‰æ‹©åŸå› ', 'error');
    reasonInput.focus();
    return;
  }
  
  if (!currentQuoteSelection) {
    showToast('é€‰æ‹©ä¿¡æ¯ä¸¢å¤±ï¼Œè¯·é‡æ–°é€‰æ‹©', 'error');
    closeQuoteReasonModal();
    return;
  }
  
  // åˆå§‹åŒ–é€‰æ‹©å­˜å‚¨
  if (!window.selectedQuotes) {
    window.selectedQuotes = {};
  }
  
  // ä¿å­˜é€‰æ‹©ç»“æœåˆ°å…¨å±€å˜é‡
  window.selectedQuotes[currentQuoteSelection.sku] = {
    supplier: currentQuoteSelection.supplier,
    supplierName: currentQuoteSelection.supplierName,
    price: currentQuoteSelection.price,
    reason: reason,
    selectTime: new Date().toISOString()
  };
  
  // åŒæ—¶ä¿å­˜åˆ°å½“å‰é‡‡è´­è®¡åˆ’ä¸­
  if (window.currentViewingPOId) {
    const currentPO = data.pos.find(p => p.id === window.currentViewingPOId);
    if (currentPO) {
      if (!currentPO.selectedQuotes) {
        currentPO.selectedQuotes = {};
      }
      currentPO.selectedQuotes[currentQuoteSelection.sku] = {
        supplier: currentQuoteSelection.supplier,
        supplierName: currentQuoteSelection.supplierName,
        price: currentQuoteSelection.price,
        reason: reason,
        selectTime: new Date().toISOString()
      };
    }
  }
  
  // å…³é—­æ¨¡æ€æ¡†
  closeQuoteReasonModal();
  
  // é‡æ–°æ¸²æŸ“æŠ¥ä»·åˆ—è¡¨ä»¥æ˜¾ç¤ºé«˜äº®
  updateQuoteDisplay(currentQuoteSelection.sku);
  
  showToast(`å·²é€‰æ‹©ä¾›åº”å•† ${currentQuoteSelection.supplierName} çš„æŠ¥ä»·ï¼šÂ¥${currentQuoteSelection.price}`, 'success');
}

function changeQuoteSelection(sku) {
  // æ¸…é™¤å…¨å±€å˜é‡ä¸­çš„é€‰æ‹©
  if (window.selectedQuotes && window.selectedQuotes[sku]) {
    delete window.selectedQuotes[sku];
  }
  
  // æ¸…é™¤é‡‡è´­è®¡åˆ’ä¸­çš„é€‰æ‹©
  if (window.currentViewingPOId) {
    const currentPO = data.pos.find(p => p.id === window.currentViewingPOId);
    if (currentPO && currentPO.selectedQuotes && currentPO.selectedQuotes[sku]) {
      delete currentPO.selectedQuotes[sku];
    }
  }
  
  // é‡æ–°æ¸²æŸ“æŠ¥ä»·åˆ—è¡¨
  updateQuoteDisplay(sku);
  
  showToast('å·²æ¸…é™¤é€‰æ‹©ï¼Œè¯·é‡æ–°é€‰æ‹©æŠ¥ä»·', 'info');
}

function updateQuoteDisplay(sku) {
  // é‡æ–°æ¸²æŸ“é‡‡è´­è®¡åˆ’è¯¦æƒ…é¡µé¢
  const modal = document.getElementById('poDetailModal');
  const content = document.getElementById('poDetailContent');
  
  if (modal && !modal.classList.contains('hidden')) {
    // å¦‚æœé‡‡è´­è®¡åˆ’è¯¦æƒ…é¡µé¢æ˜¯æ‰“å¼€çš„ï¼Œé‡æ–°æ¸²æŸ“æ•´ä¸ªé¡µé¢
    const currentPOId = window.currentViewingPOId;
    if (currentPOId) {
      viewPODetail(currentPOId);
    }
  }
}

function selectBestQuote() {
  showToast('å·²æ ¹æ®æœ€ä¼˜æŠ¥ä»·ç”Ÿæˆé‡‡è´­å»ºè®®', 'success');
}

function saveSelectedQuotesToPO(poId) {
  const po = data.pos.find(p => p.id === poId);
  if (!po) {
    showToast('é‡‡è´­è®¡åˆ’ä¸å­˜åœ¨', 'error');
    return;
  }
  
  if (!window.selectedQuotes || Object.keys(window.selectedQuotes).length === 0) {
    showToast('è¯·å…ˆé€‰æ‹©ä¾›åº”å•†æŠ¥ä»·', 'warning');
    return;
  }
  
  // ä¿å­˜é€‰æ‹©çš„æŠ¥ä»·åˆ°é‡‡è´­è®¡åˆ’
  po.selectedQuotes = {};
  po.lines.forEach(line => {
    if (window.selectedQuotes[line.sku]) {
      po.selectedQuotes[line.sku] = window.selectedQuotes[line.sku];
      
      // æ›´æ–°é‡‡è´­è®¡åˆ’çš„ä»·æ ¼ä¸ºé€‰ä¸­çš„æŠ¥ä»·ä»·æ ¼
      line.selectedPrice = window.selectedQuotes[line.sku].price;
      line.selectedSupplier = window.selectedQuotes[line.sku].supplierName;
      line.selectReason = window.selectedQuotes[line.sku].reason;
    }
  });
  
  po.selectionDate = new Date().toISOString().split('T')[0];
  
  showToast('ä¾›åº”å•†æŠ¥ä»·é€‰æ‹©å·²ä¿å­˜åˆ°é‡‡è´­è®¡åˆ’', 'success');
  
  // é‡æ–°æ¸²æŸ“é‡‡è´­è®¡åˆ’è¯¦æƒ…
  viewPODetail(poId);
}

function populateQuoteFilters() {
  const supplierFilter = document.getElementById('quoteFilterSupplier');
  const productFilter = document.getElementById('quoteFilterProduct');
  
  if (!supplierFilter || !productFilter) return;
  
  // å¡«å……ä¾›åº”å•†é€‰é¡¹
  supplierFilter.innerHTML = '<option value="">å…¨éƒ¨ä¾›åº”å•†</option>';
  const uniqueSuppliers = [...new Set((data.supplierQuotes || []).map(q => q.supplier))];
  uniqueSuppliers.forEach(supplierId => {
    const supplier = data.suppliers.find(s => s.id === supplierId);
    if (supplier) {
      supplierFilter.innerHTML += `<option value="${supplierId}">${supplier.name}</option>`;
    }
  });
  
  // å¡«å……äº§å“é€‰é¡¹
  productFilter.innerHTML = '<option value="">å…¨éƒ¨äº§å“</option>';
  const uniqueProducts = [...new Set((data.supplierQuotes || []).map(q => q.product))];
  uniqueProducts.forEach(sku => {
    const product = data.products.find(p => p.sku === sku);
    if (product) {
      productFilter.innerHTML += `<option value="${sku}">${sku} Â· ${product.name}</option>`;
    }
  });
}

function renderSupplierQuotes() {
  const tbody = document.querySelector('#table-quotes tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  const quotes = data.supplierQuotes || [];
  
  if (quotes.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);">æš‚æ— æŠ¥ä»·æ•°æ®</td></tr>';
    return;
  }
  
  quotes.forEach((quote, index) => {
    const supplier = data.suppliers.find(s => s.id === quote.supplier);
    const product = data.products.find(p => p.sku === quote.product);
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${supplier ? supplier.name : quote.supplier}</td>
      <td>${product ? product.name : quote.productName || quote.product}</td>
      <td>Â¥${(quote.price || 0).toFixed(2)}</td>
      <td>${quote.minQty}</td>
      <td>${quote.createDate || '-'}</td>
      <td>
        <button class="btn ghost" onclick="editQuote(${index})">ç¼–è¾‘</button>
        <button class="btn ghost" style="background:var(--danger);color:white" onclick="deleteQuote(${index})">åˆ é™¤</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function filterQuotes() {
  const supplierFilter = document.getElementById('quoteFilterSupplier').value;
  const productFilter = document.getElementById('quoteFilterProduct').value;
  
  const tbody = document.querySelector('#table-quotes tbody');
  if (!tbody) return;
  
  const rows = tbody.querySelectorAll('tr');
  rows.forEach(row => {
    const cells = row.querySelectorAll('td');
    if (cells.length < 6) return;
    
    const supplierName = cells[0].textContent;
    const productName = cells[1].textContent;
    
    const matchSupplier = !supplierFilter || supplierName.includes(document.querySelector('#quoteFilterSupplier option:checked').textContent);
    const matchProduct = !productFilter || productName.includes(document.querySelector('#quoteFilterProduct option:checked').textContent);
    
    row.style.display = matchSupplier && matchProduct ? '' : 'none';
  });
}

function editQuote(index) {
  const quote = data.supplierQuotes[index];
  if (!quote) return;
  
  // å¡«å……ç¼–è¾‘è¡¨å•
  const modal = document.getElementById('supplierQuoteModal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.style.display = '';
    
    // è®¾ç½®å½“å‰ç¼–è¾‘çš„ç´¢å¼•
    modal.setAttribute('data-edit-index', index);
    
    // å¡«å……è¡¨å•æ•°æ®
    document.getElementById('quoteSupplier').value = quote.supplier;
    document.getElementById('quoteProduct').value = quote.product;
    document.getElementById('quotePrice').value = quote.price;
    document.getElementById('quoteMinQty').value = quote.minQty;
    
    // é‡æ–°æ¸²æŸ“å½“å‰æŠ¥ä»·åˆ—è¡¨
    quoteDraft = [quote];
    renderQuoteList();
  }
}

function deleteQuote(index) {
  if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æŠ¥ä»·å—ï¼Ÿ')) {
    data.supplierQuotes.splice(index, 1);
    renderSupplierQuotes();
    showToast('æŠ¥ä»·å·²åˆ é™¤', 'success');
  }
}

// ä¿®æ”¹saveQuoteså‡½æ•°ä»¥æ”¯æŒç¼–è¾‘æ¨¡å¼
const originalSaveQuotes = saveQuotes;
function saveQuotes() {
  const modal = document.getElementById('supplierQuoteModal');
  const editIndex = modal ? modal.getAttribute('data-edit-index') : null;
  
  if (quoteDraft.length === 0) {
    showToast('è¯·è‡³å°‘æ·»åŠ ä¸€æ¡æŠ¥ä»·', 'error');
    return;
  }
  
  if (editIndex !== null) {
    // ç¼–è¾‘æ¨¡å¼
    data.supplierQuotes[parseInt(editIndex)] = quoteDraft[0];
    showToast('æŠ¥ä»·å·²æ›´æ–°', 'success');
  } else {
    // æ–°å¢æ¨¡å¼
    if (!data.supplierQuotes) data.supplierQuotes = [];
    data.supplierQuotes.push(...quoteDraft);
    
    // å¦‚æœæœ‰å…³è”çš„é‡‡è´­è®¡åˆ’ï¼Œæ ‡è®°æŠ¥ä»·å·²æ”¶é›†
    if (window.currentPOId) {
      const po = data.pos.find(p => p.id === window.currentPOId);
      if (po) {
        po.quotesCollected = true;
        showToast('é‡‡è´­è®¡åˆ’æŠ¥ä»·æ”¶é›†å®Œæˆï¼Œå¯ä»¥æäº¤å®¡æ‰¹äº†', 'success');
      }
      window.currentPOId = null;
    }
  }
  
  // æ¸…ç†ç¼–è¾‘çŠ¶æ€
  if (modal) {
    modal.removeAttribute('data-edit-index');
  }
  
  quoteDraft = [];
  closeSupplierQuote();
  renderQuotes();
}

/* ========= äº¤äº’ / è·¯ç”± ========== */
const views = ['dashboard','products','purchase','inventory','sales','suppliers'];
function showView(name){
  views.forEach(v=>{
    const el = document.getElementById(v + 'View');
    if(el) el.classList.toggle('hidden', v!==name);
  });
  // nav active
  $all('#nav button').forEach(b=>b.classList.toggle('active', b.dataset.view===name));
  
  // å¦‚æœåˆ‡æ¢åˆ°é”€å”®ç®¡ç†è§†å›¾ï¼Œåˆå§‹åŒ–é”€å”®å­è§†å›¾
  if(name === 'sales') {
    // ç¡®ä¿æ˜¾ç¤ºè®¢å•å­è§†å›¾
    showSalesSubView('orders');
  }
}

$all('#nav button').forEach(b=>b.addEventListener('click', ()=>{ showView(b.dataset.view); }));

$('#globalSearch').addEventListener('input', ()=>{ renderProducts(); });

function openDetail(type,id){
  const side = $('#sideDetail');
  const overlay = createModalOverlay();
  
  // æ˜¾ç¤ºé®ç½©å±‚å’Œè¯¦æƒ…æ¡†
  overlay.classList.remove('hidden');
  side.classList.remove('hidden');
  
  const title = $('#detailTitle');
  const body = $('#detailBody');
  if(type==='product'){
    const p = data.products.find(x=>x.sku===id);
    title.textContent = `äº§å“ï¼š${p.sku} Â· ${p.name}`;
    
    let bomHtml = '';
    if(p.bom && p.bom.length > 0){
      bomHtml = `
        <div style="margin-top:12px">
          <strong>BOM ç‰©æ–™æ¸…å•ï¼š</strong>
          <table style="width:100%;margin-top:4px;font-size:12px">
            <thead><tr><th>ç»„ä»¶SKU</th><th>ç»„ä»¶åç§°</th><th>æ•°é‡</th></tr></thead>
            <tbody>
              ${p.bom.map(item => `
                <tr>
                  <td>${item.component_sku}</td>
                  <td>${item.component_name}</td>
                  <td>${item.quantity}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }
    
    // 1688é…å¯¹ä¿¡æ¯ï¼ˆæƒé™æ§åˆ¶ï¼‰
    let pairing1688Html = '';
    if(hasPermission('view_1688') && p.purchasing.link1688){
      pairing1688Html = `
        <div style="margin-top:12px">
          <strong>1688é…å¯¹ï¼š</strong>
          <div style="margin-top:4px">
            <a href="${p.purchasing.link1688}" target="_blank" style="color:var(--accent);text-decoration:none;font-size:12px">
              ğŸ”— æŸ¥çœ‹é‡‡è´­é“¾æ¥ â†’
            </a>
          </div>
        </div>
      `;
    } else if(hasPermission('view_1688')) {
      pairing1688Html = `
        <div style="margin-top:12px">
          <strong>1688é…å¯¹ï¼š</strong>
          <div class="small muted">æš‚æ— é…å¯¹é“¾æ¥</div>
        </div>
      `;
    }
    
    // é‡‡è´­ä¿¡æ¯
    let purchasingHtml = '';
    if(p.purchasing){
      const showCost = hasPermission('view_cost') || currentUser === p.purchasing.purchaser;
      purchasingHtml = `
        <div style="margin-top:12px">
          <strong>é‡‡è´­ä¿¡æ¯ï¼š</strong>
          <table style="width:100%;margin-top:4px;font-size:12px">
            <tr><td style="width:80px">é‡‡è´­å‘˜ï¼š</td><td>${p.purchasing.purchaser}</td></tr>
            <tr><td>é‡‡è´­äº¤æœŸï¼š</td><td>${p.purchasing.deliveryTime}</td></tr>
            ${showCost ? `<tr><td>é‡‡è´­æˆæœ¬ï¼š</td><td>Â¥${p.purchasing.cost}</td></tr>` : ''}
            <tr><td>é‡‡è´­å¤‡æ³¨ï¼š</td><td>${p.purchasing.notes || '-'}</td></tr>
          </table>
        </div>
      `;
    }
    
    // è´¨æ£€ä¿¡æ¯
    let qualityHtml = '';
    if(p.quality){
      qualityHtml = `
        <div style="margin-top:12px">
          <strong>è´¨æ£€ä¿¡æ¯ï¼š</strong>
          <table style="width:100%;margin-top:4px;font-size:12px">
            <tr><td style="width:80px">æ£€éªŒæ ‡å‡†ï¼š</td><td>${p.quality.standard}</td></tr>
            <tr><td>æ£€éªŒè¦æ±‚ï¼š</td><td>${p.quality.requirements}</td></tr>
            <tr><td>æ£€éªŒç»“æœï¼š</td><td><span class="${p.quality.passed ? 'badge' : 'badge'}" style="background:${p.quality.passed ? 'var(--success)' : 'var(--danger)'};color:white;font-weight:500">${p.quality.passed ? 'é€šè¿‡' : 'ä¸é€šè¿‡'}</span></td></tr>
          </table>
        </div>
      `;
    }
    
    body.innerHTML = `
      <div style="display:flex;gap:12px;margin-bottom:12px">
        <div style="text-align: center;">
          <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">æ­£é¢</div>
          ${getLargeProductImage(p.image, false)}
        </div>
        <div style="text-align: center;">
          <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">èƒŒé¢</div>
          ${getLargeProductImage(p.image, true)}
        </div>
        <div style="flex:1">
          <div><strong>SKUï¼š</strong>${p.sku}</div>
          <div><strong>å‹å·ï¼š</strong>${p.model || '-'}</div>
          <div><strong>ç±»å‹ï¼š</strong>${p.type}</div>
          <div><strong>ç±»ç›®ï¼š</strong>${p.category}</div>
          <div><strong>åˆ†ç±»ï¼š</strong><span class="classification-tag" style="background: ${getClassificationColor(p.classification)}; font-size: 11px; margin-left: 4px;">${p.classification}</span></div>
          ${p.subClassification ? `<div><strong>å­åˆ†ç±»ï¼š</strong>${p.subClassification}</div>` : ''}
          <div><strong>äº¤æœŸï¼š</strong>${p.deliveryTime}</div>
          <div><strong>ç®±è§„ï¼š</strong>${p.carton || '-'}</div>
          <div><strong>é”€å”®æ¸ é“ï¼š</strong>${p.channel.join(', ')}</div>
        </div>
      </div>
      
      <div style="margin-top:8px"><strong>äº§å“è¯´æ˜ï¼š</strong></div>
      <div class="small muted" style="margin-top:4px">${p.description || 'æš‚æ— è¯´æ˜'}</div>
      
      <!-- åº“å­˜ä¸é‡‡è´­ä¿¡æ¯ -->
      <div style="margin-top:12px">
        <strong>åº“å­˜ä¸é‡‡è´­ä¿¡æ¯ï¼š</strong>
        <table style="width:100%;margin-top:4px;font-size:12px;border-collapse: collapse;">
          <tr><td style="width:80px; padding: 4px; border: 1px solid #e5e7eb;">å½“å‰åº“å­˜ï¼š</td><td style="padding: 4px; border: 1px solid #e5e7eb; color: ${p.stock < 20 ? 'var(--danger)' : 'inherit'}; font-weight: 600;">${p.stock}</td></tr>
          <tr><td style="padding: 4px; border: 1px solid #e5e7eb;">10å¤©é”€é‡ï¼š</td><td style="padding: 4px; border: 1px solid #e5e7eb; color: ${p.sales10d > 50 ? 'var(--success)' : 'inherit'};">${p.sales10d}</td></tr>
          <tr><td style="padding: 4px; border: 1px solid #e5e7eb;">30å¤©é”€é‡ï¼š</td><td style="padding: 4px; border: 1px solid #e5e7eb;">${p.sales30d}</td></tr>
          <tr><td style="padding: 4px; border: 1px solid #e5e7eb;">é‡‡è´­å‘˜ï¼š</td><td style="padding: 4px; border: 1px solid #e5e7eb;">${p.purchaser || '-'}</td></tr>
          <tr><td style="padding: 4px; border: 1px solid #e5e7eb;">æˆæœ¬ä»·æ ¼ï¼š</td><td style="padding: 4px; border: 1px solid #e5e7eb;">${p.cost ? 'Â¥' + p.cost.toFixed(2) : '-'}</td></tr>
        </table>
      </div>
      
      <!-- ç³»ç»Ÿä¿¡æ¯ -->
      <div style="margin-top:12px">
        <strong>ç³»ç»Ÿä¿¡æ¯ï¼š</strong>
        <table style="width:100%;margin-top:4px;font-size:12px;border-collapse: collapse;">
          <tr><td style="width:80px; padding: 4px; border: 1px solid #e5e7eb;">åˆ›å»ºæ—¶é—´ï¼š</td><td style="padding: 4px; border: 1px solid #e5e7eb;">${p.createdDate}</td></tr>
          <tr><td style="padding: 4px; border: 1px solid #e5e7eb;">æœ€åä¿®æ”¹ï¼š</td><td style="padding: 4px; border: 1px solid #e5e7eb;">${p.modifiedDate}</td></tr>
        </table>
      </div>
      
      <!-- å¤‡æ³¨ä¿¡æ¯ -->
      ${p.notes ? `
      <div style="margin-top:12px">
        <strong>å¤‡æ³¨ä¿¡æ¯ï¼š</strong>
        <div style="margin-top:4px;padding:8px;background:#f9fafb;border-radius:4px;font-size:12px;line-height:1.4;">
          ${p.notes}
        </div>
      </div>
      ` : ''}
      
      ${purchasingHtml}
      ${qualityHtml}
      ${pairing1688Html}
      ${bomHtml}
      
      <div style="margin-top:16px; padding-top: 12px; border-top: 1px solid var(--border-color);">
        <button class="btn primary" onclick="createPurchaseForProduct('${p.sku}')" style="margin-right: 8px;">
          ğŸ›’ å‘èµ·é‡‡è´­è®¡åˆ’
        </button>
        <button class="btn ghost" onclick="editProduct('${p.sku}')">
          âœï¸ ç¼–è¾‘äº§å“
        </button>
      </div>
      
      <div style="margin-top:12px" class="small muted">å¯å¯¼å‡ºäºŒç»´ç  / æ‰“å°æ ‡ç­¾</div>`;
  }else if(type==='po'){
    const po = data.pos.find(x=>x.id===id);
    title.textContent = `é‡‡è´­å• ${po.id}`;
    let approvalHtml = '';
    if(po.applicant || po.approver){
      approvalHtml = `
        <div style="margin-top:8px"><strong>å®¡æ‰¹ä¿¡æ¯ï¼š</strong></div>
        <div style="font-size:12px">
          <div>ç”³è¯·äººï¼š${po.applicant} (${po.applyDate})</div>
          <div>å®¡æ‰¹äººï¼š${po.approver || '-'} (${po.approveDate || '-'})</div>
          ${po.rejectReason ? `<div style="color:var(--danger)">é©³å›åŸå› ï¼š${po.rejectReason}</div>` : ''}
        </div>
      `;
    }
    
    let deliverySlipHtml = '';
    if (po.deliverySlipGenerated && po.deliverySlipId) {
      deliverySlipHtml = `
        <div style="margin-top:12px">
          <strong>å‘è´§å•ä¿¡æ¯ï¼š</strong>
          <div style="font-size:12px;margin-top:4px">
            <div>å‘è´§å•å·ï¼š${po.deliverySlipId}</div>
            <div>æŸ¥è¯¢ç ï¼š${po.deliverySlipQueryCode}</div>
            <div>ç”Ÿæˆæ—¥æœŸï¼š${po.deliverySlipDate}</div>
          </div>
          <div style="margin-top:8px">
            <button class="btn ghost" onclick="previewPODeliverySlip('${po.id}')" style="margin-right:8px;font-size:12px;padding:6px 12px;">é¢„è§ˆå‘è´§å•</button>
            <button class="btn ghost" onclick="printPODeliverySlip('${po.id}')" style="font-size:12px;padding:6px 12px;">æ‰“å°å‘è´§å•</button>
          </div>
        </div>
      `;
    } else if (po.status === 'ä»“åº“å¾…å‘è´§' || po.status === 'å·²å‘è´§' || po.status === 'å¾…æ”¶è´§') {
      deliverySlipHtml = `
        <div style="margin-top:12px">
          <strong>å‘è´§å•æ“ä½œï¼š</strong>
          <div style="margin-top:8px">
            <button class="btn" onclick="generateDeliverySlip('${po.id}')" style="margin-right:8px;font-size:12px;padding:6px 12px;">ç”Ÿæˆå‘è´§å•</button>
          </div>
        </div>
      `;
    }
    
    body.innerHTML = `<div><strong>ä¾›åº”å•†ï¼š</strong>${po.supplier}</div>
      <div><strong>çŠ¶æ€ï¼š</strong>${po.status}</div>
      <div style="margin-top:8px"><strong>æ˜ç»†ï¼š</strong></div>
      <div>${po.lines.map(l=>`${l.sku} Ã— ${l.qty} @ Â¥${l.price}`).join('<br/>')}</div>
      ${approvalHtml}
      ${deliverySlipHtml}
      <div style="margin-top:8px" class="small muted">æ”¯æŒ PDF åˆåŒç”Ÿæˆ</div>`;
  }else if(type==='purchaseOrder'){
    const order = data.purchaseOrders.find(x=>x.id===id);
    title.textContent = `é‡‡è´­è®¢å• ${order.id}`;
    
    // ä¸ºé‡‡è´­è®¢å•è¯¦æƒ…æ·»åŠ æ›´å¤§çš„CSSç±»
    const sideDetail = document.getElementById('sideDetail');
    sideDetail.classList.add('purchase-order-detail');
    
    // è®¾ç½®å½“å‰æŸ¥çœ‹çš„è®¢å•ID
    window.currentViewingOrderId = id;
    
    let contractHtml = '';
    if (order.signedContract) {
      contractHtml = `
        <div style="margin-top:16px; padding: 12px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px;">
          <div style="font-weight: 600; margin-bottom: 8px; color: #0ea5e9;">ğŸ“„ é‡‡è´­åˆåŒï¼š</div>
          <div style="font-size:14px;margin-top:4px">
            <div><strong>åˆåŒæ–‡ä»¶ï¼š</strong>${order.signedContract.fileName}</div>
            <div><strong>ä¸Šä¼ æ—¶é—´ï¼š</strong>${order.signedContract.uploadDate}</div>
            <div><strong>æ–‡ä»¶å¤§å°ï¼š</strong>${order.signedContract.fileSize || 'æœªçŸ¥'}</div>
            <div style="margin-top:8px;">
              <button class="btn primary" onclick="viewSignedContract('${order.id}')" style="margin-right:8px;font-size:12px;padding:6px 12px;">æŸ¥çœ‹åˆåŒ</button>
              <button class="btn ghost" onclick="downloadSignedContract('${order.id}')" style="font-size:12px;padding:6px 12px;">ä¸‹è½½åˆåŒ</button>
            </div>
          </div>
        </div>
      `;
    }
    
    let deliveryHtml = '';
    if (order.deliverySlipId) {
      deliveryHtml = `
        <div style="margin-top:12px">
          <strong>å‘è´§å•ä¿¡æ¯ï¼š</strong>
          <div style="font-size:12px;margin-top:4px">
            <div>å‘è´§å•å·ï¼š${order.deliverySlipId}</div>
            <div>æŸ¥è¯¢ç ï¼š${order.deliverySlipQueryCode}</div>
          </div>
          <div style="margin-top:8px">
            <button class="btn ghost" onclick="previewPurchaseOrderDeliverySlip('${order.id}')" style="margin-right:8px;font-size:12px;padding:6px 12px;">é¢„è§ˆå‘è´§å•</button>
            <button class="btn ghost" onclick="printPurchaseOrderDeliverySlip('${order.id}')" style="font-size:12px;padding:6px 12px;">æ‰“å°å‘è´§å•</button>
          </div>
        </div>
      `;
    }
    
    let receivingHtml = '';
    if (order.receiveDate) {
      receivingHtml = `
        <div style="margin-top:12px">
          <strong>æ”¶è´§ä¿¡æ¯ï¼š</strong>
          <div style="font-size:12px;margin-top:4px">
            <div>æ”¶è´§æ—¥æœŸï¼š${order.receiveDate}</div>
            <div>æ”¶è´§çŠ¶æ€ï¼š${order.receiveStatus}</div>
            ${order.receiveNotes ? `<div style="margin-top:4px;">æ”¶è´§å¤‡æ³¨ï¼š${order.receiveNotes}</div>` : ''}
            ${order.hasQualityIssues ? `<div style="color:var(--danger);margin-top:4px;">æœ‰è´¨é‡é—®é¢˜</div>` : ''}
            ${order.warehouseNotes ? `<div style="margin-top:4px;">ä»“åº“å¤‡æ³¨ï¼š${order.warehouseNotes}</div>` : ''}
          </div>
        </div>
      `;
    }
    
    let supplierConfirmHtml = '';
    if (order.status === 'å¾…ä¾›åº”å•†ç¡®è®¤' || order.status === 'ä¾›åº”å•†å·²ç¡®è®¤') {
      supplierConfirmHtml = `
        <div style="margin-top:16px; padding: 12px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 6px;">
          <div style="font-weight: 600; margin-bottom: 8px; color: #d97706;">ğŸ“ ä¾›åº”å•†æ²Ÿé€šè®°å½•ï¼š</div>
          <div style="font-size:14px;margin-top:4px">
            <div><strong>è”ç³»äººï¼š</strong>${order.supplierContact || 'æœªè®°å½•'}</div>
            <div><strong>æœ€åè”ç³»æ—¥æœŸï¼š</strong>${order.supplierContactDate || 'æœªè®°å½•'}</div>
            ${order.supplierNotes ? 
              `<div style="margin-top:8px;">
                <strong>æ²Ÿé€šå¤‡æ³¨ï¼š</strong>
                <div style="margin-top:4px; padding: 8px; background: white; border-radius: 4px; font-size: 13px; line-height: 1.4; max-height: 60px; overflow-y: auto;">
                  ${order.supplierNotes}
                </div>
                <a href="#" class="communication-link" onclick="viewFullCommunicationNotes('${order.id}'); return false;">æŸ¥çœ‹å®Œæ•´æ²Ÿé€šè®°å½• â†’</a>
              </div>` : 
              `<div style="color: #666; font-style: italic;">æš‚æ— æ²Ÿé€šå¤‡æ³¨</div>`
            }
          </div>
          <div style="margin-top:12px;">
            ${order.status === 'å¾…ä¾›åº”å•†ç¡®è®¤' ? 
              `<button class="btn primary" onclick="recordSupplierContact('${order.id}')" style="margin-right:8px;">è®°å½•ä¾›åº”å•†ç¡®è®¤</button>` :
              `<button class="btn ghost" onclick="editPurchaseOrder('${order.id}')" style="margin-right:8px;">ç¼–è¾‘è®¢å•</button>`
            }
            <button class="btn ghost" onclick="addCommunicationNote('${order.id}')">æ·»åŠ æ²Ÿé€šè®°å½•</button>
          </div>
        </div>
      `;
    }

    let actionButtons = '';
    if (order.status === 'å¾…ä¾›åº”å•†ç¡®è®¤') {
      actionButtons = `
        <div style="margin-top:12px">
          <button class="btn" onclick="editPurchaseOrder('${order.id}')">ç¼–è¾‘è®¢å•</button>
        </div>
      `;
    } else if (order.status === 'ä¾›åº”å•†å·²ç¡®è®¤') {
      actionButtons = `
        <div style="margin-top:12px">
          ${!order.signedContract ? `<button class="btn" onclick="uploadSignedContract('${order.id}')" style="margin-right:8px;">ä¸Šä¼ ç›–ç« åˆåŒ</button>` : ''}
          <button class="btn ghost" onclick="editPurchaseOrder('${order.id}')">ç¼–è¾‘è®¢å•</button>
        </div>
      `;
    } else if (order.status === 'å¾…æ”¶è´§') {
      actionButtons = `
        <div style="margin-top:12px">
          <button class="btn" onclick="openReceivingModal('${order.id}')">ç¡®è®¤æ”¶è´§</button>
        </div>
      `;
    }
    
    // è·å–é€‰ä¸­çš„ä¾›åº”å•†æŠ¥ä»·ä¿¡æ¯
    function getSelectedQuoteInfo(order) {
      let quoteInfoHtml = '';
      
      // æŸ¥æ‰¾å¯¹åº”çš„é‡‡è´­è®¡åˆ’ä»¥è·å–é€‰ä¸­çš„æŠ¥ä»·ä¿¡æ¯
      if (order.sourcePOId) {
        const sourcePO = data.pos.find(po => po.id === order.sourcePOId);
        if (sourcePO && sourcePO.selectedQuotes) {
          quoteInfoHtml = `
            <div style="margin-top:16px; padding: 12px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px;">
              <div style="font-weight: 600; margin-bottom: 8px; color: #0ea5e9;">ğŸ“‹ ä¾›åº”å•†æŠ¥ä»·é€‰æ‹©è®°å½•ï¼š</div>
              ${order.lines.map(line => {
                const selectedQuote = sourcePO.selectedQuotes[line.sku];
                if (selectedQuote) {
                  const product = data.products.find(p => p.sku === line.sku);
                  return `
                    <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #0ea5e9;">
                      <div style="font-weight: 500; margin-bottom: 4px;">${product ? product.name : line.sku}</div>
                      <div style="font-size: 12px; color: #666; line-height: 1.4;">
                        <div><strong>é€‰ä¸­ä¾›åº”å•†ï¼š</strong>${selectedQuote.supplierName}</div>
                        <div><strong>æŠ¥ä»·ï¼š</strong>Â¥${selectedQuote.price.toFixed(2)}</div>
                        <div><strong>é€‰æ‹©åŸå› ï¼š</strong><span style="color: #0ea5e9;">${selectedQuote.reason}</span></div>
                        <div><strong>é€‰æ‹©æ—¶é—´ï¼š</strong>${selectedQuote.selectTime ? selectedQuote.selectTime.split('T')[0] : '-'}</div>
                      </div>
                    </div>
                  `;
                }
                return '';
              }).filter(html => html).join('')}
            </div>
          `;
        }
      }
      
      return quoteInfoHtml;
    }
    
    // è·å–çŠ¶æ€é¢œè‰²
    function getStatusColor(status) {
      const statusColors = {
        'å¾…ä¾›åº”å•†ç¡®è®¤': '#f59e0b',
        'ä¾›åº”å•†å·²ç¡®è®¤': '#10b981',
        'å¾…æ”¶è´§': '#3b82f6',
        'å·²å®Œæˆ': '#6b7280',
        'å·²å–æ¶ˆ': '#ef4444'
      };
      return statusColors[status] || '#666';
    }
    
    // æŒ‰å“ç±»åˆ†ç»„è®¢å•æ˜ç»†
    function groupLinesByCategory(lines) {
      const grouped = {};
      
      lines.forEach(line => {
        const product = data.products.find(p => p.sku === line.sku);
        const category = product ? product.category || 'æœªåˆ†ç±»' : 'æœªåˆ†ç±»';
        
        if (!grouped[category]) {
          grouped[category] = [];
        }
        
        grouped[category].push({
          ...line,
          productName: product ? product.name : line.sku,
          category: category
        });
      });
      
      return grouped;
    }
    
    const groupedLines = groupLinesByCategory(order.lines);
    
    let linesHtml = '';
    Object.keys(groupedLines).forEach(category => {
      linesHtml += `
        <div class="category-group">
          <div class="category-header">
            ğŸ“¦ ${category} (${groupedLines[category].length}ä¸ªäº§å“)
          </div>
          <table class="order-lines-table">
            <thead>
              <tr>
                <th style="width: 25%;">äº§å“åç§°</th>
                <th style="width: 15%;">SKU</th>
                <th style="width: 15%; text-align: center;">æ•°é‡</th>
                <th style="width: 15%; text-align: right;">å•ä»·</th>
                <th style="width: 15%; text-align: right;">å°è®¡</th>
                <th style="width: 15%;">äº¤æœŸ</th>
              </tr>
            </thead>
            <tbody>
              ${groupedLines[category].map(line => `
                <tr>
                  <td style="font-weight: 500;">${line.productName}</td>
                  <td style="font-size: 12px; color: #666;">${line.sku}</td>
                  <td style="text-align: center;">${line.qty}</td>
                  <td style="text-align: right;">Â¥${line.price.toFixed(2)}</td>
                  <td style="text-align: right; font-weight: 500;">Â¥${(line.qty * line.price).toFixed(2)}</td>
                  <td style="font-size: 12px;">${line.deliveryDate || 'å¾…ç¡®è®¤'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    });
    
    body.innerHTML = `
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);">
        <div><strong>è®¢å•ç¼–å·ï¼š</strong>${order.id}</div>
        <div><strong>ä¾›åº”å•†ï¼š</strong>${order.supplier}</div>
        <div><strong>é‡‡è´­å‘˜ï¼š</strong>${order.purchaser}</div>
        <div><strong>è®¢å•çŠ¶æ€ï¼š</strong><span style="color: ${getStatusColor(order.status)}; font-weight: 600;">${order.status}</span></div>
        <div><strong>åˆ›å»ºæ—¥æœŸï¼š</strong>${order.createdDate}</div>
        <div><strong>è®¢å•é‡‘é¢ï¼š</strong><span style="color: var(--accent); font-weight: 600; font-size: 16px;">Â¥${order.totalAmount.toFixed(2)}</span></div>
        <div><strong>é¢„è®¡äº¤æœŸï¼š</strong>${order.estimatedDeliveryDate || 'å¾…ç¡®è®¤'}</div>
        <div><strong>å®é™…äº¤æœŸï¼š</strong>${order.actualDeliveryDate || 'æœªå‘è´§'}</div>
      </div>
      
      <div style="margin-bottom: 16px;">
        <h3 style="margin: 0 0 12px 0; color: var(--text); font-size: 16px;">ğŸ“‹ è®¢å•æ˜ç»†</h3>
        ${linesHtml}
      </div>
      
      ${getSelectedQuoteInfo(order)}
      
      ${supplierConfirmHtml}
      ${contractHtml}
      ${deliveryHtml}
      ${receivingHtml}
      ${actionButtons}
      <div style="margin-top:8px" class="small muted">æ”¯æŒåˆåŒç®¡ç†å’Œæ”¶è´§è·Ÿè¸ª</div>
    `;
  }else if(type==='sale'){
    const s = data.sales.find(x=>x.id===id);
    title.textContent = `é”€å”®å• ${s.id}`;
    body.innerHTML = `<div><strong>å®¢æˆ·ï¼š</strong>${s.customer}</div><div><strong>çŠ¶æ€ï¼š</strong>${s.status}</div><div style="margin-top:8px">å‘ç¥¨ç”³è¯· / å›æ¬¾è¿½è¸ª</div>`;
  }else if(type==='supplier'){
    const sp = data.suppliers.find(x=>x.id===id);
    // å­˜å‚¨å½“å‰æŸ¥çœ‹çš„ä¾›åº”å•†ID
    window.currentViewingSupplierId = id;
    
    title.textContent = `${sp.name}`;
    
    // æ˜Ÿçº§æ˜¾ç¤º
    const starRating = sp.starRating || 0;
    const stars = 'â­'.repeat(starRating);
    
    body.innerHTML = `
      <!-- åŸºæœ¬ä¿¡æ¯ -->
      <div style="margin-bottom: 20px;">
        <h3 style="margin: 0 0 16px 0; color: var(--text); font-size: 16px;">ğŸ“‹ åŸºæœ¬ä¿¡æ¯</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 14px;">
          <div><strong>ä¾›åº”å•†ä»£ç ï¼š</strong>${sp.code || '-'}</div>
          <div><strong>åˆä½œæ˜Ÿçº§ï¼š</strong><span style="color: #f59e0b; font-weight: 600;">${stars}</span></div>
          <div><strong>ä¼ä¸šè§„æ¨¡ï¼š</strong>${sp.scale || '-'}</div>
          <div><strong>ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ï¼š</strong>${sp.creditCode || '-'}</div>
          <div><strong>ç»“ç®—æ–¹å¼ï¼š</strong>${sp.settle}</div>
          <div><strong>ä¸»è¥ç±»åˆ«ï¼š</strong>${sp.category || '-'}</div>
        </div>
      </div>
      
      <!-- è”ç³»ä¿¡æ¯ -->
      <div style="margin-bottom: 20px;">
        <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 16px;">ğŸ“ è”ç³»ä¿¡æ¯</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 14px;">
          <div><strong>è”ç³»äººï¼š</strong>${sp.contact || '-'}</div>
          <div><strong>æ‰‹æœºå·ï¼š</strong>${sp.phone || '-'}</div>
          <div><strong>å¾®ä¿¡å·ï¼š</strong>${sp.wechat || '-'}</div>
          <div><strong>å…¬å¸å›ºè¯ï¼š</strong>${sp.companyPhone || '-'}</div>
        </div>
        ${sp.email ? `<div style="margin-top: 12px;"><strong>ç”µå­é‚®ç®±ï¼š</strong>${sp.email}</div>` : ''}
      </div>
      
      <!-- åœ°å€ä¿¡æ¯ -->
      <div style="margin-bottom: 20px;">
        <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 16px;">ğŸ“ åœ°å€ä¿¡æ¯</h4>
        <div style="font-size: 14px;">
          ${sp.officeAddress ? `<div style="margin-bottom: 8px;"><strong>åŠå…¬åœ°å€ï¼š</strong>${sp.officeAddress}</div>` : ''}
          ${sp.productionAddress ? `<div style="margin-bottom: 8px;"><strong>ç”Ÿäº§åœ°å€ï¼š</strong>${sp.productionAddress}</div>` : ''}
          ${sp.warehouseAddress ? `<div style="margin-bottom: 8px;"><strong>ä»“åº“åœ°å€ï¼š</strong>${sp.warehouseAddress}</div>` : ''}
          ${sp.address ? `<div style="margin-bottom: 8px;"><strong>è”ç³»åœ°å€ï¼š</strong>${sp.address}</div>` : ''}
        </div>
      </div>
      
      <!-- ä¸šåŠ¡ä¿¡æ¯ -->
      <div style="margin-bottom: 20px;">
        <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 16px;">ğŸ’¼ ä¸šåŠ¡ä¿¡æ¯</h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 14px;">
          <div><strong>é…é€æ–¹å¼ï¼š</strong>${sp.deliveryMethod || '-'}</div>
          <div><strong>ç¨ç¥¨ç±»å‹ï¼š</strong>${sp.taxType || '-'}</div>
          <div><strong>ç¨ç‚¹ï¼š</strong>${sp.taxRate ? sp.taxRate + '%' : '-'}</div>
        </div>
      </div>
      
      <!-- é™„ä»¶ä¿¡æ¯ -->
      <div style="margin-bottom: 20px;">
        <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 16px;">ğŸ“ é™„ä»¶ä¿¡æ¯</h4>
        ${sp.businessLicense ? `
          <div style="background: var(--hover-bg); padding: 12px; border-radius: 6px; font-size: 14px;">
            <div><strong>è¥ä¸šæ‰§ç…§ï¼š</strong><span style="color: var(--accent);">å·²ä¸Šä¼ </span></div>
          </div>
        ` : '<div style="color: #999; font-size: 14px;">æš‚æ— è¥ä¸šæ‰§ç…§</div>'}
        
        <!-- åˆåŒç®¡ç† -->
        ${sp.contracts && sp.contracts.length > 0 ? `
          <div style="margin-top: 16px;">
            <h5 style="margin: 0 0 8px 0; font-size: 14px; color: var(--text);">å•†åŠ¡åˆåŒ</h5>
            ${sp.contracts.map(contract => `
              <div style="background: var(--hover-bg); padding: 8px; border-radius: 4px; margin-bottom: 8px; font-size: 13px;">
                <div><strong>åˆåŒç¼–å·ï¼š</strong>${contract.contractNumber}</div>
                <div><strong>ç­¾è®¢æ—¥æœŸï¼š</strong>${contract.signDate}</div>
                <div><strong>æœ‰æ•ˆæœŸï¼š</strong>${contract.startDate} è‡³ ${contract.endDate}</div>
                ${contract.invoice ? `<div><strong>å‘ç¥¨ï¼š</strong>${contract.invoice.type} - ${contract.invoice.number}</div>` : ''}
                ${contract.attachments && contract.attachments.length > 0 ? `
                  <div style="margin-top: 4px;">
                    <strong>é™„ä»¶ï¼š</strong>
                    ${contract.attachments.map(att => `<span style="color: var(--accent); margin-left: 8px;">${att.name}</span>`).join('')}
                  </div>
                ` : ''}
              </div>
            `).join('')}
          </div>
        ` : '<div style="color: #999; font-size: 14px; margin-top: 12px;">æš‚æ— å•†åŠ¡åˆåŒ</div>'}
      </div>
      
      ${sp.notes ? `
      <div style="margin-bottom: 20px;">
        <h4 style="margin: 0 0 12px 0; color: var(--text); font-size: 16px;">ğŸ“ å¤‡æ³¨ä¿¡æ¯</h4>
        <div style="background: var(--hover-bg); padding: 12px; border-radius: 6px; font-size: 14px; line-height: 1.6;">
          ${sp.notes}
        </div>
      </div>
      ` : ''}
      
      <div style="color: #666; font-size: 12px; margin-top: 20px; padding-top: 12px; border-top: 1px solid var(--border-color);">
        <div><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${sp.createdAt ? new Date(sp.createdAt).toLocaleString('zh-CN') : 'æœªçŸ¥'}</div>
        ${sp.updatedAt && sp.updatedAt !== sp.createdAt ? 
          `<div><strong>æœ€åä¿®æ”¹ï¼š</strong>${new Date(sp.updatedAt).toLocaleString('zh-CN')}</div>` : 
          ''
        }
      </div>
    `;
  }
}
function closeDetail(){ 
  const sideDetail = document.getElementById('sideDetail');
  sideDetail.classList.add('hidden');
  
  // ç§»é™¤é‡‡è´­è®¢å•çš„å¤§å°ºå¯¸CSSç±»
  sideDetail.classList.remove('purchase-order-detail');
  
  // æ¸…é™¤å½“å‰æŸ¥çœ‹çš„è®¢å•ID
  window.currentViewingOrderId = null;
  
  // æ¸…é™¤å½“å‰æŸ¥çœ‹çš„ä¾›åº”å•†ID
  window.currentViewingSupplierId = null;
  
  const overlay = document.querySelector('.modal-overlay');
  if (overlay) {
    overlay.classList.add('hidden');
  }
}


function openCreatePO(){
  const modal = document.getElementById('createPOModal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.style.display = '';
    
    // å¡«å……ä¾›åº”å•†ã€äº§å“é€‰æ‹©
    const supSel = document.getElementById('poSupplier'); 
    if (supSel) {
      supSel.innerHTML = '';
      data.suppliers.forEach(s => supSel.innerHTML += `<option value="${s.name}">${s.name} Â· ${s.settle}</option>`);
    }
    
    const prodSel = document.getElementById('poProduct'); 
    if (prodSel) {
      prodSel.innerHTML = '';
      data.products.forEach(p => prodSel.innerHTML += `<option value="${p.sku}">${p.sku} Â· ${p.name}</option>`);
    }
    
    const poItems = document.getElementById('poItems');
    if (poItems) {
      poItems.innerHTML = '<div class="small muted">å°šæœªæ·»åŠ é‡‡è´­é¡¹</div>';
    }
    
    const poTotal = document.getElementById('poTotal');
    if (poTotal) {
      poTotal.textContent = '0';
    }
  }
}

function closeCreatePO(){ 
  const modal = document.getElementById('createPOModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
  }
}

function createPurchaseForProduct(sku) {
  // å…³é—­äº§å“è¯¦æƒ…é¡µé¢
  closeDetail();
  
  // åˆ‡æ¢åˆ°é‡‡è´­ç®¡ç†é¡µé¢
  showView('purchase');
  
  // å»¶è¿Ÿæ‰“å¼€é‡‡è´­è®¡åˆ’åˆ›å»ºæ¨¡æ€æ¡†ï¼Œç¡®ä¿é¡µé¢å·²åˆ‡æ¢
  setTimeout(() => {
    openCreatePO();
    
    // å»¶è¿Ÿé€‰æ‹©äº§å“ï¼Œç¡®ä¿æ¨¡æ€æ¡†å·²å®Œå…¨æ‰“å¼€
    setTimeout(() => {
      const productSelect = document.getElementById('poProduct');
      if (productSelect) {
        productSelect.value = sku;
        
        // è§¦å‘äº§å“é€‰æ‹©å˜åŒ–äº‹ä»¶ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        const event = new Event('change', { bubbles: true });
        productSelect.dispatchEvent(event);
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        const product = data.products.find(p => p.sku === sku);
        if (product) {
          showToast(`å·²é€‰æ‹©äº§å“: ${product.name}`, 'success');
        }
      }
    }, 100);
  }, 100);
}

// æ–°å¢äº§å“ç›¸å…³å‡½æ•°
function openAddProductModal() {
  const modal = document.getElementById('addProductModal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.style.display = '';
    
    // æ¸…ç©ºè¡¨å•
    clearAddProductForm();
  }
}

function closeAddProductModal() {
  const modal = document.getElementById('addProductModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
  }
}

function clearAddProductForm() {
  document.getElementById('newProductSku').value = '';
  document.getElementById('newProductName').value = '';
  document.getElementById('newProductModel').value = '';
  document.getElementById('newProductType').value = 'æ™®å“';
  document.getElementById('newProductCategory').value = 'ç”µå­';
  document.getElementById('newProductClassification').value = 'æˆå“';
  document.getElementById('newProductStock').value = '0';
  document.getElementById('newProductDeliveryTime').value = '';
  document.getElementById('newProductCarton').value = '';
  document.getElementById('newProductImage').value = 'mouse';
  document.getElementById('newProductPurchaser').value = 'é‡‡è´­å‘˜å¼ ';
  document.getElementById('newProductCost').value = '';
  document.getElementById('newProductNotes').value = '';
}

function saveNewProduct() {
  const sku = document.getElementById('newProductSku').value.trim();
  const name = document.getElementById('newProductName').value.trim();
  
  // éªŒè¯å¿…å¡«å­—æ®µ
  if (!sku || !name) {
    showToast('è¯·å¡«å†™SKUå’Œäº§å“åç§°', 'error');
    return;
  }
  
  // æ£€æŸ¥SKUæ˜¯å¦å·²å­˜åœ¨
  if (data.products.some(p => p.sku === sku)) {
    showToast('SKUå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–SKU', 'error');
    return;
  }
  
  // åˆ›å»ºæ–°äº§å“å¯¹è±¡
  const newProduct = {
    sku: sku,
    name: name,
    model: document.getElementById('newProductModel').value.trim() || '',
    type: document.getElementById('newProductType').value,
    category: document.getElementById('newProductCategory').value,
    classification: document.getElementById('newProductClassification').value,
    stock: parseInt(document.getElementById('newProductStock').value) || 0,
    deliveryTime: document.getElementById('newProductDeliveryTime').value.trim() || '7å¤©',
    carton: document.getElementById('newProductCarton').value.trim() || '100/ç®±',
    image: document.getElementById('newProductImage').value,
    sales10d: 0,
    sales30d: 0,
    createdDate: new Date().toISOString().split('T')[0],
    modifiedDate: new Date().toISOString().split('T')[0],
    purchaser: document.getElementById('newProductPurchaser').value,
    cost: parseFloat(document.getElementById('newProductCost').value) || 0,
    notes: document.getElementById('newProductNotes').value.trim(),
    channel: ['å†…éƒ¨'],
    description: '',
    quality: {
      inspectionType: 'æŠ½æ£€',
      packagingRequire: 'æ ‡å‡†åŒ…è£…',
      tagRequire: 'äº§å“æ ‡ç­¾',
      certificateRequire: 'è´¨æ£€æŠ¥å‘Š',
      specialRequire: 'æ— ç‰¹æ®Šè¦æ±‚'
    }
  };
  
  // æ·»åŠ åˆ°äº§å“æ•°æ®
  data.products.push(newProduct);
  
  // å…³é—­æ¨¡æ€æ¡†
  closeAddProductModal();
  
  // åˆ·æ–°äº§å“åˆ—è¡¨
  renderProducts();
  
  // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
  showToast(`äº§å“ ${name} å·²æˆåŠŸæ·»åŠ `, 'success');
}

function editProduct(sku) {
  const product = data.products.find(p => p.sku === sku);
  if (!product) {
    showToast('äº§å“ä¸å­˜åœ¨', 'error');
    return;
  }
  
  // å…³é—­äº§å“è¯¦æƒ…é¡µé¢
  closeDetail();
  
  // å¡«å……è¡¨å•æ•°æ®
  document.getElementById('newProductSku').value = product.sku;
  document.getElementById('newProductName').value = product.name;
  document.getElementById('newProductModel').value = product.model || '';
  document.getElementById('newProductType').value = product.type;
  document.getElementById('newProductCategory').value = product.category;
  document.getElementById('newProductClassification').value = product.classification;
  document.getElementById('newProductStock').value = product.stock || 0;
  document.getElementById('newProductDeliveryTime').value = product.deliveryTime || '';
  document.getElementById('newProductCarton').value = product.carton || '';
  document.getElementById('newProductImage').value = product.image;
  document.getElementById('newProductPurchaser').value = product.purchaser || 'é‡‡è´­å‘˜å¼ ';
  document.getElementById('newProductCost').value = product.cost || '';
  document.getElementById('newProductNotes').value = product.notes || '';
  
  // ä¿®æ”¹æ¨¡æ€æ¡†æ ‡é¢˜å’ŒæŒ‰é’®
  const modalTitle = document.querySelector('#addProductModal .modal-title');
  if (modalTitle) {
    modalTitle.textContent = 'âœï¸ ç¼–è¾‘äº§å“';
  }
  
  const saveButton = document.querySelector('#addProductModal .btn.primary');
  if (saveButton) {
    saveButton.textContent = 'æ›´æ–°äº§å“';
    saveButton.onclick = () => updateProduct(sku);
  }
  
  // ç¦ç”¨SKUç¼–è¾‘ï¼ˆSKUé€šå¸¸ä¸åº”è¯¥ä¿®æ”¹ï¼‰
  document.getElementById('newProductSku').disabled = true;
  
  // æ‰“å¼€æ¨¡æ€æ¡†
  openAddProductModal();
}

function updateProduct(sku) {
  const product = data.products.find(p => p.sku === sku);
  if (!product) {
    showToast('äº§å“ä¸å­˜åœ¨', 'error');
    return;
  }
  
  const name = document.getElementById('newProductName').value.trim();
  
  // éªŒè¯å¿…å¡«å­—æ®µ
  if (!name) {
    showToast('è¯·å¡«å†™äº§å“åç§°', 'error');
    return;
  }
  
  // æ›´æ–°äº§å“ä¿¡æ¯
  product.name = name;
  product.model = document.getElementById('newProductModel').value.trim() || '';
  product.type = document.getElementById('newProductType').value;
  product.category = document.getElementById('newProductCategory').value;
  product.classification = document.getElementById('newProductClassification').value;
  product.stock = parseInt(document.getElementById('newProductStock').value) || 0;
  product.deliveryTime = document.getElementById('newProductDeliveryTime').value.trim() || '7å¤©';
  product.carton = document.getElementById('newProductCarton').value.trim() || '100/ç®±';
  product.image = document.getElementById('newProductImage').value;
  product.purchaser = document.getElementById('newProductPurchaser').value;
  product.cost = parseFloat(document.getElementById('newProductCost').value) || 0;
  product.notes = document.getElementById('newProductNotes').value.trim();
  product.modifiedDate = new Date().toISOString().split('T')[0];
  
  // æ¢å¤æ¨¡æ€æ¡†æ ‡é¢˜å’ŒæŒ‰é’®
  const modalTitle = document.querySelector('#addProductModal .modal-title');
  if (modalTitle) {
    modalTitle.textContent = 'ğŸ“¦ æ–°å¢äº§å“';
  }
  
  const saveButton = document.querySelector('#addProductModal .btn.primary');
  if (saveButton) {
    saveButton.textContent = 'ä¿å­˜äº§å“';
    saveButton.onclick = saveNewProduct;
  }
  
  // å¯ç”¨SKUç¼–è¾‘
  document.getElementById('newProductSku').disabled = false;
  
  // å…³é—­æ¨¡æ€æ¡†
  closeAddProductModal();
  
  // åˆ·æ–°äº§å“åˆ—è¡¨
  renderProducts();
  
  // å¦‚æœè¯¦æƒ…é¡µé¢æ‰“å¼€ï¼Œåˆ·æ–°è¯¦æƒ…
  const sideDetail = document.getElementById('sideDetail');
  if (!sideDetail.classList.contains('hidden')) {
    openDetail('product', sku);
  }
  
  // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
  showToast(`äº§å“ ${name} å·²æ›´æ–°`, 'success');
}

let poDraft = [];
function addPoItem(){
  const productSelect = document.getElementById('poProduct');
  const qtyInput = document.getElementById('poQty');
  
  if (!productSelect || !qtyInput) return;
  
  const sku = productSelect.value;
  const qty = parseInt(qtyInput.value) || 1;
  const prod = data.products.find(p=>p.sku===sku);
  
  if (prod) {
    poDraft.push({sku, qty, price: prod.cost});
    renderPoDraft();
  }
}
function renderPoDraft(){
  const div = document.getElementById('poItems'); 
  if (!div) return;
  
  div.innerHTML = '';
  if(poDraft.length===0){ 
    div.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">ğŸ“ æš‚æ— é‡‡è´­é¡¹ç›®ï¼Œè¯·æ·»åŠ é‡‡è´­é¡¹</div>'; 
    return; 
  }
  poDraft.forEach((it,idx)=>{
    const prod = data.products.find(p=>p.sku===it.sku);
    const row = document.createElement('div');
    row.className = 'po-item';
    row.innerHTML = `
      <div class="item-info">
        <div class="item-sku">${it.sku}</div>
        <div class="item-name">${prod.name}</div>
        <div class="item-qty">Ã— ${it.qty}</div>
      </div>
      <div class="item-price">
        <div class="price">Â¥${(it.qty*it.price).toFixed(2)}</div>
        <button class="btn ghost small" onclick="removePo(${idx})" title="åˆ é™¤">
          ğŸ—‘ï¸ åˆ é™¤
        </button>
      </div>
    `;
    div.appendChild(row);
  });
  const total = poDraft.reduce((s,i)=>s+i.qty*i.price,0);
  updatePoTotal();
}
function removePo(i){ poDraft.splice(i,1); renderPoDraft(); }
function updatePoTotal(){
  const total = poDraft.reduce((s,i)=>s+i.qty*i.price,0);
  const poTotalElement = document.getElementById('poTotal');
  if (poTotalElement) {
    poTotalElement.textContent = total.toFixed(2);
  }
}
// ===== é‡‡è´­è®¢å•ç®¡ç†å‡½æ•° =====

// æ‰“å¼€é‡‡è´­è®¢å•ç¼–è¾‘æ¨¡æ€æ¡†
function editPurchaseOrder(orderId) {
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) return;
  
  const modal = document.getElementById('purchaseOrderEditModal');
  if (!modal) return;
  
  // å¡«å……è®¢å•åŸºæœ¬ä¿¡æ¯
  const orderNumber = document.getElementById('editOrderNumber');
  const supplier = document.getElementById('editOrderSupplier');
  const purchaser = document.getElementById('editOrderPurchaser');
  const status = document.getElementById('editOrderStatus');
  const estimatedDeliveryDate = document.getElementById('editEstimatedDeliveryDate');
  const confirmNotes = document.getElementById('editConfirmNotes');
  
  if (orderNumber) orderNumber.textContent = order.id;
  if (supplier) supplier.textContent = order.supplier;
  if (purchaser) purchaser.textContent = order.purchaser;
  if (status) status.textContent = order.status;
  if (estimatedDeliveryDate) estimatedDeliveryDate.value = order.estimatedDeliveryDate || '';
  if (confirmNotes) confirmNotes.value = order.confirmNotes || '';
  
  // å¡«å……è®¢å•æ˜ç»†
  const linesContainer = document.getElementById('editOrderLines');
  if (linesContainer) {
    linesContainer.innerHTML = order.lines.map(line => {
      const product = data.products.find(p => p.sku === line.sku);
      return `
        <tr style="border-bottom:1px solid #ddd;">
          <td style="padding:8px;border:1px solid #ddd;">${line.sku}</td>
          <td style="padding:8px;border:1px solid #ddd;">${product ? product.name : line.sku}</td>
          <td style="padding:8px;text-align:center;border:1px solid #ddd;">${line.qty}</td>
          <td style="padding:8px;text-align:center;border:1px solid #ddd;">Â¥${line.price}</td>
          <td style="padding:8px;text-align:center;border:1px solid #ddd;">
            <input type="date" value="${line.deliveryDate || ''}" onchange="updateLineDeliveryDate('${orderId}', '${line.sku}', this.value)" style="padding:4px;border:1px solid #ddd;border-radius:3px;">
          </td>
          <td style="padding:8px;text-align:center;border:1px solid #ddd;">
            <input type="number" value="${line.confirmedQty}" min="0" onchange="updateLineConfirmedQty('${orderId}', '${line.sku}', this.value)" style="padding:4px;border:1px solid #ddd;border-radius:3px;width:80px;">
          </td>
        </tr>
      `;
    }).join('');
  }
  
  // æ˜¾ç¤ºæ¨¡æ€æ¡†
  modal.classList.remove('hidden');
  modal.style.display = '';
  
  // ä¿å­˜å½“å‰ç¼–è¾‘çš„è®¢å•ID
  window.currentEditingOrderId = orderId;
}

// å…³é—­é‡‡è´­è®¢å•ç¼–è¾‘æ¨¡æ€æ¡†
function closePurchaseOrderEditModal() {
  const modal = document.getElementById('purchaseOrderEditModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
  }
  window.currentEditingOrderId = null;
}

// ä¿å­˜é‡‡è´­è®¢å•ç¼–è¾‘
function savePurchaseOrderEdit() {
  const orderId = window.currentEditingOrderId;
  if (!orderId) return;
  
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) return;
  
  const estimatedDeliveryDate = document.getElementById('editEstimatedDeliveryDate')?.value;
  const confirmNotes = document.getElementById('editConfirmNotes')?.value;
  
  // æ›´æ–°è®¢å•ä¿¡æ¯
  order.estimatedDeliveryDate = estimatedDeliveryDate;
  order.confirmNotes = confirmNotes;
  
  // æ›´æ–°çŠ¶æ€ä¸º"ä¾›åº”å•†å·²ç¡®è®¤"
  if (order.status === 'å¾…ä¾›åº”å•†ç¡®è®¤') {
    order.status = 'ä¾›åº”å•†å·²ç¡®è®¤';
    order.confirmedDate = new Date().toISOString().split('T')[0];
  }
  
  closePurchaseOrderEditModal();
  renderPurchaseOrdersList();
  showToast(`é‡‡è´­è®¢å• ${orderId} å·²æ›´æ–°`, 'success');
}

// æ›´æ–°è¡Œé¡¹ç›®äº¤æœŸ
function updateLineDeliveryDate(orderId, sku, date) {
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) return;
  
  const line = order.lines.find(l => l.sku === sku);
  if (line) {
    line.deliveryDate = date;
  }
}

// æ›´æ–°è¡Œé¡¹ç›®ç¡®è®¤æ•°é‡
function updateLineConfirmedQty(orderId, sku, qty) {
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) return;
  
  const line = order.lines.find(l => l.sku === sku);
  if (line) {
    line.confirmedQty = parseInt(qty) || line.qty;
  }
}

// åˆå§‹åŒ–æ¨¡æ€æ¡†äº‹ä»¶å¤„ç†
function initializeModalHandlers() {
  setupModalClickOutside('warehouseInboundModal', closeWarehouseInbound);
  setupModalClickOutside('deliverySlipModal', closeDeliverySlipModal);
  setupModalClickOutside('deliverySlipPreviewModal', closeDeliverySlipPreviewModal);
  setupModalClickOutside('qualityModal', closeQualityModal);
  setupModalClickOutside('purchaseOrderEditModal', closePurchaseOrderEditModal);
  setupModalClickOutside('signedContractModal', closeSignedContractModal);
  setupModalClickOutside('receivingModal', closeReceivingModal);
  setupModalClickOutside('supplierContactModal', closeSupplierContactModal);
  setupModalClickOutside('inventoryAdjustmentModal', closeInventoryAdjustmentModal);
    setupModalClickOutside('inventoryCountModal', closeInventoryCountModal);
  setupModalClickOutside('inventoryAlertsModal', closeInventoryAlertsModal);
  setupModalClickOutside('salesOrderCreateModal', closeSalesOrderCreateModal);
  setupModalClickOutside('productSelectModal', closeProductSelectModal);
  setupModalClickOutside('salesOrderViewModal', closeSalesOrderViewModal);
  setupModalClickOutside('salesOrderEditModal', closeSalesOrderEditModal);
}

// é‡‡è´­è®¢å•æ¨¡æ€æ¡†å¤–éƒ¨ç‚¹å‡»å…³é—­
function setupModalClickOutside(modalId, closeFunction) {
  const modal = document.getElementById(modalId);
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeFunction();
      }
    });
  }
}

// ===== åŸæœ‰å‡½æ•° =====

function savePO(){
  if(poDraft.length===0){ showToast('è¯·è‡³å°‘æ·»åŠ ä¸€é¡¹é‡‡è´­å†…å®¹', 'error'); return; }
  const supplierSelect = document.getElementById('poSupplier');
  const supplier = supplierSelect ? supplierSelect.value : '';
  const newPO = {
    id: 'PO' + (Math.floor(Math.random()*900000)+100000),
    supplier,
    items: poDraft.length,
    total: poDraft.reduce((s,i)=>s+i.qty*i.price,0),
    status: 'è‰ç¨¿', // åˆ›å»ºæ—¶è®¾ä¸ºè‰ç¨¿çŠ¶æ€ï¼Œä¸è‡ªåŠ¨æäº¤å®¡æ‰¹
    applicant: currentUser,
    applyDate: new Date().toISOString().split('T')[0],
    approver: '',
    approveDate: '',
    rejectReason: '',
    lines: JSON.parse(JSON.stringify(poDraft)),
    quotesCollected: false // æ ‡è®°æ˜¯å¦å·²æ”¶é›†ä¾›åº”å•†æŠ¥ä»·
  };
  data.pos.unshift(newPO); poDraft = []; closeCreatePO(); renderPurchaseOrders(); renderAll();
  showToast('é‡‡è´­è®¡åˆ’å·²åˆ›å»ºä¸ºè‰ç¨¿ï¼Œè¯·æ”¶é›†ä¾›åº”å•†æŠ¥ä»·åæäº¤å®¡æ‰¹', 'info');
}

// æäº¤é‡‡è´­è®¡åˆ’å®¡æ‰¹
function submitPOForApproval(poId){
  const po = data.pos.find(p => p.id === poId);
  if(!po) return;
  
  if(!po.quotesCollected){
    showToast('è¯·å…ˆæ”¶é›†ä¾›åº”å•†æŠ¥ä»·åå†æäº¤å®¡æ‰¹', 'warning');
    return;
  }
  
  po.status = 'å¾…å®¡æ ¸';
  po.submitDate = new Date().toISOString().split('T')[0];
  renderPurchaseOrders();
  renderAll();
  showToast('é‡‡è´­è®¡åˆ’å·²æäº¤å®¡æ‰¹ï¼Œç­‰å¾…è€æ¿å®¡æ ¸', 'info');
}

// é‡‡è´­å®Œæˆåè¿›å…¥ä»“åº“å¾…å‘è´§
function moveToWarehouseDelivery(poId) {
  const po = data.pos.find(p => p.id === poId);
  if(!po) return;
  
  po.status = 'ä»“åº“å¾…å‘è´§';
  po.warehouseReadyDate = new Date().toISOString().split('T')[0];
  renderPurchaseOrders();
  renderAll();
  showToast('é‡‡è´­è®¢å•å·²ç§»äº¤ä»“åº“å¤„ç†', 'info');
}

// ä¸ºé‡‡è´­è®¡åˆ’æ”¶é›†ä¾›åº”å•†æŠ¥ä»·
function collectQuotesForPO(poId){
  const po = data.pos.find(p => p.id === poId);
  if(!po) return;
  
  // æ‰“å¼€ä¾›åº”å•†æŠ¥ä»·æ¨¡æ€æ¡†ï¼Œå¹¶é¢„å…ˆå…³è”é‡‡è´­è®¡åˆ’
  showPurchaseTab('quotes');
  openSupplierQuote();
  
  // ä¸´æ—¶å­˜å‚¨å½“å‰é‡‡è´­è®¡åˆ’IDï¼Œç”¨äºå…³è”æŠ¥ä»·
  window.currentPOId = poId;
  
  showToast(`æ­£åœ¨ä¸ºé‡‡è´­è®¡åˆ’ ${poId} æ”¶é›†ä¾›åº”å•†æŠ¥ä»·`, 'info');
}

// é‡æ–°æäº¤å·²é©³å›çš„é‡‡è´­è®¡åˆ’
function resubmitPO(poId){
  const po = data.pos.find(p => p.id === poId);
  if(!po) return;
  
  const reason = prompt('è¯·è¯´æ˜ä¿®æ”¹å†…å®¹ï¼š');
  if(!reason) return;
  
  po.status = 'å¾…å®¡æ ¸';
  po.rejectReason = '';
  po.resubmitReason = reason;
  po.resubmitDate = new Date().toISOString().split('T')[0];
  
  renderPurchaseOrders();
  renderAll();
  showToast('é‡‡è´­è®¡åˆ’å·²é‡æ–°æäº¤å®¡æ‰¹', 'info');
}

function approvePO(poId){
  if(!hasPermission('approve_po')){
    showToast('æ— æƒé™å®¡æ‰¹é‡‡è´­å•', 'error');
    return;
  }
  
  const po = data.pos.find(p => p.id === poId);
  if(!po) return;
  
  po.status = 'å¾…é‡‡è´­'; // å®¡æ‰¹é€šè¿‡åè½¬ä¸ºå¾…é‡‡è´­çŠ¶æ€ï¼Œç­‰å¾…è½¬ä¸ºé‡‡è´­è®¢å•
  po.approver = currentUser;
  po.approveDate = new Date().toISOString().split('T')[0];
  
  renderPurchaseOrders();
  renderAll();
  showToast(`é‡‡è´­è®¡åˆ’ ${poId} å·²æ‰¹å‡†ï¼Œè¯·åˆ›å»ºé‡‡è´­è®¢å•`, 'success');
}

// é‡‡è´­åˆåŒç”ŸæˆåŠŸèƒ½
function generateContract(poId) {
  generateContractAndPrint(poId);
}

// å‘è´§å•ç”ŸæˆåŠŸèƒ½
function generateDeliverySlip(poId) {
  const po = data.pos.find(p => p.id === poId);
  if (!po) return;
  
  const today = new Date();
  const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
  const orderCount = (data.pos.filter(p => p.deliverySlipId && p.deliverySlipId.startsWith(dateStr)).length + 1);
  const slipId = dateStr + String(orderCount).padStart(3, '0');
  const queryCode = String(Math.floor(Math.random() * 10000)).padStart(4, '0');
  
  po.deliverySlipId = slipId;
  po.deliverySlipQueryCode = queryCode;
  po.deliverySlipGenerated = true;
  po.deliverySlipDate = new Date().toISOString().split('T')[0];
  
  // åˆå§‹åŒ–é€è´§å•æ˜ç»†
  po.deliveryDetails = po.lines.map(line => ({
    sku: line.sku,
    quantity: line.qty,
    deliveredQuantity: 0 // ä¾›æ”¶è´§æ—¶å¡«å†™
  }));
  
  // è®¾ç½®å½“å‰å‘è´§å•ID
  window.currentDeliverySlipPOId = poId;
  
  openDeliverySlipModal(poId);
  showToast(`å‘è´§å•å·²ç”Ÿæˆ\nå•å·ï¼š${slipId}\næŸ¥è¯¢ç ï¼š${queryCode}\nä¾›åº”å•†ï¼š${po.supplier}`, 'success');
}

// å…³è”è´¨æ£€æ ‡å‡†
function manageQualityStandards(poId) {
  const po = data.pos.find(p => p.id === poId);
  if (!po) return;
  
  openQualityModal(poId);
}

// ä¸Šä¼ ä¾›åº”å•†å›ä¼ é™„ä»¶
function uploadAttachment(poId) {
  const po = data.pos.find(p => p.id === poId);
  if (!po) return;
  
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.pdf,.jpg,.png,.doc,.docx';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      if (!po.attachments) po.attachments = [];
      po.attachments.push({
        name: file.name,
        type: file.type,
        size: file.size,
        uploadTime: new Date().toLocaleString(),
        uploadedBy: currentUser
      });
      showToast(`æ–‡ä»¶ ${file.name} å·²ä¸Šä¼ `, 'success');
      renderPurchaseOrders();
    }
  };
  input.click();
}

function rejectPO(poId){
  if(!hasPermission('approve_po')){
    showToast('æ— æƒé™é©³å›é‡‡è´­å•', 'error');
    return;
  }
  
  const reason = prompt('è¯·è¾“å…¥é©³å›åŸå› ï¼š');
  if(!reason) return;
  
  const po = data.pos.find(p => p.id === poId);
  if(!po) return;
  
  po.status = 'å·²é©³å›';
  po.approver = currentUser;
  po.rejectReason = reason;
  po.quotesCollected = false; // é‡ç½®æŠ¥ä»·æ”¶é›†çŠ¶æ€ï¼Œéœ€è¦é‡æ–°æ”¶é›†
  renderPurchaseOrders();
  renderAll();
  showToast(`é‡‡è´­è®¡åˆ’ ${poId} å·²é©³å›ï¼Œé‡‡è´­å‘˜å¯ä¿®æ”¹åé‡æ–°æäº¤`, 'error');
}

/* æ¨¡æ‹Ÿæ”¶è´§ï¼šå°†ç¬¬ä¸€ä¸ªå¾…æ”¶å•è®¾ä¸ºå®Œæˆå¹¶å¢åŠ åº“å­˜ */
function simulateReceive(){
  const idx = data.pos.findIndex(p=>p.status==='å¾…æ”¶è´§');
  if(idx===-1){ showToast('æ— å¾…æ”¶è´§é‡‡è´­å•', 'error'); return; }
  const po = data.pos[idx];
  po.status = 'å·²å®Œæˆ';
  po.lines.forEach(l=>{
    const prod = data.products.find(p=>p.sku===l.sku);
    if(prod) prod.stock += l.qty;
  });
  renderAll();
  showToast('æ¨¡æ‹Ÿæ”¶è´§å®Œæˆï¼Œåº“å­˜å·²æ›´æ–°', 'success');
}

/* ä¾›åº”å•†è¡¨å•ç›¸å…³å˜é‡ */
let currentEditingSupplierId = null;
let currentViewingSupplierId = null;

/* æ‰“å¼€æ–°å¢ä¾›åº”å•†è¡¨å• */
function openSupplierCreate() {
  currentEditingSupplierId = null;
  
  // æ¸…ç©ºè¡¨å•
  document.getElementById('supplierFormTitle').textContent = 'ğŸ¢ æ–°å¢ä¾›åº”å•†';
  document.getElementById('supplierFormDescription').textContent = 'å¡«å†™ä¾›åº”å•†åŸºæœ¬ä¿¡æ¯';
  document.getElementById('supplierName').value = '';
  document.getElementById('supplierCode').value = '';
  document.getElementById('supplierContact').value = '';
  document.getElementById('supplierPhone').value = '';
  document.getElementById('supplierEmail').value = '';
  document.getElementById('supplierAddress').value = '';
  document.getElementById('supplierStarRating').value = '3'; // é»˜è®¤3æ˜Ÿçº§
  document.getElementById('supplierSettle').value = 'æœˆç»“';
  document.getElementById('supplierCategory').value = '';
  document.getElementById('supplierNotes').value = '';
  
  // æ¸…ç©ºæ–°å¢å­—æ®µ
  document.getElementById('supplierScale').value = '';
  document.getElementById('supplierCreditCode').value = '';
  document.getElementById('supplierWechat').value = '';
  document.getElementById('supplierCompanyPhone').value = '';
  document.getElementById('supplierOfficeAddress').value = '';
  document.getElementById('supplierProductionAddress').value = '';
  document.getElementById('supplierWarehouseAddress').value = '';
  document.getElementById('supplierDeliveryMethod').value = '';
  document.getElementById('supplierTaxType').value = '';
  document.getElementById('supplierTaxRate').value = '';
  document.getElementById('supplierBusinessLicense').value = '';
  
  // ç”Ÿæˆä¾›åº”å•†ä»£ç 
  const code = 'S' + (Math.floor(Math.random() * 900000) + 100000);
  document.getElementById('supplierCode').value = code;
  
  // æ›´æ–°æ˜Ÿçº§æ˜¾ç¤º
  updateStarRating();
  
  // æ˜¾ç¤ºè¡¨å•
  const modal = document.getElementById('supplierFormModal');
  modal.classList.remove('hidden');
  modal.style.display = 'flex';
}

/* å…³é—­ä¾›åº”å•†è¡¨å• */
function closeSupplierFormModal() {
  const modal = document.getElementById('supplierFormModal');
  modal.classList.add('hidden');
    modal.style.display = 'none';
  currentEditingSupplierId = null;
}

/* æ›´æ–°æ˜Ÿçº§æ˜¾ç¤º */
function updateStarRating() {
  const starRating = document.getElementById('supplierStarRating').value;
  const starDisplay = document.getElementById('supplierStarRating');
  
  if (starDisplay) {
    const stars = 'â­'.repeat(parseInt(starRating) || 0) + 'â˜†'.repeat(5 - parseInt(starRating));
    // æ›´æ–°selecté€‰é¡¹çš„æ˜¾ç¤ºæ–‡æœ¬
    const selectedOption = starDisplay.options[starDisplay.selectedIndex];
    if (selectedOption) {
      selectedOption.text = stars + ' ' + selectedOption.text.split(' ')[1];
    }
  }
}

/* ä¿å­˜ä¾›åº”å•† */
function saveSupplier() {
  // è·å–è¡¨å•æ•°æ®
  const name = document.getElementById('supplierName').value.trim();
  const code = document.getElementById('supplierCode').value.trim();
  const contact = document.getElementById('supplierContact').value.trim();
  const phone = document.getElementById('supplierPhone').value.trim();
  const email = document.getElementById('supplierEmail').value.trim();
  const address = document.getElementById('supplierAddress').value.trim();
  const starRating = parseInt(document.getElementById('supplierStarRating').value) || 0;
  const settle = document.getElementById('supplierSettle').value;
  const category = document.getElementById('supplierCategory').value.trim();
  const notes = document.getElementById('supplierNotes').value.trim();
  
  // æ–°å¢å­—æ®µ
  const scale = document.getElementById('supplierScale').value;
  const creditCode = document.getElementById('supplierCreditCode').value.trim();
  const wechat = document.getElementById('supplierWechat').value.trim();
  const companyPhone = document.getElementById('supplierCompanyPhone').value.trim();
  const officeAddress = document.getElementById('supplierOfficeAddress').value.trim();
  const productionAddress = document.getElementById('supplierProductionAddress').value.trim();
  const warehouseAddress = document.getElementById('supplierWarehouseAddress').value.trim();
  const deliveryMethod = document.getElementById('supplierDeliveryMethod').value;
  const taxType = document.getElementById('supplierTaxType').value;
  const taxRate = parseFloat(document.getElementById('supplierTaxRate').value) || 0;
  
  // éªŒè¯å¿…å¡«å­—æ®µ
  if (!name || !contact || !phone || !settle || starRating === 0) {
    showToast('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼ˆåŒ…æ‹¬æ˜Ÿçº§ï¼‰', 'error');
    return;
  }
  
  // éªŒè¯ç”µè¯æ ¼å¼
  const phoneRegex = /^1[3-9]\d{9}$/;
  if (!phoneRegex.test(phone.replace(/[\s-]/g, ''))) {
    showToast('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç æ ¼å¼', 'error');
    return;
  }
  
  // å¤„ç†è¥ä¸šæ‰§ç…§ä¸Šä¼ 
  const businessLicenseFile = document.getElementById('supplierBusinessLicense').files[0];
  let businessLicense = null;
  
  if (businessLicenseFile) {
    businessLicense = {
      name: businessLicenseFile.name,
      type: businessLicenseFile.type,
      size: businessLicenseFile.size,
      uploadTime: new Date().toLocaleString(),
      uploadedBy: currentUser
    };
  }
  
  const now = new Date().toISOString();
  
  if (currentEditingSupplierId) {
    // ç¼–è¾‘ç°æœ‰ä¾›åº”å•†
    const supplier = data.suppliers.find(s => s.id === currentEditingSupplierId);
    if (supplier) {
      supplier.name = name;
      supplier.code = code || supplier.code;
      supplier.contact = contact;
      supplier.phone = phone;
      supplier.email = email;
      supplier.address = address;
      supplier.starRating = starRating;
      supplier.settle = settle;
      supplier.category = category;
      supplier.notes = notes;
      supplier.scale = scale;
      supplier.creditCode = creditCode;
      supplier.wechat = wechat;
      supplier.companyPhone = companyPhone;
      supplier.officeAddress = officeAddress;
      supplier.productionAddress = productionAddress;
      supplier.warehouseAddress = warehouseAddress;
      supplier.deliveryMethod = deliveryMethod;
      supplier.taxType = taxType;
      supplier.taxRate = taxRate;
      if (businessLicense) {
        supplier.businessLicense = businessLicense;
      }
      supplier.updatedAt = now;
      
      showToast('ä¾›åº”å•†ä¿¡æ¯å·²æ›´æ–°', 'success');
    }
  } else {
    // æ–°å¢ä¾›åº”å•†
    // æ£€æŸ¥ä¾›åº”å•†ä»£ç æ˜¯å¦é‡å¤
    if (code && data.suppliers.some(s => s.code === code)) {
      showToast('ä¾›åº”å•†ä»£ç å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–ä»£ç ', 'error');
      return;
    }
    
    const id = 'S' + (Math.floor(Math.random() * 900000) + 100000);
    const newSupplier = {
      id,
      name,
      code: code || id,
      contact,
      phone,
      email,
      address,
      starRating,
      settle,
      category,
      notes,
      scale,
      creditCode,
      wechat,
      companyPhone,
      officeAddress,
      productionAddress,
      warehouseAddress,
      deliveryMethod,
      taxType,
      taxRate,
      businessLicense,
      contracts: [], // åˆå§‹åŒ–åˆåŒæ•°ç»„
      createdAt: now,
      updatedAt: now
    };
    
    data.suppliers.push(newSupplier);
    showToast('ä¾›åº”å•†æ–°å¢æˆåŠŸ', 'success');
  }
  
  // å…³é—­è¡¨å•
  closeSupplierFormModal();
  
  // åˆ·æ–°é¡µé¢
  renderAll();
}

/* ç¼–è¾‘ä¾›åº”å•†ï¼ˆä»è¯¦æƒ…é¢æ¿è°ƒç”¨ï¼‰ */
function editSupplierFromDetail() {
  console.log('editSupplierFromDetail called, currentViewingSupplierId:', currentViewingSupplierId);
  
  const sp = data.suppliers.find(x => x.id === currentViewingSupplierId);
  if (!sp) {
    console.error('Supplier not found in editSupplierFromDetail, currentViewingSupplierId:', currentViewingSupplierId);
    return;
  }
  
  console.log('Editing supplier:', sp);
  
  currentEditingSupplierId = sp.id;
  
  // è®¾ç½®è¡¨å•æ ‡é¢˜å’Œæè¿°
  document.getElementById('supplierFormTitle').textContent = 'ğŸ¢ ç¼–è¾‘ä¾›åº”å•†';
  document.getElementById('supplierFormDescription').textContent = 'ä¿®æ”¹ä¾›åº”å•†ä¿¡æ¯';
  
  // å¡«å……è¡¨å•æ•°æ®
  document.getElementById('supplierName').value = sp.name || '';
  document.getElementById('supplierCode').value = sp.code || '';
  document.getElementById('supplierContact').value = sp.contact || '';
  document.getElementById('supplierPhone').value = sp.phone || '';
  document.getElementById('supplierEmail').value = sp.email || '';
  document.getElementById('supplierAddress').value = sp.address || '';
  document.getElementById('supplierStarRating').value = sp.starRating || 3;
  document.getElementById('supplierSettle').value = sp.settle || 'æœˆç»“';
  document.getElementById('supplierCategory').value = sp.category || '';
  document.getElementById('supplierNotes').value = sp.notes || '';
  
  // å¡«å……æ–°å¢å­—æ®µ
  document.getElementById('supplierScale').value = sp.scale || '';
  document.getElementById('supplierCreditCode').value = sp.creditCode || '';
  document.getElementById('supplierWechat').value = sp.wechat || '';
  document.getElementById('supplierCompanyPhone').value = sp.companyPhone || '';
  document.getElementById('supplierOfficeAddress').value = sp.officeAddress || '';
  document.getElementById('supplierProductionAddress').value = sp.productionAddress || '';
  document.getElementById('supplierWarehouseAddress').value = sp.warehouseAddress || '';
  document.getElementById('supplierDeliveryMethod').value = sp.deliveryMethod || '';
  document.getElementById('supplierTaxType').value = sp.taxType || '';
  document.getElementById('supplierTaxRate').value = sp.taxRate || '';
  
  // æ›´æ–°æ˜Ÿçº§æ˜¾ç¤º
  updateStarRating();
  
  // æ˜¾ç¤ºè¡¨å•æ¨¡æ€æ¡†
  const modal = document.getElementById('supplierFormModal');
  console.log('Found supplierFormModal:', modal);
  if (modal) {
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
    console.log('Supplier form modal should now be visible');
  } else {
    console.error('supplierFormModal not found!');
  }
}

/* é”€å”®åˆ›å»ºï¼Œç®€å•ç¤ºä¾‹ */
// é”€å”®ç®¡ç†æ ¸å¿ƒåŠŸèƒ½å‡½æ•°
function openCreateSalesOrder() {
  const modal = document.getElementById('salesOrderCreateModal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.style.display = '';
    initializeSalesOrderForm();
  }
}

function initializeSalesOrderForm() {
  // ç”Ÿæˆè®¢å•ç¼–å·
  const today = new Date();
  const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
  const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
  document.getElementById('salesOrderNo').value = `SO${dateStr}${randomNum}`;
  
  // è®¾ç½®é»˜è®¤æ—¥æœŸ
  document.getElementById('salesOrderDate').value = today.toISOString().split('T')[0];
  
  // æ¸…ç©ºè¡¨å•
  document.getElementById('salesOrderCreateForm').reset();
  document.getElementById('salesOrderDate').value = today.toISOString().split('T')[0];
  document.getElementById('salesOrderNo').value = `SO${dateStr}${randomNum}`;
  
  // åˆå§‹åŒ–å®¢æˆ·é€‰æ‹©
  populateCustomerSelect();
  
  // æ¸…ç©ºäº§å“æ˜ç»†
  document.getElementById('salesOrderItems').innerHTML = `
    <div class="sales-order-item">
      <div style="display: grid; grid-template-columns: 60px 120px 300px 100px 100px 120px 100px 100px 80px; gap: 8px; align-items: center; font-weight: 500; font-size: 14px; color: var(--muted);">
        <div>å›¾ç‰‡</div>
        <div>SKU</div>
        <div>äº§å“åç§°</div>
        <div>è§„æ ¼</div>
        <div>å•ä½</div>
        <div>å”®ä»·</div>
        <div>æ•°é‡</div>
        <div>å°è®¡</div>
        <div>æ“ä½œ</div>
      </div>
    </div>
  `;
  
  updateSalesOrderTotal();
}

// æ‰“å¼€é”€å”®è®¢å•åˆ›å»ºæ¨¡æ€æ¡†
function openSalesOrderCreateModal() {
  const modal = document.getElementById('salesOrderCreateModal');
  if (!modal) return;
  
  // é‡ç½®è¡¨å•
  document.getElementById('salesOrderCreateForm').reset();
  
  // è®¾ç½®é»˜è®¤å€¼
  document.getElementById('salesOrderDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('salesOrderNo').value = 'SO' + new Date().toISOString().slice(0, 10).replace(/-/g, '') + 
    String(data.sales.length + 1).padStart(4, '0');
  
  // æ¸…ç©ºäº§å“æ˜ç»†
  const itemsContainer = document.getElementById('salesOrderItems');
  if (itemsContainer) {
    itemsContainer.innerHTML = '';
  }
  
  // åˆå§‹åŒ–ä¸‹æ‹‰é€‰é¡¹
  populateCustomerSelect();
  
  // é‡ç½®å®¢æˆ·å­—æ®µçŠ¶æ€
  document.getElementById('salesCustomerInput').style.display = 'none';
  document.getElementById('salesCustomerInput').value = '';
  document.getElementById('salesContact').readOnly = true;
  document.getElementById('salesPhone').readOnly = true;
  document.getElementById('salesAddress').readOnly = true;
  document.getElementById('salesContact').placeholder = 'è‡ªåŠ¨å¡«å……';
  document.getElementById('salesPhone').placeholder = 'è‡ªåŠ¨å¡«å……';
  document.getElementById('salesAddress').placeholder = 'è‡ªåŠ¨å¡«å……';
  
  modal.classList.remove('hidden');
  modal.style.display = '';
}

function populateCustomerSelect() {
  const select = document.getElementById('salesCustomer');
  select.innerHTML = '<option value="">è¯·é€‰æ‹©å®¢æˆ·</option>';
  
  data.customers.forEach(customer => {
    const option = document.createElement('option');
    option.value = customer.id;
    option.textContent = customer.name;
    select.appendChild(option);
  });
}

function handleCustomerChange() {
  const customerId = document.getElementById('salesCustomer').value;
  const customerInput = document.getElementById('salesCustomerInput');
  
  if (customerId === 'new') {
    // é€‰æ‹©æ–°å¢å®¢æˆ·ï¼Œæ¸…ç©ºæ‰€æœ‰å­—æ®µè®©ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥
    customerInput.style.display = 'block';
    customerInput.focus();
    document.getElementById('salesContact').readOnly = false;
    document.getElementById('salesPhone').readOnly = false;
    document.getElementById('salesAddress').readOnly = false;
    document.getElementById('salesContact').placeholder = 'è¯·è¾“å…¥è”ç³»äººå§“å';
    document.getElementById('salesPhone').placeholder = 'è¯·è¾“å…¥è”ç³»ç”µè¯';
    document.getElementById('salesAddress').placeholder = 'è¯·è¾“å…¥æ”¶è´§åœ°å€';
    
    // æ¸…ç©ºå­—æ®µ
    document.getElementById('salesContact').value = '';
    document.getElementById('salesPhone').value = '';
    document.getElementById('salesAddress').value = '';
    customerInput.value = '';
  } else if (customerId) {
    // é€‰æ‹©ç°æœ‰å®¢æˆ·
    customerInput.style.display = 'none';
    const customer = data.customers.find(c => c.id === customerId);
    
    if (customer) {
      document.getElementById('salesContact').value = customer.contact || '';
      document.getElementById('salesPhone').value = customer.phone || '';
      document.getElementById('salesAddress').value = customer.address || '';
      document.getElementById('salesContact').readOnly = true;
      document.getElementById('salesPhone').readOnly = true;
      document.getElementById('salesAddress').readOnly = true;
      document.getElementById('salesContact').placeholder = 'è‡ªåŠ¨å¡«å……';
      document.getElementById('salesPhone').placeholder = 'è‡ªåŠ¨å¡«å……';
      document.getElementById('salesAddress').placeholder = 'è‡ªåŠ¨å¡«å……';
    }
  } else {
    // æ¸…ç©ºé€‰æ‹©
    customerInput.style.display = 'none';
    document.getElementById('salesContact').value = '';
    document.getElementById('salesPhone').value = '';
    document.getElementById('salesAddress').value = '';
  }
}

// åˆ‡æ¢å®¢æˆ·è¾“å…¥æ¨¡å¼
function toggleCustomerInput() {
  const customerSelect = document.getElementById('salesCustomer');
  const customerInput = document.getElementById('salesCustomerInput');
  
  if (customerInput.style.display === 'none' || customerInput.style.display === '') {
    // åˆ‡æ¢åˆ°è¾“å…¥æ¨¡å¼
    customerInput.style.display = 'block';
    customerInput.focus();
    customerSelect.value = '';
    document.getElementById('salesContact').readOnly = false;
    document.getElementById('salesPhone').readOnly = false;
    document.getElementById('salesAddress').readOnly = false;
    document.getElementById('salesContact').placeholder = 'è¯·è¾“å…¥è”ç³»äººå§“å';
    document.getElementById('salesPhone').placeholder = 'è¯·è¾“å…¥è”ç³»ç”µè¯';
    document.getElementById('salesAddress').placeholder = 'è¯·è¾“å…¥æ”¶è´§åœ°å€';
    
    // æ¸…ç©ºå­—æ®µ
    document.getElementById('salesContact').value = '';
    document.getElementById('salesPhone').value = '';
    document.getElementById('salesAddress').value = '';
    customerInput.value = '';
  } else {
    // åˆ‡æ¢å›é€‰æ‹©æ¨¡å¼
    customerInput.style.display = 'none';
    customerInput.value = '';
    document.getElementById('salesContact').readOnly = true;
    document.getElementById('salesPhone').readOnly = true;
    document.getElementById('salesAddress').readOnly = true;
    document.getElementById('salesContact').placeholder = 'è‡ªåŠ¨å¡«å……';
    document.getElementById('salesPhone').placeholder = 'è‡ªåŠ¨å¡«å……';
    document.getElementById('salesAddress').placeholder = 'è‡ªåŠ¨å¡«å……';
    
    // æ¸…ç©ºå­—æ®µ
    document.getElementById('salesContact').value = '';
    document.getElementById('salesPhone').value = '';
    document.getElementById('salesAddress').value = '';
  }
}

// å¤„ç†å®¢æˆ·è¾“å…¥
function handleCustomerInput() {
  const customerInput = document.getElementById('salesCustomerInput').value;
  const customerSelect = document.getElementById('salesCustomer');
  
  if (customerInput.trim()) {
    // å¦‚æœæœ‰è¾“å…¥å†…å®¹ï¼Œæ¸…ç©ºä¸‹æ‹‰é€‰æ‹©
    customerSelect.value = '';
    document.getElementById('salesContact').readOnly = false;
    document.getElementById('salesPhone').readOnly = false;
    document.getElementById('salesAddress').readOnly = false;
  }
}

function handleOrderTypeChange() {
  const orderType = document.getElementById('salesOrderType').value;
  const paymentMethod = document.getElementById('salesPaymentMethod');
  
  // æ¸…ç©ºä»˜æ¬¾æ–¹å¼
  paymentMethod.innerHTML = '<option value="">è¯·é€‰æ‹©ä»˜æ¬¾æ–¹å¼</option>';
  
  if (orderType === '1688') {
    // 1688ä¸šåŠ¡ï¼šæ”¯ä»˜å®ã€å¾®ä¿¡ã€é“¶è¡Œå¡ã€å¯¹å…¬æ”¶æ¬¾
    const options = ['æ”¯ä»˜å®', 'å¾®ä¿¡', 'é“¶è¡Œå¡', 'å¯¹å…¬æ”¶æ¬¾'];
    options.forEach(method => {
      const option = document.createElement('option');
      option.value = method;
      option.textContent = method;
      paymentMethod.appendChild(option);
    });
  } else if (orderType === 'offline') {
    // çº¿ä¸‹åˆä½œï¼šæœˆç»“å®¢æˆ·ã€ç°é‡‘å®¢æˆ·
    const options = ['æ”¯ä»˜å®', 'å¾®ä¿¡', 'é“¶è¡Œå¡', 'å¯¹å…¬æ”¶æ¬¾'];
    options.forEach(method => {
      const option = document.createElement('option');
      option.value = method;
      option.textContent = method;
      paymentMethod.appendChild(option);
    });
  }
}

function handleEditOrderTypeChange() {
  const orderType = document.getElementById('editOrderType').value;
  populateEditPaymentMethods(orderType);
}

function closeSalesOrderCreateModal() {
  const modal = document.getElementById('salesOrderCreateModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
  }
}

function addSalesOrderItem() {
  const modal = document.getElementById('productSelectModal');
  if (modal) {
    modal.classList.remove('hidden');
    modal.style.display = '';
    populateProductSelectionTable();
  }
}

function closeProductSelectModal() {
  const modal = document.getElementById('productSelectModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
  }
}

function populateProductSelectionTable() {
  const tbody = document.querySelector('#table-product-selection tbody');
  tbody.innerHTML = '';
  
  data.products.forEach(product => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><div class="product-image" style="width:40px;height:40px;">${getProductImage(product.image || 'package')}</div></td>
      <td>${product.sku}</td>
      <td>${product.name}</td>
      <td>${product.model || '-'}</td>
      <td>${product.stock}</td>
      <td>Â¥${(Math.random() * 200 + 50).toFixed(2)}</td>
      <td>
        <button class="btn ghost" onclick="selectProductForOrder('${product.sku}', '${product.name}', '${product.model || ''}', '${product.type || ''}')">é€‰æ‹©</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function filterProductsForSelection() {
  const searchTerm = document.getElementById('productSearchInput').value.toLowerCase();
  const tbody = document.querySelector('#table-product-selection tbody');
  const rows = tbody.getElementsByTagName('tr');
  
  Array.from(rows).forEach(row => {
    const sku = row.cells[1].textContent.toLowerCase();
    const name = row.cells[2].textContent.toLowerCase();
    
    if (sku.includes(searchTerm) || name.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

function selectProductForOrder(sku, name, model, unit) {
  closeProductSelectModal();
  
  const itemsContainer = document.getElementById('salesOrderItems');
  const itemId = Date.now(); // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
  
  const itemDiv = document.createElement('div');
  itemDiv.className = 'sales-order-item';
  itemDiv.id = `order-item-${itemId}`;
  
  itemDiv.innerHTML = `
    <div style="display: grid; grid-template-columns: 60px 120px 300px 100px 100px 120px 100px 100px 80px; gap: 8px; align-items: center; border-bottom: 1px solid var(--border-color); padding: 8px 0;">
      <td><div class="product-image" style="width:40px;height:40px;">${getProductImage('package')}</div></td>
      <td>${sku}</td>
      <td>${name}</td>
      <td>${model}</td>
      <td>${unit}</td>
      <td>
        <input type="number" id="price-${itemId}" step="0.01" value="${(Math.random() * 200 + 50).toFixed(2)}" onchange="updateItemTotal(${itemId})" style="width: 100%; padding: 4px; border: 1px solid var(--border-color); border-radius: 4px;">
      </td>
      <td>
        <input type="number" id="quantity-${itemId}" min="1" value="1" onchange="updateItemTotal(${itemId})" style="width: 100%; padding: 4px; border: 1px solid var(--border-color); border-radius: 4px;">
      </td>
      <td>
        <span id="total-${itemId}">Â¥${(Math.random() * 200 + 50).toFixed(2)}</span>
      </td>
      <td>
        <button class="btn ghost" onclick="removeSalesOrderItem(${itemId})" style="color: var(--danger);">åˆ é™¤</button>
      </td>
    </div>
  `;
  
  // éšè—è¡¨å¤´æç¤ºï¼Œæ·»åŠ é¡¹ç›®
  const headerRow = itemsContainer.querySelector('.sales-order-item');
  if (headerRow && headerRow.id && !headerRow.id.startsWith('order-item-')) {
    itemsContainer.appendChild(itemDiv);
  } else {
    itemsContainer.appendChild(itemDiv);
  }
  
  updateSalesOrderTotal();
}

function removeSalesOrderItem(itemId) {
  const item = document.getElementById(`order-item-${itemId}`);
  if (item) {
    item.remove();
    updateSalesOrderTotal();
  }
}

function updateItemTotal(itemId) {
  const price = parseFloat(document.getElementById(`price-${itemId}`).value) || 0;
  const quantity = parseInt(document.getElementById(`quantity-${itemId}`).value) || 0;
  const total = price * quantity;
  
  document.getElementById(`total-${itemId}`).textContent = `Â¥${total.toFixed(2)}`;
  updateSalesOrderTotal();
}

function updateSalesOrderTotal() {
  const items = document.querySelectorAll('.sales-order-item[id^="order-item-"]');
  let totalAmount = 0;
  
  items.forEach(item => {
    const totalSpan = item.querySelector('span[id^="total-"]');
    if (totalSpan) {
      const total = parseFloat(totalSpan.textContent.replace('Â¥', '')) || 0;
      totalAmount += total;
    }
  });
  
  document.getElementById('salesOrderTotal').textContent = totalAmount.toFixed(2);
}

function saveSalesOrder(event) {
  event.preventDefault();
  
  // æ”¶é›†è¡¨å•æ•°æ®
  const formData = {
    id: document.getElementById('salesOrderNo').value,
    orderNo: document.getElementById('salesOrderNo').value,
    orderType: document.getElementById('salesOrderType').value,
    salesDate: document.getElementById('salesOrderDate').value,
    paymentMethod: document.getElementById('salesPaymentMethod').value,
    paymentStatus: document.getElementById('salesPaymentStatus').value,
    deliveryDate: document.getElementById('salesDeliveryDate').value,
    customerId: document.getElementById('salesCustomer').value || 'new',
    customer: document.getElementById('salesCustomerInput').value || document.getElementById('salesCustomer').selectedOptions[0]?.text || '',
    contact: document.getElementById('salesContact').value,
    phone: document.getElementById('salesPhone').value,
    address: document.getElementById('salesAddress').value,
    logisticsCompany: document.getElementById('salesLogisticsCompany').value,
    trackingNo: document.getElementById('salesTrackingNo').value,
    weight: parseFloat(document.getElementById('salesWeight').value) || 0,
    shippingFee: parseFloat(document.getElementById('salesShippingFee').value) || 0,
    notes: document.getElementById('salesNotes').value,
    status: 'å¾…å‘è´§',
    salesperson: 'å¼ ä¸‰', // æ¨¡æ‹Ÿå½“å‰ä¸šåŠ¡å‘˜
    items: [],
    total: 0
  };
  
  // æ”¶é›†äº§å“æ˜ç»†
  const orderItems = document.querySelectorAll('.sales-order-item[id^="order-item-"]');
  let totalAmount = 0;
  
  orderItems.forEach(item => {
    const sku = item.id.replace('order-item-', '');
    const product = data.products.find(p => p.sku === sku);
    const price = parseFloat(document.getElementById(`price-${sku}`).value) || 0;
    const quantity = parseInt(document.getElementById(`quantity-${sku}`).value) || 0;
    const itemTotal = price * quantity;
    totalAmount += itemTotal;
    
    formData.items.push({
      sku: sku,
      name: product ? product.name : sku,
      model: product ? product.model : '',
      unit: product ? product.unit : 'ä¸ª',
      price: price,
      quantity: quantity,
      total: itemTotal
    });
  });
  
  formData.total = totalAmount;
  
  // éªŒè¯æ•°æ®
  if (!formData.orderType || !formData.customer || !formData.contact || !formData.phone || !formData.address || !formData.items.length) {
    showToast('è¯·å¡«å†™å®Œæ•´çš„è®¢å•ä¿¡æ¯ï¼ˆå®¢æˆ·åç§°ã€è”ç³»äººã€ç”µè¯ã€åœ°å€å¿…å¡«ï¼‰', 'error');
    return;
  }
  
  // æ·»åŠ åˆ°æ•°æ®ä¸­
  data.sales.unshift(formData);
  
  // å…³é—­æ¨¡æ€æ¡†
  closeSalesOrderCreateModal();
  
  // åˆ·æ–°é”€å”®è®¢å•åˆ—è¡¨
  renderSales();
  
  showToast(`é”€å”®è®¢å• ${formData.orderNo} åˆ›å»ºæˆåŠŸ`, 'success');
}

// å½“å‰ç¼–è¾‘çš„é”€å”®è®¢å•é¡¹ç›®
let currentEditOrderItems = [];

// æŸ¥çœ‹å’Œç¼–è¾‘æ¨¡æ€æ¡†ç›¸å…³å‡½æ•°
function closeSalesOrderViewModal() {
  const modal = document.getElementById('salesOrderViewModal');
  if (modal) {
    modal.classList.add('hidden');
    modal.style.display = 'none';
  }
}

function closeSalesOrderEditModal() {
  const modal = document.getElementById('salesOrderEditModal');
  if (modal) {
    modal.classList.add('hidden');
    modal.style.display = 'none';
    currentEditOrderItems = [];
  }
}

function editCurrentOrder() {
  const viewModal = document.getElementById('salesOrderViewModal');
  const orderId = viewModal.dataset.orderId;
  if (orderId) {
    closeSalesOrderViewModal();
    editSalesOrder(orderId);
  }
}

function populateEditPaymentMethods(orderType) {
  const paymentMethod = document.getElementById('editPaymentMethod');
  paymentMethod.innerHTML = '<option value="">è¯·é€‰æ‹©ä»˜æ¬¾æ–¹å¼</option>';
  
  if (orderType === '1688') {
    const options = ['æ”¯ä»˜å®', 'å¾®ä¿¡', 'é“¶è¡Œå¡', 'å¯¹å…¬æ”¶æ¬¾'];
    options.forEach(method => {
      const option = document.createElement('option');
      option.value = method;
      option.textContent = method;
      paymentMethod.appendChild(option);
    });
  } else if (orderType === 'offline') {
    const options = ['æ”¯ä»˜å®', 'å¾®ä¿¡', 'é“¶è¡Œå¡', 'å¯¹å…¬æ”¶æ¬¾'];
    options.forEach(method => {
      const option = document.createElement('option');
      option.value = method;
      option.textContent = method;
      paymentMethod.appendChild(option);
    });
  }
}

function populateEditCustomerSelect() {
  const select = document.getElementById('editCustomer');
  select.innerHTML = '<option value="">è¯·é€‰æ‹©å®¢æˆ·</option><option value="new">ğŸ“ æ–°å¢å®¢æˆ·</option>';
  
  data.customers.forEach(customer => {
    const option = document.createElement('option');
    option.value = customer.id;
    option.textContent = customer.name;
    select.appendChild(option);
  });
}

function handleEditCustomerChange() {
  const customerId = document.getElementById('editCustomer').value;
  const customerInput = document.getElementById('editCustomerInput');
  
  if (customerId === 'new') {
    customerInput.style.display = 'block';
    customerInput.focus();
  } else if (customerId) {
    customerInput.style.display = 'none';
    const customer = data.customers.find(c => c.id === customerId);
    
    if (customer) {
      document.getElementById('editContact').value = customer.contact || '';
      document.getElementById('editPhone').value = customer.phone || '';
      document.getElementById('editAddress').value = customer.address || '';
    }
  } else {
    customerInput.style.display = 'none';
  }
}

function toggleEditCustomerInput() {
  const customerSelect = document.getElementById('editCustomer');
  const customerInput = document.getElementById('editCustomerInput');
  
  if (customerInput.style.display === 'none' || customerInput.style.display === '') {
    customerInput.style.display = 'block';
    customerInput.focus();
    customerSelect.value = '';
  } else {
    customerInput.style.display = 'none';
    customerInput.value = '';
  }
}

function handleEditCustomerInput() {
  const customerInput = document.getElementById('editCustomerInput').value;
  const customerSelect = document.getElementById('editCustomer');
  
  if (customerInput.trim()) {
    customerSelect.value = '';
  }
}

function openEditProductSelectModal() {
  openProductSelectModal();
}

function removeEditOrderItem(sku) {
  const item = document.getElementById(`edit-order-item-${sku}`);
  if (item) {
    item.remove();
    currentEditOrderItems = currentEditOrderItems.filter(item => item.sku !== sku);
    updateEditSalesOrderTotal();
  }
}

function updateEditSalesOrderTotal() {
  const items = document.querySelectorAll('#editOrderItems .sales-order-item');
  let total = 0;
  
  currentEditOrderItems = [];
  
  items.forEach(item => {
    const sku = item.id.replace('edit-order-item-', '');
    const price = parseFloat(document.getElementById(`edit-price-${sku}`)?.value) || 0;
    const quantity = parseInt(document.getElementById(`edit-quantity-${sku}`)?.value) || 0;
    const subtotal = price * quantity;
    
    const subtotalElement = document.getElementById(`edit-subtotal-${sku}`);
    if (subtotalElement) {
      subtotalElement.textContent = `Â¥${subtotal.toFixed(2)}`;
    }
    
    total += subtotal;
    
    // æ›´æ–°å½“å‰ç¼–è¾‘çš„é¡¹ç›®åˆ—è¡¨
    const existingItem = currentEditOrderItems.find(item => item.sku === sku);
    if (existingItem) {
      existingItem.price = price;
      existingItem.quantity = quantity;
      existingItem.total = subtotal;
    } else {
      const product = data.products.find(p => p.sku === sku);
      currentEditOrderItems.push({
        sku: sku,
        name: product ? product.name : sku,
        model: product ? product.model : '',
        unit: product ? product.unit : 'ä¸ª',
        price: price,
        quantity: quantity,
        total: subtotal
      });
    }
  });
  
  // æ›´æ–°æ€»é‡‘é¢æ˜¾ç¤º
  const totalElement = document.getElementById('editOrderTotal');
  if (totalElement) {
    totalElement.textContent = `Â¥${total.toFixed(2)}`;
  }
}

function updateSalesOrder(event) {
  event.preventDefault();
  
  const orderId = document.getElementById('salesOrderEditModal').dataset.orderId;
  const order = data.sales.find(s => s.id === orderId);
  if (!order) return;
  
  // æ”¶é›†è¡¨å•æ•°æ®
  const formData = {
    orderType: document.getElementById('editOrderType').value,
    salesDate: document.getElementById('editSalesDate').value,
    paymentMethod: document.getElementById('editPaymentMethod').value,
    paymentStatus: document.getElementById('editPaymentStatus').value,
    deliveryDate: document.getElementById('editDeliveryDate').value,
    customerId: document.getElementById('editCustomer').value || 'new',
    customer: document.getElementById('editCustomerInput').value || document.getElementById('editCustomer').selectedOptions[0]?.text || '',
    contact: document.getElementById('editContact').value,
    phone: document.getElementById('editPhone').value,
    address: document.getElementById('editAddress').value,
    logisticsCompany: document.getElementById('editLogisticsCompany').value,
    trackingNo: document.getElementById('editTrackingNo').value,
    weight: parseFloat(document.getElementById('editWeight').value) || 0,
    shippingFee: parseFloat(document.getElementById('editShippingFee').value) || 0,
    notes: document.getElementById('editNotes').value,
    items: currentEditOrderItems,
    total: currentEditOrderItems.reduce((sum, item) => sum + item.total, 0)
  };
  
  // éªŒè¯æ•°æ®
  if (!formData.orderType || !formData.customer || !formData.contact || !formData.phone || !formData.address || !formData.items.length) {
    showToast('è¯·å¡«å†™å®Œæ•´çš„è®¢å•ä¿¡æ¯ï¼ˆå®¢æˆ·åç§°ã€è”ç³»äººã€ç”µè¯ã€åœ°å€å¿…å¡«ï¼‰', 'error');
    return;
  }
  
  // æ›´æ–°è®¢å•æ•°æ®
  Object.assign(order, formData);
  
  // å…³é—­æ¨¡æ€æ¡†
  closeSalesOrderEditModal();
  
  // åˆ·æ–°é”€å”®è®¢å•åˆ—è¡¨
  renderSales();
  
  showToast(`é”€å”®è®¢å• ${order.orderNo} æ›´æ–°æˆåŠŸ`, 'success');
}

// äº§å“é€‰æ‹©ç›¸å…³å‡½æ•°
function openProductSelectModal() {
  const modal = document.getElementById('productSelectModal');
  if (!modal) return;
  
  // æ¸²æŸ“å¯é€‰äº§å“åˆ—è¡¨
  renderProductSelectionList();
  
  modal.classList.remove('hidden');
  modal.style.display = '';
}

function closeProductSelectModal() {
  const modal = document.getElementById('productSelectModal');
  if (modal) {
    modal.classList.add('hidden');
    modal.style.display = 'none';
  }
}

function renderProductSelectionList() {
  const tbody = document.querySelector('#table-product-selection tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  data.products.forEach(product => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><img src="${product.image || 'placeholder.png'}" alt="${product.name}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;"></td>
      <td>${product.sku}</td>
      <td>${product.name}</td>
      <td>${product.model || '-'}</td>
      <td>${product.stock || 0}</td>
      <td>Â¥${(product.price || 0).toFixed(2)}</td>
      <td>
        <button class="btn primary" onclick="addProductToOrder('${product.sku}')" style="padding: 4px 8px; font-size: 12px;">é€‰æ‹©</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function filterProductsForSelection() {
  const searchTerm = document.getElementById('productSearchInput').value.toLowerCase();
  const rows = document.querySelectorAll('#table-product-selection tbody tr');
  
  rows.forEach(row => {
    const sku = row.cells[1].textContent.toLowerCase();
    const name = row.cells[2].textContent.toLowerCase();
    
    if (sku.includes(searchTerm) || name.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

function addProductToOrder(sku) {
  const product = data.products.find(p => p.sku === sku);
  if (!product) return;
  
  // æ£€æŸ¥æ˜¯å¦åœ¨ç¼–è¾‘æ¨¡å¼
  const editModal = document.getElementById('salesOrderEditModal');
  const isEditMode = editModal && !editModal.classList.contains('hidden');
  
  if (isEditMode) {
    // ç¼–è¾‘æ¨¡å¼ï¼šæ·»åŠ åˆ°ç¼–è¾‘è®¢å•é¡¹ç›®
    const existingItem = document.querySelector(`#edit-order-item-${sku}`);
    if (existingItem) {
      showToast('è¯¥äº§å“å·²æ·»åŠ åˆ°è®¢å•ä¸­', 'warning');
      return;
    }
    
    const itemsContainer = document.getElementById('editOrderItems');
    const itemRow = document.createElement('div');
    itemRow.className = 'sales-order-item';
    itemRow.id = `edit-order-item-${sku}`;
    itemRow.innerHTML = `
      <div style="display: grid; grid-template-columns: 60px 120px 200px 100px 80px 80px 100px 60px 30px; gap: 8px; align-items: center; padding: 8px; border:1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px;">
        <img src="${product.image || 'placeholder.png'}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
        <div>${product.sku}</div>
        <div>${product.name}</div>
        <div>${product.model || '-'}</div>
        <div>${product.unit || 'ä¸ª'}</div>
        <input type="number" id="edit-price-${sku}" value="${product.price || 0}" min="0" step="0.01" onchange="updateEditSalesOrderTotal()" style="width: 70px; padding: 4px;">
        <input type="number" id="edit-quantity-${sku}" value="1" min="1" onchange="updateEditSalesOrderTotal()" style="width: 70px; padding: 4px;">
        <div id="edit-subtotal-${sku}">Â¥${(product.price || 0).toFixed(2)}</div>
        <button type="button" onclick="removeEditOrderItem('${sku}')" style="background: #ff4444; color: white; border: none; border-radius: 4px; width: 24px; height: 24px; cursor: pointer;">Ã—</button>
      </div>
    `;
    
    itemsContainer.appendChild(itemRow);
    updateEditSalesOrderTotal();
    closeProductSelectModal();
    showToast(`å·²æ·»åŠ äº§å“: ${product.name}`, 'success');
  } else {
    // æ–°å»ºæ¨¡å¼ï¼šæ·»åŠ åˆ°æ–°å»ºè®¢å•é¡¹ç›®
    const existingItem = document.querySelector(`#order-item-${sku}`);
    if (existingItem) {
      showToast('è¯¥äº§å“å·²æ·»åŠ åˆ°è®¢å•ä¸­', 'warning');
      return;
    }
    
    const itemsContainer = document.getElementById('salesOrderItems');
    const itemRow = document.createElement('div');
    itemRow.className = 'sales-order-item';
    itemRow.id = `order-item-${sku}`;
    itemRow.innerHTML = `
      <div style="display: grid; grid-template-columns: 60px 120px 200px 100px 80px 80px 100px 60px 30px; gap: 8px; align-items: center; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px;">
        <img src="${product.image || 'placeholder.png'}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
        <div>${product.sku}</div>
        <div>${product.name}</div>
        <div>${product.model || '-'}</div>
        <div>${product.unit || 'ä¸ª'}</div>
        <input type="number" id="price-${sku}" value="${product.price || 0}" min="0" step="0.01" onchange="updateSalesOrderTotal()" style="width: 70px; padding: 4px;">
        <input type="number" id="quantity-${sku}" value="1" min="1" onchange="updateSalesOrderTotal()" style="width: 70px; padding: 4px;">
        <div id="subtotal-${sku}">Â¥${(product.price || 0).toFixed(2)}</div>
        <button type="button" onclick="removeOrderItem('${sku}')" style="background: #ff4444; color: white; border: none; border-radius: 4px; width: 24px; height: 24px; cursor: pointer;">Ã—</button>
      </div>
    `;
    
    itemsContainer.appendChild(itemRow);
    updateSalesOrderTotal();
    closeProductSelectModal();
    showToast(`å·²æ·»åŠ äº§å“: ${product.name}`, 'success');
  }
}

function removeOrderItem(sku) {
  const item = document.getElementById(`order-item-${sku}`);
  if (item) {
    item.remove();
    updateSalesOrderTotal();
  }
}

function updateSalesOrderTotal() {
  const items = document.querySelectorAll('.sales-order-item');
  let total = 0;
  
  items.forEach(item => {
    const sku = item.id.replace('order-item-', '');
    const price = parseFloat(document.getElementById(`price-${sku}`)?.value) || 0;
    const quantity = parseInt(document.getElementById(`quantity-${sku}`)?.value) || 0;
    const subtotal = price * quantity;
    
    const subtotalElement = document.getElementById(`subtotal-${sku}`);
    if (subtotalElement) {
      subtotalElement.textContent = `Â¥${subtotal.toFixed(2)}`;
    }
    
    total += subtotal;
  });
  
  // æ›´æ–°æ€»é‡‘é¢æ˜¾ç¤º
  const totalElement = document.getElementById('salesOrderTotal');
  if (totalElement) {
    totalElement.textContent = `Â¥${total.toFixed(2)}`;
  }
}

function viewSalesOrderDetail(orderId) {
  const order = data.sales.find(s => s.id === orderId);
  if (!order) return;
  
  const modal = document.getElementById('salesOrderViewModal');
  if (!modal) return;
  
  // å¡«å……è®¢å•åŸºæœ¬ä¿¡æ¯
  document.getElementById('viewOrderNo').value = order.orderNo;
  document.getElementById('viewOrderType').value = order.orderType === '1688' ? '1688ä¸šåŠ¡' : 'çº¿ä¸‹åˆä½œ';
  document.getElementById('viewSalesDate').value = order.salesDate;
  document.getElementById('viewPaymentMethod').value = order.paymentMethod;
  document.getElementById('viewPaymentStatus').value = order.paymentStatus;
  document.getElementById('viewDeliveryDate').value = order.deliveryDate;
  
  // å¡«å……å®¢æˆ·ä¿¡æ¯
  document.getElementById('viewCustomer').value = order.customer;
  document.getElementById('viewContact').value = order.contact;
  document.getElementById('viewPhone').value = order.phone;
  document.getElementById('viewAddress').value = order.address;
  
  // å¡«å……äº§å“æ˜ç»†
  const itemsContainer = document.getElementById('viewOrderItems');
  itemsContainer.innerHTML = '';
  
  if (order.items && order.items.length > 0) {
    order.items.forEach(item => {
      const itemRow = document.createElement('div');
      itemRow.style.cssText = 'display: grid; grid-template-columns: 60px 120px 200px 100px 80px 80px 100px; gap: 8px; align-items: center; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px;';
      itemRow.innerHTML = `
        <img src="${item.image || 'placeholder.png'}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
        <div>${item.sku}</div>
        <div>${item.name}</div>
        <div>${item.model || '-'}</div>
        <div>${item.unit || 'ä¸ª'}</div>
        <div>Â¥${item.price.toFixed(2)}</div>
        <div>${item.quantity} Ã— Â¥${item.price.toFixed(2)} = Â¥${item.total.toFixed(2)}</div>
      `;
      itemsContainer.appendChild(itemRow);
    });
  } else {
    itemsContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æš‚æ— äº§å“æ˜ç»†</div>';
  }
  
  // å¡«å……å…¶ä»–ä¿¡æ¯
  document.getElementById('viewLogisticsCompany').value = order.logisticsCompany || '-';
  document.getElementById('viewTrackingNo').value = order.trackingNo || '-';
  document.getElementById('viewWeight').value = order.weight ? `${order.weight} kg` : '-';
  document.getElementById('viewShippingFee').value = order.shippingFee ? `Â¥${order.shippingFee.toFixed(2)}` : '-';
  document.getElementById('viewNotes').value = order.notes || '';
  
  // å¡«å……è®¢å•çŠ¶æ€
  document.getElementById('viewStatus').value = order.status;
  document.getElementById('viewSalesperson').value = order.salesperson || '-';
  
  // æ˜¾ç¤ºè®¢å•æ€»é‡‘é¢
  document.getElementById('viewOrderTotal').textContent = `Â¥${order.total.toFixed(2)}`;
  
  // ä¿å­˜å½“å‰æŸ¥çœ‹çš„è®¢å•IDï¼Œç”¨äºç¼–è¾‘åŠŸèƒ½
  modal.dataset.orderId = orderId;
  
  modal.classList.remove('hidden');
  modal.style.display = '';
}

function editSalesOrder(orderId) {
  const order = data.sales.find(s => s.id === orderId);
  if (!order) return;
  
  const modal = document.getElementById('salesOrderEditModal');
  if (!modal) return;
  
  // å¡«å……è®¢å•åŸºæœ¬ä¿¡æ¯
  document.getElementById('editOrderNo').value = order.orderNo;
  document.getElementById('editOrderType').value = order.orderType;
  document.getElementById('editSalesDate').value = order.salesDate;
  document.getElementById('editPaymentMethod').value = order.paymentMethod;
  document.getElementById('editPaymentStatus').value = order.paymentStatus;
  document.getElementById('editDeliveryDate').value = order.deliveryDate;
  
  // å¡«å……å®¢æˆ·ä¿¡æ¯
  if (order.customerId && order.customerId !== 'new') {
    document.getElementById('editCustomer').value = order.customerId;
    document.getElementById('editCustomerInput').style.display = 'none';
    document.getElementById('editCustomerInput').value = '';
  } else {
    document.getElementById('editCustomer').value = '';
    document.getElementById('editCustomerInput').style.display = 'block';
    document.getElementById('editCustomerInput').value = order.customer;
  }
  
  document.getElementById('editContact').value = order.contact;
  document.getElementById('editPhone').value = order.phone;
  document.getElementById('editAddress').value = order.address;
  
  // å¡«å……äº§å“æ˜ç»†
  const itemsContainer = document.getElementById('editOrderItems');
  itemsContainer.innerHTML = '';
  currentEditOrderItems = [];
  
  if (order.items && order.items.length > 0) {
    order.items.forEach(item => {
      currentEditOrderItems.push(item);
      const itemRow = document.createElement('div');
      itemRow.className = 'sales-order-item';
      itemRow.id = `edit-order-item-${item.sku}`;
      itemRow.innerHTML = `
        <div style="display: grid; grid-template-columns: 60px 120px 200px 100px 80px 80px 100px 60px 30px; gap: 8px; align-items: center; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; margin-bottom: 8px;">
          <img src="${item.image || 'placeholder.png'}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
          <div>${item.sku}</div>
          <div>${item.name}</div>
          <div>${item.model || '-'}</div>
          <div>${item.unit || 'ä¸ª'}</div>
          <input type="number" id="edit-price-${item.sku}" value="${item.price}" min="0" step="0.01" onchange="updateEditSalesOrderTotal()" style="width: 70px; padding: 4px;">
          <input type="number" id="edit-quantity-${item.sku}" value="${item.quantity}" min="1" onchange="updateEditSalesOrderTotal()" style="width: 70px; padding: 4px;">
          <div id="edit-subtotal-${item.sku}">Â¥${item.total.toFixed(2)}</div>
          <button type="button" onclick="removeEditOrderItem('${item.sku}')" style="background: #ff4444; color: white; border: none; border-radius: 4px; width: 24px; height: 24px; cursor: pointer;">Ã—</button>
        </div>
      `;
      itemsContainer.appendChild(itemRow);
    });
  }
  
  // å¡«å……å…¶ä»–ä¿¡æ¯
  document.getElementById('editLogisticsCompany').value = order.logisticsCompany || '';
  document.getElementById('editTrackingNo').value = order.trackingNo || '';
  document.getElementById('editWeight').value = order.weight || '';
  document.getElementById('editShippingFee').value = order.shippingFee || '';
  document.getElementById('editNotes').value = order.notes || '';
  
  // åˆå§‹åŒ–ä»˜æ¬¾æ–¹å¼é€‰é¡¹
  populateEditPaymentMethods(order.orderType);
  
  // åˆå§‹åŒ–å®¢æˆ·ä¸‹æ‹‰é€‰é¡¹
  populateEditCustomerSelect();
  
  // æ›´æ–°è®¢å•æ€»é‡‘é¢
  updateEditSalesOrderTotal();
  
  // ä¿å­˜å½“å‰ç¼–è¾‘çš„è®¢å•ID
  modal.dataset.orderId = orderId;
  
  modal.classList.remove('hidden');
  modal.style.display = '';
}

function openCreateCustomer() {
  showToast('æ–°å¢å®¢æˆ·åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function viewCustomerDetail(customerId) {
  const customer = data.customers.find(c => c.id === customerId);
  if (customer) {
    showToast(`æŸ¥çœ‹å®¢æˆ·ï¼š${customer.name}`, 'info');
  }
}

function editCustomer(customerId) {
  showToast(`ç¼–è¾‘å®¢æˆ·åŠŸèƒ½å¼€å‘ä¸­... ID: ${customerId}`, 'info');
}

function openCreateQuote() {
  const modal = document.getElementById('salesQuoteCreateModal');
  if (modal) {
    // ç”ŸæˆæŠ¥ä»·ç¼–å·
    document.getElementById('quoteNo').value = 'QT' + Date.now();
    
    // è®¾ç½®é»˜è®¤å€¼
    document.getElementById('quoteValidUntil').value = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    document.getElementById('quoteStatus').value = 'è‰ç¨¿';
    
    // åŠ è½½å®¢æˆ·åˆ—è¡¨
    loadQuoteCustomers();
    
    modal.classList.remove('hidden');
    modal.style.display = '';
  }
}

function closeSalesQuoteCreateModal() {
  const modal = document.getElementById('salesQuoteCreateModal');
  if (modal) {
    modal.classList.add('hidden');
    modal.style.display = 'none';
  }
}

function openQuoteProductSelectModal() {
  const modal = document.getElementById('quoteProductSelectModal');
  if (modal) {
    loadQuoteProducts();
    modal.classList.remove('hidden');
    modal.style.display = '';
  }
}

function closeQuoteProductSelectModal() {
  const modal = document.getElementById('quoteProductSelectModal');
  if (modal) {
    modal.classList.add('hidden');
    modal.style.display = 'none';
  }
}

function openQuoteApprovalModal(quoteId) {
  const quote = data.salesQuotes.find(q => q.id === quoteId);
  if (!quote) return;
  
  const modal = document.getElementById('quoteApprovalModal');
  if (modal) {
    // å­˜å‚¨æŠ¥ä»·IDåˆ°æ¨¡æ€æ¡†æ•°æ®é›†
    modal.dataset.quoteId = quoteId;
    
    // æ˜¾ç¤ºæŠ¥ä»·ä¿¡æ¯
    let itemsHtml = '';
    if (quote.items && quote.items.length > 0) {
      itemsHtml = `
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
          <div style="font-weight: 600; margin-bottom: 8px;">äº§å“æ˜ç»†ï¼š</div>
          ${quote.items.map((item, index) => `
            <div style="margin-bottom: 12px; padding: 12px; background: var(--bg); border-radius: 4px; display: grid; grid-template-columns: 60px 1fr auto; gap: 12px; align-items: start;">
              <div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                ${getProductImage(item.image || 'package')}
              </div>
              <div>
                <div style="font-weight: 600; margin-bottom: 4px;">${item.name}</div>
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">SKU: ${item.sku}</div>
                <div style="font-size: 12px; color: var(--muted);">å‹å·: ${item.model || '-'}</div>
              </div>
              <div style="text-align: right;">
                <div style="margin-bottom: 4px;">æ•°é‡: ${item.quantity} ${item.unit || 'ä¸ª'}</div>
                <div style="margin-bottom: 4px;">å•ä»·: Â¥${item.price}</div>
                <div style="font-weight: 600; color: var(--primary);">å°è®¡: Â¥${item.total}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    document.getElementById('approvalQuoteInfo').innerHTML = `
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
        <div><strong>æŠ¥ä»·ç¼–å·ï¼š</strong>${quote.id}</div>
        <div><strong>å®¢æˆ·åç§°ï¼š</strong>${quote.customer}</div>
        <div><strong>æŠ¥ä»·é‡‘é¢ï¼š</strong>Â¥${quote.amount}</div>
        <div><strong>æœ‰æ•ˆæœŸï¼š</strong>${quote.validUntil}</div>
        <div><strong>æŠ¥ä»·çŠ¶æ€ï¼š</strong><span class="badge ${quote.status === 'å·²æ‰¹å‡†' ? 'success' : 'warning'}">${quote.status}</span></div>
        <div><strong>ä¸šåŠ¡å‘˜ï¼š</strong>${quote.salesperson}</div>
        <div style="grid-column: span 2;"><strong>åˆ›å»ºæ—¥æœŸï¼š</strong>${quote.createDate}</div>
      </div>
      ${itemsHtml}
      ${quote.remark ? `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);"><strong>å¤‡æ³¨ï¼š</strong>${quote.remark}</div>` : ''}
    `;
    
    modal.classList.remove('hidden');
    modal.style.display = '';
  }
}

function closeQuoteApprovalModal() {
  const modal = document.getElementById('quoteApprovalModal');
  if (modal) {
    modal.classList.add('hidden');
    modal.style.display = 'none';
  }
}

function toggleApprovalRemark() {
  const approvalResult = document.getElementById('approvalResult').value;
  const approvalRow = document.getElementById('approvalRemarkRow');
  
  if (approvalResult === 'å·²æ‹’ç»') {
    approvalRow.style.display = 'flex';
  } else {
    approvalRow.style.display = 'none';
  }
}

function viewQuoteDetail(quoteId) {
  const quote = data.salesQuotes.find(q => q.id === quoteId);
  if (quote) {
    const side = $('#sideDetail');
    side.classList.remove('hidden');
    $('#detailTitle').textContent = 'æŠ¥ä»·è¯¦æƒ…';
    
    const statusClass = quote.status === 'å·²æ‰¹å‡†' ? 'success' : quote.status === 'å·²æ‹’ç»' ? 'danger' : quote.status === 'å·²è¿‡æœŸ' ? 'warning' : 'info';
    
    // æ„å»ºäº§å“æ˜ç»†HTML
    let itemsHtml = '';
    if (quote.items && quote.items.length > 0) {
      itemsHtml = `
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
          <div style="font-weight: 600; margin-bottom: 8px;">äº§å“æ˜ç»†ï¼š</div>
          ${quote.items.map((item, index) => `
            <div style="margin-bottom: 12px; padding: 12px; background: var(--bg); border-radius: 4px; display: grid; grid-template-columns: 60px 1fr auto; gap: 12px; align-items: start;">
              <div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                ${getProductImage(item.image || 'package')}
              </div>
              <div>
                <div style="font-weight: 600; margin-bottom: 4px;">${item.name}</div>
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">SKU: ${item.sku}</div>
                <div style="font-size: 12px; color: var(--muted);">å‹å·: ${item.model || '-'}</div>
              </div>
              <div style="text-align: right;">
                <div style="margin-bottom: 4px;">æ•°é‡: ${item.quantity} ${item.unit || 'ä¸ª'}</div>
                <div style="margin-bottom: 4px;">å•ä»·: Â¥${item.price}</div>
                <div style="font-weight: 600; color: var(--primary);">å°è®¡: Â¥${item.total}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    $('#detailBody').innerHTML = `
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
        <div><strong>æŠ¥ä»·ç¼–å·ï¼š</strong>${quote.id}</div>
        <div><strong>å®¢æˆ·åç§°ï¼š</strong>${quote.customer}</div>
        <div><strong>æŠ¥ä»·é‡‘é¢ï¼š</strong>Â¥${quote.amount}</div>
        <div><strong>æœ‰æ•ˆæœŸï¼š</strong>${quote.validUntil}</div>
        <div><strong>æŠ¥ä»·çŠ¶æ€ï¼š</strong><span class="badge ${statusClass}">${quote.status}</span></div>
        <div><strong>ä¸šåŠ¡å‘˜ï¼š</strong>${quote.salesperson}</div>
        <div style="grid-column: span 2;"><strong>åˆ›å»ºæ—¥æœŸï¼š</strong>${quote.createDate}</div>
      </div>
      
      ${quote.remark ? `<div style="margin-bottom: 12px;"><strong>æŠ¥ä»·å¤‡æ³¨ï¼š</strong>${quote.remark}</div>` : ''}
      
      ${itemsHtml}
      
      ${quote.approvalPerson ? `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
        <div style="font-weight: 600; margin-bottom: 8px;">å®¡æ‰¹ä¿¡æ¯ï¼š</div>
        <div><strong>å®¡æ‰¹äººï¼š</strong>${quote.approvalPerson}</div>
        <div><strong>å®¡æ‰¹æ—¶é—´ï¼š</strong>${new Date(quote.approvalTime).toLocaleString()}</div>
        ${quote.approvalRemark ? `<div><strong>å®¡æ‰¹æ„è§ï¼š</strong>${quote.approvalRemark}</div>` : ''}
      </div>` : ''}
      
      <div style="margin-top: 8px; font-size: 12px; color: var(--muted);">
        åˆ›å»ºæ—¶é—´ï¼š${new Date(quote.createTime).toLocaleString()}
      </div>
    `;
  }
}

function approveQuote(quoteId) {
  openQuoteApprovalModal(quoteId);
}

function loadQuoteCustomers() {
  const customerSelect = document.getElementById('quoteCustomer');
  customerSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å®¢æˆ·</option>';
  
  if (data.customers) {
    data.customers.forEach(customer => {
      const option = document.createElement('option');
      option.value = customer.name;
      option.textContent = customer.name;
      customerSelect.appendChild(option);
    });
  }
}

function loadQuoteProducts() {
  const productList = document.getElementById('quoteProductList');
  productList.innerHTML = '';
  
  data.products.forEach(product => {
    const productDiv = document.createElement('div');
    productDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px; cursor: pointer;';
    productDiv.innerHTML = `
      <input type="checkbox" value="${product.sku}" style="margin: 0;">
      <div style="flex: 1;">
        <div style="font-weight: 500;">${product.sku}</div>
        <div style="font-size: 14px; color: var(--muted);">${product.name}</div>
        <div style="font-size: 14px;">åº“å­˜: ${product.stock}</div>
      </div>
      <div style="text-align: right;">
        <div style="font-weight: 600; color: var(--primary);">Â¥${product.price || 0}</div>
      </div>
    `;
    productList.appendChild(productDiv);
  });
}

function searchQuoteProducts() {
  const searchTerm = document.getElementById('quoteProductSearch').value.toLowerCase();
  const productItems = document.querySelectorAll('#quoteProductList > div');
  
  productItems.forEach(item => {
    const text = item.textContent.toLowerCase();
    if (text.includes(searchTerm)) {
      item.style.display = 'flex';
    } else {
      item.style.display = 'none';
    }
  });
}

function addSelectedQuoteProducts() {
  const selectedProducts = document.querySelectorAll('#quoteProductList input[type="checkbox"]:checked');
  const quoteItemsContainer = document.getElementById('quoteItems');
  
  if (selectedProducts.length === 0) {
    showToast('è¯·å…ˆé€‰æ‹©è¦æ·»åŠ çš„äº§å“', 'warning');
    return;
  }
  
  selectedProducts.forEach(checkbox => {
    const sku = checkbox.value;
    const product = data.products.find(p => p.sku === sku);
    
    if (product && !document.querySelector(`#quoteItems [data-sku="${sku}"]`)) {
      const itemDiv = document.createElement('div');
      itemDiv.dataset.sku = sku;
      itemDiv.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 12px; align-items: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px;';
      itemDiv.innerHTML = `
        <div>
          <div style="font-weight: 500;">${product.name}</div>
          <div style="font-size: 12px; color: var(--muted);">SKU: ${product.sku}</div>
        </div>
        <div>
          <input type="number" placeholder="æ•°é‡" min="1" value="1" style="width: 80px; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px;" onchange="calculateQuoteTotal()">
        </div>
        <div>
          <input type="number" placeholder="å•ä»·" min="0" step="0.01" value="${product.price || 0}" style="width: 100px; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px;" onchange="calculateQuoteTotal()">
        </div>
        <div style="font-weight: 600; color: var(--primary);" class="quote-item-total">Â¥${product.price || 0}</div>
        <button type="button" onclick="removeQuoteItem('${sku}')" style="padding: 6px 12px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;">åˆ é™¤</button>
      `;
      quoteItemsContainer.appendChild(itemDiv);
    }
  });
  
  calculateQuoteTotal();
  closeQuoteProductSelectModal();
}

function removeQuoteItem(sku) {
  const item = document.querySelector(`#quoteItems [data-sku="${sku}"]`);
  if (item) {
    item.remove();
    calculateQuoteTotal();
  }
}

function calculateQuoteTotal() {
  const quoteItems = document.querySelectorAll('#quoteItems > div');
  let total = 0;
  
  quoteItems.forEach(item => {
    const quantityInput = item.querySelector('input[type="number"]:nth-of-type(1)');
    const priceInput = item.querySelector('input[type="number"]:nth-of-type(2)');
    
    if (!quantityInput || !priceInput) return;
    
    const quantity = parseInt(quantityInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    const itemTotal = quantity * price;
    
    const totalElement = item.querySelector('.quote-item-total');
    if (totalElement) {
      totalElement.textContent = `Â¥${itemTotal.toFixed(2)}`;
    }
    
    total += itemTotal;
  });
  
  document.getElementById('quoteTotalAmount').textContent = `Â¥${total.toFixed(2)}`;
}


function submitQuoteForApproval() {
  const quoteData = collectQuoteData();
  if (!quoteData) return;
  
  quoteData.status = 'å¾…å®¡æ‰¹';
  quoteData.createTime = new Date().toISOString();
  
  if (!data.salesQuotes) data.salesQuotes = [];
  data.salesQuotes.push(quoteData);
  
    
  closeSalesQuoteCreateModal();
  renderSalesQuotes();
  showToast('æŠ¥ä»·å·²æäº¤å®¡æ‰¹', 'success');
}


function collectQuoteData() {
  const quoteNo = document.getElementById('quoteNo').value;
  const customer = document.getElementById('quoteCustomer').value;
  const validUntil = document.getElementById('quoteValidUntil').value;
  const salesperson = document.getElementById('quoteSalesperson').value;
  const status = document.getElementById('quoteStatus').value;
  const remark = document.getElementById('quoteRemark').value;
  
  if (!customer) {
    showToast('è¯·é€‰æ‹©å®¢æˆ·', 'error');
    return null;
  }
  
  if (!validUntil) {
    showToast('è¯·é€‰æ‹©æŠ¥ä»·æœ‰æ•ˆæœŸ', 'error');
    return null;
  }
  
  const quoteItems = document.querySelectorAll('#quoteItems > div');
  if (quoteItems.length === 0) {
    showToast('è¯·æ·»åŠ æŠ¥ä»·äº§å“', 'error');
    return null;
  }
  
  const items = [];
  let totalAmount = 0;
  
  quoteItems.forEach(item => {
    const sku = item.dataset.sku;
    const product = data.products.find(p => p.sku === sku);
    const quantityInput = item.querySelector('input[type="number"]:nth-of-type(1)');
    const priceInput = item.querySelector('input[type="number"]:nth-of-type(2)');
    
    if (!quantityInput || !priceInput) return;
    
    const quantity = parseInt(quantityInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    const itemTotal = quantity * price;
    
    items.push({
      sku: sku,
      name: product.name,
      model: product.model || '',
      image: product.image || '',
      unit: product.unit || 'ä¸ª',
      quantity: quantity,
      price: price,
      total: itemTotal
    });
    
    totalAmount += itemTotal;
  });
  
  return {
    id: quoteNo,
    customer: customer,
    amount: totalAmount,
    validUntil: validUntil,
    salesperson: salesperson,
    status: status,
    remark: remark,
    items: items,
    createDate: new Date().toISOString().split('T')[0]
  };
}

function saveQuoteApproval() {
  const approvalResult = document.getElementById('approvalResult').value;
  const approvalRemark = document.getElementById('approvalRemark').value;
  const approvalPerson = document.getElementById('approvalPerson').value;
  
  if (!approvalResult) {
    showToast('è¯·é€‰æ‹©å®¡æ‰¹ç»“æœ', 'error');
    return;
  }
  
  if (approvalResult === 'å·²æ‹’ç»' && !approvalRemark.trim()) {
    showToast('è¯·è¾“å…¥å®¡æ‰¹æ„è§', 'error');
    return;
  }
  
  // è·å–å½“å‰å®¡æ‰¹çš„æŠ¥ä»·ï¼ˆé€šè¿‡éšè—å­—æ®µå­˜å‚¨æŠ¥ä»·IDï¼‰
  const quoteId = document.getElementById('quoteApprovalModal').dataset.quoteId;
  const quote = data.salesQuotes.find(q => q.id === quoteId);
  
  if (quote) {
    quote.status = approvalResult;
    quote.approvalPerson = approvalPerson;
    quote.approvalRemark = approvalRemark;
    quote.approvalTime = new Date().toISOString();
    
    closeQuoteApprovalModal();
    renderSalesQuotes();
    showToast('å®¡æ‰¹å®Œæˆ', 'success');
  }
}

function printDeliveryList() {
  showToast('æ‰“å°å‘è´§å•åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function viewDeliveryDetail(batchNo) {
  const delivery = data.deliveries.find(d => d.batchNo === batchNo);
  if (delivery) {
    showToast(`æŸ¥çœ‹å‘è´§å•ï¼š${delivery.batchNo}`, 'info');
  }
}

function printDelivery(batchNo) {
  showToast(`æ‰“å°å‘è´§å•åŠŸèƒ½å¼€å‘ä¸­... æ‰¹æ¬¡å·: ${batchNo}`, 'info');
}

function openCreateReturn() {
  showToast('æ–°å»ºé€€è´§å•åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function viewReturnDetail(returnId) {
  const returnOrder = data.returns.find(r => r.id === returnId);
  if (returnOrder) {
    showToast(`æŸ¥çœ‹é€€è´§å•ï¼š${returnOrder.customer}`, 'info');
  }
}

function processReturn(returnId) {
  showToast(`å¤„ç†é€€è´§åŠŸèƒ½å¼€å‘ä¸­... ID: ${returnId}`, 'info');
}

function openCreateInvoice() {
  showToast('ç”³è¯·å‘ç¥¨åŠŸèƒ½å¼€å‘ä¸­...', 'info');
}

function viewInvoiceDetail(invoiceId) {
  const invoice = data.invoices.find(i => i.id === invoiceId);
  if (invoice) {
    showToast(`æŸ¥çœ‹å‘ç¥¨ç”³è¯·ï¼š${invoice.customer}`, 'info');
  }
}

function approveInvoice(invoiceId) {
  showToast(`å®¡æ‰¹å‘ç¥¨åŠŸèƒ½å¼€å‘ä¸­... ID: ${invoiceId}`, 'info');
}

function createMockSale(){
  const id = 'SO' + (Math.floor(Math.random()*900000)+100000);
  data.sales.unshift({id, customer:'MKD-NEW', items:1, total: (Math.random()*100).toFixed(2), status:'å¾…å‘è´§'});
  // ä¸åšåº“å­˜å ç”¨é€»è¾‘ï¼Œä»…ç¤ºæ„
  renderAll();
}

/* å¯¼å‡ºç¤ºä¾‹ï¼ˆæ¨¡æ‹Ÿï¼‰*/
function exportMock(){ alert('å¯¼å‡ºå·²è§¦å‘ï¼ˆæ¨¡æ‹Ÿï¼‰'); }

function switchUser(){
  const userSwitch = document.getElementById('userSwitch');
  const currentUserDisplay = document.getElementById('currentUserDisplay');
  const currentUserRole = document.getElementById('currentUserRole');
  if (userSwitch && currentUserDisplay && currentUserRole) {
    currentUser = userSwitch.value;
    currentUserDisplay.textContent = currentUser;
    currentUserRole.textContent = `(${userRoles[currentUser].role})`;
    renderAll();
    showToast(`å·²åˆ‡æ¢åˆ°ï¼š${currentUser} (${userRoles[currentUser].role})`, 'info');
  }
}

// ===== æ–°å¢æ¨¡æ€æ¡†åŠŸèƒ½å‡½æ•° =====

// ä¾›åº”å•†ç¡®è®¤è®°å½•åŠŸèƒ½
let currentSupplierContactOrderId = null;

function recordSupplierContact(orderId) {
  currentSupplierContactOrderId = orderId;
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) return;
  
  const modal = document.getElementById('supplierContactModal');
  if (modal) {
    // è®¾ç½®é»˜è®¤å€¼
    document.getElementById('confirmDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('responsiblePerson').value = currentUser;
    
    modal.classList.remove('hidden');
    modal.style.display = '';
  }
}

function closeSupplierContactModal() {
  const modal = document.getElementById('supplierContactModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
    currentSupplierContactOrderId = null;
  }
}

function saveSupplierContact() {
  const orderId = currentSupplierContactOrderId;
  if (!orderId) return;
  
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) return;
  
  const confirmMethod = document.getElementById('confirmMethod')?.value;
  const confirmDate = document.getElementById('confirmDate')?.value;
  const supplierContact = document.getElementById('supplierContact')?.value;
  const contactInfo = document.getElementById('contactInfo')?.value;
  const confirmResult = document.getElementById('confirmResult')?.value;
  const replyTime = document.getElementById('replyTime')?.value;
  const contactNotes = document.getElementById('contactNotes')?.value;
  const followUpTime = document.getElementById('followUpTime')?.value;
  const responsiblePerson = document.getElementById('responsiblePerson')?.value;
  
  // éªŒè¯å¿…å¡«å­—æ®µ
  if (!confirmMethod || !confirmDate || !supplierContact || !confirmResult) {
    showToast('è¯·å¡«å†™å®Œæ•´çš„ç¡®è®¤ä¿¡æ¯', 'error');
    return;
  }
  
  // åˆ›å»ºç¡®è®¤è®°å½•
  const contactRecord = {
    method: confirmMethod,
    date: confirmDate,
    contact: supplierContact,
    contactInfo: contactInfo,
    result: confirmResult,
    replyTime: replyTime,
    notes: contactNotes,
    followUpTime: followUpTime,
    responsiblePerson: responsiblePerson,
    recordTime: new Date().toLocaleString()
  };
  
  // ä¿å­˜åˆ°è®¢å•ä¸­
  if (!order.supplierContacts) {
    order.supplierContacts = [];
  }
  order.supplierContacts.push(contactRecord);
  
  // æ›´æ–°è®¢å•çŠ¶æ€
  if (confirmResult === 'ç¡®è®¤æ¥å•') {
    order.status = 'ä¾›åº”å•†å·²ç¡®è®¤';
  } else if (confirmResult === 'éœ€è¦ä¿®æ”¹') {
    order.status = 'å¾…ä¿®æ”¹';
  }
  
  // æ›´æ–°ä¾›åº”å•†å¤‡æ³¨
  if (contactNotes) {
    order.supplierNotes = contactNotes;
  }
  
  showToast('ä¾›åº”å•†ç¡®è®¤è®°å½•å·²ä¿å­˜', 'success');
  closeSupplierContactModal();
  renderPurchaseOrders();
}

// é‡‡è´­è®¢å•ç¼–è¾‘åŠŸèƒ½
let currentEditingOrderId = null;

function editPurchaseOrder(orderId) {
  currentEditingOrderId = orderId;
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) return;
  
  const modal = document.getElementById('purchaseOrderEditModal');
  if (modal) {
    // å¡«å……è®¢å•ä¿¡æ¯
    document.getElementById('editOrderId').value = order.id;
    document.getElementById('editOrderStatus').value = order.status;
    document.getElementById('editSupplier').value = order.supplier;
    document.getElementById('editPurchaser').value = order.purchaser || '';
    document.getElementById('editExpectedDate').value = order.expectedDate || '';
    document.getElementById('editActualDate').value = order.actualDate || '';
    document.getElementById('editSupplierNotes').value = order.supplierNotes || '';
    
    modal.classList.remove('hidden');
    modal.style.display = '';
  }
}

function closePurchaseOrderEditModal() {
  const modal = document.getElementById('purchaseOrderEditModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
    currentEditingOrderId = null;
  }
}

function savePurchaseOrderEdit() {
  const orderId = currentEditingOrderId;
  if (!orderId) return;
  
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) return;
  
  const status = document.getElementById('editOrderStatus')?.value;
  const purchaser = document.getElementById('editPurchaser')?.value;
  const expectedDate = document.getElementById('editExpectedDate')?.value;
  const actualDate = document.getElementById('editActualDate')?.value;
  const supplierNotes = document.getElementById('editSupplierNotes')?.value;
  
  // æ›´æ–°è®¢å•ä¿¡æ¯
  order.status = status;
  if (purchaser) order.purchaser = purchaser;
  if (expectedDate) order.expectedDate = expectedDate;
  if (actualDate) order.actualDate = actualDate;
  if (supplierNotes) order.supplierNotes = supplierNotes;
  
  showToast('é‡‡è´­è®¢å•ä¿¡æ¯å·²æ›´æ–°', 'success');
  closePurchaseOrderEditModal();
  renderPurchaseOrdersList();
}

// åˆåŒä¸Šä¼ åŠŸèƒ½
let currentContractOrderId = null;

function uploadSignedContract(orderId) {
  currentContractOrderId = orderId;
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) return;
  
  const modal = document.getElementById('signedContractModal');
  if (modal) {
    // å¡«å……è®¢å•ä¿¡æ¯
    document.getElementById('contractOrderId').textContent = order.id;
    document.getElementById('contractSupplier').textContent = order.supplier;
    document.getElementById('contractAmount').textContent = `Â¥${order.total.toFixed(2)}`;
    
    // å¦‚æœå·²æœ‰åˆåŒï¼Œæ˜¾ç¤ºåˆ—è¡¨
    if (order.signedContracts && order.signedContracts.length > 0) {
      document.getElementById('uploadedContractsSection').style.display = 'block';
      let contractsHtml = '';
      order.signedContracts.forEach((contract, index) => {
        contractsHtml += `
          <div style="background: var(--hover-bg); padding: 12px; border-radius: 6px; margin-bottom: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div><strong>æ–‡ä»¶ï¼š</strong>${contract.name}</div>
                <div><strong>ä¸Šä¼ æ—¶é—´ï¼š</strong>${contract.uploadTime}</div>
                <div><strong>ä¸Šä¼ äººï¼š</strong>${contract.uploadedBy}</div>
                ${contract.description ? `<div><strong>è¯´æ˜ï¼š</strong>${contract.description}</div>` : ''}
              </div>
              <div>
                <button class="btn ghost" onclick="previewContract('${order.id}', ${index})">é¢„è§ˆ</button>
                <button class="btn ghost" onclick="downloadContract('${order.id}', ${index})">ä¸‹è½½</button>
                <button class="btn ghost" onclick="deleteContract('${order.id}', ${index})">åˆ é™¤</button>
              </div>
            </div>
          </div>
        `;
      });
      document.getElementById('uploadedContractsList').innerHTML = contractsHtml;
    } else {
      document.getElementById('uploadedContractsSection').style.display = 'none';
    }
    
    modal.classList.remove('hidden');
    modal.style.display = '';
  }
}

function closeSignedContractModal() {
  const modal = document.getElementById('signedContractModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
    currentContractOrderId = null;
  }
}

// ä¾›åº”å•†æ²Ÿé€šè®°å½•ç›¸å…³å˜é‡
let currentCommunicationOrderId = null;

function viewFullCommunicationNotes(orderId) {
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) return;
  
  currentCommunicationOrderId = orderId;
  
  const modal = document.getElementById('communicationModal');
  const content = document.getElementById('communicationContent');
  
  if (!modal || !content) return;
  
  content.innerHTML = `
    <div style="margin-bottom: 20px;">
      <h4 style="margin: 0 0 12px 0; color: var(--text);">è®¢å•ä¿¡æ¯</h4>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
        <div><strong>è®¢å•ç¼–å·ï¼š</strong>${order.id}</div>
        <div><strong>ä¾›åº”å•†ï¼š</strong>${order.supplier}</div>
        <div><strong>é‡‡è´­å‘˜ï¼š</strong>${order.purchaser}</div>
        <div><strong>è®¢å•çŠ¶æ€ï¼š</strong>${order.status}</div>
      </div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <h4 style="margin: 0 0 12px 0; color: var(--text);">è”ç³»ä¿¡æ¯</h4>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
        <div><strong>è”ç³»äººï¼š</strong>${order.supplierContact || 'æœªè®°å½•'}</div>
        <div><strong>æœ€åè”ç³»æ—¥æœŸï¼š</strong>${order.supplierContactDate || 'æœªè®°å½•'}</div>
      </div>
    </div>
    
    <div>
      <h4 style="margin: 0 0 12px 0; color: var(--text);">æ²Ÿé€šè®°å½•</h4>
      ${order.supplierNotes ? 
        `<div style="background: var(--hover-bg); border-radius: 6px; padding: 16px; max-height: 400px; overflow-y: auto; line-height: 1.6; font-size: 14px; white-space: pre-wrap;">
          ${order.supplierNotes}
        </div>` :
        `<div style="text-align: center; padding: 40px; color: var(--muted); font-style: italic;">
          æš‚æ— æ²Ÿé€šè®°å½•
        </div>`
      }
    </div>
  `;
  
  modal.classList.remove('hidden');
  modal.style.display = 'flex';
}

function closeCommunicationModal() {
  const modal = document.getElementById('communicationModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
    currentCommunicationOrderId = null;
  }
}

function addCommunicationNote(orderId) {
  const note = prompt('è¯·è¾“å…¥æ–°çš„æ²Ÿé€šè®°å½•ï¼š');
  if (note === null) return;
  
  if (!note.trim()) {
    showToast('æ²Ÿé€šè®°å½•ä¸èƒ½ä¸ºç©º', 'error');
    return;
  }
  
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) return;
  
  const timestamp = new Date().toLocaleString('zh-CN');
  const newNote = `\n\n--- ${timestamp} ---\n${note.trim()}`;
  
  if (!order.supplierNotes) {
    order.supplierNotes = '';
  }
  
  order.supplierNotes += newNote;
  
  // æ›´æ–°è”ç³»æ—¥æœŸ
  order.supplierContactDate = new Date().toISOString().split('T')[0];
  
  showToast('æ²Ÿé€šè®°å½•å·²æ·»åŠ ', 'success');
  
  // å¦‚æœæ²Ÿé€šè®°å½•æ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„ï¼Œåˆ·æ–°å†…å®¹
  if (currentCommunicationOrderId === orderId) {
    viewFullCommunicationNotes(orderId);
  }
  
  // åˆ·æ–°é‡‡è´­è®¢å•è¯¦æƒ…
  if (window.currentViewingOrderId === orderId) {
    openPurchaseOrderDetail(orderId);
  }
}

function addNewCommunicationNote() {
  if (currentCommunicationOrderId) {
    addCommunicationNote(currentCommunicationOrderId);
  }
}

function downloadSignedContract(orderId) {
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order || !order.signedContract) {
    showToast('åˆåŒæ–‡ä»¶ä¸å­˜åœ¨', 'error');
    return;
  }
  
  showToast(`æ­£åœ¨ä¸‹è½½åˆåŒæ–‡ä»¶ï¼š${order.signedContract.fileName}`, 'info');
  // è¿™é‡Œåº”è¯¥å®ç°å®é™…çš„ä¸‹è½½é€»è¾‘
}

// æ–‡ä»¶é€‰æ‹©å¤„ç†
document.addEventListener('DOMContentLoaded', function() {
  const contractFileInput = document.getElementById('contractFile');
  if (contractFileInput) {
    contractFileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        // ç®€å•çš„æ–‡ä»¶éªŒè¯
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
          showToast('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB', 'error');
          e.target.value = '';
          return;
        }
      }
    });
  }
});

// ä¸Šä¼ ç›–ç« åˆåŒ
function uploadSignedContract() {
  const orderId = currentContractOrderId;
  if (!orderId) return;
  
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) return;
  
  const fileInput = document.getElementById('contractFile');
  const file = fileInput?.files[0];
  
  if (!file) {
    showToast('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶', 'error');
    return;
  }
  
  const description = document.getElementById('contractDescription')?.value || '';
  
  // åˆ›å»ºåˆåŒè®°å½•
  const contractRecord = {
    name: file.name,
    type: file.type,
    size: file.size,
    description: description,
    uploadTime: new Date().toLocaleString(),
    uploadedBy: currentUser,
    url: `#` // æ¨¡æ‹Ÿæ–‡ä»¶URL
  };
  
  // ä¿å­˜åˆ°è®¢å•ä¸­
  if (!order.signedContracts) {
    order.signedContracts = [];
  }
  order.signedContracts.push(contractRecord);
  
  // æ›´æ–°è®¢å•çŠ¶æ€
  order.status = 'åˆåŒå·²ä¸Šä¼ ';
  
  showToast(`åˆåŒæ–‡ä»¶ ${file.name} ä¸Šä¼ æˆåŠŸ`, 'success');
  closeSignedContractModal();
  renderPurchaseOrders();
}

// åˆåŒé¢„è§ˆã€ä¸‹è½½ã€åˆ é™¤åŠŸèƒ½
function previewContract(orderId, contractIndex) {
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order || !order.signedContracts || !order.signedContracts[contractIndex]) return;
  
  const contract = order.signedContracts[contractIndex];
  
  // åˆ›å»ºé¢„è§ˆæ¨¡æ€æ¡†
  const modal = document.createElement('div');
  modal.className = 'modal-form';
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  `;
  
  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 90%;
    max-height: 90%;
    overflow: auto;
    position: relative;
  `;
  
  // æ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºä¸åŒé¢„è§ˆ
  let previewContent = '';
  if (contract.type.includes('pdf')) {
    previewContent = `
      <div style="text-align: center;">
        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“„</div>
        <h3>PDF æ–‡ä»¶é¢„è§ˆ</h3>
        <p style="margin: 10px 0;"><strong>æ–‡ä»¶åï¼š</strong>${contract.name}</p>
        <p style="margin: 10px 0;"><strong>å¤§å°ï¼š</strong>${(contract.size / 1024).toFixed(2)} KB</p>
        <div style="border: 2px dashed #ccc; padding: 40px; margin: 20px 0; background: #f9f9f9;">
          <p>PDF é¢„è§ˆåŒºåŸŸ</p>
          <p style="color: #666; font-size: 14px;">å®é™…åº”ç”¨ä¸­å°†æ˜¾ç¤ºPDFå†…å®¹</p>
        </div>
      </div>
    `;
  } else if (contract.type.includes('image')) {
    previewContent = `
      <div style="text-align: center;">
        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ–¼ï¸</div>
        <h3>å›¾ç‰‡æ–‡ä»¶é¢„è§ˆ</h3>
        <p style="margin: 10px 0;"><strong>æ–‡ä»¶åï¼š</strong>${contract.name}</p>
        <div style="border: 2px dashed #ccc; padding: 40px; margin: 20px 0; background: #f9f9f9;">
          <p>å›¾ç‰‡é¢„è§ˆåŒºåŸŸ</p>
          <p style="color: #666; font-size: 14px;">å®é™…åº”ç”¨ä¸­å°†æ˜¾ç¤ºå›¾ç‰‡å†…å®¹</p>
        </div>
      </div>
    `;
  } else {
    previewContent = `
      <div style="text-align: center;">
        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“‹</div>
        <h3>æ–‡æ¡£æ–‡ä»¶é¢„è§ˆ</h3>
        <p style="margin: 10px 0;"><strong>æ–‡ä»¶åï¼š</strong>${contract.name}</p>
        <p style="margin: 10px 0;"><strong>ç±»å‹ï¼š</strong>${contract.type}</p>
        <p style="margin: 10px 0;"><strong>å¤§å°ï¼š</strong>${(contract.size / 1024).toFixed(2)} KB</p>
        <div style="border: 2px dashed #ccc; padding: 40px; margin: 20px 0; background: #f9f9f9;">
          <p>æ–‡æ¡£é¢„è§ˆåŒºåŸŸ</p>
          <p style="color: #666; font-size: 14px;">æ­¤æ–‡ä»¶ç±»å‹ä¸æ”¯æŒåœ¨çº¿é¢„è§ˆ</p>
        </div>
      </div>
    `;
  }
  
  modalContent.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>æ–‡ä»¶é¢„è§ˆ</h2>
      <button onclick="this.parentElement.parentElement.parentElement.remove()" 
              style="background: none; border: none; font-size: 24px; cursor: pointer;">Ã—</button>
    </div>
    ${previewContent}
    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
      <button onclick="printContract('${orderId}', ${contractIndex})" 
              style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ–¨ï¸ æ‰“å°</button>
      <button onclick="downloadContract('${orderId}', ${contractIndex}); this.parentElement.parentElement.parentElement.remove();" 
              style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">â¬‡ï¸ ä¸‹è½½</button>
      <button onclick="this.parentElement.parentElement.parentElement.remove()" 
              style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">å…³é—­</button>
    </div>
  `;
  
  modal.appendChild(modalContent);
  document.body.appendChild(modal);
  
  // ç‚¹å‡»èƒŒæ™¯å…³é—­
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

function downloadContract(orderId, contractIndex) {
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order || !order.signedContracts || !order.signedContracts[contractIndex]) return;
  
  const contract = order.signedContracts[contractIndex];
  
  // æ¨¡æ‹Ÿä¸‹è½½è¿‡ç¨‹
  showToast(`æ­£åœ¨å‡†å¤‡ä¸‹è½½ ${contract.name}...`, 'info');
  
  setTimeout(() => {
    // åˆ›å»ºä¸‹è½½é“¾æ¥
    const link = document.createElement('a');
    link.href = contract.url || '#';
    link.download = contract.name;
    link.target = '_blank';
    
    // æ¨¡æ‹Ÿä¸‹è½½å®Œæˆ
    showToast(`${contract.name} ä¸‹è½½å®Œæˆ`, 'success');
    
    // å¦‚æœæœ‰å®é™…URLï¼Œåˆ™è§¦å‘ä¸‹è½½
    if (contract.url && contract.url !== '#') {
      link.click();
    }
  }, 1500);
}

function printContract(orderId, contractIndex) {
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order || !order.signedContracts || !order.signedContracts[contractIndex]) return;
  
  const contract = order.signedContracts[contractIndex];
  
  // åˆ›å»ºæ‰“å°çª—å£
  const printWindow = window.open('', '_blank');
  if (!printWindow) {
    showToast('è¯·å…è®¸å¼¹çª—ä»¥ä½¿ç”¨æ‰“å°åŠŸèƒ½', 'error');
    return;
  }
  
  // ç”Ÿæˆæ‰“å°å†…å®¹
  const printContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>æ‰“å°åˆåŒ - ${contract.name}</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .contract-info { margin-bottom: 20px; }
        .contract-info h1 { margin: 0; color: #333; }
        .contract-info p { margin: 5px 0; color: #666; }
        .content { min-height: 400px; border: 1px solid #ddd; padding: 20px; background: #f9f9f9; }
        .footer { text-align: center; margin-top: 30px; font-size: 12px; color: #999; }
        @media print {
          .no-print { display: none; }
        }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>åˆåŒæ–‡ä»¶</h1>
      </div>
      <div class="contract-info">
        <h1>${contract.name}</h1>
        <p><strong>è®¢å•å·ï¼š</strong>${order.id}</p>
        <p><strong>ä¾›åº”å•†ï¼š</strong>${order.supplier}</p>
        <p><strong>åˆåŒé‡‘é¢ï¼š</strong>Â¥${order.total.toFixed(2)}</p>
        <p><strong>ä¸Šä¼ æ—¶é—´ï¼š</strong>${contract.uploadTime}</p>
        <p><strong>ä¸Šä¼ äººï¼š</strong>${contract.uploadedBy}</p>
        ${contract.description ? `<p><strong>æ–‡ä»¶è¯´æ˜ï¼š</strong>${contract.description}</p>` : ''}
      </div>
      <div class="content">
        <h3>åˆåŒå†…å®¹é¢„è§ˆ</h3>
        <p style="color: #666; text-align: center; margin-top: 100px;">
          å®é™…åº”ç”¨ä¸­å°†åœ¨æ­¤å¤„æ˜¾ç¤ºå®Œæ•´çš„åˆåŒå†…å®¹
        </p>
      </div>
      <div class="footer no-print">
        <p>æ‰“å°æ—¶é—´ï¼š${new Date().toLocaleString()}</p>
        <button onclick="window.print()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 10px;">ğŸ–¨ï¸ æ‰“å°</button>
        <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 10px;">å…³é—­</button>
      </div>
      <script>
        window.onload = function() {
          setTimeout(function() {
            window.print();
          }, 500);
        };
      <\/script>
    </body>
    </html>
  `;
  
  printWindow.document.write(printContent);
  printWindow.document.close();
  
  showToast('æ‰“å°çª—å£å·²æ‰“å¼€ï¼Œè¯·ä½¿ç”¨æµè§ˆå™¨æ‰“å°åŠŸèƒ½', 'info');
}

function deleteContract(orderId, contractIndex) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆåŒæ–‡ä»¶å—ï¼Ÿ')) return;
  
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order || !order.signedContracts || !order.signedContracts[contractIndex]) return;
  
  order.signedContracts.splice(contractIndex, 1);
  
  showToast('åˆåŒæ–‡ä»¶å·²åˆ é™¤', 'success');
  uploadSignedContract(orderId); // åˆ·æ–°æ¨¡æ€æ¡†
  renderPurchaseOrders();
}

// æ”¶è´§ä¿¡æ¯ç™»è®°åŠŸèƒ½
let currentReceivingOrderId = null;

function openReceivingModal(orderId) {
  currentReceivingOrderId = orderId;
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) return;
  
  const modal = document.getElementById('receivingModal');
  if (modal) {
    // è®¾ç½®é»˜è®¤å€¼
    document.getElementById('receivingDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('receiver').value = currentUser;
    
    // ç”Ÿæˆæ”¶è´§æ˜ç»†
    let detailsHtml = `
      <table style="width:100%; border-collapse: collapse; font-size: 14px;">
        <thead>
          <tr style="background: var(--hover-bg);">
            <th style="padding: 8px; border: 1px solid var(--border-color);">SKU</th>
            <th style="padding: 8px; border: 1px solid var(--border-color);">å“å</th>
            <th style="padding: 8px; border: 1px solid var(--border-color);">åº”æ”¶æ•°é‡</th>
            <th style="padding: 8px; border: 1px solid var(--border-color);">å®æ”¶æ•°é‡</th>
            <th style="padding: 8px; border: 1px solid var(--border-color);">è´¨é‡çŠ¶æ€</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    order.lines.forEach(line => {
      const product = data.products.find(p => p.sku === line.sku);
      detailsHtml += `
        <tr>
          <td style="padding: 8px; border: 1px solid var(--border-color);">${line.sku}</td>
          <td style="padding: 8px; border: 1px solid var(--border-color);">${product ? product.name : line.sku}</td>
          <td style="padding: 8px; border: 1px solid var(--border-color);">${line.qty}</td>
          <td style="padding: 8px; border: 1px solid var(--border-color);">
            <input type="number" id="receivedQty_${line.sku}" value="${line.qty}" min="0" 
                   style="width: 80px; padding: 4px; border: 1px solid var(--border-color); border-radius: 4px;" />
          </td>
          <td style="padding: 8px; border: 1px solid var(--border-color);">
            <select id="quality_${line.sku}" style="width: 100px; padding: 4px; border: 1px solid var(--border-color); border-radius: 4px;">
              <option value="æ­£å¸¸">æ­£å¸¸</option>
              <option value="è½»å¾®ç‘•ç–µ">è½»å¾®ç‘•ç–µ</option>
              <option value="è´¨é‡é—®é¢˜">è´¨é‡é—®é¢˜</option>
            </select>
          </td>
        </tr>
      `;
    });
    
    detailsHtml += '</tbody></table>';
    document.getElementById('receivingDetails').innerHTML = detailsHtml;
    
    modal.classList.remove('hidden');
    modal.style.display = '';
  }
}

function closeReceivingModal() {
  const modal = document.getElementById('receivingModal');
  if (modal) {
    modal.classList.add('hidden');
      modal.style.display = 'none';
    currentReceivingOrderId = null;
  }
}

// ä¿å­˜æ”¶è´§ä¿¡æ¯
function saveReceiving() {
  const orderId = currentReceivingOrderId;
  if (!orderId) return;
  
  const order = data.purchaseOrders.find(o => o.id === orderId);
  if (!order) return;
  
  const receivingDate = document.getElementById('receivingDate')?.value;
  const receivingStatus = document.getElementById('receivingStatus')?.value;
  const receivingNotes = document.getElementById('receivingNotes')?.value;
  const hasQualityIssues = document.getElementById('hasQualityIssues')?.checked;
  const supplierDeliverySlipChecked = document.getElementById('supplierDeliverySlipCheck')?.checked;
  
  // æ”¶é›†æ”¶è´§æ˜ç»†
  const receivingDetails = order.lines.map(line => {
    const receivedQty = parseInt(document.getElementById(`receivedQty_${line.sku}`)?.value) || line.qty;
    const quality = document.getElementById(`quality_${line.sku}`)?.value || 'æ­£å¸¸';
    
    return {
      sku: line.sku,
      expectedQty: line.qty,
      receivedQty: receivedQty,
      quality: quality,
      discrepancy: receivedQty - line.qty
    };
  });
  
  // éªŒè¯å¿…å¡«å­—æ®µ
  if (!receivingDate || !receivingStatus) {
    showToast('è¯·å¡«å†™å®Œæ•´çš„æ”¶è´§ä¿¡æ¯', 'error');
    return;
  }
  
  // åˆ›å»ºæ”¶è´§è®°å½•
  const receivingRecord = {
    date: receivingDate,
    status: receivingStatus,
    notes: receivingNotes,
    hasQualityIssues: hasQualityIssues,
    supplierDeliverySlipChecked: supplierDeliverySlipChecked,
    details: receivingDetails,
    receiver: currentUser,
    recordTime: new Date().toLocaleString()
  };
  
  // ä¿å­˜åˆ°è®¢å•ä¸­
  if (!order.receivingRecords) {
    order.receivingRecords = [];
  }
  order.receivingRecords.push(receivingRecord);
  
  // æ›´æ–°è®¢å•çŠ¶æ€
  if (receivingStatus === 'å…¨éƒ¨æ”¶é½') {
    order.status = 'å·²æ”¶è´§';
    
    // æ›´æ–°åº“å­˜
    receivingDetails.forEach(detail => {
      const product = data.products.find(p => p.sku === detail.sku);
      if (product) {
        product.stock += detail.receivedQty;
      }
    });
  } else if (receivingStatus === 'éƒ¨åˆ†æ”¶è´§') {
    order.status = 'éƒ¨åˆ†æ”¶è´§';
  }
  
  showToast('æ”¶è´§ä¿¡æ¯å·²ä¿å­˜', 'success');
  closeReceivingModal();
  renderPurchaseOrders();
  renderAll(); // æ›´æ–°åº“å­˜æ˜¾ç¤º
}

// ===== æ–°å¢æ¨¡æ€æ¡†åŠŸèƒ½å‡½æ•°ç»“æŸ =====

/* ç»Ÿä¸€æ¸²æŸ“ */
function renderAll(){
  renderStats(); renderPOs(); renderProducts(); renderInventory(); renderSales(); renderSuppliers(); renderPurchaseOrders();
}

/* åˆå§‹åŒ–å˜é‡ï¼Œç¡®ä¿è¿‡æ»¤æ­£å¸¸å·¥ä½œ */
currentProductType = 'all';
currentCategory = 'all';

/* åˆå§‹æ¸²æŸ“ & è§†å›¾è®¾ç½® */
renderAll();
showView('dashboard');

// åˆå§‹åŒ–æ¨¡æ€æ¡†äº‹ä»¶å¤„ç†
document.addEventListener('DOMContentLoaded', function() {
  initializeModalHandlers();
  
  // ç¡®ä¿å…¥åº“ç®¡ç†æ¨¡æ€æ¡†åˆå§‹çŠ¶æ€ä¸ºéšè—
  const inboundModal = document.getElementById('warehouseInboundModal');
  if (inboundModal) {
    inboundModal.classList.add('hidden');
    inboundModal.style.display = 'none';
  }
  
  // åˆå§‹åŒ–å½“å‰ç”¨æˆ·æ˜¾ç¤º
  const currentUserDisplay = document.getElementById('currentUserDisplay');
  const currentUserRole = document.getElementById('currentUserRole');
  if (currentUserDisplay) {
    currentUserDisplay.textContent = currentUser;
  }
  if (currentUserRole) {
    currentUserRole.textContent = `(${userRoles[currentUser].role})`;
  }
});


/* ç§»é™¤å¿«é€Ÿåˆ›å»ºæŒ‰é’®ç»‘å®š */

</script>

<!-- é”€å”®è®¢å•åˆ›å»ºæ¨¡æ€æ¡† -->
<div id="salesOrderCreateModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“‹ æ–°å»ºé”€å”®è®¢å•</div>
    <button class="modal-close" onclick="closeSalesOrderCreateModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">åˆ›å»ºæ–°çš„é”€å”®è®¢å•ï¼Œè¯·å¡«å†™å®Œæ•´çš„è®¢å•ä¿¡æ¯</div>
    
    <form id="salesOrderCreateForm" onsubmit="saveSalesOrder(event)">
      <!-- è®¢å•åŸºæœ¬ä¿¡æ¯ -->
      <div class="form-section">
        <div class="section-title">è®¢å•åŸºæœ¬ä¿¡æ¯</div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          <div>
            <label>è®¢å•ç¼–å· <span style="color: var(--danger);">*</span></label>
            <input type="text" id="salesOrderNo" required placeholder="ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ" readonly style="background: var(--bg);">
          </div>
          <div>
            <label>è®¢å•ç±»å‹ <span style="color: var(--danger);">*</span></label>
            <select id="salesOrderType" required onchange="handleOrderTypeChange()">
              <option value="">è¯·é€‰æ‹©è®¢å•ç±»å‹</option>
              <option value="1688">1688ä¸šåŠ¡</option>
              <option value="offline">çº¿ä¸‹åˆä½œ</option>
            </select>
          </div>
          <div>
            <label>é”€å”®æ—¥æœŸ <span style="color: var(--danger);">*</span></label>
            <input type="date" id="salesOrderDate" required>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px;">
          <div>
            <label>ä»˜æ¬¾æ–¹å¼ <span style="color: var(--danger);">*</span></label>
            <select id="salesPaymentMethod" required>
              <option value="">è¯·é€‰æ‹©ä»˜æ¬¾æ–¹å¼</option>
              <option value="æ”¯ä»˜å®">æ”¯ä»˜å®</option>
              <option value="å¾®ä¿¡">å¾®ä¿¡</option>
              <option value="é“¶è¡Œå¡">é“¶è¡Œå¡</option>
              <option value="å¯¹å…¬æ”¶æ¬¾">å¯¹å…¬æ”¶æ¬¾</option>
            </select>
          </div>
          <div>
            <label>ä»˜æ¬¾çŠ¶æ€ <span style="color: var(--danger);">*</span></label>
            <select id="salesPaymentStatus" required>
              <option value="å·²æ”¶">å·²æ”¶</option>
              <option value="æœªæ”¶">æœªæ”¶</option>
            </select>
          </div>
          <div>
            <label>äº¤è´§æ—¥æœŸ <span style="color: var(--danger);">*</span></label>
            <input type="date" id="salesDeliveryDate" required>
          </div>
        </div>
      </div>

      <!-- å®¢æˆ·ä¿¡æ¯ -->
      <div class="form-section">
        <div class="section-title">å®¢æˆ·ä¿¡æ¯</div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          <div>
            <label>å®¢æˆ·åç§° <span style="color: var(--danger);">*</span></label>
            <div style="display: flex; gap: 8px;">
              <select id="salesCustomer" required onchange="handleCustomerChange()" style="flex: 1;">
                <option value="">è¯·é€‰æ‹©å®¢æˆ·</option>
                <option value="new">ğŸ“ æ–°å¢å®¢æˆ·</option>
              </select>
              <button type="button" onclick="toggleCustomerInput()" style="padding: 8px 12px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;" title="æ‰‹åŠ¨è¾“å…¥å®¢æˆ·ä¿¡æ¯">
                âœï¸
              </button>
            </div>
            <input type="text" id="salesCustomerInput" placeholder="æˆ–ç›´æ¥è¾“å…¥å®¢æˆ·åç§°" style="display: none; margin-top: 8px; width: 100%;" oninput="handleCustomerInput()">
          </div>
          <div>
            <label>è”ç³»äºº</label>
            <input type="text" id="salesContact" readonly placeholder="è‡ªåŠ¨å¡«å……">
          </div>
          <div>
            <label>è”ç³»ç”µè¯</label>
            <input type="text" id="salesPhone" readonly placeholder="è‡ªåŠ¨å¡«å……">
          </div>
        </div>
        <div style="margin-top: 12px;">
          <label>æ”¶è´§åœ°å€ <span style="color: var(--danger);">*</span></label>
          <input type="text" id="salesAddress" required placeholder="è¯·è¾“å…¥æ”¶è´§åœ°å€">
        </div>
      </div>

      <!-- äº§å“æ˜ç»† -->
      <div class="form-section">
        <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
          <span>äº§å“æ˜ç»†</span>
          <button type="button" class="btn ghost" onclick="addSalesOrderItem()" style="padding: 6px 12px;">+ æ·»åŠ äº§å“</button>
        </div>
        
        <div id="salesOrderItems" style="margin-top: 12px;">
          <div class="sales-order-item">
            <div style="display: grid; grid-template-columns: 60px 120px 300px 100px 100px 120px 100px 100px 80px; gap: 8px; align-items: center; font-weight: 500; font-size: 14px; color: var(--muted);">
              <div>å›¾ç‰‡</div>
              <div>SKU</div>
              <div>äº§å“åç§°</div>
              <div>è§„æ ¼</div>
              <div>å•ä½</div>
              <div>å”®ä»·</div>
              <div>æ•°é‡</div>
              <div>å°è®¡</div>
              <div>æ“ä½œ</div>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 16px; text-align: right;">
          <div style="font-size: 16px; font-weight: 500;">
            æ€»é‡‘é¢ï¼šÂ¥<span id="salesOrderTotal">0.00</span>
          </div>
        </div>
      </div>

      <!-- å…¶ä»–ä¿¡æ¯ -->
      <div class="form-section">
        <div class="section-title">å…¶ä»–ä¿¡æ¯</div>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
          <div>
            <label>ç‰©æµå…¬å¸</label>
            <select id="salesLogisticsCompany" class="form-select">
              <option value="">è¯·é€‰æ‹©ç‰©æµå…¬å¸</option>
              <option value="é¡ºä¸°å¿«é€’">é¡ºä¸°å¿«é€’</option>
              <option value="åœ†é€šå¿«é€’">åœ†é€šå¿«é€’</option>
              <option value="ä¸­é€šå¿«é€’">ä¸­é€šå¿«é€’</option>
              <option value="ç”³é€šå¿«é€’">ç”³é€šå¿«é€’</option>
              <option value="éŸµè¾¾å¿«é€’">éŸµè¾¾å¿«é€’</option>
              <option value="äº¬ä¸œç‰©æµ">äº¬ä¸œç‰©æµ</option>
              <option value="å¾·é‚¦ç‰©æµ">å¾·é‚¦ç‰©æµ</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
          <div>
            <label>å¿«é€’å•å·</label>
            <input type="text" id="salesTrackingNo" placeholder="å¿«é€’å•å·">
          </div>
          <div>
            <label>è®¡é‡(kg)</label>
            <input type="number" id="salesWeight" step="0.1" placeholder="é‡é‡">
          </div>
          <div>
            <label>è¿è´¹</label>
            <input type="number" id="salesShippingFee" step="0.01" placeholder="è¿è´¹é‡‘é¢">
          </div>
        </div>
        <div style="margin-top: 12px;">
          <label>å¤‡æ³¨</label>
          <textarea id="salesNotes" rows="3" placeholder="è®¢å•å¤‡æ³¨ä¿¡æ¯"></textarea>
        </div>
      </div>

      <!-- è¡¨å•æ“ä½œ -->
      <div class="form-actions">
        <button type="button" class="btn ghost" onclick="closeSalesOrderCreateModal()">å–æ¶ˆ</button>
        <button type="submit" class="btn primary">ä¿å­˜è®¢å•</button>
      </div>
    </form>
  </div>
</div>

<!-- äº§å“é€‰æ‹©æ¨¡æ€æ¡† -->
<div id="productSelectModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ›ï¸ é€‰æ‹©äº§å“</div>
    <button class="modal-close" onclick="closeProductSelectModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">é€‰æ‹©è¦æ·»åŠ åˆ°è®¢å•çš„äº§å“</div>
    
    <div style="margin-bottom: 12px;">
      <input type="text" id="productSearchInput" placeholder="æœç´¢SKUæˆ–äº§å“åç§°..." onkeyup="filterProductsForSelection()" style="width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px;">
    </div>
    
    <div class="panel" style="max-height: 400px; overflow-y: auto;">
      <table id="table-product-selection">
        <thead>
          <tr>
            <th>å›¾ç‰‡</th>
            <th>SKU</th>
            <th>äº§å“åç§°</th>
            <th>è§„æ ¼</th>
            <th>åº“å­˜</th>
            <th>å”®ä»·</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- é”€å”®è®¢å•æŸ¥çœ‹æ¨¡æ€æ¡† -->
<div id="salesOrderViewModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">ğŸ“‹ é”€å”®è®¢å•è¯¦æƒ…</div>
    <button class="modal-close" onclick="closeSalesOrderViewModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">è®¢å•è¯¦ç»†ä¿¡æ¯</div>
    
    <form id="salesOrderViewForm">
      <!-- è®¢å•åŸºæœ¬ä¿¡æ¯ -->
      <div class="form-section">
        <div class="section-title">è®¢å•åŸºæœ¬ä¿¡æ¯</div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          <div>
            <label>è®¢å•ç¼–å·</label>
            <input type="text" id="viewOrderNo" readonly style="background: var(--bg);">
          </div>
          <div>
            <label>è®¢å•ç±»å‹</label>
            <input type="text" id="viewOrderType" readonly style="background: var(--bg);">
          </div>
          <div>
            <label>é”€å”®æ—¥æœŸ</label>
            <input type="text" id="viewSalesDate" readonly style="background: var(--bg);">
          </div>
          <div>
            <label>ä»˜æ¬¾æ–¹å¼</label>
            <input type="text" id="viewPaymentMethod" readonly style="background: var(--bg);">
          </div>
          <div>
            <label>ä»˜æ¬¾çŠ¶æ€</label>
            <input type="text" id="viewPaymentStatus" readonly style="background: var(--bg);">
          </div>
          <div>
            <label>äº¤è´§æ—¥æœŸ</label>
            <input type="text" id="viewDeliveryDate" readonly style="background: var(--bg);">
          </div>
        </div>
      </div>
      
      <!-- å®¢æˆ·ä¿¡æ¯ -->
      <div class="form-section">
        <div class="section-title">å®¢æˆ·ä¿¡æ¯</div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          <div>
            <label>å®¢æˆ·åç§°</label>
            <input type="text" id="viewCustomer" readonly style="background: var(--bg);">
          </div>
          <div>
            <label>è”ç³»äºº</label>
            <input type="text" id="viewContact" readonly style="background: var(--bg);">
          </div>
          <div>
            <label>è”ç³»ç”µè¯</label>
            <input type="text" id="viewPhone" readonly style="background: var(--bg);">
          </div>
          <div style="grid-column: span 3;">
            <label>æ”¶è´§åœ°å€</label>
            <input type="text" id="viewAddress" readonly style="background: var(--bg);">
          </div>
        </div>
      </div>
      
      <!-- äº§å“æ˜ç»† -->
      <div class="form-section">
        <div class="section-title">äº§å“æ˜ç»†</div>
        <div id="viewOrderItems" style="margin-bottom: 12px;">
          <!-- äº§å“æ˜ç»†å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div style="text-align: right; font-weight: bold; font-size: 16px;">
          è®¢å•æ€»é‡‘é¢ï¼š<span id="viewOrderTotal">Â¥0.00</span>
        </div>
      </div>
      
      <!-- å…¶ä»–ä¿¡æ¯ -->
      <div class="form-section">
        <div class="section-title">å…¶ä»–ä¿¡æ¯</div>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
          <div>
            <label>ç‰©æµå…¬å¸</label>
            <input type="text" id="viewLogisticsCompany" readonly style="background: var(--bg);">
          </div>
          <div>
            <label>å¿«é€’å•å·</label>
            <input type="text" id="viewTrackingNo" readonly style="background: var(--bg);">
          </div>
          <div>
            <label>è®¡é‡(kg)</label>
            <input type="text" id="viewWeight" readonly style="background: var(--bg);">
          </div>
          <div>
            <label>è¿è´¹</label>
            <input type="text" id="viewShippingFee" readonly style="background: var(--bg);">
          </div>
          <div style="grid-column: span 4;">
            <label>å¤‡æ³¨</label>
            <textarea id="viewNotes" rows="3" readonly style="background: var(--bg);"></textarea>
          </div>
        </div>
      </div>
      
      <!-- è®¢å•çŠ¶æ€ -->
      <div class="form-section">
        <div class="section-title">è®¢å•çŠ¶æ€</div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
          <div>
            <label>è®¢å•çŠ¶æ€</label>
            <input type="text" id="viewStatus" readonly style="background: var(--bg);">
          </div>
          <div>
            <label>ä¸šåŠ¡å‘˜</label>
            <input type="text" id="viewSalesperson" readonly style="background: var(--bg);">
          </div>
        </div>
      </div>
      
      <!-- è¡¨å•æ“ä½œ -->
      <div class="form-actions">
        <button type="button" class="btn ghost" onclick="closeSalesOrderViewModal()">å…³é—­</button>
        <button type="button" class="btn primary" onclick="editCurrentOrder()">ç¼–è¾‘è®¢å•</button>
      </div>
    </form>
  </div>
</div>

<!-- é”€å”®è®¢å•ç¼–è¾‘æ¨¡æ€æ¡† -->
<div id="salesOrderEditModal" class="modal-form hidden" style="display: none;">
  <div class="modal-header" onclick="event.stopPropagation()">
    <div class="modal-title">âœï¸ ç¼–è¾‘é”€å”®è®¢å•</div>
    <button class="modal-close" onclick="closeSalesOrderEditModal()" title="å…³é—­">Ã—</button>
  </div>
  <div class="modal-body" onclick="event.stopPropagation()">
    <div class="form-description">ç¼–è¾‘é”€å”®è®¢å•ä¿¡æ¯</div>
    
    <form id="salesOrderEditForm" onsubmit="updateSalesOrder(event)">
      <!-- è®¢å•åŸºæœ¬ä¿¡æ¯ -->
      <div class="form-section">
        <div class="section-title">è®¢å•åŸºæœ¬ä¿¡æ¯</div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          <div>
            <label>è®¢å•ç¼–å·</label>
            <input type="text" id="editOrderNo" readonly style="background: var(--bg);">
          </div>
          <div>
            <label>è®¢å•ç±»å‹</label>
            <select id="editOrderType" required onchange="handleEditOrderTypeChange()">
              <option value="">è¯·é€‰æ‹©è®¢å•ç±»å‹</option>
              <option value="1688">1688ä¸šåŠ¡</option>
              <option value="offline">çº¿ä¸‹åˆä½œ</option>
            </select>
          </div>
          <div>
            <label>é”€å”®æ—¥æœŸ</label>
            <input type="date" id="editSalesDate" required>
          </div>
          <div>
            <label>ä»˜æ¬¾æ–¹å¼</label>
            <select id="editPaymentMethod" required>
              <option value="">è¯·é€‰æ‹©ä»˜æ¬¾æ–¹å¼</option>
            </select>
          </div>
          <div>
            <label>ä»˜æ¬¾çŠ¶æ€</label>
            <select id="editPaymentStatus" required>
              <option value="">è¯·é€‰æ‹©ä»˜æ¬¾çŠ¶æ€</option>
              <option value="å·²æ”¶">å·²æ”¶</option>
              <option value="æœªæ”¶">æœªæ”¶</option>
            </select>
          </div>
          <div>
            <label>äº¤è´§æ—¥æœŸ</label>
            <input type="date" id="editDeliveryDate" required>
          </div>
        </div>
      </div>
      
      <!-- å®¢æˆ·ä¿¡æ¯ -->
      <div class="form-section">
        <div class="section-title">å®¢æˆ·ä¿¡æ¯</div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          <div>
            <label>å®¢æˆ·åç§° <span style="color: var(--danger);">*</span></label>
            <div style="display: flex; gap: 8px;">
              <select id="editCustomer" required onchange="handleEditCustomerChange()" style="flex: 1;">
                <option value="">è¯·é€‰æ‹©å®¢æˆ·</option>
                <option value="new">ğŸ“ æ–°å¢å®¢æˆ·</option>
              </select>
              <button type="button" onclick="toggleEditCustomerInput()" style="padding: 8px 12px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;" title="æ‰‹åŠ¨è¾“å…¥å®¢æˆ·ä¿¡æ¯">
                âœï¸
              </button>
            </div>
            <input type="text" id="editCustomerInput" placeholder="æˆ–ç›´æ¥è¾“å…¥å®¢æˆ·åç§°" style="display: none; margin-top: 8px; width: 100%;" oninput="handleEditCustomerInput()">
          </div>
          <div>
            <label>è”ç³»äºº</label>
            <input type="text" id="editContact" required placeholder="è”ç³»äººå§“å">
          </div>
          <div>
            <label>è”ç³»ç”µè¯</label>
            <input type="text" id="editPhone" required placeholder="è”ç³»ç”µè¯">
          </div>
          <div style="grid-column: span 3;">
            <label>æ”¶è´§åœ°å€</label>
            <input type="text" id="editAddress" required placeholder="æ”¶è´§åœ°å€">
          </div>
        </div>
      </div>
      
      <!-- äº§å“æ˜ç»† -->
      <div class="form-section">
        <div class="section-title">äº§å“æ˜ç»†</div>
        <div style="margin-bottom: 12px;">
          <button type="button" class="btn ghost" onclick="openEditProductSelectModal()">â• æ·»åŠ äº§å“</button>
        </div>
        <div id="editOrderItems" style="margin-bottom: 12px;">
          <!-- äº§å“æ˜ç»†å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div style="text-align: right; font-weight: bold; font-size: 16px;">
          è®¢å•æ€»é‡‘é¢ï¼š<span id="editOrderTotal">Â¥0.00</span>
        </div>
      </div>
      
      <!-- å…¶ä»–ä¿¡æ¯ -->
      <div class="form-section">
        <div class="section-title">å…¶ä»–ä¿¡æ¯</div>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
          <div>
            <label>ç‰©æµå…¬å¸</label>
            <select id="editLogisticsCompany" class="form-select">
              <option value="">è¯·é€‰æ‹©ç‰©æµå…¬å¸</option>
              <option value="é¡ºä¸°å¿«é€’">é¡ºä¸°å¿«é€’</option>
              <option value="åœ†é€šå¿«é€’">åœ†é€šå¿«é€’</option>
              <option value="ä¸­é€šå¿«é€’">ä¸­é€šå¿«é€’</option>
              <option value="ç”³é€šå¿«é€’">ç”³é€šå¿«é€’</option>
              <option value="éŸµè¾¾å¿«é€’">éŸµè¾¾å¿«é€’</option>
              <option value="äº¬ä¸œç‰©æµ">äº¬ä¸œç‰©æµ</option>
              <option value="å¾·é‚¦ç‰©æµ">å¾·é‚¦ç‰©æµ</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
          <div>
            <label>å¿«é€’å•å·</label>
            <input type="text" id="editTrackingNo" placeholder="å¿«é€’å•å·">
          </div>
          <div>
            <label>è®¡é‡(kg)</label>
            <input type="number" id="editWeight" step="0.1" placeholder="é‡é‡">
          </div>
          <div>
            <label>è¿è´¹</label>
            <input type="number" id="editShippingFee" step="0.01" placeholder="è¿è´¹">
          </div>
          <div style="grid-column: span 4;">
            <label>å¤‡æ³¨</label>
            <textarea id="editNotes" rows="3" placeholder="è®¢å•å¤‡æ³¨ä¿¡æ¯"></textarea>
          </div>
        </div>
      </div>
      
      <!-- è¡¨å•æ“ä½œ -->
      <div class="form-actions">
        <button type="button" class="btn ghost" onclick="closeSalesOrderEditModal()">å–æ¶ˆ</button>
        <button type="submit" class="btn primary">ä¿å­˜ä¿®æ”¹</button>
      </div>
    </form>
  </div>
</div>

</script>
</body>
</html>
